
<!DOCTYPE html><html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.1" theme-name="Stellar" theme-version="1.29.1">
  
  <meta name="generator" content="Hexo 7.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  
  <title>嵌入式初始配置 - 玲璐</title>

  
    <meta name="description" content="Firefly Linux 开发指南 1.1. Ubuntu Desktop 系统¶Ubuntu Desktop 系统开机启动后，自动登录到 firefly 用户。 如果有连接调试串口，串口终端自动登录 root 用户。  firefly 用户密码： firefly root 用户：默认没有设置 root 密码，firefly 用户通过 sudo passwd root 命令自行配置 root 密">
<meta property="og:type" content="article">
<meta property="og:title" content="嵌入式初始配置">
<meta property="og:url" content="http://liuluhua.github.io/2024/12/19/0-%E5%B9%B3%E5%8F%B0-%E5%B5%8C%E5%85%A5%E5%BC%8F-%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%88%9D%E5%A7%8B%E9%85%8D%E7%BD%AE/index.html">
<meta property="og:site_name" content="玲璐">
<meta property="og:description" content="Firefly Linux 开发指南 1.1. Ubuntu Desktop 系统¶Ubuntu Desktop 系统开机启动后，自动登录到 firefly 用户。 如果有连接调试串口，串口终端自动登录 root 用户。  firefly 用户密码： firefly root 用户：默认没有设置 root 密码，firefly 用户通过 sudo passwd root 命令自行配置 root 密">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/gpio_led_1.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/gpio_led_2.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/wifi-bridge-topology.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/router1-20220629170401-d8fx48i.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/router2-20220630162119-lgcya9l.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/router3-20220705091939-09uw91m.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/double_panel.jpg">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-config-Versions.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-config-Compilers_1.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-config-Compilers_2.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-config-Debuggers.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-config-Devices.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-config-Kits.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-Choose-Kit.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-command_line_arguments.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-set-environment.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-Compile.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/X_Logo.png">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/qt_logo.jpeg">
<meta property="og:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/wayland_logo.png">
<meta property="article:published_time" content="2024-12-19T03:18:10.000Z">
<meta property="article:modified_time" content="2024-12-19T03:19:53.000Z">
<meta property="article:author" content="liuluhua">
<meta property="article:tag" content="clippings">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/gpio_led_1.png">
  
  
  
  <meta name="keywords" content="clippings">

  <!-- feed -->
  

  <link rel="stylesheet" href="/css/main.css?v=1.29.1">


  

  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/satouriko/LxgwWenKai_Webfonts@v1.101/dist/LXGWWenKaiMono-Bold.css" />
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="https://raw.staticdn.net/liuluhua/liuluhua.github.io/ImageBed/BlogRes/avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">玲璐</div><div class="sub cap">玲璐的充电站</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="Search"></form><div id="search-result"></div><div class="search-no-result">No Results!</div></div>


<nav class="menu dis-select"><a class="nav-item active" title="Qexo" target="_blank" rel="noopener" href="http://124.222.246.202:9083/" style="color:#3DC550"><span>Qexo</span></a><a class="nav-item active" title="Alist" target="_blank" rel="noopener" href="http://124.222.246.202:9084/" style="color:#FA6400"><span>Alist</span></a></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">Recent Update</span></div><div class="widget-body fs14"><a class="item title" href="/2024/12/19/0-%E5%B9%B3%E5%8F%B0-%E5%B9%B3%E5%8F%B0%E7%9B%B8%E5%85%B3-Linux%E5%90%AF%E5%8A%A8/"><span class="title">Linux启动</span></a><a class="item title" href="/2024/12/19/0-%E5%B9%B3%E5%8F%B0-%E5%B9%B3%E5%8F%B0%E7%9B%B8%E5%85%B3-Windows%E7%9A%84%E5%90%AF%E5%8A%A8/"><span class="title">Windows的启动</span></a><a class="item title" href="/2024/12/19/1-%E8%AF%AD%E8%A8%80-C%E8%AF%AD%E8%A8%80-%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E5%88%87%E6%8D%A2%E5%BC%80%E9%94%80/"><span class="title">切换开销</span></a><a class="item title" href="/2024/07/16/1-%E8%AF%AD%E8%A8%80-C%E8%AF%AD%E8%A8%80-%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="title">多线程</span></a><a class="item title" href="/2024/12/19/0-%E5%B9%B3%E5%8F%B0-%E5%B9%B3%E5%8F%B0%E7%9B%B8%E5%85%B3-%E5%BC%80%E6%BA%90%E5%8D%8F%E8%AE%AE/"><span class="title">开源协议</span></a><a class="item title" href="/2024/07/12/2-%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE-USB-USB%E8%AE%BE%E5%A4%87%E8%8A%82%E7%82%B9%E5%90%8D%E4%B8%8D%E5%9B%BA%E5%AE%9A/"><span class="title">USB设备节点名不固定</span></a><a class="item title" href="/2024/12/19/0-%E5%B9%B3%E5%8F%B0-%E5%B9%B3%E5%8F%B0%E7%9B%B8%E5%85%B3-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"><span class="title">操作系统</span></a><a class="item title" href="/2024/12/19/0-%E5%B9%B3%E5%8F%B0-Linux-%E7%B3%BB%E7%BB%9F%E5%8F%82%E6%95%B0-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/"><span class="title">用户管理</span></a><a class="item title" href="/2024/12/18/0-%E5%B9%B3%E5%8F%B0-%E6%9C%8D%E5%8A%A1%E5%99%A8-%E5%8D%9A%E5%AE%A2-WordPress%E6%90%AD%E5%BB%BA/"><span class="title">WordPress搭建</span></a><a class="item title" href="/2024/05/22/3-%E8%BD%AF%E4%BB%B6-0%E6%9D%82%E9%A1%B9-16-8%E7%A6%81%E9%A3%9F%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"><span class="title">16-8禁食软件架构设计</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="/" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/08a41b181ce68.svg"/></a><a class="social" href="/" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/3845874.svg"/></a><a class="social" href="/" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/3616429.svg"/></a><a class="social" href="/about/#comments" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/942ebbf1a4b91.svg"/></a><a class="social" onclick="switchTheme()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024"><path fill="currentColor" fill-rule="evenodd" d="M582.4 326.4c-140.8 0-256 115.2-256 256s115.2 256 256 256 256-115.2 256-256-115.2-256-256-256z m0 448c-70.4 0-131.2-36.8-164.8-92.8 12.8 3.2 27.2 4.8 40 4.8 121.6 0 219.2-99.2 219.2-219.2 0-17.6-1.6-35.2-6.4-52.8 60.8 32 102.4 96 102.4 169.6 1.6 104-84.8 190.4-190.4 190.4zM582.4 262.4c17.6 0 32-14.4 32-32v-128c0-17.6-14.4-32-32-32s-32 14.4-32 32v128c0 17.6 14.4 32 32 32zM262.4 582.4c0-17.6-14.4-32-32-32h-128c-17.6 0-32 14.4-32 32s14.4 32 32 32h128c17.6 0 32-14.4 32-32zM310.4 356.8c6.4 6.4 14.4 9.6 22.4 9.6 8 0 16-3.2 22.4-9.6 12.8-12.8 12.8-32 0-44.8l-91.2-91.2c-12.8-12.8-32-12.8-44.8 0-12.8 12.8-12.8 32 0 44.8l91.2 91.2zM944 220.8c-12.8-12.8-32-12.8-44.8 0l-91.2 91.2c-12.8 12.8-12.8 32 0 44.8 6.4 6.4 14.4 9.6 22.4 9.6 8 0 16-3.2 22.4-9.6l91.2-91.2c12.8-12.8 12.8-33.6 0-44.8zM310.4 808l-91.2 91.2c-12.8 12.8-12.8 32 0 44.8 6.4 6.4 14.4 9.6 22.4 9.6 8 0 16-3.2 22.4-9.6l91.2-91.2c12.8-12.8 12.8-32 0-44.8-11.2-11.2-32-11.2-44.8 0z"></path></svg></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">Home</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">Blog</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/0-%E5%B9%B3%E5%8F%B0/">0.平台</a> <span class="sep"></span> <a class="cap breadcrumb-link" href="/categories/0-%E5%B9%B3%E5%8F%B0/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a></div>
<div class="flex-row" id="post-meta"><span class="text created">Posted on: <time datetime="2024-12-19T03:18:10.000Z">2024-12-19</time></span><span class="sep updated"></span><span class="text updated">Updated on: <time datetime="2024-12-19T03:19:53.000Z">2024-12-19</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>嵌入式初始配置</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><p><a target="_blank" rel="noopener" href="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/index.html">Firefly Linux 开发指南</a></p>
<h2 id="1-1-Ubuntu-Desktop-系统¶"><a href="#1-1-Ubuntu-Desktop-系统¶" class="headerlink" title="1.1. Ubuntu Desktop 系统¶"></a>1.1. Ubuntu Desktop 系统¶</h2><p>Ubuntu Desktop 系统开机启动后，自动登录到 firefly 用户。</p>
<p>如果有连接调试串口，串口终端自动登录 root 用户。</p>
<ul>
<li>firefly 用户密码： firefly</li>
<li>root 用户：默认没有设置 root 密码，firefly 用户通过 <code>sudo passwd root</code> 命令自行配置 root 密码。</li>
</ul>
<h2 id="1-2-Ubuntu-Minimal-系统¶"><a href="#1-2-Ubuntu-Minimal-系统¶" class="headerlink" title="1.2. Ubuntu Minimal 系统¶"></a>1.2. Ubuntu Minimal 系统¶</h2><ul>
<li>Ubuntu Minimal 系统开机启动后，自动登录到 root 用户，密码为 firefly。</li>
<li>系统已经添加 OpenGL ES, OpenCL, DRM 支持。</li>
</ul>
<h2 id="1-3-Buildroot-系统¶"><a href="#1-3-Buildroot-系统¶" class="headerlink" title="1.3. Buildroot 系统¶"></a>1.3. Buildroot 系统¶</h2><ul>
<li>用户：root</li>
<li>密码：firefly</li>
</ul>
<h2 id="2-ADB-使用¶"><a href="#2-ADB-使用¶" class="headerlink" title="2. ADB 使用¶"></a>2. ADB 使用¶</h2><h2 id="2-1-ADB¶"><a href="#2-1-ADB¶" class="headerlink" title="2.1. ADB¶"></a>2.1. ADB¶</h2><p>用 Type-C data cable 连接设备和主机，然后输入以下命令：</p>
<h2 id="2-2-网络-ADB¶"><a href="#2-2-网络-ADB¶" class="headerlink" title="2.2. 网络 ADB¶"></a>2.2. 网络 ADB¶</h2><p>查看开发板 IP 地址，PC 端通过网络访问：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb connect + IP</span><br><span class="line">adb shell</span><br></pre></td></tr></table></figure>

<p>注意点： AIO-3399-JD4 &#x2F; AIO-3399J 要支持使用 ADB 需要修改 <code>kernel/arch/arm64/boot/dts/rockchip/rk3399-firefly-aio.dtsi</code>，将 <code>usbdrd_dwc3_0</code> 设置为 <code>peripheral</code> 模式，之后该 usb 只能作为从设备使用。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&amp;usbdrd_dwc3_0 &#123;</span><br><span class="line">    dr_mode = <span class="string">&quot;peripheral&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>同理，AIO-3399Pro-JD4 要支持使用 ADB 需要修改 <code>kernel/arch/arm64/boot/dts/rockchip/rk3399pro-firefly-aioc.dts</code>。</p>
<p>然后重新编译和烧写 Kernel。</p>
<h2 id="4-导出设备系统¶"><a href="#4-导出设备系统¶" class="headerlink" title="4. 导出设备系统¶"></a>4. 导出设备系统¶</h2><p>当用户已经在一台设备上完成工作环境的部署，需要将当前环境完整导出，以批量部署到其它同设备上，可以通过导出设备文件系统来备份当前的开发环境。</p>
<p>导出设备系统分为两步：</p>
<ol>
<li>在设备上导出 Ubuntu 根文件系统 rootfs；</li>
<li>二次打包完整固件，将 Ubuntu rootfs 与发布固件的其他分区组合，完成二次打包，生成新的完整固件。</li>
</ol>
<h2 id="4-1-导出-rootfs¶"><a href="#4-1-导出-rootfs¶" class="headerlink" title="4.1. 导出 rootfs¶"></a>4.1. 导出 rootfs¶</h2><p><strong>注意以下操作均在设备端上操作！</strong></p>
<ol>
<li>在设备的 Ubuntu 环境下，安装 <code>fireflydev</code>：</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install fireflydev</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>安装 <code>fireflydev</code> 后，就能使用 <code>ff_export_rootfs</code> 脚本导出根文件系统</li>
</ol>
<ul>
<li>建议使用容量较大的移动硬盘</li>
<li>导出工具会执行 <code>apt clean</code> 等操作以减小文件系统大小</li>
<li>将根文件系统导出，例如导出到 <code>/media/firefly/AC91-C4AE/</code> 目录（需要等待一定时间）：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ff_export_rootfs /media/firefly/AC91-C4AE/</span><br></pre></td></tr></table></figure>

<ul>
<li>压缩文件系统，删除不必要的空白空间以减少存储器资源的占用：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 有部分客户说导出的 rootfs 大小为 <span class="number">3.3</span>G，可实际只用了 <span class="number">3</span>G，原因是没有对 rootfs 进行压缩</span><br><span class="line">e2fsck -p -f Firefly_Ubuntu_18<span class="number">.04</span><span class="number">.6</span>_rootfs.img</span><br><span class="line">resize2fs -M Firefly_Ubuntu_18<span class="number">.04</span><span class="number">.6</span>_rootfs.img</span><br></pre></td></tr></table></figure>

<h2 id="4-2-二次打包完整固件¶"><a href="#4-2-二次打包完整固件¶" class="headerlink" title="4.2. 二次打包完整固件¶"></a>4.2. 二次打包完整固件¶</h2><p><strong>注意以下操作均在 PC 机端（x86-64 架构）上操作！</strong></p>
<ol>
<li>安装必要的软件包：<code>sudo apt-get install lib32stdc++6</code></li>
<li>下载二次打包工具：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1qiOqutl4WW1OFBpom8w6nA">firefly-linux-repack</a>（提取码：1234）</li>
<li>解压二次打包工具：</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xzf firefly-linux-repack.tgz</span><br><span class="line">cd firefly-linux-repack</span><br></pre></td></tr></table></figure>

<p>目录如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">firefly-linux-repack</span><br><span class="line">    ├── bin</span><br><span class="line">    │   ├── afptool</span><br><span class="line">    │   └── rkImageMaker</span><br><span class="line">    ├── pack.sh # 打包脚本</span><br><span class="line">    ├── Readme_en.md</span><br><span class="line">    ├── Readme.md</span><br><span class="line">    └── unpack.sh # 解包脚本</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>解包操作： 把官方发布的 Ubuntu 固件拷贝到 <code>firefly-linux-repack</code> 根目录，重命名为 <code>update.img</code>，执行解包脚本 <code>unpack.sh</code>。解包完成后，各分区文件在 <code>output</code> 目录下。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv /path/to/ROC-RK3566-PC_Ubuntu18<span class="number">.04</span>-r21156_v1<span class="number">.2</span><span class="number">.4</span>a_220519.img update.img</span><br><span class="line">./unpack.sh</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>打包操作：保持当前目录结构，文件名等不变，接入移动硬盘到 PC 机，把前面导出的 Ubuntu rootfs 替换 <code>output/Image/rootfs.img</code>，然后执行打包脚本 <code>pack.sh</code>。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /media/customer/<span class="number">1878</span><span class="number">-4615</span>/Firefly_Ubuntu_18<span class="number">.04</span><span class="number">.6</span>_rootfs.img /path/to/firefly-linux-repack/output/Image/rootfs.img</span><br><span class="line">./pack.sh</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>新的完整固件为当前目录的 <code>new_update.img</code>。</li>
</ol>
<h2 id="5-GPIO-配置与使用¶"><a href="#5-GPIO-配置与使用¶" class="headerlink" title="5. GPIO 配置与使用¶"></a>5. GPIO 配置与使用¶</h2><p>GPIO, 全称 General-Purpose Input&#x2F;Output（通用输入输出），是一种软件运行期间能够动态配置和控制的通用引脚。</p>
<p>以下通过控制 ROC-RK3399-PC Pro 的 LED 为例，对于其他设备，方法是类似的。</p>
<p>ROC-RK3399-PC Pro 的主控是 RK3399，RK3399 有 5 组 GPIO bank：GPIO0<del>GPIO4，每组又以 A0</del>A7, B0<del>B7, C0</del>C7, D0~D7 作为编号区分。</p>
<h2 id="5-1-GPIO-编号计算¶"><a href="#5-1-GPIO-编号计算¶" class="headerlink" title="5.1. GPIO 编号计算¶"></a>5.1. GPIO 编号计算¶</h2><p>ROC-RK3399-PC Pro 板载两个 LED，如下：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/gpio_led_1.png" alt="_images/gpio_led_1.png"></p>
<p>DIY_LED 网络是接到引脚 GPIO0_B5：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/gpio_led_2.png" alt="_images/gpio_led_2.png"></p>
<p>PIO pin 脚计算公式：</p>
<p>GPIO 小组编号计算公式：</p>
<p>例如 GPIO0_B5：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bank = <span class="number">0</span>;      <span class="comment">// GPIO0_B5 =&gt; 0, bank ∈ [0,4]</span></span><br><span class="line">group = <span class="number">1</span>;     <span class="comment">// GPIO0_B5 =&gt; 1, group ∈ &#123;(A=0), (B=1), (C=2), (D=3)&#125;</span></span><br><span class="line">X = <span class="number">5</span>;         <span class="comment">// GPIO0_B5 =&gt; 5, X ∈ [0,7]</span></span><br><span class="line">number = group * <span class="number">8</span> + X = <span class="number">1</span> * <span class="number">8</span> + <span class="number">5</span> = <span class="number">13</span>;</span><br><span class="line">pin = bank * <span class="number">32</span> + number = <span class="number">0</span> * <span class="number">32</span> + <span class="number">13</span> = <span class="number">13</span>;</span><br></pre></td></tr></table></figure>

<p>注意：这个引脚在官方发布的固件中默认已被 LED 子系统占用，因此首先需要找到以下节点将其 disable！</p>
<p>ROC-RK3399-PC Pro 是定义在 <code>arch/arm64/boot/dts/rockchip/rk3399-roc-pc.dtsi</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">user &#123;</span><br><span class="line">        status = <span class="string">&quot;disabled&quot;</span>; <span class="comment">// 添加这一行</span></span><br><span class="line">        label = <span class="string">&quot;firefly:yellow:user&quot;</span>;</span><br><span class="line">        linux,<span class="keyword">default</span>-trigger = <span class="string">&quot;ir-user-click&quot;</span>;</span><br><span class="line">        <span class="keyword">default</span>-state = <span class="string">&quot;off&quot;</span>;</span><br><span class="line">        gpios = &lt;&amp;gpio0 <span class="number">13</span> GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">        pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">        pinctrl<span class="number">-0</span> = &lt;&amp;led_user&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后编译与重新烧写内核固件。</p>
<h2 id="5-2-用户态使用-GPIO¶"><a href="#5-2-用户态使用-GPIO¶" class="headerlink" title="5.2. 用户态使用 GPIO¶"></a>5.2. 用户态使用 GPIO¶</h2><p>1、申请 GPIO</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="number">13</span> &gt; /sys/<span class="keyword">class</span>/gpio/<span class="keyword">export</span></span><br></pre></td></tr></table></figure>

<p>2、配置引脚方向</p>
<p>查看默认引脚方向：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/<span class="keyword">class</span>/gpio/gpio13/direction</span><br></pre></td></tr></table></figure>

<p>配置成输出方向：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo out &gt; /sys/<span class="keyword">class</span>/gpio/gpio13/direction</span><br></pre></td></tr></table></figure>

<p>3、配置引脚输出电平</p>
<p>从前面的原理图可知，输出高电平为点亮 LED：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="number">1</span> &gt; /sys/<span class="keyword">class</span>/gpio/gpio13/value</span><br></pre></td></tr></table></figure>

<p>熄灭 LED：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="number">0</span> &gt; /sys/<span class="keyword">class</span>/gpio/gpio13/value</span><br></pre></td></tr></table></figure>

<h2 id="5-3-设备树使用-GPIO¶"><a href="#5-3-设备树使用-GPIO¶" class="headerlink" title="5.3. 设备树使用 GPIO¶"></a>5.3. 设备树使用 GPIO¶</h2><p>在设备树中配置 GPIO，需要配置引脚的功能复用与电气属性</p>
<p>对于 rockchip 引脚，配置如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rockchip,pins = &lt;PIN_BANK PIN_BANK_IDX MUX &amp;phandle&gt;</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><code>PIN_BANK</code>：引脚所在的 bank</li>
<li><code>PIN_BANK_IDX</code>：引脚所在 bank 的引脚号</li>
<li><code>MUX</code>：功能复用配置，<code>0</code> 表示普通 GPIO，<code>1-N</code> 表示特殊的功能复用</li>
<li><code>phandle</code>：引脚一般配置，例如内部上拉、电流强度等，在 <code>Documentation/devicetree/bindings/pinctrl/pinctrl-bindings.txt</code> 文件中描述</li>
</ul>
<p>配置 GPIO0_B5 引脚：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rockchip,pins = &lt;<span class="number">0</span> <span class="number">13</span> RK_FUNC_GPIO &amp;pcfg_pull_none&gt;;</span><br></pre></td></tr></table></figure>

<p>此处的含义：</p>
<ol>
<li><code>PIN_BANK</code> 等于 <code>0</code></li>
<li><code>PIN_BANK_IDX</code> 等于 <code>13</code></li>
<li><code>RK_FUNC_GPIO</code> 代表使用普通 GPIO 功能</li>
<li><code>pcfg_pull_none</code> 代表普通配置</li>
</ol>
<p>对于 LED，Linux 定义了一套 GPIO 子系统，设备树的配置如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/ &#123;</span><br><span class="line">	gpio_led: gpio-led &#123;</span><br><span class="line">		compatible = <span class="string">&quot;gpio-leds&quot;</span>;</span><br><span class="line"></span><br><span class="line">		diy_led: diy-led &#123;</span><br><span class="line">			label = <span class="string">&quot;diy-led&quot;</span>;</span><br><span class="line">			<span class="keyword">default</span>-state = <span class="string">&quot;on&quot;</span>; <span class="comment">// 默认打开</span></span><br><span class="line">			linux,<span class="keyword">default</span>-trigger = <span class="string">&quot;default-on&quot;</span>; <span class="comment">// 默认触发</span></span><br><span class="line">			gpios = &lt;&amp;gpio0 <span class="number">13</span> GPIO_ACTIVE_HIGH&gt;; <span class="comment">// 引脚设置</span></span><br><span class="line">			pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">			pinctrl<span class="number">-0</span> = &lt;&amp;diy_led_pin&gt;; <span class="comment">// 引用 pinctrl</span></span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;pinctrl &#123;</span><br><span class="line">	gpio-led-pin &#123;</span><br><span class="line">		diy_led_pin: diy-led-pin &#123;</span><br><span class="line">			rockchip,pins =</span><br><span class="line">				&lt;<span class="number">0</span> <span class="number">13</span> RK_FUNC_GPIO &amp;pcfg_pull_none&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后编译与重新烧写内核固件，重启系统会看到 LED 默认点亮。</p>
<p>如果希望 LED 具有闪烁效果，可以修改 <code>linux,default-trigger</code> 属性实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">linux,<span class="keyword">default</span>-trigger = <span class="string">&quot;timer&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>配置该属性后，LED 默认每 500ms 间隔闪烁。</p>
<p>更多属性配置可以参考 <code>Documentation/devicetree/bindings/leds/leds-gpio.txt</code>。</p>
<p>以上设备树配置可以在 <code>arch/arm64/boot/dts/rockchip/firefly-gpio-demo.dtsi</code> 找到！有需求的用户在板极设备树中包含该文件即可（记得要首先 disable <code>rk3399-roc-pc.dtsi</code> 里面冲突部分）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;firefly-gpio-demo.dtsi&quot;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="6-网络配置¶"><a href="#6-网络配置¶" class="headerlink" title="6. 网络配置¶"></a>6. 网络配置¶</h2><h2 id="6-1-以太网口通用参数配置¶"><a href="#6-1-以太网口通用参数配置¶" class="headerlink" title="6.1. 以太网口通用参数配置¶"></a>6.1. 以太网口通用参数配置¶</h2><h3 id="6-1-1-查看以太网通用参数¶"><a href="#6-1-1-查看以太网通用参数¶" class="headerlink" title="6.1.1. 查看以太网通用参数¶"></a>6.1.1. 查看以太网通用参数¶</h3><p>以太网的通用参数包括：自协商，双工模式和接口速率</p>
<h3 id="6-1-2-配置以太网通用参数¶"><a href="#6-1-2-配置以太网通用参数¶" class="headerlink" title="6.1.2. 配置以太网通用参数¶"></a>6.1.2. 配置以太网通用参数¶</h3><h4 id="6-1-2-1-打开或关闭自协商¶"><a href="#6-1-2-1-打开或关闭自协商¶" class="headerlink" title="6.1.2.1. 打开或关闭自协商¶"></a>6.1.2.1. 打开或关闭自协商¶</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ethtool -s port_name autoneg &#123; on | off &#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-1-2-2-修改双工模式¶"><a href="#6-1-2-2-修改双工模式¶" class="headerlink" title="6.1.2.2. 修改双工模式¶"></a>6.1.2.2. 修改双工模式¶</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ethtool -s port_name duplex &#123; half | full &#125;</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li>当以太网接口工作在自协商模式时，缺省情况下双工模式是和对端接口协商得到的。</li>
<li>当以太网接口工作在非自协商模式时，缺省情况下双工模式为全双工模式。</li>
</ul>
<h4 id="6-1-2-3-修改速率¶"><a href="#6-1-2-3-修改速率¶" class="headerlink" title="6.1.2.3. 修改速率¶"></a>6.1.2.3. 修改速率¶</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ethtool -s port_name speed &#123; <span class="number">10</span> | <span class="number">100</span> | <span class="number">1000</span> &#125;</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li>当以太网接口工作在自协商模式时，缺省情况下接口速率是和对端接口协商得到的。</li>
<li>当以太网接口工作在非自协商模式时，缺省情况下接口速率为接口支持的最大接口速率。</li>
</ul>
<h3 id="6-1-3-配置举例¶"><a href="#6-1-3-配置举例¶" class="headerlink" title="6.1.3. 配置举例¶"></a>6.1.3. 配置举例¶</h3><p>手动设置 eth0 的接口速率为 100，工作在全双工模式下。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ethtool -s eth0 autoneg off</span><br><span class="line">ethtool -s eth0 speed <span class="number">100</span></span><br><span class="line">ethtool -s eth0 duplex full</span><br></pre></td></tr></table></figure>

<h2 id="6-2-使用-Netplan-管理网络¶"><a href="#6-2-使用-Netplan-管理网络¶" class="headerlink" title="6.2. 使用 Netplan 管理网络¶"></a>6.2. 使用 Netplan 管理网络¶</h2><p>Netplan 是一个用于在 linux 系统上轻松配置网络的实用程序。您只需创建所需网络接口的 YAML 描述以及每个应配置的功能。根据此描述，Netplan 将为您选择的渲染器工具生成所有必要的配置。在 Ubuntu18.04 及其以上版本进行了支持。</p>
<h3 id="6-2-1-配置¶"><a href="#6-2-1-配置¶" class="headerlink" title="6.2.1. 配置¶"></a>6.2.1. 配置¶</h3><p>要配置 netplan，请 <code>/etc/netplan/</code> 使用 <code>.yaml</code> 扩展名（例如 <code>/etc/netplan/config.yaml</code>）保存配置文件，然后运行 <code>sudo netplan apply</code>. 此命令解析配置并将其应用于系统。</p>
<p>注意：</p>
<ul>
<li>如果 <code>netplan apply</code> 报错，说明您的 yaml 配置文件未被系统支持，请仔细检查</li>
<li>对于以太网口，必须保证有网线接入，并且网卡灯闪烁，才能保证 Netplan 配置生效</li>
</ul>
<p>下面根据最常使用的工作场景进行配置，需要更多的配置案例教程，请阅读 <a target="_blank" rel="noopener" href="https://netplan.io/examples">netplan官方实例</a></p>
<h3 id="6-2-2-基础配置¶"><a href="#6-2-2-基础配置¶" class="headerlink" title="6.2.2. 基础配置¶"></a>6.2.2. 基础配置¶</h3><p>Netplan 支持 networkd 和 NetworkManager 两种网络后端，一般为 networkd</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">  version: <span class="number">2</span></span><br><span class="line">  renderer: networkd</span><br></pre></td></tr></table></figure>

<p>如果不存在 networkd，可以使用 NetworkManager，都是一样的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">  version: <span class="number">2</span></span><br><span class="line">  renderer: NetworkManager</span><br></pre></td></tr></table></figure>

<h3 id="6-2-3-以太网连接：动态-IP¶"><a href="#6-2-3-以太网连接：动态-IP¶" class="headerlink" title="6.2.3. 以太网连接：动态 IP¶"></a>6.2.3. 以太网连接：动态 IP¶</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">  version: <span class="number">2</span></span><br><span class="line">  renderer: networkd</span><br><span class="line">  ethernets:</span><br><span class="line">    eth0:</span><br><span class="line">      dhcp4: yes</span><br><span class="line">    eth1:</span><br><span class="line">      dhcp4: yes</span><br></pre></td></tr></table></figure>

<h3 id="6-2-4-以太网连接：静态-IP¶"><a href="#6-2-4-以太网连接：静态-IP¶" class="headerlink" title="6.2.4. 以太网连接：静态 IP¶"></a>6.2.4. 以太网连接：静态 IP¶</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">  version: <span class="number">2</span></span><br><span class="line">  renderer: networkd</span><br><span class="line">  ethernets:</span><br><span class="line">    eth0:</span><br><span class="line">      addresses:</span><br><span class="line">        - <span class="number">10.10</span><span class="number">.10</span><span class="number">.3</span>/<span class="number">24</span></span><br><span class="line">      nameservers:</span><br><span class="line">        addresses: [<span class="number">202.96</span><span class="number">.128</span><span class="number">.86</span>]</span><br><span class="line">      routes:</span><br><span class="line">        - to: <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line">          via: <span class="number">10.10</span><span class="number">.10</span><span class="number">.1</span></span><br><span class="line">    </span><br><span class="line">    eth1:</span><br><span class="line">      addresses:</span><br><span class="line">        - <span class="number">10.10</span><span class="number">.10</span><span class="number">.2</span>/<span class="number">24</span></span><br><span class="line">      nameservers:</span><br><span class="line">        addresses: [<span class="number">202.96</span><span class="number">.128</span><span class="number">.86</span>]</span><br><span class="line">      routes:</span><br><span class="line">        - to: <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line">          via: <span class="number">10.10</span><span class="number">.10</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-5-WIFI-连接：静态-IP¶"><a href="#6-2-5-WIFI-连接：静态-IP¶" class="headerlink" title="6.2.5. WIFI 连接：静态 IP¶"></a>6.2.5. WIFI 连接：静态 IP¶</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">  version: <span class="number">2</span></span><br><span class="line">  renderer: networkd</span><br><span class="line">  wifis:</span><br><span class="line">    wlan0:</span><br><span class="line">      dhcp4: no</span><br><span class="line">      dhcp6: no</span><br><span class="line">      addresses: [<span class="number">192.168</span><span class="number">.1</span><span class="number">.200</span>/<span class="number">24</span>]</span><br><span class="line">      nameservers:</span><br><span class="line">        addresses: [<span class="number">202.96</span><span class="number">.128</span><span class="number">.86</span>]</span><br><span class="line">      access-points:</span><br><span class="line">        <span class="string">&quot;NETGEAR25&quot;</span>:</span><br><span class="line">            password: <span class="string">&quot;ceshizhuanyong&quot;</span></span><br><span class="line">      routes:</span><br><span class="line">        - to: <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line">          via: <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-6-WIFI-连接：动态-IP¶"><a href="#6-2-6-WIFI-连接：动态-IP¶" class="headerlink" title="6.2.6. WIFI 连接：动态 IP¶"></a>6.2.6. WIFI 连接：动态 IP¶</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">  version: <span class="number">2</span></span><br><span class="line">  renderer: networkd</span><br><span class="line">  wifis:</span><br><span class="line">    wlan0:</span><br><span class="line">      dhcp4: yes</span><br><span class="line">      access-points:</span><br><span class="line">        <span class="string">&quot;NETGEAR25&quot;</span>:</span><br><span class="line">            password: <span class="string">&quot;ceshizhuanyong&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="6-3-使用-nmcli-管理网络¶"><a href="#6-3-使用-nmcli-管理网络¶" class="headerlink" title="6.3. 使用 nmcli 管理网络¶"></a>6.3. 使用 nmcli 管理网络¶</h2><p>nmcli 是用来管理 NetworkManager 网络连接的命令行工具</p>
<h3 id="6-3-1-常用命令¶"><a href="#6-3-1-常用命令¶" class="headerlink" title="6.3.1. 常用命令¶"></a>6.3.1. 常用命令¶</h3><ul>
<li>显示所有连接</li>
<li>显示连接信息</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection show connection_name</span><br></pre></td></tr></table></figure>

<ul>
<li>显示网络设备列表、其状态以及使用该设备的连接</li>
<li>激活连接</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection up connection_name</span><br></pre></td></tr></table></figure>

<ul>
<li>取消激活连接</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection down connection_name</span><br></pre></td></tr></table></figure>

<ul>
<li>删除连接</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection del connection_name</span><br></pre></td></tr></table></figure>

<h3 id="6-3-2-以太网连接：静态-IP¶"><a href="#6-3-2-以太网连接：静态-IP¶" class="headerlink" title="6.3.2. 以太网连接：静态 IP¶"></a>6.3.2. 以太网连接：静态 IP¶</h3><p>假设进行配置以太网网卡为 eth0，IP 为 192.168.1.10&#x2F;24，默认网关为 192.168.1.1，DNS 服务器为 202.96.128.86</p>
<ol>
<li>为以太网连接添加新的连接</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add con-name Example-Connection ifname eth0 type ethernet</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>设置 IPv4 地址</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify Example-Connection ipv4.addresses <span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>将 IPv4 连接方法设置为 <code>manual</code></li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify Example-Connection ipv4.method manual</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>设置 IPv4 默认网关</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify Example-Connection ipv4.gateway <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>设置 IPv4 DNS 服务器地址</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify Example-Connection ipv4.dns <span class="string">&quot;202.96.128.86&quot;</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>激活连接</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection up Example-Connection</span><br></pre></td></tr></table></figure>

<h3 id="6-3-3-以太网连接：动态-IP¶"><a href="#6-3-3-以太网连接：动态-IP¶" class="headerlink" title="6.3.3. 以太网连接：动态 IP¶"></a>6.3.3. 以太网连接：动态 IP¶</h3><ol>
<li>为以太网连接添加新的连接</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add con-name Example-Connection ifname eth0 type ethernet</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>激活连接</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection up Example-Connection</span><br></pre></td></tr></table></figure>

<h3 id="6-3-4-WIFI-连接：动态-IP¶"><a href="#6-3-4-WIFI-连接：动态-IP¶" class="headerlink" title="6.3.4. WIFI 连接：动态 IP¶"></a>6.3.4. WIFI 连接：动态 IP¶</h3><ol>
<li>确保 WiFi 被启用（默认）</li>
<li>刷新可用的 Wi-Fi 连接列表：</li>
<li>查看可用的 Wi-Fi 接入点：</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nmcli dev wifi list</span><br><span class="line"></span><br><span class="line">IN-USE  SSID      MODE   CHAN  RATE        SIGNAL  BARS  SECURITY</span><br><span class="line">...</span><br><span class="line">        MyCafe    Infra  <span class="number">3</span>     <span class="number">405</span> Mbit/s  <span class="number">85</span>      ▂▄▆█  WPA1 WPA2</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用 <strong>nmcli</strong> 连接到 Wi-Fi 连接：</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli dev wifi connect SSID-Name password wireless-password</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli dev wifi connect MyCafe password wireless-password</span><br></pre></td></tr></table></figure>

<p>请注意，如果要禁用 Wi-Fi 状态：</p>
<h2 id="6-4-快速创建无线-AP-热点¶"><a href="#6-4-快速创建无线-AP-热点¶" class="headerlink" title="6.4. 快速创建无线 AP 热点¶"></a>6.4. 快速创建无线 AP 热点¶</h2><h3 id="6-4-1-对无线热点的-IP-局域网段无要求¶"><a href="#6-4-1-对无线热点的-IP-局域网段无要求¶" class="headerlink" title="6.4.1. 对无线热点的 IP 局域网段无要求¶"></a>6.4.1. 对无线热点的 IP 局域网段无要求¶</h3><p>在这种情况下，只需要使用 nmcli 命令创建一个无线 AP 热点即可：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli device wifi hotspot ifname wlan0 con-name MyHostspot ssid MyHostspotSSID password <span class="number">12345678</span></span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>con-name：连接名称：这里设置为 MyHostspot（可自定义）</li>
<li>ssid：创建的 AP 热点的名称：这里设置为 MyHostspotSSID（可自定义）</li>
<li>password：创建的 AP 热点的密码：这里设置为 12345678（可自定义）</li>
</ul>
<h3 id="6-4-2-对无线热点的-IP-局域网段有要求¶"><a href="#6-4-2-对无线热点的-IP-局域网段有要求¶" class="headerlink" title="6.4.2. 对无线热点的 IP 局域网段有要求¶"></a>6.4.2. 对无线热点的 IP 局域网段有要求¶</h3><p>请阅读章节《创建桥接无线 AP》</p>
<h2 id="6-5-创建桥接无线-AP-热点¶"><a href="#6-5-创建桥接无线-AP-热点¶" class="headerlink" title="6.5. 创建桥接无线 AP 热点¶"></a>6.5. 创建桥接无线 AP 热点¶</h2><h3 id="6-5-1-功能需求¶"><a href="#6-5-1-功能需求¶" class="headerlink" title="6.5.1. 功能需求¶"></a>6.5.1. 功能需求¶</h3><p>假设有一局域网，网段为 <code>10.10.0.0</code>，掩码为 <code>255.255.255.0</code>。Firefly 的开发板，以下简称 <code>Firefly Board</code>，其网口通过路由器 <code>Router</code>，获取到本局域网内的动态 IP 地址：为 <code>10.10.0.2</code>。</p>
<p>需求：将系统配置成软路由，具体要求如下：</p>
<p>（1）<code>Firefly Board</code> 开启一个无线 AP 热点，平板和手机等外设通过该无线 AP 热点访问网络，进行上网。</p>
<p>（2）<code>Firefly Board</code> 开启的无线热点局域网为：<code>192.168.4.1</code></p>
<p>（3）<code>Firefly Board</code> 如果有多个网口，要求 <code>eth0</code> 作为 <code>WAN</code> 口功能，自动从路由器获取 IP 地址，<code>eth1</code> 作为 <code>LAN</code> 口功能，能够为接入的设备分配 <code>192.168.4.0/24</code> 网段的 IP 地址。</p>
<p>网络拓扑如下：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/wifi-bridge-topology.png" alt="_images/wifi-bridge-topology.png"></p>
<h3 id="6-5-2-安装管理-AP-热点必要的软件包¶"><a href="#6-5-2-安装管理-AP-热点必要的软件包¶" class="headerlink" title="6.5.2. 安装管理 AP 热点必要的软件包¶"></a>6.5.2. 安装管理 AP 热点必要的软件包¶</h3><p>安装 <code>hostapd</code>：<code>hostapd</code> 可以用来模拟软 AP，所以是实现该功能必须的：</p>
<p>允许 <code>hostapd</code> 开机启动，这样重启之后无线 AP 热点会自动打开</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl unmask hostapd</span><br><span class="line">systemctl enable hostapd</span><br></pre></td></tr></table></figure>

<p>安装 <code>isc-dhcp-server</code>：<code>isc-dhcp-server</code> 用于为接入无线 AP 的设备自动分配 IP 地址和 DNS 服务器地址</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install isc-dhcp-server </span><br></pre></td></tr></table></figure>

<p>允许 <code>isc-dhcp-server</code> 开启启动</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable isc-dhcp-server </span><br></pre></td></tr></table></figure>

<p>安装 <code>netfilter-persistent iptables-persistent</code>：用于保存防火墙规则</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install netfilter-persistent iptables-persistent</span><br></pre></td></tr></table></figure>

<p>安装 <code>bridge-utils</code>：用于创建虚拟网桥</p>
<h3 id="6-5-3-配置-Netplan¶"><a href="#6-5-3-配置-Netplan¶" class="headerlink" title="6.5.3. 配置 Netplan¶"></a>6.5.3. 配置 Netplan¶</h3><p>目的是创建网桥 <code>br0</code>，网桥 IP 为 <code>192.168.4.1</code>。允许系统 <code>eth0</code> 网卡分配 IP 地址，禁止系统为 <code>eth1</code> 网卡分配 IP 地址，将 eth1 网卡绑定到网桥 <code>br0</code>。</p>
<p>假设 <code>netplan</code> 的配置文件为：<code>/etc/netplan/netplan.yaml</code>，内容如下所示：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">        version: <span class="number">2</span></span><br><span class="line">        renderer: networkd</span><br><span class="line">        ethernets:</span><br><span class="line">                eth0:</span><br><span class="line">                        dhcp4: yes</span><br><span class="line">                eth1:</span><br><span class="line">                        dhcp4: no</span><br><span class="line"></span><br><span class="line">        bridges:</span><br><span class="line">                br0:</span><br><span class="line">                        dhcp4: no</span><br><span class="line">                        addresses:</span><br><span class="line">                                - <span class="number">192.168</span><span class="number">.4</span><span class="number">.1</span>/<span class="number">24</span></span><br><span class="line">                        interfaces:</span><br><span class="line">                                - eth1</span><br></pre></td></tr></table></figure>

<p>接着运行如下命令启用网络配置：</p>
<h3 id="6-5-4-配置-hostapd¶"><a href="#6-5-4-配置-hostapd¶" class="headerlink" title="6.5.4. 配置 hostapd¶"></a>6.5.4. 配置 hostapd¶</h3><p>创建一个 <code>hostapd.conf</code> 配置文件，用来设置无线热点的名称，密码，信道等属性</p>
<p>在其中写入如下内容：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">country_code=CN</span><br><span class="line">interface=wlan0</span><br><span class="line">bridge=br0</span><br><span class="line">ssid=Example-Wifi-Name</span><br><span class="line">hw_mode=g</span><br><span class="line">channel=<span class="number">11</span></span><br><span class="line">macaddr_acl=<span class="number">0</span></span><br><span class="line">auth_algs=<span class="number">1</span></span><br><span class="line">ignore_broadcast_ssid=<span class="number">0</span></span><br><span class="line">wpa=<span class="number">2</span></span><br><span class="line">wpa_passphrase=<span class="number">12345678</span></span><br><span class="line">wpa_key_mgmt=WPA-PSK</span><br><span class="line">wpa_pairwise=TKIP</span><br><span class="line">rsn_pairwise=CCMP</span><br></pre></td></tr></table></figure>

<p>重要参数说明：</p>
<ul>
<li><code>country_code</code>：国家码，中国使用 CN</li>
<li><code>interface</code>：开启无线 AP 热点的无线网卡</li>
<li><code>bridge</code>：绑定到 <code>br0</code> 网桥，使得无线 AP 热点和以太网口在同一个局域网内</li>
<li><code>hw_mode</code>：设置无线模式</li>
<li><code>channel</code>：信道</li>
<li><code>ssid</code>：无线 AP 名称，这里设置 <code>Example-Wifi-Name</code></li>
<li><code>wpa_passphrase</code>：无线 AP 密码，这里设置为 <code>12345678</code></li>
</ul>
<p>关于更多，<code>hostapd.conf</code> 的配置无疑是非常复杂的，<code>hw_mode</code> 支持的模式有 <code>a，g</code>，<code>channel</code> 信道与 <code>hw_mode</code>，<code>country_code</code> 等都有关系，这里不再展开。如果需要对这些无线参数进行更自动化且紧密的配置，可以使用 <code>OpenWRT</code> 软路由系统来代替 <code>Ubuntu</code> 系统。</p>
<p>接下来，需要配置 <code>hostapd</code> 的全局配置文件</p>
<p>取消 <code>DAEMON_CONF</code> 的注释，设置它的值为上面创建的 <code>/etc/hostapd.conf</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># Defaults <span class="keyword">for</span> hostapd initscript</span><br><span class="line"># </span><br><span class="line"># See /usr/share/doc/hostapd/README.Debian <span class="keyword">for</span> information about alternative</span><br><span class="line"><span class="meta"># methods of managing hostapd.</span></span><br><span class="line">#</span><br><span class="line"># Uncomment <span class="keyword">and</span> set DAEMON_CONF to the absolute path of a hostapd configuration</span><br><span class="line"><span class="meta"># file and hostapd will be started during system boot. An example configuration</span></span><br><span class="line"><span class="meta"># file can be found at /usr/share/doc/hostapd/examples/hostapd.conf.gz</span></span><br><span class="line">#</span><br><span class="line">DAEMON_CONF=<span class="string">&quot;/etc/hostapd.conf&quot;</span></span><br><span class="line"></span><br><span class="line"># Additional daemon options to be appended to hostapd command:-</span><br><span class="line">#       -d   show more debug <span class="built_in">messages</span> (-dd <span class="keyword">for</span> even more)</span><br><span class="line">#       -K   include key data in debug messages</span><br><span class="line">#       -t   include timestamps in some debug messages</span><br><span class="line">#</span><br><span class="line"># Note that -<span class="built_in">B</span> (daemon mode) <span class="keyword">and</span> -<span class="built_in">P</span> (pidfile) options are automatically</span><br><span class="line"><span class="meta"># configured by the init.d script and must not be added to DAEMON_OPTS.</span></span><br><span class="line">#</span><br><span class="line">#DAEMON_OPTS=<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>重启 <code>hostapd</code> 服务</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart hostapd</span><br></pre></td></tr></table></figure>

<p>到此，已经可以通过手机等设备，查看到有一个无线 AP 热点开启，名称为“<code>Example-Wifi-Name</code>”，但是连接之后无法为设备分配 IP 地址，设备会立即断开。</p>
<h3 id="6-5-5-配置-isc-dhcp-server¶"><a href="#6-5-5-配置-isc-dhcp-server¶" class="headerlink" title="6.5.5. 配置 isc-dhcp-server¶"></a>6.5.5. 配置 isc-dhcp-server¶</h3><p><code>isc-dhcp-server</code> 作为一个 <code>dhcp</code> 服务器，为接入无线 AP 节点的设备，比如拓扑图中的 <code>Laptop1</code> 和 <code>Laptop2</code> 自动分配 IP 地址和 DNS 服务器地址。</p>
<p>编辑 <code>/etc/dhcp/dhcpd.conf</code>，</p>
<p>用如下内容进行替换：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 为设备指定DNS地址，多个DNS使用<span class="string">&quot;,&quot;</span>隔开</span><br><span class="line">option domain-name-servers <span class="number">202.96</span><span class="number">.128</span><span class="number">.86</span>,<span class="number">202.96</span><span class="number">.128</span><span class="number">.166</span>,<span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span>,<span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span>;</span><br><span class="line"><span class="keyword">default</span>-lease-time <span class="number">600</span>;</span><br><span class="line">max-lease-time <span class="number">7200</span>;</span><br><span class="line">ddns-update-style none; ddns-updates off;</span><br><span class="line"></span><br><span class="line">subnet <span class="number">192.168</span><span class="number">.4</span><span class="number">.0</span> netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> &#123;</span><br><span class="line">    range <span class="number">192.168</span><span class="number">.4</span><span class="number">.2</span> <span class="number">192.168</span><span class="number">.4</span><span class="number">.200</span>;</span><br><span class="line">    option routers <span class="number">192.168</span><span class="number">.4</span><span class="number">.1</span>;</span><br><span class="line">    option broadcast-address <span class="number">192.168</span><span class="number">.4</span><span class="number">.255</span>;</span><br><span class="line">    option subnet-mask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重要参数说明：</p>
<ul>
<li><code>domain-name-servers</code>：DNS 服务器地址列表，为接入 <code>192.168.4.0/24</code> 网段的设备，分配 <code>DNS</code></li>
<li><code>subnet 192.168.4.0 netmask 255.255.255.0</code>：定义子网网段 <code>192.168.4.0/24</code></li>
<li><code>range 192.168.4.2 192.168.4.200</code>：分配的 IP 地址范围</li>
<li><code>option routers 192.168.4.1</code>：默认路由</li>
<li><code>option broadcast-address 192.168.4.255</code>：广播地址</li>
<li><code>option subnet-mask 255.255.255.0</code>：子网掩码</li>
</ul>
<p>重启 <code>isc-dhcp-server</code>，让配置生效：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart isc-dhcp-server</span><br></pre></td></tr></table></figure>

<h3 id="6-5-6-开启-IP-转发¶"><a href="#6-5-6-开启-IP-转发¶" class="headerlink" title="6.5.6. 开启 IP 转发¶"></a>6.5.6. 开启 IP 转发¶</h3><p>经过如上内容的配置，接入 <code>eth1</code> 的设备，和连接入无线 AP 热点的设备，都能获取到 <code>192.168.4.0/24</code> 网段的 IP，且都能 ping 通 <code>192.168.4.1</code>，也可以查看到设备获取到的 <code>DNS</code> 服务器地址。但是设备还无法访问 internet。</p>
<p>开启 IP 转发</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.ipv4.ip_forward=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>设置 <code>MASQUERADE</code>（地址欺骗）。<code>MASQUERADE</code> 与 <code>SNAT</code> 作用大致一样，<code>MASQUERADE</code> 不用指定明确的 IP，会动态的将报文的源地址修改为指定网卡上可用的 IP 地址。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<p>注意，这里指定为 <code>eth0</code>，让 <code>Firefly Board</code> 所有的 IP 包全部转发到 <code>eth0</code>，让外设能够进行上网，这里也可以指定为任何能访问外网的网卡，比如 4G 网卡 <code>usb0</code>，<code>wwan0</code>，举一反三。</p>
<p>现在保存 <code>IPv4</code>（包括上面的规则）和 <code>IPv6</code> 的当前防火墙规则，以便在启动时由 <code>netfilter-persistent</code> 服务加载：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netfilter-persistent save</span><br></pre></td></tr></table></figure>

<h2 id="6-6-使用-ip-和-netplan-配置-IP-地址和路由¶"><a href="#6-6-使用-ip-和-netplan-配置-IP-地址和路由¶" class="headerlink" title="6.6. 使用 ip 和 netplan 配置 IP 地址和路由¶"></a>6.6. 使用 ip 和 netplan 配置 IP 地址和路由¶</h2><h3 id="6-6-1-静态-IP-地址配置¶"><a href="#6-6-1-静态-IP-地址配置¶" class="headerlink" title="6.6.1. 静态 IP 地址配置¶"></a>6.6.1. 静态 IP 地址配置¶</h3><p>一个网口接口上可以同时配置多个 IP 地址，这些 IP 地址可以属于同一网络，也可以不属于同一网络。第一个配置的 IP 地址默认为接口的主 IP 地址，后面配置的 IP 地址为接口的从 IP 地址。</p>
<h4 id="6-6-1-1-常用的-IP-配置命令：¶"><a href="#6-6-1-1-常用的-IP-配置命令：¶" class="headerlink" title="6.6.1.1. 常用的 IP 配置命令：¶"></a>6.6.1.1. 常用的 IP 配置命令：¶</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置接口的 IP 地址</span></span><br><span class="line">ip address add PREFIX [ broadcast ADDR ] dev IFNAME</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除接口的 IP 地址</span></span><br><span class="line">ip address del PREFIX dev IFNAME</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看接口的 IP 地址</span></span><br><span class="line">ip address show/list [ dev IFNAME ]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清空接口的所有 IP 地址</span></span><br><span class="line">ip address flush [ dev IFNAME ]</span><br></pre></td></tr></table></figure>

<h4 id="6-6-1-2-配置举例：¶"><a href="#6-6-1-2-配置举例：¶" class="headerlink" title="6.6.1.2. 配置举例：¶"></a>6.6.1.2. 配置举例：¶</h4><p>为 eth0 接口配置主 IP：192.168.2.2，从 IP：192.168.2.3</p>
<ul>
<li>临时配置</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip address add <span class="number">192.168</span><span class="number">.2</span><span class="number">.2</span>/<span class="number">24</span> dev eth0</span><br><span class="line">ip address add <span class="number">192.168</span><span class="number">.2</span><span class="number">.3</span>/<span class="number">24</span> dev eth0</span><br></pre></td></tr></table></figure>

<ul>
<li>持久化配置：使用 Netplan</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">  version: <span class="number">2</span></span><br><span class="line">  renderer: networkd</span><br><span class="line">  ethernets:</span><br><span class="line">    eth0:</span><br><span class="line">      dhcp4: no</span><br><span class="line">      addresses:</span><br><span class="line">          - <span class="number">192.168</span><span class="number">.2</span><span class="number">.2</span>/<span class="number">24</span></span><br><span class="line">          - <span class="number">192.168</span><span class="number">.2</span><span class="number">.3</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>

<h3 id="6-6-2-动态-IP-地址配置¶"><a href="#6-6-2-动态-IP-地址配置¶" class="headerlink" title="6.6.2. 动态 IP 地址配置¶"></a>6.6.2. 动态 IP 地址配置¶</h3><p>操作系统一般都会为网络接口自动分配 IP 地址。对于 buildroot 系统中，dhcpcd 服务会发送 dhcp 请求到 DHCP 服务器（这里的 DHCP 服务器大概率是你的路由）请求接口的 IP 地址。而在 Ubuntu 系统中，会由 NetworkManager 来完成这一过程。</p>
<ul>
<li>临时配置</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">udhcpc -i eth0/eth1</span><br><span class="line"></span><br><span class="line"># 或者</span><br><span class="line">dhclient eth0/eth1</span><br></pre></td></tr></table></figure>

<ul>
<li>持久化配置：使用 netplan</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">  version: <span class="number">2</span></span><br><span class="line">  renderer: networkd</span><br><span class="line">  ethernets:</span><br><span class="line">    eth0:</span><br><span class="line">      dhcp4: yes</span><br></pre></td></tr></table></figure>

<h3 id="6-6-3-静态路由配置¶"><a href="#6-6-3-静态路由配置¶" class="headerlink" title="6.6.3. 静态路由配置¶"></a>6.6.3. 静态路由配置¶</h3><p>与静态路由相对的是动态路由，动态路由有 OSPF 和 RIP，这两个协议只存在于路由器中。对于非路由器设备，如果某个目的网段无法直接到达，需要配置静态路由，告诉设备目的网段，出接口，下一跳的 IP 地址。</p>
<h4 id="6-6-3-1-常用的配置命令：¶"><a href="#6-6-3-1-常用的配置命令：¶" class="headerlink" title="6.6.3.1. 常用的配置命令：¶"></a>6.6.3.1. 常用的配置命令：¶</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 查看路由表</span><br><span class="line">route -n </span><br><span class="line"># 或者</span><br><span class="line">netstat -rn</span><br><span class="line"></span><br><span class="line"># 添加 IP 静态路由</span><br><span class="line">ip route add PREFIX via ADDRESS dev IFNAME [ metric METRIC ]</span><br><span class="line"></span><br><span class="line"># 删除 IP 静态路由</span><br><span class="line">ip route del PREFIX via ADDRESS dev IFNAME [ metric METRIC ]</span><br><span class="line"></span><br><span class="line"># 清空 IP 路由</span><br><span class="line">ip route flush dev IFNAME</span><br></pre></td></tr></table></figure>

<h4 id="6-6-3-2-配置举例：¶"><a href="#6-6-3-2-配置举例：¶" class="headerlink" title="6.6.3.2. 配置举例：¶"></a>6.6.3.2. 配置举例：¶</h4><p>假设存在这样的一个网络拓扑，图中的 Router1 和 Router2 是我们的开发板设备，运行的系统是 Ubuntu 操作系统。在这个网络中，对于 Router1，网段 192.168.2.0&#x2F;24 和网段 192.168.3.0&#x2F;24，它们对于 Router1 属于直连网段，意味着对于 PC-A 来说，访问网段 192.168.2.0&#x2F;24 和网段 192.168.3.0&#x2F;24 是没有问题的，但是却不能访问网段 192.168.4.0&#x2F;24。这是因为对于网段 192.168.4.0&#x2F;24，对 Router1 来说是不可见的。需要在 Router1 配置静态路由，这条静态路由表明到目的网段 192.168.4.0&#x2F;24，需要经过下一条 IP 地址为 192.168.3.2&#x2F;24，出接口为 Router1 的 eth1。同样的，对于 Router2 来说，网段 192.168.3.0&#x2F;24 和网段 192.168.4.0&#x2F;24 属于直连网段，PC-B 也同样无法访问 192.168.2.0&#x2F;24 网段，需要在 Router2 配置一条静态路由，表明到目的网络 192.168.2.0&#x2F;24，需要经过下一跳 IP 地址为 192.168.3.1&#x2F;24，出接口为为 Router2 的 eth1。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/router1-20220629170401-d8fx48i.png" alt="_images/router1-20220629170401-d8fx48i.png"></p>
<ul>
<li><p>临时配置</p>
</li>
<li><p>对于 Router1：</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 开启IP转发功能</span><br><span class="line">echo <span class="number">1</span> &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"></span><br><span class="line"># 设置eth0, eth1的IP地址</span><br><span class="line">ip addr add <span class="number">192.168</span><span class="number">.2</span><span class="number">.1</span>/<span class="number">24</span> dev eth0</span><br><span class="line">ip addr add <span class="number">192.168</span><span class="number">.3</span><span class="number">.1</span>/<span class="number">24</span> dev eth1</span><br><span class="line"></span><br><span class="line"># 配置静态路由</span><br><span class="line">ip route add <span class="number">192.168</span><span class="number">.4</span><span class="number">.0</span>/<span class="number">24</span> via <span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span> dev eth1</span><br></pre></td></tr></table></figure>

<ul>
<li>对于 Router2：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 开启IP转发功能</span><br><span class="line">echo <span class="number">1</span> &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"></span><br><span class="line"># 设置eth0, eth1的IP地址</span><br><span class="line">ip addr add <span class="number">192.168</span><span class="number">.4</span><span class="number">.1</span>/<span class="number">24</span> dev eth0</span><br><span class="line">ip addr add <span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>/<span class="number">24</span> dev eth1</span><br><span class="line"></span><br><span class="line"># 配置静态路由</span><br><span class="line">ip route add <span class="number">192.168</span><span class="number">.2</span><span class="number">.0</span>/<span class="number">24</span> via <span class="number">192.168</span><span class="number">.3</span><span class="number">.1</span> dev eth1</span><br></pre></td></tr></table></figure>

<ul>
<li><p>持久化配置</p>
</li>
<li><p>对 Router1 和 Router2，执行以下命令永久开启 IP 转发</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.ipv4.ip_forward=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<ul>
<li>对于 Router1，配置 Netplan</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">        version: <span class="number">2</span></span><br><span class="line">        renderer: networkd</span><br><span class="line">        ethernets:</span><br><span class="line">                eth0:</span><br><span class="line">                        addresses:</span><br><span class="line">                                - <span class="number">192.168</span><span class="number">.2</span><span class="number">.1</span>/<span class="number">24</span></span><br><span class="line">                eth1:</span><br><span class="line">                        addresses:</span><br><span class="line">                                - <span class="number">192.168</span><span class="number">.3</span><span class="number">.1</span>/<span class="number">24</span></span><br><span class="line">                        routes:</span><br><span class="line">                                - to: <span class="number">192.168</span><span class="number">.4</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line">                                  via: <span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>

<ul>
<li>对于 Router2，配置 Netplan</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">        version: <span class="number">2</span></span><br><span class="line">        renderer: networkd</span><br><span class="line">        ethernets:</span><br><span class="line">                eth0:</span><br><span class="line">                        addresses:</span><br><span class="line">                                - <span class="number">192.168</span><span class="number">.4</span><span class="number">.1</span>/<span class="number">24</span></span><br><span class="line">                eth1:</span><br><span class="line">                        addresses:</span><br><span class="line">                                - <span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>/<span class="number">24</span></span><br><span class="line">                        routes:</span><br><span class="line">                                - to: <span class="number">192.168</span><span class="number">.2</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line">                                  via: <span class="number">192.168</span><span class="number">.3</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<h3 id="6-6-4-默认路由配置¶"><a href="#6-6-4-默认路由配置¶" class="headerlink" title="6.6.4. 默认路由配置¶"></a>6.6.4. 默认路由配置¶</h3><ul>
<li>临时配置</li>
</ul>
<p>对于通过 DCHP 服务动态获取 IP 地址的接口，操作系统会自动为其分配一条默认路由。对于静态 IP 地址配置，需要手动为其设置默认路由。</p>
<p>还是以上面的例子来讲解，假设 PC-A 是一个 Linux 操作系统，我们需要进行如下配置：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 配置网卡 IP，假设其网卡为eth0</span><br><span class="line">ip addr add <span class="number">192.168</span><span class="number">.2</span><span class="number">.2</span>/<span class="number">24</span> dev eth0</span><br><span class="line"></span><br><span class="line"># 配置默认路由</span><br><span class="line">ip route add <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span> via <span class="number">192.168</span><span class="number">.2</span><span class="number">.1</span> dev eth0</span><br></pre></td></tr></table></figure>

<ul>
<li>持久化配置：使用 Netplan</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">        version: <span class="number">2</span></span><br><span class="line">        renderer: networkd</span><br><span class="line">        ethernets:</span><br><span class="line">                eth0:</span><br><span class="line">                        addresses:</span><br><span class="line">                                - <span class="number">192.168</span><span class="number">.2</span><span class="number">.2</span>/<span class="number">24</span></span><br><span class="line">                        routes:</span><br><span class="line">                                - to: <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line">                                  via: <span class="number">192.168</span><span class="number">.2</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<h3 id="6-6-5-调整默认路由顺序¶"><a href="#6-6-5-调整默认路由顺序¶" class="headerlink" title="6.6.5. 调整默认路由顺序¶"></a>6.6.5. 调整默认路由顺序¶</h3><p>在双网口的开发板中，如果两个网口的 IP 地址是通过 DHCP 自动获取的，那么操作系统会生成两条默认路由，每个网口分别有一条默认路由，先插入网线的网口或者先获得 IP 的网口，会获得更高的路由优先级。如下所示，有两条默认路由，eth0 网卡的默认路由优先级高于 eth1。这就意味着开发板默认通信的时候，使用的是 eth0 网卡。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@firefly:~<span class="meta"># ip route list</span></span><br><span class="line"><span class="keyword">default</span> via <span class="number">168.168</span><span class="number">.0</span><span class="number">.1</span> dev eth0 proto dhcp metric <span class="number">100</span> </span><br><span class="line"><span class="keyword">default</span> via <span class="number">168.168</span><span class="number">.0</span><span class="number">.1</span> dev eth1 proto dhcp metric <span class="number">101</span> </span><br><span class="line"><span class="number">168.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> dev eth0 proto kernel scope link src <span class="number">168.168</span><span class="number">.110</span><span class="number">.72</span> metric <span class="number">100</span> </span><br><span class="line"><span class="number">168.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> dev eth1 proto kernel scope link src <span class="number">168.168</span><span class="number">.110</span><span class="number">.111</span> metric <span class="number">101</span></span><br></pre></td></tr></table></figure>

<h4 id="6-6-5-1-配置举例：¶"><a href="#6-6-5-1-配置举例：¶" class="headerlink" title="6.6.5.1. 配置举例：¶"></a>6.6.5.1. 配置举例：¶</h4><p>假设存在一种情况，Wireless Router1 的网段为 192.168.3.0&#x2F;24，Wireless Router2 的网段为 192.168.2.0&#x2F;24，此时对于 Firefly Board 来说，eth0 和 eth1 都是动态获取 IP 地址，如果 eth0 的默认路由的优先级比 eth1 的默认路由优先级高，通信时将使用 eth0 的默认路由，由于 eth0 所在网络无外网连接，Firefly Board 就无法访问 Internet，此时可以通过修改默认路由的优先级来解决。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/router2-20220630162119-lgcya9l.png" alt="_images/router2-20220630162119-lgcya9l.png"></p>
<p>其 Netplan 配置如下，eth1 的 metric 数值小于 eth0，数值越小优先级越高</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">        version: <span class="number">2</span></span><br><span class="line">        ethernets:</span><br><span class="line">                eth0:</span><br><span class="line">                        dhcp4: yes</span><br><span class="line">                        dhcp4-overrides:</span><br><span class="line">                                route-metric: <span class="number">200</span></span><br><span class="line">                eth1:</span><br><span class="line">                        dhcp4: yes</span><br><span class="line">                        dhcp4-overrides:</span><br><span class="line">                                route-metric: <span class="number">100</span></span><br></pre></td></tr></table></figure>

<h2 id="6-7-iptables-NAT-配置¶"><a href="#6-7-iptables-NAT-配置¶" class="headerlink" title="6.7. iptables NAT 配置¶"></a>6.7. iptables NAT 配置¶</h2><p>网络转换技术也称为 NAT（Network Address Translation）技术，它的基本作用就是实现私有 IP 地址和公有 IP 地址之间的转换。</p>
<p>在 Linux 系统中，NAT 可以细化为 SNAT（Source Network Address Translation）和 DNAT（Destinationnetwork address translation）。SNAT 也称为源地址转换技术，用于当私网主机向外网主机发起网络通信时，IP 数据包在到达外网网络之前，将 IP 数据包中的源 IP 修改为路由器或者防火墙的 IP 地址，这样外网主机就无法获知内网主机的私网 IP 地址。DNAT 也称为目标地址转换技术，用于当外网主机需要访问内网主机提供的网络服务时，比如 http，IP 数据包到达路由器或者防火墙时，由它们将 IP 数据包中的目标 IP 改为提供网络服务的私网主机 IP。</p>
<h3 id="6-7-1-常用命令¶"><a href="#6-7-1-常用命令¶" class="headerlink" title="6.7.1. 常用命令¶"></a>6.7.1. 常用命令¶</h3><p>我们可以通过配置 iptables 的 nat 表，来实现 SNAT 和 DNAT</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 查看nat规则</span><br><span class="line">iptables -t nat -vnL</span><br><span class="line"></span><br><span class="line"># 清空nat规则</span><br><span class="line">iptables -t nat -F</span><br><span class="line"></span><br><span class="line"># 添加一个SNAT规则，将内网的IP，映射到外网的IP</span><br><span class="line">iptables -t nat -A POSTROUTING -s LocalIP -j SNAT --to-source ExtIP</span><br><span class="line"></span><br><span class="line"># 添加一个DNAT规则，将外网的IP和端口，映射到内网的IP和端口</span><br><span class="line">iptables -t nat -A PREROUTING -d ExtIP -p tcp|udp --dport PORT -j DNAT --to-destination LocalIP[:PORT]</span><br></pre></td></tr></table></figure>

<p>iptables 也支持 MASQUERADE（地址欺骗），它的作用与 SNAT 基本相同，也可以起到源地址转换的作用。在一种特殊情况中，如果外网的 IP 地址不是一个固定且长期有效的 IP 地址，比如是通过 pppoe 进行拨号动态获取的 IP 地址，就可以使用 MASQUERADE 来实现源地址转换。MASQUERADE 则不用指定明确的 IP，会动态的将报文的源地址修改为指定网卡上可用的 IP 地址。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 添加一个MASQUERADE规则，将内网的IP，映射到外网网卡所在的IP（这里的内网IP可以省略，则默认将所有内网的IP，都映射到外网网卡所在的IP）</span><br><span class="line">iptables -t nat -A POSTROUTING [-s LocalIP] -o IFNAME -j MASQUERADE</span><br></pre></td></tr></table></figure>

<h3 id="6-7-2-配置举例¶"><a href="#6-7-2-配置举例¶" class="headerlink" title="6.7.2. 配置举例¶"></a>6.7.2. 配置举例¶</h3><p>假设存在这样的一个网络拓扑，用 10.1.0.0&#x2F;16 来模拟一个公网网络，用 192.168.1.0&#x2F;24 来模拟私有网络。图中的机器都是用 Linux 主机进行模拟的机器。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/router3-20220705091939-09uw91m.png" alt="_images/router3-20220705091939-09uw91m.png"></p>
<p>对于 Router1，是一个连接内外网的路由器，其 netplan 配置如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">        version: <span class="number">2</span></span><br><span class="line">        renderer: networkd</span><br><span class="line">        ethernets:</span><br><span class="line">                eth0:</span><br><span class="line">                        addresses:</span><br><span class="line">                                - <span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span>/<span class="number">24</span></span><br><span class="line">                eth1:</span><br><span class="line">                        addresses:</span><br><span class="line">                                - <span class="number">10.1</span><span class="number">.0</span><span class="number">.7</span>/<span class="number">16</span></span><br></pre></td></tr></table></figure>

<p>同时对于 Router1，需要开启 IP 转发功能：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="number">1</span> &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure>

<p>对于 Internet PC，是一个外网的个人主机，其 netplan 配置如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">        version: <span class="number">2</span></span><br><span class="line">        renderer: networkd</span><br><span class="line">        ethernets:</span><br><span class="line">                eth0:</span><br><span class="line">                        addresses:</span><br><span class="line">                                - <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span>/<span class="number">16</span></span><br></pre></td></tr></table></figure>

<p>对于 Web Server，是一个私网服务器，提供 http 服务，其 netplan 配置如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">        version: <span class="number">2</span></span><br><span class="line">        renderer: networkd</span><br><span class="line">        ethernets:</span><br><span class="line">                eth0:</span><br><span class="line">                        addresses:</span><br><span class="line">                                - <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span>/<span class="number">24</span></span><br><span class="line">                        routes:</span><br><span class="line">                                - to: <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line">                                  via: <span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>

<h3 id="6-7-3-SNAT¶"><a href="#6-7-3-SNAT¶" class="headerlink" title="6.7.3. SNAT¶"></a>6.7.3. SNAT¶</h3><p>需求：目前的网络结构中，内网主机是无法访问外网的。</p>
<p>添加一条 SNAT 规则，修改内网主机发往外网的 IP 数据包，将源 IP 地址为 192.168.1.0&#x2F;24 网段的 IP，修改为 10.1.0.7</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span> -j SNAT --to-source <span class="number">10.1</span><span class="number">.0</span><span class="number">.7</span></span><br></pre></td></tr></table></figure>

<p>验证方法：</p>
<ul>
<li>在内网的 Web Server，ping 外网的 Internet PC</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~  ping -c <span class="number">4</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span>                                                                                                                                                    ok </span><br><span class="line">PING <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span> (<span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of data.</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span>: icmp_seq=<span class="number">1</span> ttl=<span class="number">63</span> time=<span class="number">2.15</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span>: icmp_seq=<span class="number">2</span> ttl=<span class="number">63</span> time=<span class="number">2.12</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span>: icmp_seq=<span class="number">3</span> ttl=<span class="number">63</span> time=<span class="number">1.99</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span>: icmp_seq=<span class="number">4</span> ttl=<span class="number">63</span> time=<span class="number">2.14</span> ms</span><br><span class="line"></span><br><span class="line">--- <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span> ping statistics ---</span><br><span class="line"><span class="number">4</span> packets transmitted, <span class="number">4</span> received, <span class="number">0</span>% packet loss, time <span class="number">7</span>ms</span><br><span class="line">rtt min/avg/max/mdev = <span class="number">1.989</span>/<span class="number">2.098</span>/<span class="number">2.147</span>/<span class="number">0.063</span> ms</span><br></pre></td></tr></table></figure>

<ul>
<li>在内网的 Web Server，抓包</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@firefly:/<span class="meta"># tcpdump -i eth1 -nn icmp       </span></span><br><span class="line">tcpdump: verbose output suppressed, use -v <span class="keyword">or</span> -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth1, link-<span class="function">type <span class="title">EN10MB</span> <span class="params">(Ethernet)</span>, capture size 262144 bytes</span></span><br><span class="line"><span class="function">03:<span class="number">33</span>:<span class="number">37.503348</span> IP <span class="number">10.1</span><span class="number">.0</span><span class="number">.7</span> &gt; <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span>: ICMP echo request, id <span class="number">53287</span>, seq <span class="number">1</span>, length <span class="number">64</span></span></span><br><span class="line"><span class="function"><span class="number">03</span>:<span class="number">33</span>:<span class="number">37.503603</span> IP <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span> &gt; <span class="number">10.1</span><span class="number">.0</span><span class="number">.7</span>: ICMP echo reply, id <span class="number">53287</span>, seq <span class="number">1</span>, length <span class="number">64</span></span></span><br><span class="line"><span class="function"><span class="number">03</span>:<span class="number">33</span>:<span class="number">38.503348</span> IP <span class="number">10.1</span><span class="number">.0</span><span class="number">.7</span> &gt; <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span>: ICMP echo request, id <span class="number">53287</span>, seq <span class="number">2</span>, length <span class="number">64</span></span></span><br><span class="line"><span class="function"><span class="number">03</span>:<span class="number">33</span>:<span class="number">38.503560</span> IP <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span> &gt; <span class="number">10.1</span><span class="number">.0</span><span class="number">.7</span>: ICMP echo reply, id <span class="number">53287</span>, seq <span class="number">2</span>, length <span class="number">64</span></span></span><br><span class="line"><span class="function"><span class="number">03</span>:<span class="number">33</span>:<span class="number">39.504601</span> IP <span class="number">10.1</span><span class="number">.0</span><span class="number">.7</span> &gt; <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span>: ICMP echo request, id <span class="number">53287</span>, seq <span class="number">3</span>, length <span class="number">64</span></span></span><br><span class="line"><span class="function"><span class="number">03</span>:<span class="number">33</span>:<span class="number">39.504812</span> IP <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span> &gt; <span class="number">10.1</span><span class="number">.0</span><span class="number">.7</span>: ICMP echo reply, id <span class="number">53287</span>, seq <span class="number">3</span>, length <span class="number">64</span></span></span><br><span class="line"><span class="function"><span class="number">03</span>:<span class="number">33</span>:<span class="number">40.505347</span> IP <span class="number">10.1</span><span class="number">.0</span><span class="number">.7</span> &gt; <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span>: ICMP echo request, id <span class="number">53287</span>, seq <span class="number">4</span>, length <span class="number">64</span></span></span><br><span class="line"><span class="function"><span class="number">03</span>:<span class="number">33</span>:<span class="number">40.505557</span> IP <span class="number">10.1</span><span class="number">.0</span><span class="number">.6</span> &gt; <span class="number">10.1</span><span class="number">.0</span><span class="number">.7</span>: ICMP echo reply, id <span class="number">53287</span>, seq <span class="number">4</span>, length <span class="number">64</span></span></span><br></pre></td></tr></table></figure>

<h3 id="6-7-4-DNAT¶"><a href="#6-7-4-DNAT¶" class="headerlink" title="6.7.4. DNAT¶"></a>6.7.4. DNAT¶</h3><p>需求：内网 Web Server 提供 http 服务，外网主机想要访问内网的 web 网页。</p>
<p>添加一条 DNAT 规则，修改外网发往内网的 IP 数据包，将目的 IP 地址，和端口号，修改为内网 Web 服务器的 IP 和端口号。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -d <span class="number">10.1</span><span class="number">.0</span><span class="number">.7</span> -p tcp --dport <span class="number">8000</span> -j DNAT --to-destination <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span>:<span class="number">8000</span></span><br></pre></td></tr></table></figure>

<p>验证方法：</p>
<ul>
<li>在外网 Internet PC 访问内网 Web Server 的 Web 服务</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@firefly:/<span class="meta"># wget http:<span class="comment">//10.1.0.7:8000/index.html</span></span></span><br><span class="line">-<span class="number">-2021</span><span class="number">-02</span><span class="number">-19</span> <span class="number">03</span>:<span class="number">31</span>:<span class="number">12</span>--  http:<span class="comment">//10.1.0.7:8000/index.html</span></span><br><span class="line">Connecting to <span class="number">10.1</span><span class="number">.0</span><span class="number">.7</span>:<span class="number">8000.</span>.. connected.</span><br><span class="line">HTTP request sent, awaiting response... <span class="number">200</span> OK</span><br><span class="line">Length: <span class="number">41323</span> (<span class="number">40</span>K) [text/html]</span><br><span class="line">Saving to: ‘index.html’</span><br><span class="line"></span><br><span class="line">index.html          <span class="number">100</span>%[===================&gt;]  <span class="number">40.35</span>K  --.-KB/s    in <span class="number">0.001</span>s  </span><br><span class="line"></span><br><span class="line"><span class="number">2021</span><span class="number">-02</span><span class="number">-19</span> <span class="number">03</span>:<span class="number">31</span>:<span class="number">12</span> (<span class="number">29.8</span> MB/s) - ‘index.html’ saved [<span class="number">41323</span>/<span class="number">41323</span>]</span><br></pre></td></tr></table></figure>

<h3 id="6-7-5-MASQUERADE¶"><a href="#6-7-5-MASQUERADE¶" class="headerlink" title="6.7.5. MASQUERADE¶"></a>6.7.5. MASQUERADE¶</h3><p>需求：如果连接内外网的 Router1，它的外网网卡只有一个，为 eth1，且 IP 地址动态获取。</p>
<p>解决方法：添加一条 MASQUERADE 规则，将内网 192.168.1.0&#x2F;24 发往外网的 IP 数据包，修改其源 IP 地址为 eth1 网卡的 IP 地址。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span> -o eth1 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<h2 id="6-8-iptables-filter-配置¶"><a href="#6-8-iptables-filter-配置¶" class="headerlink" title="6.8. iptables filter 配置¶"></a>6.8. iptables filter 配置¶</h2><p>iptables 的 filter 表（过滤规则表），用于控制数据包是否允许进出及转发。filter 表可以控制的链路有 INPUT、FORWARD 和 OUTPUT。常用的动作有 ACCEPT，DROP，REJECT。</p>
<h3 id="6-8-1-通用命令¶"><a href="#6-8-1-通用命令¶" class="headerlink" title="6.8.1. 通用命令¶"></a>6.8.1. 通用命令¶</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 清空filter表</span><br><span class="line">iptables -t filter -F</span><br><span class="line"></span><br><span class="line"># 显示filter表</span><br><span class="line">iptables -t filter -nvL</span><br></pre></td></tr></table></figure>

<h3 id="6-8-2-ACCEPT：允许数据包通过¶"><a href="#6-8-2-ACCEPT：允许数据包通过¶" class="headerlink" title="6.8.2. ACCEPT：允许数据包通过¶"></a>6.8.2. ACCEPT：允许数据包通过¶</h3><p>配置举例：默认情况下 ssh 使用 22 端口进行 tcp 通信，如果要开启远程访问，需要开启 22 端口的 tcp 连接。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -t filter -p tcp --dport <span class="number">22</span> -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>开启 ssh 访问，允许 192.168.0.0&#x2F;24 网段进行访问</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -t filter -p tcp -s <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span> --dport <span class="number">22</span> -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>开启 ssh 访问，允许收到的数据包来源于 eth0 网卡</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -t filter -p tcp -i eth0 --dport <span class="number">22</span> -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>开启 ssh 访问，允许 192.168.0.0&#x2F;24 网段中 MAC 地址为 00:50:8D:FD:E6:32 的主机进行访问</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -t filter -p tcp -s <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span> --dport <span class="number">22</span> -m mac --mac-source <span class="number">00</span>:<span class="number">50</span>:<span class="number">8</span>D:FD:E6:<span class="number">32</span> -j ACCEPT</span><br></pre></td></tr></table></figure>

<h3 id="6-8-3-REJECT：拒绝数据包通过¶"><a href="#6-8-3-REJECT：拒绝数据包通过¶" class="headerlink" title="6.8.3. REJECT：拒绝数据包通过¶"></a>6.8.3. REJECT：拒绝数据包通过¶</h3><p>REJECT 动作的常用选项为–reject-with（使用–reject-with 选项，可以设置提示信息，当对方被拒绝时，会提示对方为什么被拒绝）</p>
<p>对于 ICMP 协议，可用值如下，如果不提供，默认为 icmp-port-unreachable</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">icmp-net-unreachable</span><br><span class="line">icmp-host-unreachable</span><br><span class="line">icmp-port-unreachable,</span><br><span class="line">icmp-proto-unreachable</span><br><span class="line">icmp-net-prohibited</span><br><span class="line">icmp-host-pro-hibited</span><br><span class="line">icmp-admin-prohibited</span><br></pre></td></tr></table></figure>

<p>配置举例：拒接外部 ping，并提示”Destination Host Unreachable”</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -t filter -p icmp -j REJECT --reject-with icmp-host-unreachable</span><br></pre></td></tr></table></figure>

<h3 id="6-8-4-DROP：丢弃数据包¶"><a href="#6-8-4-DROP：丢弃数据包¶" class="headerlink" title="6.8.4. DROP：丢弃数据包¶"></a>6.8.4. DROP：丢弃数据包¶</h3><p>配置举例：直接将外部 ping 包丢弃</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -t filter -p icmp -j DROP</span><br></pre></td></tr></table></figure>

<h2 id="7-Qt-支持¶"><a href="#7-Qt-支持¶" class="headerlink" title="7. Qt 支持¶"></a>7. Qt 支持¶</h2><h2 id="7-1-Qt-环境支持¶"><a href="#7-1-Qt-环境支持¶" class="headerlink" title="7.1. Qt 环境支持¶"></a>7.1. Qt 环境支持¶</h2><p>Firefly 设备系统如果是 Ubuntu 22.04 可以直接通过 apt 安装 Qt 环境：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 安装基础环境</span><br><span class="line">apt update</span><br><span class="line">apt install -y qtcreator qtbase5-dev</span><br><span class="line"></span><br><span class="line"># 安装额外组件与开发环境，例如</span><br><span class="line">apt install -y libqt5multimedia5 qtmultimedia5-dev libqt5quick5 qtdeclarative5-dev</span><br></pre></td></tr></table></figure>

<p>安装后直接在设备上进行开发。</p>
<p>Ubuntu 18.04 或者 Ubuntu 20.04 需要借助电脑进行交叉编译，详情请看下一章</p>
<h2 id="7-2-Qt-交叉编译环境支持¶"><a href="#7-2-Qt-交叉编译环境支持¶" class="headerlink" title="7.2. Qt 交叉编译环境支持¶"></a>7.2. Qt 交叉编译环境支持¶</h2><p>Firefly 发布了两个 Qt 交叉编译工具链，适用于以下环境，请根据需求选择:</p>
<ul>
<li>Qt: 5.12.2</li>
<li>Host: x86-64 &#x2F; Ubuntu 18.04</li>
<li>Target: Firefly RK3568 RK3566 RK3399 RK3328 PX30 &#x2F; Ubuntu 18.04 Minimal&amp;Desktop</li>
</ul>
<p>和</p>
<ul>
<li>Qt: 5.15</li>
<li>Host: x86-64 &#x2F; Ubuntu 20.04</li>
<li>Target: Firefly RK3588 RK3568 RK3566 &#x2F; Ubuntu 20.04 Desktop</li>
</ul>
<p>工具链完整支持 wenEngine, 支持 EGLFS LinuxFB XCB 等 backend。</p>
<ul>
<li>下载地址</li>
</ul>
<p>点击 <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1sFzjS0nelCyw0xT9se1KMQ">下载链接</a>(提取码：FFQT)</p>
<ul>
<li>部署</li>
</ul>
<p><strong>详情参见工具链中的 Qt5.1x.x_Release.md 文件</strong></p>
<p><strong>注意，文档中所有路径的名称不可更改，否则会导致编译或者运行出错。</strong></p>
<ul>
<li>编译</li>
</ul>
<p>在 host 端，进入 Qt 工程目录，<code>qmake &amp;&amp; make</code> 即可.</p>
<ul>
<li>运行</li>
</ul>
<p>工具链中含有例程，用户在部署完成后，可以在 host 端 build demo，在 tartget 端运行 demo 以测试部署是否成功。</p>
<p>确定了使用哪个后端，就可以修改设备中 &#x2F;etc&#x2F;profile.d&#x2F;target_qtEnv.sh 文件，去除对应平台环境变量前面的 <code>#</code> 使其一直生效</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 例如，使用 XCB ，则将文件内 XCB 部分前面的 # 删除</span><br><span class="line"></span><br><span class="line">#XCB</span><br><span class="line"><span class="keyword">export</span> QT_QPA_PLATFORM=XCB</span><br><span class="line"><span class="keyword">export</span> QT_QPA_EGLFS_INTEGRATION=XCB_EGL</span><br></pre></td></tr></table></figure>

<h2 id="7-3-Qt-双屏异显¶"><a href="#7-3-Qt-双屏异显¶" class="headerlink" title="7.3. Qt 双屏异显¶"></a>7.3. Qt 双屏异显¶</h2><p>Firefly Ubuntu 系统可以使用 Qt 应用实现双屏显示和操作。</p>
<p>（1）进入桌面环境</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> XAUTHORITY=/home/firefly/.Xauthority</span><br><span class="line"><span class="keyword">export</span> DISPLAY=:<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>（2）设置环境变量</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> QT_QPA_PLATFORM=xcb</span><br><span class="line"><span class="keyword">export</span> QT_QPA_EGLFS_INTEGRATION=XCB_EGL</span><br></pre></td></tr></table></figure>

<p>（3）运行 Demo</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./firefly_arm64_qt5<span class="number">.12</span><span class="number">.2</span>_18<span class="number">.04</span>/demo/double_panel_demo</span><br></pre></td></tr></table></figure>

<p>（4）Demo 代码目录</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firefly_arm64_qt5<span class="number">.12</span><span class="number">.2</span>_18<span class="number">.04</span>/example/double_panel_demo</span><br></pre></td></tr></table></figure>

<p>（5）代码编译</p>
<p>（6）添加自己的 Qt 工程</p>
<ol>
<li>在 <code>example</code> 目录下添加用户自己的 Qt 项目工程。</li>
<li>编辑 <code>example</code> 目录下 <code>gui.pro</code> 文件。</li>
<li>假设工程目录名为 <code>double_panel_demo</code>，则在 <code>gui.pro</code> 文件中追加 <code>SUBDIRS += double_panel_demo</code>。</li>
<li>执行命令 <code>qmake &amp;&amp; make</code>。</li>
</ol>
<p>（7）运行效果</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/double_panel.jpg" alt="_images/double_panel.jpg"></p>
<h2 id="7-4-Qt-Creator¶"><a href="#7-4-Qt-Creator¶" class="headerlink" title="7.4. Qt Creator¶"></a>7.4. Qt Creator¶</h2><p>目标平台的系统是 Ubuntu 22.04 则不用看本章节，直接在设备上使用 qtcreator，无需特殊设置。</p>
<p>其他版本系统需要交叉编译 qt，请继续往下看：</p>
<p>下面介绍主机上 Qt Creator 的使用说明，<strong>在操作前，请先安装、配置好 Qt 交叉编译环境和运行环境</strong>。</p>
<h3 id="7-4-1-安装¶"><a href="#7-4-1-安装¶" class="headerlink" title="7.4.1. 安装¶"></a>7.4.1. 安装¶</h3><p>进入 <a target="_blank" rel="noopener" href="https://download.qt.io/archive/qtcreator/">Qt 官方下载页面</a>，选择一个版本下载 qt-creator-opensource-linux-x86_64-x.x.x.run，下载完成之后，在终端执行 <code>./xxxx.run</code> 运行安装，注意文件需要有执行权限。</p>
<h3 id="7-4-2-配置¶"><a href="#7-4-2-配置¶" class="headerlink" title="7.4.2. 配置¶"></a>7.4.2. 配置¶</h3><p>下面以 firefly-qt-5.12.2-aarch64 环境作为例子进行配置，目标平台是 Buildroot 系统：</p>
<p><strong>目标平台系统不同，配置也稍有不同，所以请仔细查看文字说明，图片仅供参考，不要照搬图片中的配置</strong></p>
<p>安装完成后，启动 Qt Creator，打开菜单 <code>Tools -&gt; Options</code>，找到 Kits。</p>
<ul>
<li>配置 Qt Versions</li>
</ul>
<p>点击右侧 <code>add</code> 按钮添加，选择 Qt 环境安装位置中的 qmake 即可</p>
<p>qmake：<code>/opt/firefly-qt-5.12.2-aarch64/host/bin/qmake</code></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-config-Versions.png" alt="_images/Qt-config-Versions.png"></p>
<ul>
<li>配置 Compilers</li>
</ul>
<p>点击右侧 <code>add</code> 按钮添加 gcc 和 g++ 交叉编译器的位置</p>
<p>如果主机安装了 crossbuild-essential-arm64，则编译器就在 <code>/usr/bin/</code> 下</p>
<p>如果使用了第三方的交叉编译器，找到安装位置并添加即可</p>
<p>如果目标平台是 Buildroot，则需要使用 Buildroot Qt 环境包中的编译器</p>
<p>g++：<code>/opt/firefly-qt-5.12.2-aarch64/host/bin/aarch64-buildroot-linux-gnu-g++</code></p>
<p>gcc：<code>/opt/firefly-qt-5.12.2-aarch64/host/bin/aarch64-buildroot-linux-gnu-gcc</code></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-config-Compilers_1.png" alt="_images/Qt-config-Compilers_1.png"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-config-Compilers_2.png" alt="_images/Qt-config-Compilers_2.png"></p>
<p>为方便调试，配置 Debuggers 和 Devices 用于在线调试：</p>
<ul>
<li>配置 Debuggers</li>
</ul>
<p>首先主机中安装 gdb-multiarch：<code>apt install -y gdb-multiarch</code></p>
<p>检查目标机上是否存在 &#x2F;usr&#x2F;bin&#x2F;gdbserver，没有的话需要安装：<code>apt install -y gdbserver</code> (Buildroot 自带，无需安装)</p>
<p>回到主机的 Qt Creator，点击右侧 <code>add</code> 按钮添加 gdb</p>
<p>选择主机中的 gdb-multiarch ：<code>/usr/bin/gdb-multiarch</code></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-config-Debuggers.png" alt="_images/Qt-config-Debuggers.png"></p>
<ul>
<li>配置 Devices</li>
</ul>
<p>设置好设备的 IP、用户名 (root) 和密码 (firefly) 。为了方便调试，可以在设备上设置静态 IP。</p>
<p>GDB server 设置为 <code>/usr/bin/gdbserver</code></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-config-Devices.png" alt="_images/Qt-config-Devices.png"></p>
<ul>
<li>配置 Kits</li>
</ul>
<p>将前面设置的配置项添加到 Kits。</p>
<p><strong>如果目标平台是 Ubuntu 系统，这一步也需要添加 sysroot 的路径</strong></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-config-Kits.png" alt="_images/Qt-config-Kits.png"></p>
<h3 id="7-4-3-编译运行¶"><a href="#7-4-3-编译运行¶" class="headerlink" title="7.4.3. 编译运行¶"></a>7.4.3. 编译运行¶</h3><p>打开 demo 程序，<code>Welcome -&gt; Open Project</code>，选择要使用的 Kits：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-Choose-Kit.png" alt="_images/Qt-Choose-Kit.png"></p>
<p>之后打开 <code>Projects -&gt; Run</code>，配置命令行参数，这里设置为 <code>-platform wayland</code>：</p>
<p>目标平台是 Ubuntu 则使用 <code>-platform xcb</code> (Ubuntu 桌面环境)，或者根据需要选择 <code>linuxfb</code>、<code>eglfs</code></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-command_line_arguments.png" alt="_images/Qt-command_line_arguments.png"></p>
<p>配置环境变量，即 <code>export XDG_RUNTIME_DIR=/tmp/.xdg</code>：</p>
<p>RK356X Buildroot 则需要使用 <code>/var/run</code> 而不是 <code>/tmp/.xdg</code></p>
<p>目标平台是 Ubuntu 则需要根据之前设置的 <code>platform</code> 添加不同的环境变量，详情在 Qt 环境包中的说明文件中</p>
<p>如果目标平台的运行环境(本文开头提到的)之前已经配置好并成功运行 demo，此时可以直接点击右侧 <code>Fetch Device Environment</code> 获取目标的环境变量</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-set-environment.png" alt="_images/Qt-set-environment.png"></p>
<p>编译运行：</p>
<p>点击 <code>Build</code> 交叉编译 Qt 程序；点击 <code>Run</code> 或 <code>Debug</code> 在设备上运行或调试程序。要重新运行程序时，记得手动点击 <code>Stop</code> 关闭已经运行的程序。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/Qt-Compile.png" alt="_images/Qt-Compile.png"></p>
<p>编译生成目录和 demo 目录在同一位置。</p>
<h2 id="8-Docker-支持¶"><a href="#8-Docker-支持¶" class="headerlink" title="8. Docker 支持¶"></a>8. Docker 支持¶</h2><p>Firefly 发布的普通固件一般不满足 Docker 的运行要求，如果有需求，可以使用 SDK 打开内核的相关配置，重新编译烧录内核以支持 Docker。</p>
<p><strong>（RK356X v1.2.4a 及以后版本 、RK3399&#x2F;RK3588 默认支持 Docker，可直跳到 安装 Docker 步骤）</strong></p>
<p>以下案例是基于 Firefly Ubuntu 20.04，内核配置部分是通用的！</p>
<h2 id="8-1-检查-Kernel-配置¶"><a href="#8-1-检查-Kernel-配置¶" class="headerlink" title="8.1. 检查 Kernel 配置¶"></a>8.1. 检查 Kernel 配置¶</h2><p>首先需要通过工具检查当前设备的内核缺少了哪些 Docker 需要的配置。检测脚本 <code>check-config.sh</code> 可以前往 <a target="_blank" rel="noopener" href="https://dev.t-firefly.com/thread-115083-1-1.html">社区论坛</a> 获取。</p>
<p>获取到脚本之后，开始进行检测：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#将脚本拷贝到SDK的kernel目录下</span><br><span class="line">cp check-config.sh PathToSDK/kernel/</span><br><span class="line">cd PathToSDK/kernel</span><br><span class="line">chmod +x check-config.sh</span><br><span class="line"></span><br><span class="line">#获取当前内核配置</span><br><span class="line">make ARCH=arm64 firefly_linux_defconfig</span><br><span class="line"></span><br><span class="line">#检测</span><br><span class="line">./check-config.sh .config</span><br></pre></td></tr></table></figure>

<p>执行后的结果如下，主要是两部分：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Generally Necessary:</span><br><span class="line">- cgroup hierarchy: properly mounted [/sys/fs/cgroup]</span><br><span class="line">- apparmor: enabled <span class="keyword">and</span> tools installed</span><br><span class="line">- CONFIG_NAMESPACES: enabled</span><br><span class="line">- CONFIG_NET_NS: enabled</span><br><span class="line">- CONFIG_PID_NS: enabled</span><br><span class="line">- CONFIG_IPC_NS: enabled</span><br><span class="line">- CONFIG_UTS_NS: enabled</span><br><span class="line">- CONFIG_CGROUPS: enabled</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">Optional Features:</span><br><span class="line">- CONFIG_USER_NS: enabled</span><br><span class="line">- CONFIG_SECCOMP: enabled</span><br><span class="line">- CONFIG_SECCOMP_FILTER: enabled</span><br><span class="line">- CONFIG_CGROUP_PIDS: enabled</span><br><span class="line">- CONFIG_MEMCG_SWAP: enabled</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>Generally Necessary: 表示必要的配置，如果有显示 missing 的地方，就需要在内核配置中打开它。 Optional Features: 是可选配置，根据需要打开。</p>
<h3 id="8-1-1-开启需要的配置¶"><a href="#8-1-1-开启需要的配置¶" class="headerlink" title="8.1.1. 开启需要的配置¶"></a>8.1.1. 开启需要的配置¶</h3><p>从上面的检测结果中得知需要打开哪些配置后，即可使用 <code>make ARCH=arm64 menuconfig</code> 进入菜单，搜索对应项目将其打开。请认真查看菜单中的操作说明，遇到不可选中的项目请注意依赖关系。</p>
<p>开启所有必要配置以及部分可选配置后，注意保存：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make ARCH=arm64 savedefconfig</span><br><span class="line">mv defconfig arch/arm64/configs/firefly_linux_defconfig</span><br></pre></td></tr></table></figure>

<p>之后进行编译内核：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#退回到SDK目录</span><br><span class="line">cd ..</span><br><span class="line">#编译内核</span><br><span class="line">./build.sh kernel</span><br></pre></td></tr></table></figure>

<h2 id="8-2-安装-Docker¶"><a href="#8-2-安装-Docker¶" class="headerlink" title="8.2. 安装 Docker¶"></a>8.2. 安装 Docker¶</h2><p>烧录完新内核之后，可以开始在设备上安装 Docker (此安装方法同样适用于 PC)：</p>
<ul>
<li>步骤 1：快速安装</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 这里仅介绍直接使用脚本快速安装</span><br><span class="line">apt-get update</span><br><span class="line">wget -qO- https:<span class="comment">//get.docker.com/ | sh</span></span><br></pre></td></tr></table></figure>

<p>等待安装成功之后应该会看见 Docker 版本信息</p>
<ul>
<li>步骤 2：检查 docker 存储位置（该步骤仅适用于 PC 安装 docker）</li>
</ul>
<p>如果你在 Firefly 设备中安装 docker，请跳过步骤 2</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 执行</span><br><span class="line">docker info | grep -i dir</span><br><span class="line"># 执行结果</span><br><span class="line"> Docker Root Dir: /var/lib/docker</span><br></pre></td></tr></table></figure>

<p>返回的信息显示了 docker 的默认存储位置，该位置在不同电脑上可能不一样</p>
<p>镜像和容器会占用大量空间，因此，<strong>如果默认的位置空间不大，需要修改到空间充足的位置</strong></p>
<p><strong>再次强调，此步骤只用于 PC，Firefly 设备中，修改此位置会导致 docker 无法工作</strong>，请直接跳到下一步</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 先关闭 docker 服务</span><br><span class="line">sudo systemctl stop docker</span><br><span class="line"></span><br><span class="line"># 修改文件 /lib/systemd/system/docker.service</span><br><span class="line">sudo vim /lib/systemd/system/docker.service</span><br><span class="line"></span><br><span class="line"># 在这一行末尾添加想要修改的位置 --graph /home/firefly/docker/data</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:<span class="comment">// --containerd=/run/containerd/containerd.sock --graph /home/firefly/docker/data</span></span><br><span class="line"></span><br><span class="line"># 重启 docker 服务</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl start docker</span><br><span class="line"></span><br><span class="line"># 检查位置是否修改成功</span><br><span class="line">docker info | grep -i dir</span><br><span class="line"> Docker Root Dir: /home/firefly/docker/data</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤 3：将自己的用户添加到 docker 组</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -a -G docker firefly</span><br><span class="line"># 添加后重启</span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤 4：重启后运行 demo 测试是否正常：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">firefly@firefly:~<span class="meta"># docker run hello-world</span></span><br><span class="line">Unable to find image <span class="string">&#x27;hello-world:latest&#x27;</span> locally</span><br><span class="line">latest: Pulling from library/hello-world</span><br><span class="line"><span class="number">93288797b</span>d35: Pull complete</span><br><span class="line">Digest: sha256:cc15c5b292d8525effc0f89cb299f1804f3a725c8d05e158653a563f15e4f685</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> hello-world:latest</span><br><span class="line"></span><br><span class="line">Hello from Docker!</span><br><span class="line">This message shows that your installation appears to be working correctly.</span><br><span class="line"></span><br><span class="line">To generate <span class="keyword">this</span> message, Docker took the following steps:</span><br><span class="line"> <span class="number">1.</span> The Docker client contacted the Docker daemon.</span><br><span class="line"> <span class="number">2.</span> The Docker daemon pulled the <span class="string">&quot;hello-world&quot;</span> image from the Docker Hub.</span><br><span class="line">    (arm64v8)</span><br><span class="line"> <span class="number">3.</span> The Docker daemon created a <span class="keyword">new</span> container from that image which runs the</span><br><span class="line">    executable that produces the output you are currently reading.</span><br><span class="line"> <span class="number">4.</span> The Docker daemon streamed that output to the Docker client, which sent it</span><br><span class="line">    to your terminal.</span><br><span class="line"></span><br><span class="line">To <span class="keyword">try</span> something more ambitious, you can run an Ubuntu container with:</span><br><span class="line"> $ docker run -it ubuntu bash</span><br><span class="line"></span><br><span class="line">Share images, automate workflows, <span class="keyword">and</span> more with a free Docker ID:</span><br><span class="line"> https:<span class="comment">//hub.docker.com/</span></span><br><span class="line"></span><br><span class="line">For more examples <span class="keyword">and</span> ideas, visit:</span><br><span class="line"> https:<span class="comment">//docs.docker.com/get-started/</span></span><br></pre></td></tr></table></figure>

<h2 id="9-ROS-支持¶"><a href="#9-ROS-支持¶" class="headerlink" title="9. ROS 支持¶"></a>9. ROS 支持¶</h2><h2 id="9-1-安装-ROS¶"><a href="#9-1-安装-ROS¶" class="headerlink" title="9.1. 安装 ROS¶"></a>9.1. 安装 ROS¶</h2><p>首先按照官方安装教程安装，根据系统选择对应 ROS 版本安装。 <a target="_blank" rel="noopener" href="http://wiki.ros.org/cn/ROS/Installation">官方安装教程</a></p>
<h3 id="9-1-1-安装-GLX-库¶"><a href="#9-1-1-安装-GLX-库¶" class="headerlink" title="9.1.1. 安装 GLX 库¶"></a>9.1.1. 安装 GLX 库¶</h3><p>rviz,gazebo 是基于 GLX 编写的，我们系统目前只支持 EGL，所以他们无法使用 GPU 加速，同时需要安装 GLX 库才能能够正常运行。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install -y libgl1-mesa-glx libgl1-mesa-dri libglx-mesa0</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h2 id="9-2-更新-libqt5opengl5-dev¶"><a href="#9-2-更新-libqt5opengl5-dev¶" class="headerlink" title="9.2. 更新 libqt5opengl5-dev¶"></a>9.2. 更新 libqt5opengl5-dev¶</h2><p>如果遇到 rviz 还不能运行，rqt 报 QOpenGLTimeMonitor 等错误，需要更新官方的 libqt5opengl5-dev， 执行下面操作，再尝试运行 rqt、rviz 和 gazebo 等程序</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s/.*wiki.t-firefly.com.*/\#&amp;/&#x27;</span> /etc/apt/sources.list</span><br><span class="line">apt install libqt5opengl5-dev</span><br><span class="line">sed -i <span class="string">&#x27;/.*wiki.t-firefly.com.*/s/^#//&#x27;</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure>

<h2 id="9-3-wayland-下运行-rviz，rqt-和-gazebo-等程序¶"><a href="#9-3-wayland-下运行-rviz，rqt-和-gazebo-等程序¶" class="headerlink" title="9.3. wayland 下运行 rviz，rqt 和 gazebo 等程序¶"></a>9.3. wayland 下运行 rviz，rqt 和 gazebo 等程序¶</h2><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/X.Org_Server#XWayland">XWayland说明</a> 基于 GLX 的程序在 wayland 运行，需要使用 XWayland。使用 QT_QPA_PLATFORM&#x3D;xcb 强制 Qt 应用程序使用 X11</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">QT_QPA_PLATFORM=xcb rviz</span><br><span class="line">QT_QPA_PLATFORM=xcb rqt</span><br><span class="line">QT_QPA_PLATFORM=xcb gazebo</span><br><span class="line"># 也可以将该环境设置到.bashrc，就可以直接运行rviz等程序。</span><br><span class="line">echo <span class="string">&quot;export QT_QPA_PLATFORM=xcb&quot;</span> &gt;&gt; /~/.bashrc</span><br></pre></td></tr></table></figure>

<h2 id="9-4-ROS教程¶"><a href="#9-4-ROS教程¶" class="headerlink" title="9.4. ROS教程¶"></a>9.4. <a target="_blank" rel="noopener" href="http://wiki.ros.org/cn/ROS/Tutorials">ROS教程</a><a target="_blank" rel="noopener" href="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/#ros-jiao-cheng" title="永久链接至标题">¶</a></h2><h2 id="10-显示架构支持¶"><a href="#10-显示架构支持¶" class="headerlink" title="10. 显示架构支持¶"></a>10. 显示架构支持¶</h2><p>对于 Rockchip 平台，主要有以下几种显示架构可供选择：</p>
<ul>
<li>Qt + Wayland</li>
<li>Qt + EGLFS</li>
<li>EGL program + X11</li>
<li>Wayland</li>
<li>None</li>
</ul>
<p>多窗口的功能需求，选择：</p>
<ul>
<li>X11</li>
<li>Wayland</li>
</ul>
<p>桌面的功能需求，选择：</p>
<ul>
<li>X11</li>
</ul>
<p>4K 视频播放 + 全屏：</p>
<ul>
<li>Qt + Wayland</li>
<li>Qt + EGLFS</li>
<li>X11</li>
<li>Wayland</li>
</ul>
<p>4K 视频播放 + 多窗口：</p>
<ul>
<li>X11</li>
<li>Qt + Wayland</li>
<li>Wayland</li>
</ul>
<p>如果您对显示架构的技术不太理解，可以继续往下阅读。</p>
<h2 id="10-1-X11¶"><a href="#10-1-X11¶" class="headerlink" title="10.1. X11¶"></a>10.1. X11¶</h2><p><strong>X11</strong> 是 X 显示协议的第 11 个版本。</p>
<p>X 协议已经延用了 30 年，X 协议的 Client&#x2F;Server 结构起初是为了在以前硬件性能太弱的情况下，设备（Client 端）通过发送渲染请求给 X server（以前 X server 是运行在另一个独立的硬件）渲染显示。</p>
<p>但是随着现代硬件性能不断提升，同一个硬件系统上可以同时运行 Client 和 Server 了，但是这种远程通讯结构运用在本地机器上带来的后果就是性能的丢失，目前在 Debian 官方已经有分支在开发 Wayland 用于替换掉 X11，但是目前 Wayland 对现有软件兼容性并不好所有还没有正式替换使用。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/X_Logo.png" alt="_images/X_Logo.png"></p>
<p>参考资料:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//en.wikipedia.org/wiki/X.Org_Server</span></span><br><span class="line">https:<span class="comment">//www.comptechdoc.org/os/linux/howlinuxworks/linux_hlxwindows.html</span></span><br><span class="line">https:<span class="comment">//dri.freedesktop.org/wiki/DDX/</span></span><br><span class="line">https:<span class="comment">//www.freedesktop.org/wiki/Software/Glamor/</span></span><br><span class="line">https:<span class="comment">//en.wikipedia.org/wiki/X.Org_Server</span></span><br></pre></td></tr></table></figure>

<h2 id="10-2-Qt-EGLFS¶"><a href="#10-2-Qt-EGLFS¶" class="headerlink" title="10.2. Qt + EGLFS¶"></a>10.2. Qt + EGLFS¶</h2><p><strong>Qt + EGLFS</strong> 是 Qt 自己实现的一个 GUI 系统，不支持多窗口，但也因此少了 window composite。</p>
<p>Qt + EGLFS 和 dri2 的方式类似，区别就在于 Qt + EGLFS 的 font buffer 在自己用 gpu composite 后，是直接送给 DRM 显示，而 X 里是送至 Window manager 做 composite，所以 EGLFS 在效率上是有优势的。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/qt_logo.jpeg" alt="_images/qt_logo.jpeg"></p>
<h2 id="10-3-Qt-Wayland¶"><a href="#10-3-Qt-Wayland¶" class="headerlink" title="10.3. Qt + Wayland¶"></a>10.3. Qt + Wayland¶</h2><p>在 <strong>Wayland</strong> 中，<strong>Weston</strong> 是 Wayland 显示协议中的具体实现，其对应关系就好比 Xorg （X server）和 X 的关系一样。</p>
<p>目前 Wayland 和 X 对比唯一缺点就是在兼容性上了，所以目前主流的系统版本中依然大部分使用 X。</p>
<p>Weston 不再使用 X 的 Client&#x2F;Server 的结构，而是直接由合成器接受内核事件，并传递给 Client 端，由 Client 端直接渲染，只向合成器发送需要更新的区域，再由合成器通知内核安排翻页。</p>
<p>需要注意的是由于 Ubuntu&#x2F;Debian 已经有 X11，所以 SDK 默认是在 Buildroot 添加了 Weston 的支持，实际上如果 Ubuntu&#x2F;Debian 需要安装 Weston 的话也可以在 Minimal 版本上搭建。</p>
<p>（Firefly Ubuntu 20.04，将会默认自带 Wayland 和 X，并且可以自由切换。）</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wiki.t-firefly.com/zh_CN/Firefly-Linux-Guide/_images/wayland_logo.png" alt="_images/wayland_logo.png"></p>
<p>建议使用 Buildroot&#x2F;Yocto 做 Wayland 的开发。效率上 Wayland 要比 X11 好点，主要是兼容性问题。</p>
<p>如果不需要桌面，又要多窗口，可以尝试使用 Wayland。</p>
<h2 id="10-4-None¶"><a href="#10-4-None¶" class="headerlink" title="10.4. None¶"></a>10.4. None¶</h2><p>除了 X11 和 Wayland 之外，还有 <strong>None</strong>，这也是嵌入式上接触比较多的。比如 MiniGUI，SDL 皆是如此。</p>
<p>若要支持到 DRM 和 opengl 的话，就只能选择 Qt 了。</p>
<p><strong>MiniGUI</strong> 是一个定位于轻量级的嵌入式图形库，对系统资源的需求完全考虑到了嵌入式设备的硬件情况，如 MiniGUI 库所占的空间最小可以裁剪到 500K 左右。</p>
<p>针对 Buildroot 系统适配在硬件资源比较紧张的设备上的特性，MiniGUI 搭配 Buildroot 是再适合不过了。</p>
<p>参考资料:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//wayland.freedesktop.org/architecture.html</span></span><br><span class="line">https:<span class="comment">//en.wikipedia.org/wiki/Wayland</span></span><br></pre></td></tr></table></figure>

<div class="article-footer fs14">
    <section id="share">
      <div class="header"><span>Share</span></div>
      <div class="body">
        <div class="link"><input class="copy-area" readonly="true" id="copy-link" value="http://liuluhua.github.io/2024/12/19/0-%E5%B9%B3%E5%8F%B0-%E5%B5%8C%E5%85%A5%E5%BC%8F-%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%88%9D%E5%A7%8B%E9%85%8D%E7%BD%AE/" /></div>
        <div class="social-wrap dis-select"><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;Copied!&quot;)"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/8411ed322ced6.svg" /></a></div>
        
      </div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">Newer</div><a href="/2024/12/19/0-%E5%B9%B3%E5%8F%B0-NAS-%E8%BD%AF%E8%B7%AF%E7%94%B1-OpenWRT/">软路由-OpenWRT</a></div><div class="item" id="next"><div class="note">Older</div><a href="/2024/12/19/0-%E5%B9%B3%E5%8F%B0-%E5%B5%8C%E5%85%A5%E5%BC%8F-%E5%B5%8C%E5%85%A5%E5%BC%8F%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91/">1. 桌面应用 — Firefly Wiki</a></div></section></div>

<div class="related-wrap" id="related-posts">
    <section class='header'>
      <div class='title cap theme'>您可能感兴趣的文章</div>
    </section>
    <section class='body'>
    <div class="related-posts"><a class="item" href="/2024/12/19/0-平台-NAS-软路由-OpenWRT/" title="软路由-OpenWRT"><span class="title">软路由-OpenWRT</span></a><a class="item" href="/2024/12/19/0-平台-嵌入式-嵌入式交叉编译/" title="1. 桌面应用 — Firefly Wiki"><span class="title">1. 桌面应用 — Firefly Wiki</span></a><a class="item" href="/2024/12/11/0-平台-服务器-Obsidian在ios端利用git-同步/" title="Obsidian在ios端利用git 同步"><span class="title">Obsidian在ios端利用git 同步</span></a><a class="item" href="/2024/12/12/1-语言-Qt-信号与槽详解/" title="信号与槽详解"><span class="title">信号与槽详解</span></a><a class="item" href="/2024/08/15/0-平台-嵌入式-3566与3568与3588之间的差异/" title="3566与3568与3588之间的差异"><span class="title">3566与3568与3588之间的差异</span></a></div></section></div>


  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>快来参与讨论吧~</p>

    </section>
    <section class='body cmt-body utterances'>
      

<svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="utterances" repo="liuluhua/liuluhua.github.io" issue-term="title" theme="preferred-color-scheme" label="💬"></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs15">博客</span><a href="/">近期</a><a href="/categories/">标签</a><a href="/archives/">归档</a></div><div class="sitemap-group"><span class="fs15">项目</span><a target="_blank" rel="noopener" href="https://github.com/liuluhua/">GitHub</a><a target="_blank" rel="noopener" href="https://tongji.baidu.com/">百度统计</a></div><div class="sitemap-group"><span class="fs15">社交</span><a href="/">友链</a><a href="/about/#comments">留言板</a></div><div class="sitemap-group"><span class="fs15">更多</span><a href="/about/">关于本站</a></div></div><div class="text"><p>本站使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.1">Stellar 1.29.1</a> 主题创建。</p>
<script color="0,255,255" opacity="1" zIndex="-1" count="70" src="https://cdn.staticfile.org/canvas-nest.js/1.0.1/canvas-nest.js"></script>
<center>
</br>
</br>
<!--不蒜子计数器-->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!--添加一个访问量-->
<span>
    本"<span style="color: rgb(13, 109, 252); font-weight: bold;">页面</ a></span>"访问 <span id="busuanzi_value_page_pv" style="color: rgb(13, 109, 252); font-weight: bold;"></span> 次 | 👀总访问 <span id="busuanzi_value_site_pv" style="color: rgb(13, 109, 252); font-weight: bold;"></span>                次 | 🥷总访客 <span id="busuanzi_value_site_uv" style="color: rgb(13, 109, 252); font-weight: bold;"></span> 人
</span>
</br>
</br>
<script type="text/javascript">
function show_runtime() {
    window.setTimeout("show_runtime()", 1000);
    X = new Date("05/20/2023 05:20:00");
    Y = new Date();
    T = (Y.getTime() - X.getTime());
    M = 24 * 60 * 60 * 1000;
    a = T / M;
    A = Math.floor(a);
    b = (a - A) * 24;
    B = Math.floor(b);
    c = (b - B) * 60;
    C = Math.floor((b - B) * 60);
    D = Math.floor((c - C) * 60);
    runtime_span.innerHTML = "⏱️本站已运行 " + A + "天" + B + "小时" + C + "分" + D + "秒"
}
show_runtime();
</script>
<span id="runtime_span"></span>
</center>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">On This Page</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-Ubuntu-Desktop-%E7%B3%BB%E7%BB%9F%C2%B6"><span class="toc-text">1.1. Ubuntu Desktop 系统¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Ubuntu-Minimal-%E7%B3%BB%E7%BB%9F%C2%B6"><span class="toc-text">1.2. Ubuntu Minimal 系统¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-Buildroot-%E7%B3%BB%E7%BB%9F%C2%B6"><span class="toc-text">1.3. Buildroot 系统¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ADB-%E4%BD%BF%E7%94%A8%C2%B6"><span class="toc-text">2. ADB 使用¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-ADB%C2%B6"><span class="toc-text">2.1. ADB¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E7%BD%91%E7%BB%9C-ADB%C2%B6"><span class="toc-text">2.2. 网络 ADB¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%AF%BC%E5%87%BA%E8%AE%BE%E5%A4%87%E7%B3%BB%E7%BB%9F%C2%B6"><span class="toc-text">4. 导出设备系统¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E5%AF%BC%E5%87%BA-rootfs%C2%B6"><span class="toc-text">4.1. 导出 rootfs¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E4%BA%8C%E6%AC%A1%E6%89%93%E5%8C%85%E5%AE%8C%E6%95%B4%E5%9B%BA%E4%BB%B6%C2%B6"><span class="toc-text">4.2. 二次打包完整固件¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-GPIO-%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8%C2%B6"><span class="toc-text">5. GPIO 配置与使用¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-GPIO-%E7%BC%96%E5%8F%B7%E8%AE%A1%E7%AE%97%C2%B6"><span class="toc-text">5.1. GPIO 编号计算¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E7%94%A8%E6%88%B7%E6%80%81%E4%BD%BF%E7%94%A8-GPIO%C2%B6"><span class="toc-text">5.2. 用户态使用 GPIO¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E8%AE%BE%E5%A4%87%E6%A0%91%E4%BD%BF%E7%94%A8-GPIO%C2%B6"><span class="toc-text">5.3. 设备树使用 GPIO¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%C2%B6"><span class="toc-text">6. 网络配置¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E4%BB%A5%E5%A4%AA%E7%BD%91%E5%8F%A3%E9%80%9A%E7%94%A8%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%C2%B6"><span class="toc-text">6.1. 以太网口通用参数配置¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1-%E6%9F%A5%E7%9C%8B%E4%BB%A5%E5%A4%AA%E7%BD%91%E9%80%9A%E7%94%A8%E5%8F%82%E6%95%B0%C2%B6"><span class="toc-text">6.1.1. 查看以太网通用参数¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2-%E9%85%8D%E7%BD%AE%E4%BB%A5%E5%A4%AA%E7%BD%91%E9%80%9A%E7%94%A8%E5%8F%82%E6%95%B0%C2%B6"><span class="toc-text">6.1.2. 配置以太网通用参数¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-2-1-%E6%89%93%E5%BC%80%E6%88%96%E5%85%B3%E9%97%AD%E8%87%AA%E5%8D%8F%E5%95%86%C2%B6"><span class="toc-text">6.1.2.1. 打开或关闭自协商¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-2-2-%E4%BF%AE%E6%94%B9%E5%8F%8C%E5%B7%A5%E6%A8%A1%E5%BC%8F%C2%B6"><span class="toc-text">6.1.2.2. 修改双工模式¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-2-3-%E4%BF%AE%E6%94%B9%E9%80%9F%E7%8E%87%C2%B6"><span class="toc-text">6.1.2.3. 修改速率¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-3-%E9%85%8D%E7%BD%AE%E4%B8%BE%E4%BE%8B%C2%B6"><span class="toc-text">6.1.3. 配置举例¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E4%BD%BF%E7%94%A8-Netplan-%E7%AE%A1%E7%90%86%E7%BD%91%E7%BB%9C%C2%B6"><span class="toc-text">6.2. 使用 Netplan 管理网络¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1-%E9%85%8D%E7%BD%AE%C2%B6"><span class="toc-text">6.2.1. 配置¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-2-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%C2%B6"><span class="toc-text">6.2.2. 基础配置¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-3-%E4%BB%A5%E5%A4%AA%E7%BD%91%E8%BF%9E%E6%8E%A5%EF%BC%9A%E5%8A%A8%E6%80%81-IP%C2%B6"><span class="toc-text">6.2.3. 以太网连接：动态 IP¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-4-%E4%BB%A5%E5%A4%AA%E7%BD%91%E8%BF%9E%E6%8E%A5%EF%BC%9A%E9%9D%99%E6%80%81-IP%C2%B6"><span class="toc-text">6.2.4. 以太网连接：静态 IP¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-5-WIFI-%E8%BF%9E%E6%8E%A5%EF%BC%9A%E9%9D%99%E6%80%81-IP%C2%B6"><span class="toc-text">6.2.5. WIFI 连接：静态 IP¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-6-WIFI-%E8%BF%9E%E6%8E%A5%EF%BC%9A%E5%8A%A8%E6%80%81-IP%C2%B6"><span class="toc-text">6.2.6. WIFI 连接：动态 IP¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E4%BD%BF%E7%94%A8-nmcli-%E7%AE%A1%E7%90%86%E7%BD%91%E7%BB%9C%C2%B6"><span class="toc-text">6.3. 使用 nmcli 管理网络¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-1-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%C2%B6"><span class="toc-text">6.3.1. 常用命令¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-2-%E4%BB%A5%E5%A4%AA%E7%BD%91%E8%BF%9E%E6%8E%A5%EF%BC%9A%E9%9D%99%E6%80%81-IP%C2%B6"><span class="toc-text">6.3.2. 以太网连接：静态 IP¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-3-%E4%BB%A5%E5%A4%AA%E7%BD%91%E8%BF%9E%E6%8E%A5%EF%BC%9A%E5%8A%A8%E6%80%81-IP%C2%B6"><span class="toc-text">6.3.3. 以太网连接：动态 IP¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-4-WIFI-%E8%BF%9E%E6%8E%A5%EF%BC%9A%E5%8A%A8%E6%80%81-IP%C2%B6"><span class="toc-text">6.3.4. WIFI 连接：动态 IP¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-%E5%BF%AB%E9%80%9F%E5%88%9B%E5%BB%BA%E6%97%A0%E7%BA%BF-AP-%E7%83%AD%E7%82%B9%C2%B6"><span class="toc-text">6.4. 快速创建无线 AP 热点¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-1-%E5%AF%B9%E6%97%A0%E7%BA%BF%E7%83%AD%E7%82%B9%E7%9A%84-IP-%E5%B1%80%E5%9F%9F%E7%BD%91%E6%AE%B5%E6%97%A0%E8%A6%81%E6%B1%82%C2%B6"><span class="toc-text">6.4.1. 对无线热点的 IP 局域网段无要求¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-2-%E5%AF%B9%E6%97%A0%E7%BA%BF%E7%83%AD%E7%82%B9%E7%9A%84-IP-%E5%B1%80%E5%9F%9F%E7%BD%91%E6%AE%B5%E6%9C%89%E8%A6%81%E6%B1%82%C2%B6"><span class="toc-text">6.4.2. 对无线热点的 IP 局域网段有要求¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E5%88%9B%E5%BB%BA%E6%A1%A5%E6%8E%A5%E6%97%A0%E7%BA%BF-AP-%E7%83%AD%E7%82%B9%C2%B6"><span class="toc-text">6.5. 创建桥接无线 AP 热点¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-1-%E5%8A%9F%E8%83%BD%E9%9C%80%E6%B1%82%C2%B6"><span class="toc-text">6.5.1. 功能需求¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-2-%E5%AE%89%E8%A3%85%E7%AE%A1%E7%90%86-AP-%E7%83%AD%E7%82%B9%E5%BF%85%E8%A6%81%E7%9A%84%E8%BD%AF%E4%BB%B6%E5%8C%85%C2%B6"><span class="toc-text">6.5.2. 安装管理 AP 热点必要的软件包¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-3-%E9%85%8D%E7%BD%AE-Netplan%C2%B6"><span class="toc-text">6.5.3. 配置 Netplan¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-4-%E9%85%8D%E7%BD%AE-hostapd%C2%B6"><span class="toc-text">6.5.4. 配置 hostapd¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-5-%E9%85%8D%E7%BD%AE-isc-dhcp-server%C2%B6"><span class="toc-text">6.5.5. 配置 isc-dhcp-server¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-6-%E5%BC%80%E5%90%AF-IP-%E8%BD%AC%E5%8F%91%C2%B6"><span class="toc-text">6.5.6. 开启 IP 转发¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-6-%E4%BD%BF%E7%94%A8-ip-%E5%92%8C-netplan-%E9%85%8D%E7%BD%AE-IP-%E5%9C%B0%E5%9D%80%E5%92%8C%E8%B7%AF%E7%94%B1%C2%B6"><span class="toc-text">6.6. 使用 ip 和 netplan 配置 IP 地址和路由¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-1-%E9%9D%99%E6%80%81-IP-%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE%C2%B6"><span class="toc-text">6.6.1. 静态 IP 地址配置¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-6-1-1-%E5%B8%B8%E7%94%A8%E7%9A%84-IP-%E9%85%8D%E7%BD%AE%E5%91%BD%E4%BB%A4%EF%BC%9A%C2%B6"><span class="toc-text">6.6.1.1. 常用的 IP 配置命令：¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-6-1-2-%E9%85%8D%E7%BD%AE%E4%B8%BE%E4%BE%8B%EF%BC%9A%C2%B6"><span class="toc-text">6.6.1.2. 配置举例：¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-2-%E5%8A%A8%E6%80%81-IP-%E5%9C%B0%E5%9D%80%E9%85%8D%E7%BD%AE%C2%B6"><span class="toc-text">6.6.2. 动态 IP 地址配置¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-3-%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE%C2%B6"><span class="toc-text">6.6.3. 静态路由配置¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-6-3-1-%E5%B8%B8%E7%94%A8%E7%9A%84%E9%85%8D%E7%BD%AE%E5%91%BD%E4%BB%A4%EF%BC%9A%C2%B6"><span class="toc-text">6.6.3.1. 常用的配置命令：¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-6-3-2-%E9%85%8D%E7%BD%AE%E4%B8%BE%E4%BE%8B%EF%BC%9A%C2%B6"><span class="toc-text">6.6.3.2. 配置举例：¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-4-%E9%BB%98%E8%AE%A4%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE%C2%B6"><span class="toc-text">6.6.4. 默认路由配置¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-5-%E8%B0%83%E6%95%B4%E9%BB%98%E8%AE%A4%E8%B7%AF%E7%94%B1%E9%A1%BA%E5%BA%8F%C2%B6"><span class="toc-text">6.6.5. 调整默认路由顺序¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-6-5-1-%E9%85%8D%E7%BD%AE%E4%B8%BE%E4%BE%8B%EF%BC%9A%C2%B6"><span class="toc-text">6.6.5.1. 配置举例：¶</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-7-iptables-NAT-%E9%85%8D%E7%BD%AE%C2%B6"><span class="toc-text">6.7. iptables NAT 配置¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-1-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%C2%B6"><span class="toc-text">6.7.1. 常用命令¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-2-%E9%85%8D%E7%BD%AE%E4%B8%BE%E4%BE%8B%C2%B6"><span class="toc-text">6.7.2. 配置举例¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-3-SNAT%C2%B6"><span class="toc-text">6.7.3. SNAT¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-4-DNAT%C2%B6"><span class="toc-text">6.7.4. DNAT¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-5-MASQUERADE%C2%B6"><span class="toc-text">6.7.5. MASQUERADE¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-8-iptables-filter-%E9%85%8D%E7%BD%AE%C2%B6"><span class="toc-text">6.8. iptables filter 配置¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-8-1-%E9%80%9A%E7%94%A8%E5%91%BD%E4%BB%A4%C2%B6"><span class="toc-text">6.8.1. 通用命令¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-8-2-ACCEPT%EF%BC%9A%E5%85%81%E8%AE%B8%E6%95%B0%E6%8D%AE%E5%8C%85%E9%80%9A%E8%BF%87%C2%B6"><span class="toc-text">6.8.2. ACCEPT：允许数据包通过¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-8-3-REJECT%EF%BC%9A%E6%8B%92%E7%BB%9D%E6%95%B0%E6%8D%AE%E5%8C%85%E9%80%9A%E8%BF%87%C2%B6"><span class="toc-text">6.8.3. REJECT：拒绝数据包通过¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-8-4-DROP%EF%BC%9A%E4%B8%A2%E5%BC%83%E6%95%B0%E6%8D%AE%E5%8C%85%C2%B6"><span class="toc-text">6.8.4. DROP：丢弃数据包¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Qt-%E6%94%AF%E6%8C%81%C2%B6"><span class="toc-text">7. Qt 支持¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-Qt-%E7%8E%AF%E5%A2%83%E6%94%AF%E6%8C%81%C2%B6"><span class="toc-text">7.1. Qt 环境支持¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-Qt-%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E6%94%AF%E6%8C%81%C2%B6"><span class="toc-text">7.2. Qt 交叉编译环境支持¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-Qt-%E5%8F%8C%E5%B1%8F%E5%BC%82%E6%98%BE%C2%B6"><span class="toc-text">7.3. Qt 双屏异显¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-Qt-Creator%C2%B6"><span class="toc-text">7.4. Qt Creator¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-1-%E5%AE%89%E8%A3%85%C2%B6"><span class="toc-text">7.4.1. 安装¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-2-%E9%85%8D%E7%BD%AE%C2%B6"><span class="toc-text">7.4.2. 配置¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-3-%E7%BC%96%E8%AF%91%E8%BF%90%E8%A1%8C%C2%B6"><span class="toc-text">7.4.3. 编译运行¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Docker-%E6%94%AF%E6%8C%81%C2%B6"><span class="toc-text">8. Docker 支持¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E6%A3%80%E6%9F%A5-Kernel-%E9%85%8D%E7%BD%AE%C2%B6"><span class="toc-text">8.1. 检查 Kernel 配置¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-1-%E5%BC%80%E5%90%AF%E9%9C%80%E8%A6%81%E7%9A%84%E9%85%8D%E7%BD%AE%C2%B6"><span class="toc-text">8.1.1. 开启需要的配置¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E5%AE%89%E8%A3%85-Docker%C2%B6"><span class="toc-text">8.2. 安装 Docker¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-ROS-%E6%94%AF%E6%8C%81%C2%B6"><span class="toc-text">9. ROS 支持¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E5%AE%89%E8%A3%85-ROS%C2%B6"><span class="toc-text">9.1. 安装 ROS¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-1-%E5%AE%89%E8%A3%85-GLX-%E5%BA%93%C2%B6"><span class="toc-text">9.1.1. 安装 GLX 库¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-%E6%9B%B4%E6%96%B0-libqt5opengl5-dev%C2%B6"><span class="toc-text">9.2. 更新 libqt5opengl5-dev¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-wayland-%E4%B8%8B%E8%BF%90%E8%A1%8C-rviz%EF%BC%8Crqt-%E5%92%8C-gazebo-%E7%AD%89%E7%A8%8B%E5%BA%8F%C2%B6"><span class="toc-text">9.3. wayland 下运行 rviz，rqt 和 gazebo 等程序¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-4-ROS%E6%95%99%E7%A8%8B%C2%B6"><span class="toc-text">9.4. ROS教程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E6%98%BE%E7%A4%BA%E6%9E%B6%E6%9E%84%E6%94%AF%E6%8C%81%C2%B6"><span class="toc-text">10. 显示架构支持¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-X11%C2%B6"><span class="toc-text">10.1. X11¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-Qt-EGLFS%C2%B6"><span class="toc-text">10.2. Qt + EGLFS¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-Qt-Wayland%C2%B6"><span class="toc-text">10.3. Qt + Wayland¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-4-None%C2%B6"><span class="toc-text">10.4. None¶</span></a></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>Scroll to Top</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>Join Discussion</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `Just`,
      min: `minutes ago`,
      hour: `hours ago`,
      day: `days ago`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"odeblock":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://raw.staticdn.net/liuluhua/liuluhua.github.io/ImageBed/BlogRes/avatar.jpg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>


<!-- required -->
<script src="/js/main.js?v=1.29.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    applyThemeToGiscus(theme)
  }

  const applyThemeToGiscus = (theme) => {
    theme = theme === 'auto' ? 'preferred_color_scheme' : theme

    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)

    const messages = {
      light: `Switched to Light Mode`,
      dark: `Switched to Dark Mode`,
      auto: `Switched to Auto Mode`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    }
  })()
</script>


<!-- optional -->

  <script type="module">
  const el = document.querySelector("#comments #utterances");
  util.viewportLazyload(el, load_utterances, false);

  function load_utterances() {
    if (!el) return;
    try {
      el.innerHTML = '';
    } catch (error) {
      console.error(error);
    }
    const script = document.createElement('script');
    script.src = 'https://utteranc.es/client.js';
    script.async = true;
    for (const key of Object.keys(el.attributes)) {
      const attr = el.attributes[key];
      if (['class', 'id'].includes(attr.name) === false) {
        script.setAttribute(attr.name, attr.value);
      }
    }
    el.appendChild(script);
  }
</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script><script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?da53de6b993ed1e1aa3bb704f307c05b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- inject -->

</div></body></html>

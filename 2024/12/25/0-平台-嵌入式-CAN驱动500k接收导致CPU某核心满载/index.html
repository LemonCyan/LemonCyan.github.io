
<!DOCTYPE html><html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.1" theme-name="Stellar" theme-version="1.29.1">
  
  <meta name="generator" content="Hexo 7.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  
  <title>CAN驱动500k接收导致CPU某核心满载 - 玲璐</title>

  
    <meta name="description" content="当 CAN 作为接收端时，快速的数据接收会导致 CPU 4 处于满载状态。这种情况在断开 CAN 接口或者外部设备后恢复正常。在 CAN 接收中断中记录的日志显示，日志的打印时间是与接收到的数据的时间紧密相关。接收的数据速率过高可能在某种程度上影响了 CPU 的处理能力，导致其无法有效管理处理器资源，从而出现过载现象。 在驱动程序 rockchip_canfd.c 中禁用 NAPI 后，系统恢复正">
<meta property="og:type" content="article">
<meta property="og:title" content="CAN驱动500k接收导致CPU某核心满载">
<meta property="og:url" content="http://liuluhua.github.io/2024/12/25/0-%E5%B9%B3%E5%8F%B0-%E5%B5%8C%E5%85%A5%E5%BC%8F-CAN%E9%A9%B1%E5%8A%A8500k%E6%8E%A5%E6%94%B6%E5%AF%BC%E8%87%B4CPU%E6%9F%90%E6%A0%B8%E5%BF%83%E6%BB%A1%E8%BD%BD/index.html">
<meta property="og:site_name" content="玲璐">
<meta property="og:description" content="当 CAN 作为接收端时，快速的数据接收会导致 CPU 4 处于满载状态。这种情况在断开 CAN 接口或者外部设备后恢复正常。在 CAN 接收中断中记录的日志显示，日志的打印时间是与接收到的数据的时间紧密相关。接收的数据速率过高可能在某种程度上影响了 CPU 的处理能力，导致其无法有效管理处理器资源，从而出现过载现象。 在驱动程序 rockchip_canfd.c 中禁用 NAPI 后，系统恢复正">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-12-25T02:12:29.000Z">
<meta property="article:modified_time" content="2024-12-25T02:15:12.000Z">
<meta property="article:author" content="liuluhua">
<meta name="twitter:card" content="summary">
  
  
  
  

  <!-- feed -->
  

  <link rel="stylesheet" href="/css/main.css?v=1.29.1">


  

  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/satouriko/LxgwWenKai_Webfonts@v1.101/dist/LXGWWenKaiMono-Bold.css" />
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="https://raw.staticdn.net/liuluhua/liuluhua.github.io/ImageBed/BlogRes/avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">玲璐</div><div class="sub cap">玲璐的充电站</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="Search"></form><div id="search-result"></div><div class="search-no-result">No Results!</div></div>


<nav class="menu dis-select"><a class="nav-item active" title="Qexo" target="_blank" rel="noopener" href="http://124.222.246.202:9083/" style="color:#3DC550"><span>Qexo</span></a><a class="nav-item active" title="Alist" target="_blank" rel="noopener" href="http://124.222.246.202:9084/" style="color:#FA6400"><span>Alist</span></a></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">Recent Update</span></div><div class="widget-body fs14"><a class="item title" href="/2024/12/25/4-%E5%85%B6%E4%BB%96-%E9%87%91%E8%9E%8D-%E5%BC%80%E6%88%B7/"><span class="title">开户</span></a><a class="item title" href="/2024/05/17/3-%E8%BD%AF%E4%BB%B6-Git-1-Git%E4%BB%8B%E7%BB%8D%E5%92%8C%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/"><span class="title">1. Git介绍和基本命令</span></a><a class="item title" href="/2024/12/25/3-%E8%BD%AF%E4%BB%B6-Git-%E5%9C%A8-Git-%E4%B8%AD%E5%BF%BD%E7%95%A5%E6%96%87%E4%BB%B6%E5%92%8C%E6%96%87%E4%BB%B6%E5%A4%B9/"><span class="title">在 Git 中忽略文件和文件夹</span></a><a class="item title" href="/2024/12/25/0-%E5%B9%B3%E5%8F%B0-Linux-%E9%A9%B1%E5%8A%A8-%E4%B8%AD%E6%96%AD%E7%94%B3%E8%AF%B7/"><span class="title">中断申请</span></a><a class="item title" href="/2024/12/25/1-%E8%AF%AD%E8%A8%80-Python-OpenCV-%E5%9B%BE%E7%89%87%E7%9B%B8%E4%BC%BC%E5%BA%A6/"><span class="title">OpenCV 图片相似度</span></a><a class="item title" href="/2024/05/22/1-%E8%AF%AD%E8%A8%80-Python-Web%E9%83%A8%E7%BD%B2/"><span class="title">Web部署</span></a><a class="item title" href="/2024/12/18/1-%E8%AF%AD%E8%A8%80-Python-%E8%B5%84%E6%96%99/"><span class="title">资料</span></a><a class="item title" href="/2024/12/18/1-%E8%AF%AD%E8%A8%80-Python-%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/"><span class="title">学习路线</span></a><a class="item title" href="/2024/07/02/1-%E8%AF%AD%E8%A8%80-Python-%E7%AC%94%E8%AE%B0/"><span class="title">笔记</span></a><a class="item title" href="/2024/05/21/1-%E8%AF%AD%E8%A8%80-Python-%E5%AE%89%E8%A3%85/"><span class="title">安装</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="/" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/08a41b181ce68.svg"/></a><a class="social" href="/" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/3845874.svg"/></a><a class="social" href="/" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/3616429.svg"/></a><a class="social" href="/about/#comments" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/942ebbf1a4b91.svg"/></a><a class="social" onclick="switchTheme()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024"><path fill="currentColor" fill-rule="evenodd" d="M582.4 326.4c-140.8 0-256 115.2-256 256s115.2 256 256 256 256-115.2 256-256-115.2-256-256-256z m0 448c-70.4 0-131.2-36.8-164.8-92.8 12.8 3.2 27.2 4.8 40 4.8 121.6 0 219.2-99.2 219.2-219.2 0-17.6-1.6-35.2-6.4-52.8 60.8 32 102.4 96 102.4 169.6 1.6 104-84.8 190.4-190.4 190.4zM582.4 262.4c17.6 0 32-14.4 32-32v-128c0-17.6-14.4-32-32-32s-32 14.4-32 32v128c0 17.6 14.4 32 32 32zM262.4 582.4c0-17.6-14.4-32-32-32h-128c-17.6 0-32 14.4-32 32s14.4 32 32 32h128c17.6 0 32-14.4 32-32zM310.4 356.8c6.4 6.4 14.4 9.6 22.4 9.6 8 0 16-3.2 22.4-9.6 12.8-12.8 12.8-32 0-44.8l-91.2-91.2c-12.8-12.8-32-12.8-44.8 0-12.8 12.8-12.8 32 0 44.8l91.2 91.2zM944 220.8c-12.8-12.8-32-12.8-44.8 0l-91.2 91.2c-12.8 12.8-12.8 32 0 44.8 6.4 6.4 14.4 9.6 22.4 9.6 8 0 16-3.2 22.4-9.6l91.2-91.2c12.8-12.8 12.8-33.6 0-44.8zM310.4 808l-91.2 91.2c-12.8 12.8-12.8 32 0 44.8 6.4 6.4 14.4 9.6 22.4 9.6 8 0 16-3.2 22.4-9.6l91.2-91.2c12.8-12.8 12.8-32 0-44.8-11.2-11.2-32-11.2-44.8 0z"></path></svg></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">Home</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">Blog</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/0-%E5%B9%B3%E5%8F%B0/">0.平台</a> <span class="sep"></span> <a class="cap breadcrumb-link" href="/categories/0-%E5%B9%B3%E5%8F%B0/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a></div>
<div class="flex-row" id="post-meta"><span class="text created">Posted on: <time datetime="2024-12-25T02:12:29.000Z">2024-12-25</time></span><span class="sep updated"></span><span class="text updated">Updated on: <time datetime="2024-12-25T02:15:12.000Z">2024-12-25</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>CAN驱动500k接收导致CPU某核心满载</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><p>当 CAN 作为接收端时，快速的数据接收会导致 CPU 4 处于满载状态。这种情况在断开 CAN 接口或者外部设备后恢复正常。在 CAN 接收中断中记录的日志显示，日志的打印时间是与接收到的数据的时间紧密相关。接收的数据速率过高可能在某种程度上影响了 CPU 的处理能力，导致其无法有效管理处理器资源，从而出现过载现象。</p>
<p>在驱动程序 <code>rockchip_canfd.c</code> 中禁用 NAPI 后，系统恢复正常。NAPI（新型自适应中断处理机制）旨在提高网络处理性能，针对不同硬件和软件环境，NAPI 的效果和表现可能存在差异，可能不是最佳选择。</p>
<p>例如，某些硬件可能原本设计用于处理低速率数据，这就使得在高速数据接收时，即便使用了 NAPI，反而会因频繁的中断和处理导致 CPU 负载过重，最终引发性能瓶颈。在这样的情况下，可能需要重新评估数据接收和中断管理策略，为特定的硬件环境优化接收方案或中断处理方式。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: GPL-2.0</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2020 Rockchip Electronics Co. Ltd.</span></span><br><span class="line"><span class="comment"> * Rockchip CANFD driver</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/iopoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/pinctrl/consumer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/clk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/interrupt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/netdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/skbuff.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/spinlock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/can/dev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/can/error.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/can/led.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/reset.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/pm_runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/rockchip/cpu.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* registers definition */</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">rockchip_canfd_reg</span> &#123;</span><br><span class="line">	CAN_MODE = <span class="number">0x00</span>,</span><br><span class="line">	CAN_CMD = <span class="number">0x04</span>,</span><br><span class="line">	CAN_STATE = <span class="number">0x08</span>,</span><br><span class="line">	CAN_INT = <span class="number">0x0c</span>,</span><br><span class="line">	CAN_INT_MASK = <span class="number">0x10</span>,</span><br><span class="line">	CAN_LOSTARB_CODE = <span class="number">0x28</span>,</span><br><span class="line">	CAN_ERR_CODE = <span class="number">0x2c</span>,</span><br><span class="line">	CAN_RX_ERR_CNT = <span class="number">0x34</span>,</span><br><span class="line">	CAN_TX_ERR_CNT = <span class="number">0x38</span>,</span><br><span class="line">	CAN_IDCODE = <span class="number">0x3c</span>,</span><br><span class="line">	CAN_IDMASK = <span class="number">0x40</span>,</span><br><span class="line">	CAN_TX_CHECK_FIC = <span class="number">0x50</span>,</span><br><span class="line">	CAN_NBTP = <span class="number">0x100</span>,</span><br><span class="line">	CAN_DBTP = <span class="number">0x104</span>,</span><br><span class="line">	CAN_TDCR = <span class="number">0x108</span>,</span><br><span class="line">	CAN_TSCC = <span class="number">0x10c</span>,</span><br><span class="line">	CAN_TSCV = <span class="number">0x110</span>,</span><br><span class="line">	CAN_TXEFC = <span class="number">0x114</span>,</span><br><span class="line">	CAN_RXFC = <span class="number">0x118</span>,</span><br><span class="line">	CAN_AFC = <span class="number">0x11c</span>,</span><br><span class="line">	CAN_IDCODE0 = <span class="number">0x120</span>,</span><br><span class="line">	CAN_IDMASK0 = <span class="number">0x124</span>,</span><br><span class="line">	CAN_IDCODE1 = <span class="number">0x128</span>,</span><br><span class="line">	CAN_IDMASK1 = <span class="number">0x12c</span>,</span><br><span class="line">	CAN_IDCODE2 = <span class="number">0x130</span>,</span><br><span class="line">	CAN_IDMASK2 = <span class="number">0x134</span>,</span><br><span class="line">	CAN_IDCODE3 = <span class="number">0x138</span>,</span><br><span class="line">	CAN_IDMASK3 = <span class="number">0x13c</span>,</span><br><span class="line">	CAN_IDCODE4 = <span class="number">0x140</span>,</span><br><span class="line">	CAN_IDMASK4 = <span class="number">0x144</span>,</span><br><span class="line">	CAN_TXFIC = <span class="number">0x200</span>,</span><br><span class="line">	CAN_TXID = <span class="number">0x204</span>,</span><br><span class="line">	CAN_TXDAT0 = <span class="number">0x208</span>,</span><br><span class="line">	CAN_TXDAT1 = <span class="number">0x20c</span>,</span><br><span class="line">	CAN_TXDAT2 = <span class="number">0x210</span>,</span><br><span class="line">	CAN_TXDAT3 = <span class="number">0x214</span>,</span><br><span class="line">	CAN_TXDAT4 = <span class="number">0x218</span>,</span><br><span class="line">	CAN_TXDAT5 = <span class="number">0x21c</span>,</span><br><span class="line">	CAN_TXDAT6 = <span class="number">0x220</span>,</span><br><span class="line">	CAN_TXDAT7 = <span class="number">0x224</span>,</span><br><span class="line">	CAN_TXDAT8 = <span class="number">0x228</span>,</span><br><span class="line">	CAN_TXDAT9 = <span class="number">0x22c</span>,</span><br><span class="line">	CAN_TXDAT10 = <span class="number">0x230</span>,</span><br><span class="line">	CAN_TXDAT11 = <span class="number">0x234</span>,</span><br><span class="line">	CAN_TXDAT12 = <span class="number">0x238</span>,</span><br><span class="line">	CAN_TXDAT13 = <span class="number">0x23c</span>,</span><br><span class="line">	CAN_TXDAT14 = <span class="number">0x240</span>,</span><br><span class="line">	CAN_TXDAT15 = <span class="number">0x244</span>,</span><br><span class="line">	CAN_RXFIC = <span class="number">0x300</span>,</span><br><span class="line">	CAN_RXID = <span class="number">0x304</span>,</span><br><span class="line">	CAN_RXTS = <span class="number">0x308</span>,</span><br><span class="line">	CAN_RXDAT0 = <span class="number">0x30c</span>,</span><br><span class="line">	CAN_RXDAT1 = <span class="number">0x310</span>,</span><br><span class="line">	CAN_RXDAT2 = <span class="number">0x314</span>,</span><br><span class="line">	CAN_RXDAT3 = <span class="number">0x318</span>,</span><br><span class="line">	CAN_RXDAT4 = <span class="number">0x31c</span>,</span><br><span class="line">	CAN_RXDAT5 = <span class="number">0x320</span>,</span><br><span class="line">	CAN_RXDAT6 = <span class="number">0x324</span>,</span><br><span class="line">	CAN_RXDAT7 = <span class="number">0x328</span>,</span><br><span class="line">	CAN_RXDAT8 = <span class="number">0x32c</span>,</span><br><span class="line">	CAN_RXDAT9 = <span class="number">0x330</span>,</span><br><span class="line">	CAN_RXDAT10 = <span class="number">0x334</span>,</span><br><span class="line">	CAN_RXDAT11 = <span class="number">0x338</span>,</span><br><span class="line">	CAN_RXDAT12 = <span class="number">0x33c</span>,</span><br><span class="line">	CAN_RXDAT13 = <span class="number">0x340</span>,</span><br><span class="line">	CAN_RXDAT14 = <span class="number">0x344</span>,</span><br><span class="line">	CAN_RXDAT15 = <span class="number">0x348</span>,</span><br><span class="line">	CAN_RXFRD = <span class="number">0x400</span>,</span><br><span class="line">	CAN_TXEFRD = <span class="number">0x500</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">	ROCKCHIP_CANFD_MODE = <span class="number">0</span>,</span><br><span class="line">	ROCKCHIP_CAN_MODE,</span><br><span class="line">	ROCKCHIP_RK3568_CAN_MODE,</span><br><span class="line">	ROCKCHIP_RK3568_CAN_MODE_V2,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DATE_LENGTH_12_BYTE	(0x9)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DATE_LENGTH_16_BYTE	(0xa)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DATE_LENGTH_20_BYTE	(0xb)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DATE_LENGTH_24_BYTE	(0xc)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DATE_LENGTH_32_BYTE	(0xd)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DATE_LENGTH_48_BYTE	(0xe)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DATE_LENGTH_64_BYTE	(0xf)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAN_TX0_REQ		BIT(0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAN_TX1_REQ		BIT(1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAN_TX_REQ_FULL		((CAN_TX0_REQ) | (CAN_TX1_REQ))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODE_FDOE		BIT(15)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODE_BRSD		BIT(13)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODE_SPACE_RX		BIT(12)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODE_AUTO_RETX		BIT(10)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODE_RXSORT		BIT(7)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODE_TXORDER		BIT(6)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODE_RXSTX		BIT(5)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODE_LBACK		BIT(4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODE_SILENT		BIT(3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODE_SELF_TEST		BIT(2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODE_SLEEP		BIT(1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RESET_MODE		0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WORK_MODE		BIT(0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RX_FINISH_INT		BIT(0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TX_FINISH_INT		BIT(1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERR_WARN_INT		BIT(2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RX_BUF_OV_INT		BIT(3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PASSIVE_ERR_INT		BIT(4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TX_LOSTARB_INT		BIT(5)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUS_ERR_INT		BIT(6)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RX_FIFO_FULL_INT	BIT(7)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RX_FIFO_OV_INT		BIT(8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUS_OFF_INT		BIT(9)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUS_OFF_RECOVERY_INT	BIT(10)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TSC_OV_INT		BIT(11)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TXE_FIFO_OV_INT		BIT(12)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TXE_FIFO_FULL_INT	BIT(13)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WAKEUP_INT		BIT(14)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERR_TYPE_MASK		GENMASK(28, 26)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERR_TYPE_SHIFT		26</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BIT_ERR			0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STUFF_ERR		1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FORM_ERR		2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACK_ERR			3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRC_ERR			4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERR_DIR_RX		BIT(25)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERR_LOC_MASK		GENMASK(15, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Nominal Bit Timing &amp; Prescaler Register (NBTP) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NBTP_MODE_3_SAMPLES	BIT(31)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NBTP_NSJW_SHIFT		24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NBTP_NSJW_MASK		(0x7f &lt;&lt; NBTP_NSJW_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NBTP_NBRP_SHIFT		16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NBTP_NBRP_MASK		(0xff &lt;&lt; NBTP_NBRP_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NBTP_NTSEG2_SHIFT	8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NBTP_NTSEG2_MASK	(0x7f &lt;&lt; NBTP_NTSEG2_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NBTP_NTSEG1_SHIFT	0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NBTP_NTSEG1_MASK	(0x7f &lt;&lt; NBTP_NTSEG1_SHIFT)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Data Bit Timing &amp; Prescaler Register (DBTP) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBTP_MODE_3_SAMPLES	BIT(21)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBTP_DSJW_SHIFT		17</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBTP_DSJW_MASK		(0xf &lt;&lt; DBTP_DSJW_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBTP_DBRP_SHIFT		9</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBTP_DBRP_MASK		(0xff &lt;&lt; DBTP_DBRP_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBTP_DTSEG2_SHIFT	5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBTP_DTSEG2_MASK	(0xf &lt;&lt; DBTP_DTSEG2_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBTP_DTSEG1_SHIFT	0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBTP_DTSEG1_MASK	(0x1f &lt;&lt; DBTP_DTSEG1_SHIFT)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Transmitter Delay Compensation Register (TDCR) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TDCR_TDCO_SHIFT		1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TDCR_TDCO_MASK		(0x3f &lt;&lt; TDCR_TDCO_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TDCR_TDC_ENABLE		BIT(0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TX_FD_ENABLE		BIT(5)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TX_FD_BRS_ENABLE	BIT(4)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIFO_ENABLE		BIT(0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RX_FIFO_CNT0_SHIFT	4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RX_FIFO_CNT0_MASK	(0x7 &lt;&lt; RX_FIFO_CNT0_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RX_FIFO_CNT1_SHIFT	5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RX_FIFO_CNT1_MASK	(0x7 &lt;&lt; RX_FIFO_CNT1_SHIFT)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FORMAT_SHIFT		7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FORMAT_MASK		(0x1 &lt;&lt; FORMAT_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTR_SHIFT		6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTR_MASK		(0x1 &lt;&lt; RTR_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FDF_SHIFT		5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FDF_MASK		(0x1 &lt;&lt; FDF_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BRS_SHIFT		4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BRS_MASK		(0x1 &lt;&lt; BRS_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DLC_SHIFT		0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DLC_MASK		(0xF &lt;&lt; DLC_SHIFT)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAN_RF_SIZE		0x48</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAN_TEF_SIZE		0x8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAN_TXEFRD_OFFSET(n)	(CAN_TXEFRD + CAN_TEF_SIZE * (n))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAN_RXFRD_OFFSET(n)	(CAN_RXFRD + CAN_RF_SIZE * (n))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAN_RX_FILTER_MASK	0x1fffffff</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NOACK_ERR_FLAG		0xc200800</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAN_BUSOFF_FLAG		0x20</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DRV_NAME	<span class="string">&quot;rockchip_canfd&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* rockchip_canfd private data structure */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> &#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">can_priv</span> can;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">device</span> *dev;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">napi_struct</span> napi;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">clk_bulk_data</span> *clks;</span><br><span class="line">	<span class="type">int</span> num_clks;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">reset_control</span> *reset;</span><br><span class="line">	<span class="type">void</span> __iomem *base;</span><br><span class="line">	u32 irqstatus;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> mode;</span><br><span class="line">	<span class="type">int</span> rx_fifo_shift;</span><br><span class="line">	u32 rx_fifo_mask;</span><br><span class="line">	<span class="type">bool</span> txtorx;</span><br><span class="line">	u32 tx_invalid[<span class="number">4</span>];</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">delayed_work</span> tx_err_work;</span><br><span class="line">	u32 noack_cnt;</span><br><span class="line">	u32 delay_time_ms;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> u32 <span class="title">rockchip_canfd_read</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> rockchip_canfd *priv,</span></span></span><br><span class="line"><span class="params"><span class="function">				      <span class="keyword">enum</span> rockchip_canfd_reg reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">readl</span>(priv-&gt;base + reg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">rockchip_canfd_write</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> rockchip_canfd *priv,</span></span></span><br><span class="line"><span class="params"><span class="function">					<span class="keyword">enum</span> rockchip_canfd_reg reg, u32 val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">writel</span>(val, priv-&gt;base + reg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">can_bittiming_const</span> rockchip_canfd_bittiming_const = &#123;</span><br><span class="line">	.name = DRV_NAME,</span><br><span class="line">	.tseg1_min = <span class="number">1</span>,</span><br><span class="line">	.tseg1_max = <span class="number">128</span>,</span><br><span class="line">	.tseg2_min = <span class="number">1</span>,</span><br><span class="line">	.tseg2_max = <span class="number">128</span>,</span><br><span class="line">	.sjw_max = <span class="number">128</span>,</span><br><span class="line">	.brp_min = <span class="number">1</span>,</span><br><span class="line">	.brp_max = <span class="number">256</span>,</span><br><span class="line">	.brp_inc = <span class="number">2</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">can_bittiming_const</span> rockchip_canfd_data_bittiming_const = &#123;</span><br><span class="line">	.name = DRV_NAME,</span><br><span class="line">	.tseg1_min = <span class="number">1</span>,</span><br><span class="line">	.tseg1_max = <span class="number">32</span>,</span><br><span class="line">	.tseg2_min = <span class="number">1</span>,</span><br><span class="line">	.tseg2_max = <span class="number">16</span>,</span><br><span class="line">	.sjw_max = <span class="number">16</span>,</span><br><span class="line">	.brp_min = <span class="number">1</span>,</span><br><span class="line">	.brp_max = <span class="number">256</span>,</span><br><span class="line">	.brp_inc = <span class="number">2</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">set_reset_mode</span><span class="params">(<span class="keyword">struct</span> net_device *ndev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">reset_control_assert</span>(rcan-&gt;reset);</span><br><span class="line">	<span class="built_in">udelay</span>(<span class="number">2</span>);</span><br><span class="line">	<span class="built_in">reset_control_deassert</span>(rcan-&gt;reset);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_MODE, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">netdev_dbg</span>(ndev, <span class="string">&quot;%s MODE=0x%08x\n&quot;</span>, __func__,</span><br><span class="line">		   <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_MODE));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">set_normal_mode</span><span class="params">(<span class="keyword">struct</span> net_device *ndev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line">	u32 val;</span><br><span class="line"></span><br><span class="line">	val = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_MODE);</span><br><span class="line">	val |= WORK_MODE;</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_MODE, val);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">netdev_dbg</span>(ndev, <span class="string">&quot;%s MODE=0x%08x\n&quot;</span>, __func__,</span><br><span class="line">		   <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_MODE));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bittiming is called in reset_mode only */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rockchip_canfd_set_bittiming</span><span class="params">(<span class="keyword">struct</span> net_device *ndev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line">	<span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">can_bittiming</span> *bt = &amp;rcan-&gt;can.bittiming;</span><br><span class="line">	<span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">can_bittiming</span> *dbt = &amp;rcan-&gt;can.data_bittiming;</span><br><span class="line">	u16 brp, sjw, tseg1, tseg2;</span><br><span class="line">	u32 reg_btp;</span><br><span class="line"></span><br><span class="line">	brp = (bt-&gt;brp &gt;&gt; <span class="number">1</span>) - <span class="number">1</span>;</span><br><span class="line">	sjw = bt-&gt;sjw - <span class="number">1</span>;</span><br><span class="line">	tseg1 = bt-&gt;prop_seg + bt-&gt;phase_seg1 - <span class="number">1</span>;</span><br><span class="line">	tseg2 = bt-&gt;phase_seg2 - <span class="number">1</span>;</span><br><span class="line">	reg_btp = (brp &lt;&lt; NBTP_NBRP_SHIFT) | (sjw &lt;&lt; NBTP_NSJW_SHIFT) |</span><br><span class="line">		  (tseg1 &lt;&lt; NBTP_NTSEG1_SHIFT) |</span><br><span class="line">		  (tseg2 &lt;&lt; NBTP_NTSEG2_SHIFT);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rcan-&gt;can.ctrlmode &amp; CAN_CTRLMODE_3_SAMPLES)</span><br><span class="line">		reg_btp |= NBTP_MODE_3_SAMPLES;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_NBTP, reg_btp);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rcan-&gt;can.ctrlmode &amp; CAN_CTRLMODE_FD) &#123;</span><br><span class="line">		reg_btp = <span class="number">0</span>;</span><br><span class="line">		brp = (dbt-&gt;brp &gt;&gt; <span class="number">1</span>) - <span class="number">1</span>;</span><br><span class="line">		sjw = dbt-&gt;sjw - <span class="number">1</span>;</span><br><span class="line">		tseg1 = dbt-&gt;prop_seg + dbt-&gt;phase_seg1 - <span class="number">1</span>;</span><br><span class="line">		tseg2 = dbt-&gt;phase_seg2 - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (dbt-&gt;bitrate &gt; <span class="number">2200000</span>) &#123;</span><br><span class="line">			u32 tdco;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* Equation based on Bosch&#x27;s ROCKCHIP_CAN User Manual&#x27;s</span></span><br><span class="line"><span class="comment">			 * Transmitter Delay Compensation Section</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			tdco = (rcan-&gt;can.clock.freq / dbt-&gt;bitrate) * <span class="number">2</span> / <span class="number">3</span>;</span><br><span class="line">			<span class="comment">/* Max valid TDCO value is 63 */</span></span><br><span class="line">			<span class="keyword">if</span> (tdco &gt; <span class="number">63</span>)</span><br><span class="line">				tdco = <span class="number">63</span>;</span><br><span class="line"></span><br><span class="line">			<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_TDCR,</span><br><span class="line">					     (tdco &lt;&lt; TDCR_TDCO_SHIFT) |</span><br><span class="line">					     TDCR_TDC_ENABLE);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		reg_btp |= (brp &lt;&lt; DBTP_DBRP_SHIFT) |</span><br><span class="line">			   (sjw &lt;&lt; DBTP_DSJW_SHIFT) |</span><br><span class="line">			   (tseg1 &lt;&lt; DBTP_DTSEG1_SHIFT) |</span><br><span class="line">			   (tseg2 &lt;&lt; DBTP_DTSEG2_SHIFT);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (rcan-&gt;can.ctrlmode &amp; CAN_CTRLMODE_3_SAMPLES)</span><br><span class="line">			reg_btp |= DBTP_MODE_3_SAMPLES;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_DBTP, reg_btp);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (bt-&gt;bitrate &gt; <span class="number">200000</span>)</span><br><span class="line">		rcan-&gt;delay_time_ms = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (bt-&gt;bitrate &gt; <span class="number">50000</span>)</span><br><span class="line">		rcan-&gt;delay_time_ms = <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		rcan-&gt;delay_time_ms = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">netdev_dbg</span>(ndev, <span class="string">&quot;%s NBTP=0x%08x, DBTP=0x%08x, TDCR=0x%08x\n&quot;</span>, __func__,</span><br><span class="line">		   <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_NBTP),</span><br><span class="line">		   <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_DBTP),</span><br><span class="line">		   <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_TDCR));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rockchip_canfd_get_berr_counter</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> net_device *ndev,</span></span></span><br><span class="line"><span class="params"><span class="function">					   <span class="keyword">struct</span> can_berr_counter *bec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	err = <span class="built_in">pm_runtime_get_sync</span>(rcan-&gt;dev);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">netdev_err</span>(ndev, <span class="string">&quot;%s: pm_runtime_get failed(%d)\n&quot;</span>,</span><br><span class="line">			   __func__, err);</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	bec-&gt;rxerr = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_RX_ERR_CNT);</span><br><span class="line">	bec-&gt;txerr = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_TX_ERR_CNT);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">pm_runtime_put</span>(rcan-&gt;dev);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">netdev_dbg</span>(ndev, <span class="string">&quot;%s RX_ERR_CNT=0x%08x, TX_ERR_CNT=0x%08x\n&quot;</span>, __func__,</span><br><span class="line">		   <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_RX_ERR_CNT),</span><br><span class="line">		   <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_TX_ERR_CNT));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rockchip_canfd_start</span><span class="params">(<span class="keyword">struct</span> net_device *ndev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line">	u32 val;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* we need to enter the reset mode */</span></span><br><span class="line">	<span class="built_in">set_reset_mode</span>(ndev);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_INT_MASK, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* RECEIVING FILTER, accept all */</span></span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_IDCODE, <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_IDMASK, CAN_RX_FILTER_MASK);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_IDCODE0, <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_IDMASK0, CAN_RX_FILTER_MASK);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_IDCODE1, <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_IDMASK1, CAN_RX_FILTER_MASK);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_IDCODE2, <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_IDMASK2, CAN_RX_FILTER_MASK);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_IDCODE3, <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_IDMASK3, CAN_RX_FILTER_MASK);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_IDCODE4, <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_IDMASK4, CAN_RX_FILTER_MASK);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* set mode */</span></span><br><span class="line">	val = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_MODE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* rx fifo enable */</span></span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_RXFC,</span><br><span class="line">			     <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_RXFC) | FIFO_ENABLE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Mode */</span></span><br><span class="line">	val |= MODE_FDOE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Loopback Mode */</span></span><br><span class="line">	<span class="keyword">if</span> (rcan-&gt;can.ctrlmode &amp; CAN_CTRLMODE_LOOPBACK)</span><br><span class="line">		val |= MODE_SELF_TEST | MODE_LBACK;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Listen-only mode */</span></span><br><span class="line">	<span class="keyword">if</span> (rcan-&gt;can.ctrlmode &amp; CAN_CTRLMODE_LISTENONLY)</span><br><span class="line">		val |= MODE_SILENT;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_MODE, val);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">rockchip_canfd_set_bittiming</span>(ndev);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">set_normal_mode</span>(ndev);</span><br><span class="line"></span><br><span class="line">	rcan-&gt;can.state = CAN_STATE_ERROR_ACTIVE;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">netdev_dbg</span>(ndev, <span class="string">&quot;%s MODE=0x%08x, INT_MASK=0x%08x\n&quot;</span>, __func__,</span><br><span class="line">		   <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_MODE),</span><br><span class="line">		   <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_INT_MASK));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rockchip_canfd_stop</span><span class="params">(<span class="keyword">struct</span> net_device *ndev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line"></span><br><span class="line">	rcan-&gt;can.state = CAN_STATE_STOPPED;</span><br><span class="line">	<span class="comment">/* we need to enter reset mode */</span></span><br><span class="line">	<span class="built_in">set_reset_mode</span>(ndev);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* disable all interrupts */</span></span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_INT_MASK, <span class="number">0xffff</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">netdev_dbg</span>(ndev, <span class="string">&quot;%s MODE=0x%08x, INT_MASK=0x%08x\n&quot;</span>, __func__,</span><br><span class="line">		   <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_MODE),</span><br><span class="line">		   <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_INT_MASK));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rockchip_canfd_set_mode</span><span class="params">(<span class="keyword">struct</span> net_device *ndev,</span></span></span><br><span class="line"><span class="params"><span class="function">				   <span class="keyword">enum</span> can_mode mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">	<span class="keyword">case</span> CAN_MODE_START:</span><br><span class="line">		err = <span class="built_in">rockchip_canfd_start</span>(ndev);</span><br><span class="line">		<span class="keyword">if</span> (err) &#123;</span><br><span class="line">			<span class="built_in">netdev_err</span>(ndev, <span class="string">&quot;starting CAN controller failed!\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">netif_queue_stopped</span>(ndev))</span><br><span class="line">			<span class="built_in">netif_wake_queue</span>(ndev);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">rockchip_canfd_tx_err_delay_work</span><span class="params">(<span class="keyword">struct</span> work_struct *work)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan =</span><br><span class="line">		<span class="built_in">container_of</span>(work, <span class="keyword">struct</span> rockchip_canfd, tx_err_work.work);</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">net_device</span> *ndev = <span class="built_in">dev_get_drvdata</span>(rcan-&gt;dev);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_MODE,</span><br><span class="line">				     <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_MODE) | MODE_SPACE_RX);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_CMD, CAN_TX0_REQ);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_MODE,</span><br><span class="line">				     <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_MODE) &amp; (~MODE_SPACE_RX));</span><br><span class="line">	rcan-&gt;noack_cnt++;</span><br><span class="line">	<span class="built_in">schedule_delayed_work</span>(&amp;rcan-&gt;tx_err_work, <span class="built_in">msecs_to_jiffies</span>(rcan-&gt;delay_time_ms));</span><br><span class="line">	<span class="keyword">if</span> (rcan-&gt;noack_cnt &gt; <span class="number">50</span>) &#123;</span><br><span class="line">		<span class="built_in">cancel_delayed_work</span>(&amp;rcan-&gt;tx_err_work);</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_INT_MASK, <span class="number">0xffff</span>);</span><br><span class="line">		<span class="built_in">can_bus_off</span>(ndev);</span><br><span class="line">		rcan-&gt;noack_cnt = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* transmit a CAN message</span></span><br><span class="line"><span class="comment"> * message layout in the sk_buff should be like this:</span></span><br><span class="line"><span class="comment"> * xx xx xx xx         ff         ll 00 11 22 33 44 55 66 77</span></span><br><span class="line"><span class="comment"> * [ can_id ] [flags] [len] [can data (up to 8 bytes]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rockchip_canfd_start_xmit</span><span class="params">(<span class="keyword">struct</span> sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">				     <span class="keyword">struct</span> net_device *ndev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">canfd_frame</span> *cf = (<span class="keyword">struct</span> canfd_frame *)skb-&gt;data;</span><br><span class="line">	u32 id, dlc;</span><br><span class="line">	u32 cmd = CAN_TX0_REQ;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">can_dropped_invalid_skb</span>(ndev, skb))</span><br><span class="line">		<span class="keyword">return</span> NETDEV_TX_OK;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">netif_stop_queue</span>(ndev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">rockchip_canfd_read</span>(rcan, CAN_CMD) &amp; CAN_TX0_REQ)</span><br><span class="line">		cmd = CAN_TX1_REQ;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Watch carefully on the bit sequence */</span></span><br><span class="line">	<span class="keyword">if</span> (cf-&gt;can_id &amp; CAN_EFF_FLAG) &#123;</span><br><span class="line">		<span class="comment">/* Extended CAN ID format */</span></span><br><span class="line">		id = cf-&gt;can_id &amp; CAN_EFF_MASK;</span><br><span class="line">		dlc = <span class="built_in">can_len2dlc</span>(cf-&gt;len) &amp; DLC_MASK;</span><br><span class="line">		dlc |= FORMAT_MASK;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Extended frames remote TX request */</span></span><br><span class="line">		<span class="keyword">if</span> (cf-&gt;can_id &amp; CAN_RTR_FLAG)</span><br><span class="line">			dlc |= RTR_MASK;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* Standard CAN ID format */</span></span><br><span class="line">		id = cf-&gt;can_id &amp; CAN_SFF_MASK;</span><br><span class="line">		dlc = <span class="built_in">can_len2dlc</span>(cf-&gt;len) &amp; DLC_MASK;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Standard frames remote TX request */</span></span><br><span class="line">		<span class="keyword">if</span> (cf-&gt;can_id &amp; CAN_RTR_FLAG)</span><br><span class="line">			dlc |= RTR_MASK;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((rcan-&gt;can.ctrlmode &amp; CAN_CTRLMODE_FD) &amp;&amp; <span class="built_in">can_is_canfd_skb</span>(skb)) &#123;</span><br><span class="line">		dlc |= TX_FD_ENABLE;</span><br><span class="line">		<span class="keyword">if</span> (cf-&gt;flags &amp; CANFD_BRS)</span><br><span class="line">			dlc |= TX_FD_BRS_ENABLE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rcan-&gt;txtorx &amp;&amp; rcan-&gt;mode &lt;= ROCKCHIP_RK3568_CAN_MODE &amp;&amp; cf-&gt;can_id &amp; CAN_EFF_FLAG)</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_MODE,</span><br><span class="line">				     <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_MODE) | MODE_RXSTX);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_MODE,</span><br><span class="line">				     <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_MODE) &amp; (~MODE_RXSTX));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!rcan-&gt;txtorx &amp;&amp; rcan-&gt;mode &lt;= ROCKCHIP_RK3568_CAN_MODE &amp;&amp; cf-&gt;can_id &amp; CAN_EFF_FLAG) &#123;</span><br><span class="line">		<span class="comment">/* Two frames are sent consecutively.</span></span><br><span class="line"><span class="comment">		 * Before the first frame is tx finished,</span></span><br><span class="line"><span class="comment">		 * the register of the second frame is configured.</span></span><br><span class="line"><span class="comment">		 * Don&#x27;t be interrupted in the middle.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="built_in">local_irq_save</span>(flags);</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_TXID, rcan-&gt;tx_invalid[<span class="number">1</span>]);</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_TXFIC, rcan-&gt;tx_invalid[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_TXDAT0, rcan-&gt;tx_invalid[<span class="number">2</span>]);</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_TXDAT1, rcan-&gt;tx_invalid[<span class="number">3</span>]);</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_CMD, CAN_TX0_REQ);</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_TXID, id);</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_TXFIC, dlc);</span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cf-&gt;len; i += <span class="number">4</span>)</span><br><span class="line">			<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_TXDAT0 + i,</span><br><span class="line">					     *(u32 *)(cf-&gt;data + i));</span><br><span class="line">		<span class="built_in">can_put_echo_skb</span>(skb, ndev, <span class="number">0</span>);</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_CMD, CAN_TX1_REQ);</span><br><span class="line">		<span class="built_in">local_irq_restore</span>(flags);</span><br><span class="line">		<span class="keyword">return</span> NETDEV_TX_OK;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_TXID, id);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_TXFIC, dlc);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cf-&gt;len; i += <span class="number">4</span>)</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_TXDAT0 + i,</span><br><span class="line">				     *(u32 *)(cf-&gt;data + i));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">can_put_echo_skb</span>(skb, ndev, <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_MODE,</span><br><span class="line">			     <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_MODE) | MODE_SPACE_RX);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_CMD, cmd);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_MODE,</span><br><span class="line">			     <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_MODE) &amp; (~MODE_SPACE_RX));</span><br><span class="line">	<span class="built_in">schedule_delayed_work</span>(&amp;rcan-&gt;tx_err_work, <span class="built_in">msecs_to_jiffies</span>(rcan-&gt;delay_time_ms));</span><br><span class="line">	<span class="keyword">return</span> NETDEV_TX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rockchip_canfd_rx</span><span class="params">(<span class="keyword">struct</span> net_device *ndev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">net_device_stats</span> *stats = &amp;ndev-&gt;stats;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">canfd_frame</span> *cf;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">sk_buff</span> *skb;</span><br><span class="line">	u32 id_rockchip_canfd, dlc;</span><br><span class="line">	<span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">	u32 __maybe_unused ts, ret;</span><br><span class="line">	u32 data[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">	dlc = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_RXFRD);</span><br><span class="line">	id_rockchip_canfd = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_RXFRD);</span><br><span class="line">	ts = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_RXFRD);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="built_in">ARRAY_SIZE</span>(data); i++)</span><br><span class="line">		data[i] = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_RXFRD);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rcan-&gt;mode &lt;= ROCKCHIP_RK3568_CAN_MODE) &#123;</span><br><span class="line">		<span class="comment">/* may be an empty frame */</span></span><br><span class="line">		<span class="keyword">if</span> (!dlc &amp;&amp; !id_rockchip_canfd)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (rcan-&gt;txtorx) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">rockchip_canfd_read</span>(rcan, CAN_TX_CHECK_FIC) &amp; FORMAT_MASK) &#123;</span><br><span class="line">				ret = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_TXID) &amp; CAN_SFF_MASK;</span><br><span class="line">				<span class="keyword">if</span> ((id_rockchip_canfd == ret) &amp;&amp; !(dlc &amp; FORMAT_MASK))</span><br><span class="line">					<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_TX_CHECK_FIC,</span><br><span class="line">							     ts | CAN_TX0_REQ);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* create zero&#x27;ed CAN frame buffer */</span></span><br><span class="line">	<span class="keyword">if</span> (dlc &amp; FDF_MASK)</span><br><span class="line">		skb = <span class="built_in">alloc_canfd_skb</span>(ndev, &amp;cf);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		skb = <span class="built_in">alloc_can_skb</span>(ndev, (<span class="keyword">struct</span> can_frame **)&amp;cf);</span><br><span class="line">	<span class="keyword">if</span> (!skb) &#123;</span><br><span class="line">		stats-&gt;rx_dropped++;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Change CAN data length format to socketCAN data format */</span></span><br><span class="line">	<span class="keyword">if</span> (dlc &amp; FDF_MASK)</span><br><span class="line">		cf-&gt;len = <span class="built_in">can_dlc2len</span>(dlc &amp; DLC_MASK);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		cf-&gt;len = <span class="built_in">get_can_dlc</span>(dlc &amp; DLC_MASK);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Change CAN ID format to socketCAN ID format */</span></span><br><span class="line">	<span class="keyword">if</span> (dlc &amp; FORMAT_MASK) &#123;</span><br><span class="line">		<span class="comment">/* The received frame is an Extended format frame */</span></span><br><span class="line">		cf-&gt;can_id = id_rockchip_canfd;</span><br><span class="line">		cf-&gt;can_id |= CAN_EFF_FLAG;</span><br><span class="line">		<span class="keyword">if</span> (dlc &amp; RTR_MASK)</span><br><span class="line">			cf-&gt;can_id |= CAN_RTR_FLAG;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* The received frame is a standard format frame */</span></span><br><span class="line">		cf-&gt;can_id = id_rockchip_canfd;</span><br><span class="line">		<span class="keyword">if</span> (dlc &amp; RTR_MASK)</span><br><span class="line">			cf-&gt;can_id |= CAN_RTR_FLAG;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dlc &amp; BRS_MASK)</span><br><span class="line">		cf-&gt;flags |= CANFD_BRS;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!(cf-&gt;can_id &amp; CAN_RTR_FLAG)) &#123;</span><br><span class="line">		<span class="comment">/* Change CAN data format to socketCAN data format */</span></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cf-&gt;len; i += <span class="number">4</span>)</span><br><span class="line">			*(u32 *)(cf-&gt;data + i) = data[i / <span class="number">4</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	stats-&gt;rx_packets++;</span><br><span class="line">	stats-&gt;rx_bytes += cf-&gt;len;</span><br><span class="line">	<span class="built_in">netif_rx</span>(skb);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">can_led_event</span>(ndev, CAN_LED_EVENT_RX);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rockchip_canfd_get_rx_fifo_cnt</span><span class="params">(<span class="keyword">struct</span> net_device *ndev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line">	<span class="type">int</span> quota = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">read_poll_timeout_atomic</span>(rockchip_canfd_read, quota,</span><br><span class="line">				     (quota &amp; rcan-&gt;rx_fifo_mask) &gt;&gt; rcan-&gt;rx_fifo_shift,</span><br><span class="line">				     <span class="number">0</span>, <span class="number">500000</span>, <span class="literal">false</span>, rcan, CAN_RXFC))</span><br><span class="line">		<span class="built_in">netdev_dbg</span>(ndev, <span class="string">&quot;Warning: get fifo cnt failed\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	quota = (quota &amp; rcan-&gt;rx_fifo_mask) &gt;&gt; rcan-&gt;rx_fifo_shift;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> quota;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* rockchip_canfd_rx_poll - Poll routine for rx packets (NAPI)</span></span><br><span class="line"><span class="comment"> * @napi:	napi structure pointer</span></span><br><span class="line"><span class="comment"> * @quota:	Max number of rx packets to be processed.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This is the poll routine for rx part.</span></span><br><span class="line"><span class="comment"> * It will process the packets maximux quota value.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return: number of packets received</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rockchip_canfd_rx_poll</span><span class="params">(<span class="keyword">struct</span> napi_struct *napi, <span class="type">int</span> quota)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">net_device</span> *ndev = napi-&gt;dev;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line">	<span class="type">int</span> work_done = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	quota = <span class="built_in">rockchip_canfd_get_rx_fifo_cnt</span>(ndev);</span><br><span class="line">	<span class="keyword">if</span> (quota &gt; <span class="number">6</span>)</span><br><span class="line">		quota = <span class="number">6</span>;</span><br><span class="line">	<span class="keyword">if</span> (quota) &#123;</span><br><span class="line">		<span class="keyword">while</span> (work_done &lt; quota)</span><br><span class="line">			work_done += <span class="built_in">rockchip_canfd_rx</span>(ndev);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (work_done)</span><br><span class="line">		<span class="built_in">can_led_event</span>(ndev, CAN_LED_EVENT_RX);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (work_done &lt; <span class="number">6</span>) &#123;</span><br><span class="line">		<span class="built_in">napi_complete_done</span>(napi, work_done);</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_INT_MASK, <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> work_done;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">rockchip_canfd_tx_retry</span><span class="params">(<span class="keyword">struct</span> net_device *ndev, u32 isr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line">	u32 err_code = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_ERR_CODE);</span><br><span class="line">	u32 data[<span class="number">4</span>], mode;</span><br><span class="line">	<span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((isr &amp; TX_LOSTARB_INT) || ((!(err_code &amp; <span class="number">0x2000000</span>)) &amp;&amp; (err_code &amp; <span class="number">0x1ff0000</span>))) &#123;</span><br><span class="line">		mode = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_MODE);</span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="built_in">ARRAY_SIZE</span>(data); i++)</span><br><span class="line">			data[i] = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_TXFIC + i * <span class="number">4</span>);</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_INT_MASK, <span class="number">0xffff</span>);</span><br><span class="line">		<span class="built_in">rockchip_canfd_start</span>(ndev);</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_MODE, mode);</span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="built_in">ARRAY_SIZE</span>(data); i++)</span><br><span class="line">			<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_TXFIC + i * <span class="number">4</span>, data[i]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rockchip_canfd_err</span><span class="params">(<span class="keyword">struct</span> net_device *ndev, u32 isr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">net_device_stats</span> *stats = &amp;ndev-&gt;stats;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">can_frame</span> *cf;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">sk_buff</span> *skb;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> rxerr, txerr;</span><br><span class="line">	u32 sta_reg;</span><br><span class="line"></span><br><span class="line">	skb = <span class="built_in">alloc_can_err_skb</span>(ndev, &amp;cf);</span><br><span class="line"></span><br><span class="line">	rxerr = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_RX_ERR_CNT);</span><br><span class="line">	txerr = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_TX_ERR_CNT);</span><br><span class="line">	sta_reg = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_STATE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (skb) &#123;</span><br><span class="line">		cf-&gt;data[<span class="number">6</span>] = txerr;</span><br><span class="line">		cf-&gt;data[<span class="number">7</span>] = rxerr;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (isr &amp; BUS_OFF_INT) &#123;</span><br><span class="line">		rcan-&gt;can.state = CAN_STATE_BUS_OFF;</span><br><span class="line">		rcan-&gt;can.can_stats.bus_off++;</span><br><span class="line">		cf-&gt;can_id |= CAN_ERR_BUSOFF;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (isr &amp; ERR_WARN_INT) &#123;</span><br><span class="line">		rcan-&gt;can.can_stats.error_warning++;</span><br><span class="line">		rcan-&gt;can.state = CAN_STATE_ERROR_WARNING;</span><br><span class="line">		<span class="comment">/* error warning state */</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">likely</span>(skb)) &#123;</span><br><span class="line">			cf-&gt;can_id |= CAN_ERR_CRTL;</span><br><span class="line">			cf-&gt;data[<span class="number">1</span>] = (txerr &gt; rxerr) ?</span><br><span class="line">				CAN_ERR_CRTL_TX_WARNING :</span><br><span class="line">				CAN_ERR_CRTL_RX_WARNING;</span><br><span class="line">			cf-&gt;data[<span class="number">6</span>] = txerr;</span><br><span class="line">			cf-&gt;data[<span class="number">7</span>] = rxerr;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (isr &amp; PASSIVE_ERR_INT) &#123;</span><br><span class="line">		rcan-&gt;can.can_stats.error_passive++;</span><br><span class="line">		rcan-&gt;can.state = CAN_STATE_ERROR_PASSIVE;</span><br><span class="line">		<span class="comment">/* error passive state */</span></span><br><span class="line">		cf-&gt;can_id |= CAN_ERR_CRTL;</span><br><span class="line">		cf-&gt;data[<span class="number">1</span>] = (txerr &gt; rxerr) ?</span><br><span class="line">					CAN_ERR_CRTL_TX_WARNING :</span><br><span class="line">					CAN_ERR_CRTL_RX_WARNING;</span><br><span class="line">		cf-&gt;data[<span class="number">6</span>] = txerr;</span><br><span class="line">		cf-&gt;data[<span class="number">7</span>] = rxerr;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rcan-&gt;can.state &gt;= CAN_STATE_BUS_OFF ||</span><br><span class="line">	    ((sta_reg &amp; CAN_BUSOFF_FLAG) == CAN_BUSOFF_FLAG)) &#123;</span><br><span class="line">		<span class="built_in">cancel_delayed_work</span>(&amp;rcan-&gt;tx_err_work);</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_INT_MASK, <span class="number">0xffff</span>);</span><br><span class="line">		<span class="built_in">can_bus_off</span>(ndev);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	stats-&gt;rx_packets++;</span><br><span class="line">	stats-&gt;rx_bytes += cf-&gt;can_dlc;</span><br><span class="line">	<span class="built_in">netif_rx</span>(skb);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">irqreturn_t</span> <span class="title">rockchip_canfd_interrupt</span><span class="params">(<span class="type">int</span> irq, <span class="type">void</span> *dev_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">net_device</span> *ndev = (<span class="keyword">struct</span> net_device *)dev_id;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">net_device_stats</span> *stats = &amp;ndev-&gt;stats;</span><br><span class="line">	u32 err_int = ERR_WARN_INT | RX_BUF_OV_INT | PASSIVE_ERR_INT |</span><br><span class="line">		      BUS_ERR_INT | BUS_OFF_INT;</span><br><span class="line">	u32 isr;</span><br><span class="line">	u32 dlc = <span class="number">0</span>;</span><br><span class="line">	u32 quota, work_done = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	isr = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_INT);</span><br><span class="line">	<span class="keyword">if</span> (isr &amp; TX_FINISH_INT) &#123;</span><br><span class="line">		<span class="built_in">cancel_delayed_work</span>(&amp;rcan-&gt;tx_err_work);</span><br><span class="line">		dlc = <span class="built_in">rockchip_canfd_read</span>(rcan, CAN_TXFIC);</span><br><span class="line">		<span class="comment">/* transmission complete interrupt */</span></span><br><span class="line">		<span class="keyword">if</span> (dlc &amp; FDF_MASK)</span><br><span class="line">			stats-&gt;tx_bytes += <span class="built_in">can_dlc2len</span>(dlc &amp; DLC_MASK);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			stats-&gt;tx_bytes += (dlc &amp; DLC_MASK);</span><br><span class="line">		stats-&gt;tx_packets++;</span><br><span class="line">		<span class="keyword">if</span> (rcan-&gt;txtorx &amp;&amp; rcan-&gt;mode &lt;= ROCKCHIP_RK3568_CAN_MODE &amp;&amp; dlc &amp; FORMAT_MASK) &#123;</span><br><span class="line">			<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_TX_CHECK_FIC, FORMAT_MASK);</span><br><span class="line">			quota = <span class="built_in">rockchip_canfd_get_rx_fifo_cnt</span>(ndev);</span><br><span class="line">			<span class="keyword">if</span> (quota) &#123;</span><br><span class="line">				<span class="keyword">while</span> (work_done &lt; quota)</span><br><span class="line">					work_done += <span class="built_in">rockchip_canfd_rx</span>(ndev);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">rockchip_canfd_read</span>(rcan, CAN_TX_CHECK_FIC) &amp; CAN_TX0_REQ)</span><br><span class="line">				<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_CMD, CAN_TX1_REQ);</span><br><span class="line">			<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_TX_CHECK_FIC, <span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">read_poll_timeout_atomic</span>(rockchip_canfd_read, quota,</span><br><span class="line">					     !(quota &amp; <span class="number">0x3</span>),</span><br><span class="line">					     <span class="number">0</span>, <span class="number">5000000</span>, <span class="literal">false</span>, rcan, CAN_CMD))</span><br><span class="line">			<span class="built_in">netdev_err</span>(ndev, <span class="string">&quot;Warning: wait tx req timeout!\n&quot;</span>);</span><br><span class="line">		<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_CMD, <span class="number">0</span>);</span><br><span class="line">		<span class="built_in">can_get_echo_skb</span>(ndev, <span class="number">0</span>);</span><br><span class="line">		<span class="built_in">netif_wake_queue</span>(ndev);</span><br><span class="line">		<span class="built_in">can_led_event</span>(ndev, CAN_LED_EVENT_TX);</span><br><span class="line">		rcan-&gt;noack_cnt = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((isr &amp; RX_FINISH_INT) || (isr &amp; RX_FIFO_OV_INT) || (isr &amp; RX_FIFO_FULL_INT)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (rcan-&gt;mode == ROCKCHIP_RK3568_CAN_MODE_V2) &#123;</span><br><span class="line">			<span class="comment">//rockchip_canfd_write(rcan, CAN_INT_MASK, 0x1);</span></span><br><span class="line">			work_done = <span class="number">0</span>;</span><br><span class="line">			quota = (<span class="built_in">rockchip_canfd_read</span>(rcan, CAN_RXFC) &amp;</span><br><span class="line">				rcan-&gt;rx_fifo_mask) &gt;&gt;</span><br><span class="line">				rcan-&gt;rx_fifo_shift;</span><br><span class="line">			<span class="keyword">if</span> (quota) &#123;</span><br><span class="line">				<span class="keyword">while</span> (work_done &lt; quota)</span><br><span class="line">					work_done += <span class="built_in">rockchip_canfd_rx</span>(ndev);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			work_done = <span class="number">0</span>;</span><br><span class="line">			quota = (<span class="built_in">rockchip_canfd_read</span>(rcan, CAN_RXFC) &amp;</span><br><span class="line">				 rcan-&gt;rx_fifo_mask) &gt;&gt;</span><br><span class="line">				rcan-&gt;rx_fifo_shift;</span><br><span class="line">			<span class="keyword">if</span> (quota) &#123;</span><br><span class="line">				<span class="keyword">while</span> (work_done &lt; quota)</span><br><span class="line">					work_done += <span class="built_in">rockchip_canfd_rx</span>(ndev);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (isr &amp; err_int) &#123;</span><br><span class="line">		<span class="comment">/* error interrupt */</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">rockchip_canfd_err</span>(ndev, isr))</span><br><span class="line">			<span class="built_in">netdev_err</span>(ndev, <span class="string">&quot;can&#x27;t allocate buffer - clearing pending interrupts\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">rockchip_canfd_tx_retry</span>(ndev, isr);</span><br><span class="line">	<span class="built_in">rockchip_canfd_write</span>(rcan, CAN_INT, isr);</span><br><span class="line">	<span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rockchip_canfd_open</span><span class="params">(<span class="keyword">struct</span> net_device *ndev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* common open */</span></span><br><span class="line">	err = <span class="built_in">open_candev</span>(ndev);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	err = <span class="built_in">pm_runtime_get_sync</span>(rcan-&gt;dev);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">netdev_err</span>(ndev, <span class="string">&quot;%s: pm_runtime_get failed(%d)\n&quot;</span>,</span><br><span class="line">			   __func__, err);</span><br><span class="line">		<span class="keyword">goto</span> exit;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = <span class="built_in">rockchip_canfd_start</span>(ndev);</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		<span class="built_in">netdev_err</span>(ndev, <span class="string">&quot;could not start CAN peripheral\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> exit_can_start;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">can_led_event</span>(ndev, CAN_LED_EVENT_OPEN);</span><br><span class="line"><span class="comment">//	if (rcan-&gt;mode == ROCKCHIP_RK3568_CAN_MODE_V2)</span></span><br><span class="line"><span class="comment">//		napi_enable(&amp;rcan-&gt;napi);</span></span><br><span class="line">	<span class="built_in">netif_start_queue</span>(ndev);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">netdev_dbg</span>(ndev, <span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">exit_can_start:</span><br><span class="line">	<span class="built_in">pm_runtime_put</span>(rcan-&gt;dev);</span><br><span class="line">exit:</span><br><span class="line">	<span class="built_in">close_candev</span>(ndev);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rockchip_canfd_close</span><span class="params">(<span class="keyword">struct</span> net_device *ndev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">netif_stop_queue</span>(ndev);</span><br><span class="line"><span class="comment">//	if (rcan-&gt;mode == ROCKCHIP_RK3568_CAN_MODE_V2)</span></span><br><span class="line"><span class="comment">//		napi_disable(&amp;rcan-&gt;napi);</span></span><br><span class="line">	<span class="built_in">rockchip_canfd_stop</span>(ndev);</span><br><span class="line">	<span class="built_in">close_candev</span>(ndev);</span><br><span class="line">	<span class="built_in">can_led_event</span>(ndev, CAN_LED_EVENT_STOP);</span><br><span class="line">	<span class="built_in">pm_runtime_put</span>(rcan-&gt;dev);</span><br><span class="line">	<span class="built_in">cancel_delayed_work_sync</span>(&amp;rcan-&gt;tx_err_work);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">netdev_dbg</span>(ndev, <span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">net_device_ops</span> rockchip_canfd_netdev_ops = &#123;</span><br><span class="line">	.ndo_open = rockchip_canfd_open,</span><br><span class="line">	.ndo_stop = rockchip_canfd_close,</span><br><span class="line">	.ndo_start_xmit = rockchip_canfd_start_xmit,</span><br><span class="line">	.ndo_change_mtu = can_change_mtu,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * rockchip_canfd_suspend - Suspend method for the driver</span></span><br><span class="line"><span class="comment"> * @dev:	Address of the device structure</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Put the driver into low power mode.</span></span><br><span class="line"><span class="comment"> * Return: 0 on success and failure value on error</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> __maybe_unused <span class="title">rockchip_canfd_suspend</span><span class="params">(<span class="keyword">struct</span> device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">net_device</span> *ndev = <span class="built_in">dev_get_drvdata</span>(dev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">netif_running</span>(ndev)) &#123;</span><br><span class="line">		<span class="built_in">netif_stop_queue</span>(ndev);</span><br><span class="line">		<span class="built_in">netif_device_detach</span>(ndev);</span><br><span class="line">		<span class="built_in">rockchip_canfd_stop</span>(ndev);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">pm_runtime_force_suspend</span>(dev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * rockchip_canfd_resume - Resume from suspend</span></span><br><span class="line"><span class="comment"> * @dev:	Address of the device structure</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Resume operation after suspend.</span></span><br><span class="line"><span class="comment"> * Return: 0 on success and failure value on error</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> __maybe_unused <span class="title">rockchip_canfd_resume</span><span class="params">(<span class="keyword">struct</span> device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">net_device</span> *ndev = <span class="built_in">dev_get_drvdata</span>(dev);</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	ret = <span class="built_in">pm_runtime_force_resume</span>(dev);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		<span class="built_in">dev_err</span>(dev, <span class="string">&quot;pm_runtime_force_resume failed on resume\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">netif_running</span>(ndev)) &#123;</span><br><span class="line">		ret = <span class="built_in">rockchip_canfd_start</span>(ndev);</span><br><span class="line">		<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">			<span class="built_in">dev_err</span>(dev, <span class="string">&quot;rockchip_canfd_chip_start failed on resume\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">netif_device_attach</span>(ndev);</span><br><span class="line">		<span class="built_in">netif_start_queue</span>(ndev);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * rockchip_canfd_runtime_suspend - Runtime suspend method for the driver</span></span><br><span class="line"><span class="comment"> * @dev:	Address of the device structure</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Put the driver into low power mode.</span></span><br><span class="line"><span class="comment"> * Return: 0 always</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> __maybe_unused <span class="title">rockchip_canfd_runtime_suspend</span><span class="params">(<span class="keyword">struct</span> device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">net_device</span> *ndev = <span class="built_in">dev_get_drvdata</span>(dev);</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">clk_bulk_disable_unprepare</span>(rcan-&gt;num_clks, rcan-&gt;clks);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * rockchip_canfd_runtime_resume - Runtime resume from suspend</span></span><br><span class="line"><span class="comment"> * @dev:	Address of the device structure</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Resume operation after suspend.</span></span><br><span class="line"><span class="comment"> * Return: 0 on success and failure value on error</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> __maybe_unused <span class="title">rockchip_canfd_runtime_resume</span><span class="params">(<span class="keyword">struct</span> device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">net_device</span> *ndev = <span class="built_in">dev_get_drvdata</span>(dev);</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	ret = <span class="built_in">clk_bulk_prepare_enable</span>(rcan-&gt;num_clks, rcan-&gt;clks);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		<span class="built_in">dev_err</span>(dev, <span class="string">&quot;Cannot enable clock.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">dev_pm_ops</span> rockchip_canfd_dev_pm_ops = &#123;</span><br><span class="line">	<span class="built_in">SET_SYSTEM_SLEEP_PM_OPS</span>(rockchip_canfd_suspend, rockchip_canfd_resume)</span><br><span class="line">	<span class="built_in">SET_RUNTIME_PM_OPS</span>(rockchip_canfd_runtime_suspend,</span><br><span class="line">			   rockchip_canfd_runtime_resume, <span class="literal">NULL</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">of_device_id</span> rockchip_canfd_of_match[] = &#123;</span><br><span class="line">	&#123;</span><br><span class="line">		.compatible = <span class="string">&quot;rockchip,canfd-1.0&quot;</span>,</span><br><span class="line">		.data = (<span class="type">void</span> *)ROCKCHIP_CANFD_MODE</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.compatible = <span class="string">&quot;rockchip,can-2.0&quot;</span>,</span><br><span class="line">		.data = (<span class="type">void</span> *)ROCKCHIP_CAN_MODE</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		.compatible = <span class="string">&quot;rockchip,rk3568-can-2.0&quot;</span>,</span><br><span class="line">		.data = (<span class="type">void</span> *)ROCKCHIP_RK3568_CAN_MODE</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">MODULE_DEVICE_TABLE</span>(of, rockchip_canfd_of_match);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rockchip_canfd_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">net_device</span> *ndev;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rockchip_canfd</span> *rcan;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">resource</span> *res;</span><br><span class="line">	<span class="type">void</span> __iomem *addr;</span><br><span class="line">	<span class="type">int</span> err, irq;</span><br><span class="line"></span><br><span class="line">	irq = <span class="built_in">platform_get_irq</span>(pdev, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (irq &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">dev_err</span>(&amp;pdev-&gt;dev, <span class="string">&quot;could not get a valid irq\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -ENODEV;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	res = <span class="built_in">platform_get_resource</span>(pdev, IORESOURCE_MEM, <span class="number">0</span>);</span><br><span class="line">	addr = <span class="built_in">devm_ioremap_resource</span>(&amp;pdev-&gt;dev, res);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">IS_ERR</span>(addr))</span><br><span class="line">		<span class="keyword">return</span> -EBUSY;</span><br><span class="line"></span><br><span class="line">	ndev = <span class="built_in">alloc_candev</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> rockchip_canfd), <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (!ndev) &#123;</span><br><span class="line">		<span class="built_in">dev_err</span>(&amp;pdev-&gt;dev, <span class="string">&quot;could not allocate memory for CANFD device\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line">	rcan = <span class="built_in">netdev_priv</span>(ndev);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* register interrupt handler */</span></span><br><span class="line">	err = <span class="built_in">devm_request_irq</span>(&amp;pdev-&gt;dev, irq, rockchip_canfd_interrupt,</span><br><span class="line">			       <span class="number">0</span>, ndev-&gt;name, ndev);</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		<span class="built_in">dev_err</span>(&amp;pdev-&gt;dev, <span class="string">&quot;request_irq err: %d\n&quot;</span>, err);</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rcan-&gt;reset = <span class="built_in">devm_reset_control_array_get</span>(&amp;pdev-&gt;dev, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">IS_ERR</span>(rcan-&gt;reset)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">PTR_ERR</span>(rcan-&gt;reset) != -EPROBE_DEFER)</span><br><span class="line">			<span class="built_in">dev_err</span>(&amp;pdev-&gt;dev, <span class="string">&quot;failed to get canfd reset lines\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">PTR_ERR</span>(rcan-&gt;reset);</span><br><span class="line">	&#125;</span><br><span class="line">	rcan-&gt;num_clks = <span class="built_in">devm_clk_bulk_get_all</span>(&amp;pdev-&gt;dev, &amp;rcan-&gt;clks);</span><br><span class="line">	<span class="keyword">if</span> (rcan-&gt;num_clks &lt; <span class="number">1</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">	rcan-&gt;mode = (<span class="type">unsigned</span> <span class="type">long</span>)<span class="built_in">of_device_get_match_data</span>(&amp;pdev-&gt;dev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((<span class="built_in">cpu_is_rk3566</span>() || <span class="built_in">cpu_is_rk3568</span>()) &amp;&amp; (<span class="built_in">rockchip_get_cpu_version</span>() == <span class="number">3</span>))</span><br><span class="line">		rcan-&gt;mode = ROCKCHIP_RK3568_CAN_MODE_V2;</span><br><span class="line"></span><br><span class="line">	rcan-&gt;base = addr;</span><br><span class="line">	rcan-&gt;can.clock.freq = <span class="built_in">clk_get_rate</span>(rcan-&gt;clks[<span class="number">0</span>].clk);</span><br><span class="line">	rcan-&gt;dev = &amp;pdev-&gt;dev;</span><br><span class="line">	rcan-&gt;can.state = CAN_STATE_STOPPED;</span><br><span class="line">	<span class="keyword">switch</span> (rcan-&gt;mode) &#123;</span><br><span class="line">	<span class="keyword">case</span> ROCKCHIP_CANFD_MODE:</span><br><span class="line">		rcan-&gt;can.bittiming_const = &amp;rockchip_canfd_bittiming_const;</span><br><span class="line">		rcan-&gt;can.data_bittiming_const = &amp;rockchip_canfd_data_bittiming_const;</span><br><span class="line">		rcan-&gt;can.do_set_mode = rockchip_canfd_set_mode;</span><br><span class="line">		rcan-&gt;can.do_get_berr_counter = rockchip_canfd_get_berr_counter;</span><br><span class="line">		rcan-&gt;can.do_set_bittiming = rockchip_canfd_set_bittiming;</span><br><span class="line">		rcan-&gt;can.do_set_data_bittiming = rockchip_canfd_set_bittiming;</span><br><span class="line">		rcan-&gt;can.ctrlmode = CAN_CTRLMODE_FD;</span><br><span class="line">		<span class="comment">/* IFI CANFD can do both Bosch FD and ISO FD */</span></span><br><span class="line">		rcan-&gt;can.ctrlmode_supported = CAN_CTRLMODE_LOOPBACK |</span><br><span class="line">					       CAN_CTRLMODE_FD;</span><br><span class="line">		rcan-&gt;rx_fifo_shift = RX_FIFO_CNT0_SHIFT;</span><br><span class="line">		rcan-&gt;rx_fifo_mask = RX_FIFO_CNT0_MASK;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> ROCKCHIP_CAN_MODE:</span><br><span class="line">	<span class="keyword">case</span> ROCKCHIP_RK3568_CAN_MODE:</span><br><span class="line">	<span class="keyword">case</span> ROCKCHIP_RK3568_CAN_MODE_V2:</span><br><span class="line">		rcan-&gt;can.bittiming_const = &amp;rockchip_canfd_bittiming_const;</span><br><span class="line">		rcan-&gt;can.do_set_mode = rockchip_canfd_set_mode;</span><br><span class="line">		rcan-&gt;can.do_get_berr_counter = rockchip_canfd_get_berr_counter;</span><br><span class="line">		rcan-&gt;can.ctrlmode_supported = CAN_CTRLMODE_BERR_REPORTING |</span><br><span class="line">					       CAN_CTRLMODE_LISTENONLY |</span><br><span class="line">					       CAN_CTRLMODE_LOOPBACK |</span><br><span class="line">					       CAN_CTRLMODE_3_SAMPLES;</span><br><span class="line">		rcan-&gt;rx_fifo_shift = RX_FIFO_CNT0_SHIFT;</span><br><span class="line">		rcan-&gt;rx_fifo_mask = RX_FIFO_CNT0_MASK;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rcan-&gt;mode == ROCKCHIP_CAN_MODE) &#123;</span><br><span class="line">		rcan-&gt;rx_fifo_shift = RX_FIFO_CNT1_SHIFT;</span><br><span class="line">		rcan-&gt;rx_fifo_mask = RX_FIFO_CNT1_MASK;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">device_property_read_u32_array</span>(&amp;pdev-&gt;dev,</span><br><span class="line">					   <span class="string">&quot;rockchip,tx-invalid-info&quot;</span>,</span><br><span class="line">					   rcan-&gt;tx_invalid, <span class="number">4</span>))</span><br><span class="line">		rcan-&gt;txtorx = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rcan-&gt;mode == ROCKCHIP_RK3568_CAN_MODE_V2) &#123;</span><br><span class="line">		rcan-&gt;txtorx = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">//netif_napi_add(ndev, &amp;rcan-&gt;napi, rockchip_canfd_rx_poll, 6);</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ndev-&gt;netdev_ops = &amp;rockchip_canfd_netdev_ops;</span><br><span class="line">	ndev-&gt;irq = irq;</span><br><span class="line">	ndev-&gt;flags |= IFF_ECHO;</span><br><span class="line">	rcan-&gt;can.restart_ms = <span class="number">100</span>;</span><br><span class="line">	rcan-&gt;noack_cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">irq_set_affinity_hint</span>(irq, <span class="built_in">get_cpu_mask</span>(<span class="built_in">num_online_cpus</span>() - <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">INIT_DELAYED_WORK</span>(&amp;rcan-&gt;tx_err_work, rockchip_canfd_tx_err_delay_work);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">platform_set_drvdata</span>(pdev, ndev);</span><br><span class="line">	<span class="built_in">SET_NETDEV_DEV</span>(ndev, &amp;pdev-&gt;dev);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">pm_runtime_enable</span>(&amp;pdev-&gt;dev);</span><br><span class="line">	err = <span class="built_in">pm_runtime_get_sync</span>(&amp;pdev-&gt;dev);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">dev_err</span>(&amp;pdev-&gt;dev, <span class="string">&quot;%s: pm_runtime_get failed(%d)\n&quot;</span>,</span><br><span class="line">			__func__, err);</span><br><span class="line">		<span class="keyword">goto</span> err_pmdisable;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = <span class="built_in">register_candev</span>(ndev);</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		<span class="built_in">dev_err</span>(&amp;pdev-&gt;dev, <span class="string">&quot;registering %s failed (err=%d)\n&quot;</span>,</span><br><span class="line">			DRV_NAME, err);</span><br><span class="line">		<span class="keyword">goto</span> err_disableclks;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">devm_can_led_init</span>(ndev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_disableclks:</span><br><span class="line">	<span class="built_in">pm_runtime_put</span>(&amp;pdev-&gt;dev);</span><br><span class="line">err_pmdisable:</span><br><span class="line">	<span class="built_in">pm_runtime_disable</span>(&amp;pdev-&gt;dev);</span><br><span class="line">	<span class="built_in">free_candev</span>(ndev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rockchip_canfd_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">net_device</span> *ndev = <span class="built_in">platform_get_drvdata</span>(pdev);</span><br><span class="line"><span class="comment">//	struct rockchip_canfd *rcan = netdev_priv(ndev);</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">unregister_netdev</span>(ndev);</span><br><span class="line">	<span class="built_in">pm_runtime_disable</span>(&amp;pdev-&gt;dev);</span><br><span class="line"><span class="comment">//	if (rcan-&gt;mode == ROCKCHIP_RK3568_CAN_MODE_V2)</span></span><br><span class="line"><span class="comment">//		netif_napi_del(&amp;rcan-&gt;napi);</span></span><br><span class="line">	<span class="built_in">free_candev</span>(ndev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">platform_driver</span> rockchip_canfd_driver = &#123;</span><br><span class="line">	.driver = &#123;</span><br><span class="line">		.name = DRV_NAME,</span><br><span class="line">		.pm = &amp;rockchip_canfd_dev_pm_ops,</span><br><span class="line">		.of_match_table = rockchip_canfd_of_match,</span><br><span class="line">	&#125;,</span><br><span class="line">	.probe = rockchip_canfd_probe,</span><br><span class="line">	.remove = rockchip_canfd_remove,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">module_platform_driver</span>(rockchip_canfd_driver);</span><br><span class="line"></span><br><span class="line"><span class="built_in">MODULE_AUTHOR</span>(<span class="string">&quot;Elaine Zhang &lt;zhangqing@rock-chips.com&gt;&quot;</span>);</span><br><span class="line"><span class="built_in">MODULE_LICENSE</span>(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"><span class="built_in">MODULE_DESCRIPTION</span>(<span class="string">&quot;Rockchip CANFD Drivers&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<div class="article-footer fs14">
    <section id="share">
      <div class="header"><span>Share</span></div>
      <div class="body">
        <div class="link"><input class="copy-area" readonly="true" id="copy-link" value="http://liuluhua.github.io/2024/12/25/0-%E5%B9%B3%E5%8F%B0-%E5%B5%8C%E5%85%A5%E5%BC%8F-CAN%E9%A9%B1%E5%8A%A8500k%E6%8E%A5%E6%94%B6%E5%AF%BC%E8%87%B4CPU%E6%9F%90%E6%A0%B8%E5%BF%83%E6%BB%A1%E8%BD%BD/" /></div>
        <div class="social-wrap dis-select"><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;Copied!&quot;)"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/8411ed322ced6.svg" /></a></div>
        
      </div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">Newer</div><a href="/2024/12/25/1-%E8%AF%AD%E8%A8%80-Qt-%E4%BD%BF%E7%94%A8-CMake-%E6%9E%84%E5%BB%BA-Qt5-%E9%A1%B9%E7%9B%AE/">使用 CMake 构建 Qt5 项目</a></div><div class="item" id="next"><div class="note">Older</div><a href="/2024/12/25/0-%E5%B9%B3%E5%8F%B0-%E6%9C%8D%E5%8A%A1%E5%99%A8-%E5%B7%A5%E5%85%B7-davfs2%E6%8C%82%E8%BD%BDwebdav%E4%BD%9C%E4%B8%BA%E6%9C%AC%E5%9C%B0%E7%A3%81%E7%9B%98/">davfs2挂载webdav作为本地磁盘</a></div></section></div>

<div class="related-wrap" id="related-posts">
    <section class='header'>
      <div class='title cap theme'>您可能感兴趣的文章</div>
    </section>
    <section class='body'>
    <div class="related-posts"><a class="item" href="/2024/08/15/0-平台-嵌入式-3568GPU负载查看及参数设置/" title="3568GPU负载查看及参数设置"><span class="title">3568GPU负载查看及参数设置</span></a></div></section></div>


  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>快来参与讨论吧~</p>

    </section>
    <section class='body cmt-body utterances'>
      

<svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="utterances" repo="liuluhua/liuluhua.github.io" issue-term="title" theme="preferred-color-scheme" label="💬"></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs15">博客</span><a href="/">近期</a><a href="/categories/">标签</a><a href="/archives/">归档</a></div><div class="sitemap-group"><span class="fs15">项目</span><a target="_blank" rel="noopener" href="https://github.com/liuluhua/">GitHub</a><a target="_blank" rel="noopener" href="https://tongji.baidu.com/">百度统计</a></div><div class="sitemap-group"><span class="fs15">社交</span><a href="/">友链</a><a href="/about/#comments">留言板</a></div><div class="sitemap-group"><span class="fs15">更多</span><a href="/about/">关于本站</a></div></div><div class="text"><p>本站使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.1">Stellar 1.29.1</a> 主题创建。</p>
<script color="0,255,255" opacity="1" zIndex="-1" count="70" src="https://cdn.staticfile.org/canvas-nest.js/1.0.1/canvas-nest.js"></script>
<center>
</br>
</br>
<!--不蒜子计数器-->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!--添加一个访问量-->
<span>
    本"<span style="color: rgb(13, 109, 252); font-weight: bold;">页面</ a></span>"访问 <span id="busuanzi_value_page_pv" style="color: rgb(13, 109, 252); font-weight: bold;"></span> 次 | 👀总访问 <span id="busuanzi_value_site_pv" style="color: rgb(13, 109, 252); font-weight: bold;"></span>                次 | 🥷总访客 <span id="busuanzi_value_site_uv" style="color: rgb(13, 109, 252); font-weight: bold;"></span> 人
</span>
</br>
</br>
<script type="text/javascript">
function show_runtime() {
    window.setTimeout("show_runtime()", 1000);
    X = new Date("05/20/2023 05:20:00");
    Y = new Date();
    T = (Y.getTime() - X.getTime());
    M = 24 * 60 * 60 * 1000;
    a = T / M;
    A = Math.floor(a);
    b = (a - A) * 24;
    B = Math.floor(b);
    c = (b - B) * 60;
    C = Math.floor((b - B) * 60);
    D = Math.floor((c - C) * 60);
    runtime_span.innerHTML = "⏱️本站已运行 " + A + "天" + B + "小时" + C + "分" + D + "秒"
}
show_runtime();
</script>
<span id="runtime_span"></span>
</center>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
</aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `Just`,
      min: `minutes ago`,
      hour: `hours ago`,
      day: `days ago`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"odeblock":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://raw.staticdn.net/liuluhua/liuluhua.github.io/ImageBed/BlogRes/avatar.jpg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>


<!-- required -->
<script src="/js/main.js?v=1.29.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    applyThemeToGiscus(theme)
  }

  const applyThemeToGiscus = (theme) => {
    theme = theme === 'auto' ? 'preferred_color_scheme' : theme

    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)

    const messages = {
      light: `Switched to Light Mode`,
      dark: `Switched to Dark Mode`,
      auto: `Switched to Auto Mode`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    }
  })()
</script>


<!-- optional -->

  <script type="module">
  const el = document.querySelector("#comments #utterances");
  util.viewportLazyload(el, load_utterances, false);

  function load_utterances() {
    if (!el) return;
    try {
      el.innerHTML = '';
    } catch (error) {
      console.error(error);
    }
    const script = document.createElement('script');
    script.src = 'https://utteranc.es/client.js';
    script.async = true;
    for (const key of Object.keys(el.attributes)) {
      const attr = el.attributes[key];
      if (['class', 'id'].includes(attr.name) === false) {
        script.setAttribute(attr.name, attr.value);
      }
    }
    el.appendChild(script);
  }
</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script><script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?da53de6b993ed1e1aa3bb704f307c05b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- inject -->

</div></body></html>

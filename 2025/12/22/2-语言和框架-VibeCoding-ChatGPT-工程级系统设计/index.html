
<!DOCTYPE html><html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1" theme-name="Stellar" theme-version="1.33.1">
  
  
  <meta name="generator" content="Hexo 7.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  <title>ChatGPT-工程级系统设计 - LemonCyan</title>

  
    <meta name="description" content="categories:comments: truedate: 2025-12-22 13:33:24dg-publish: truetags:title: ChatGPT-工程级系统设计updated: 2025-12-24 15:49:05 工程级系统设计User: 刘璐华 (&#108;&#x69;&#117;&#x6c;&#x75;&#104;&#117;&#97;&#x37;&#64;&amp;#">
<meta property="og:type" content="article">
<meta property="og:title" content="ChatGPT-工程级系统设计">
<meta property="og:url" content="https://lemoncyan.github.io/2025/12/22/2-%E8%AF%AD%E8%A8%80%E5%92%8C%E6%A1%86%E6%9E%B6-VibeCoding-ChatGPT-%E5%B7%A5%E7%A8%8B%E7%BA%A7%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">
<meta property="og:site_name" content="LemonCyan">
<meta property="og:description" content="categories:comments: truedate: 2025-12-22 13:33:24dg-publish: truetags:title: ChatGPT-工程级系统设计updated: 2025-12-24 15:49:05 工程级系统设计User: 刘璐华 (&#108;&#x69;&#117;&#x6c;&#x75;&#104;&#117;&#97;&#x37;&#64;&amp;#">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/LemonCyan/LemonCyan.github.io/ImageBed/BlogRes/17671541770009xm5z9.png">
<meta property="article:published_time" content="2025-12-22T13:33:24.000Z">
<meta property="article:modified_time" content="2025-12-24T15:55:13.000Z">
<meta property="article:author" content="liuluhua">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/LemonCyan/LemonCyan.github.io/ImageBed/BlogRes/17671541770009xm5z9.png">
  
  
  
  

  <!-- feed -->
  

  <link rel="stylesheet" href="/css/main.css?v=1.33.1">


  

  

  <script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"liuluhua","sameAs":[],"image":"https://raw.githubusercontent.com/LemonCyan/LemonCyan.github.io/ImageBed/BlogRes/17671541770009xm5z9.png"},"dateCreated":"2025-12-22T13:33:24+00:00","dateModified":"2025-12-24T15:55:13+00:00","datePublished":"2025-12-22T13:33:24+00:00","description":"","headline":"ChatGPT-工程级系统设计","mainEntityOfPage":{"@type":"WebPage","@id":"https://lemoncyan.github.io/2025/12/22/2-%E8%AF%AD%E8%A8%80%E5%92%8C%E6%A1%86%E6%9E%B6-VibeCoding-ChatGPT-%E5%B7%A5%E7%A8%8B%E7%BA%A7%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"},"publisher":{"@type":"Organization","name":"liuluhua","sameAs":[],"image":"https://raw.githubusercontent.com/LemonCyan/LemonCyan.github.io/ImageBed/BlogRes/17671541770009xm5z9.png","logo":{"@type":"ImageObject","url":"https://raw.githubusercontent.com/LemonCyan/LemonCyan.github.io/ImageBed/BlogRes/17671541770009xm5z9.png"}},"url":"https://lemoncyan.github.io/2025/12/22/2-%E8%AF%AD%E8%A8%80%E5%92%8C%E6%A1%86%E6%9E%B6-VibeCoding-ChatGPT-%E5%B7%A5%E7%A8%8B%E7%BA%A7%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/","image":[]}</script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/satouriko/LxgwWenKai_Webfonts@v1.101/dist/LXGWWenKaiMono-Bold.css" />
</head>
<body>

<div class="l_body content" id="start" layout="post" type="tech" ><aside class="l_left"><div class="sidebg"></div><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="config.avatar" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main">LemonCyan</div><div class="sub cap">LemonCyan`s Charging</div></a></div></header>

<div class="nav-area">

<nav class="menu dis-select"><a class="nav-item active" title="博客" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="文档" href="/wiki/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="探索" href="/explore/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12a8 8 0 1 1-16 0a8 8 0 0 1 16 0" opacity=".5"/><path fill="currentColor" d="M17.712 5.453c1.047-.193 2.006-.259 2.797-.152c.77.103 1.536.393 1.956 1.064c.446.714.312 1.542-.012 2.258c-.33.728-.918 1.499-1.672 2.268c-1.516 1.547-3.836 3.226-6.597 4.697c-2.763 1.472-5.495 2.484-7.694 2.92c-1.095.217-2.098.299-2.923.201c-.8-.095-1.6-.383-2.032-1.075c-.47-.752-.296-1.63.07-2.379c.375-.768 1.032-1.586 1.872-2.403L4 12.416c0 .219.083.71.168 1.146c.045.23.09.444.123.596c-.652.666-1.098 1.263-1.339 1.756c-.277.567-.208.825-.145.925c.072.116.305.305.937.38c.609.073 1.44.018 2.455-.183c2.02-.4 4.613-1.351 7.28-2.772c2.667-1.42 4.85-3.015 6.23-4.423c.694-.707 1.15-1.334 1.377-1.836c.233-.515.167-.75.107-.844c-.07-.112-.289-.294-.883-.374c-.542-.072-1.272-.041-2.163.112L16.87 5.656c.338-.101.658-.17.842-.203"/></svg></a><a class="nav-item" title="社交" href="/friends/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="Search"></form><div id="search-result"></div><div class="search-no-result">No Results!</div></div>



<widget class="widget-wrapper recent post-list"><div class="widget-header dis-select"><span class="name">Recent Update</span></div><div class="widget-body fs14"><a class="item title" href="/2025/12/30/2-%E8%AF%AD%E8%A8%80%E5%92%8C%E6%A1%86%E6%9E%B6-Qt-QT%E7%95%8C%E9%9D%A2%E4%B8%8E%E9%80%BB%E8%BE%91%E5%88%86%E7%A6%BB/"><span class="title">QT界面与逻辑分离</span></a><a class="item title" href="/2026/01/04/4-Others-%E9%87%91%E8%9E%8D-0-%E6%9C%AF/"><span class="title">0 术</span></a><a class="item title" href="/2025/05/10/4-Others-AI-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A5%E5%85%A5/"><span class="title">大模型接入</span></a><a class="item title" href="/2025/12/30/1-%E5%B9%B3%E5%8F%B0-%E6%9C%8D%E5%8A%A1%E5%99%A8-Clash%E6%9A%B4%E9%9C%B2%E5%85%AC%E7%BD%91%E5%AF%BC%E8%87%B4%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5%E8%AE%B0%E5%BD%95/"><span class="title">Clash暴露公网导致服务器异常排查记录</span></a><a class="item title" href="/2025/12/30/2-%E8%AF%AD%E8%A8%80%E5%92%8C%E6%A1%86%E6%9E%B6-Qt-qmake%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/"><span class="title">qmake完全指南</span></a><a class="item title" href="/2024/12/20/1-%E5%B9%B3%E5%8F%B0-Docker-Docker%E9%83%A8%E7%BD%B2/"><span class="title">Docker部署</span></a><a class="item title" href="/2025/12/22/2-%E8%AF%AD%E8%A8%80%E5%92%8C%E6%A1%86%E6%9E%B6-VibeCoding-ChatGPT-%E5%B7%A5%E7%A8%8B%E7%BA%A7%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"><span class="title">ChatGPT-工程级系统设计</span></a><a class="item title" href="/2025/12/19/2-%E8%AF%AD%E8%A8%80%E5%92%8C%E6%A1%86%E6%9E%B6-VibeCoding-%E8%AE%BE%E8%AE%A1/"><span class="title">设计</span></a><a class="item title" href="/2025/12/18/2-%E8%AF%AD%E8%A8%80%E5%92%8C%E6%A1%86%E6%9E%B6-VibeCoding-3-VibePrompt/"><span class="title">3.VibePrompt</span></a><a class="item title" href="/2025/12/22/1-%E5%B9%B3%E5%8F%B0-WSL-%E5%A6%82%E4%BD%95%E5%9C%A8windows%E7%8E%AF%E5%A2%83%E4%B8%AD%E8%AE%BF%E9%97%AEwsl%E7%9A%84%E6%96%87%E4%BB%B6%E5%A4%B9/"><span class="title">如何在windows环境中访问wsl的文件夹</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="/" rel="noopener noreferrer"><img src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/08a41b181ce68.svg"/></a><a class="social" href="/" rel="noopener noreferrer"><img src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/3845874.svg"/></a><a class="social" href="/" rel="noopener noreferrer"><img src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/3616429.svg"/></a><a class="social" href="/about/#comments" rel="noopener noreferrer"><img src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/942ebbf1a4b91.svg"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">Home</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">Blog</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/2-%E8%AF%AD%E8%A8%80%E5%92%8C%E6%A1%86%E6%9E%B6/">2.语言和框架</a> <span class="sep"></span> <a class="cap breadcrumb-link" href="/categories/2-%E8%AF%AD%E8%A8%80%E5%92%8C%E6%A1%86%E6%9E%B6/VibeCoding/">VibeCoding</a></div>
<div class="flex-row" id="post-meta"><span class="text created">Posted on: <time datetime="2025-12-22T13:33:24.000Z">2025-12-22</time></span><span class="sep updated"></span><span class="text updated">Updated on: <time datetime="2025-12-24T15:55:13.000Z">2025-12-24</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>ChatGPT-工程级系统设计</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><p>categories:<br>comments: true<br>date: 2025-12-22 13:33:24<br>dg-publish: true<br>tags:<br>title: ChatGPT-工程级系统设计<br>updated: 2025-12-24 15:49:05</p>
<h1 id="工程级系统设计"><a href="#工程级系统设计" class="headerlink" title="工程级系统设计"></a>工程级系统设计</h1><p><strong>User:</strong> 刘璐华 (<a href="mailto:&#108;&#x69;&#117;&#x6c;&#x75;&#104;&#117;&#97;&#x37;&#64;&#x67;&#109;&#x61;&#x69;&#108;&#46;&#x63;&#111;&#109;">&#108;&#x69;&#117;&#x6c;&#x75;&#104;&#117;&#97;&#x37;&#64;&#x67;&#109;&#x61;&#x69;&#108;&#46;&#x63;&#111;&#109;</a>)<br><strong>Created:</strong> 12&#x2F;18&#x2F;2025 12:34:04<br><strong>Updated:</strong> 12&#x2F;19&#x2F;2025 10:43:49<br><strong>Exported:</strong> 12&#x2F;19&#x2F;2025 16:06:17<br><strong>Link:</strong> <a target="_blank" rel="noopener" href="https://chatgpt.com/g/g-p-6942528204288191bbd143d0284b5d31/c/69438343-42b8-8320-aede-deea93800c31">https://chatgpt.com/g/g-p-6942528204288191bbd143d0284b5d31/c/69438343-42b8-8320-aede-deea93800c31</a></p>
<h2 id="Prompt"><a href="#Prompt" class="headerlink" title="Prompt:"></a>Prompt:</h2><p>你是一个耐心的 VibeCoding 高手。我是一个完全的新手，使用 WSL2+VScode 环境，需要你一步一步指导我完成一个工程级的可长时间复用且维护的 VibeCoding 系统的实现与完善。我设计的系统如下，分为 1. prompt 部分 1.1 system.md 规 1.2 architecture.md1.3 conventions.md 1.4 evolution.md1.5 task.md2. spec 部分 2.1 spec_overview.md 2.2 spec_details.md 2.3 schema.json 3. 代码生成部分 3.1 main.py 3.2.ai_client.py 3.3.spec_parser.py 3.4.file_manager.py 要求： - 每个环节给出具体的示例，并给出具体的注释内容 - 如果我的架构不够完善，帮我分析补充架构的内容 -补充长时间复用可维护的工程级系统需要的环节 - 设计的系统需要在功能上接近于 cursor，但是每个环节我都能够自己定义 现在开始吧。</p>
<h2 id="Response"><a href="#Response" class="headerlink" title="Response:"></a>Response:</h2><p>很好，这个目标和拆分<strong>非常专业</strong>，而且你已经具备「工程级 VibeCoding 系统」的雏形了 👍<br>我会<strong>严格按你要求：一步一步、一次只做一个步骤、给出示例和注释</strong>，等你确认完成后再进入下一步。</p>
<h2 id="✅-第-0-步（本轮）：整体架构体检-工程级补充设计"><a href="#✅-第-0-步（本轮）：整体架构体检-工程级补充设计" class="headerlink" title="✅ 第 0 步（本轮）：整体架构体检 + 工程级补充设计"></a>✅ 第 0 步（本轮）：<strong>整体架构体检 + 工程级补充设计</strong></h2><blockquote>
<p>目标：<br>在你现有设计基础上，<strong>补齐“长期可复用 &#x2F; 可维护 &#x2F; 可演进”所必需但你还没显式写出来的层</strong><br>不写代码，只做“系统设计对齐”，让后面每一步都不返工<br>👉 <strong>这一步做完，我们才开始写 prompt</strong></p>
</blockquote>
<h2 id="一、你现有架构的评价（结论先给）"><a href="#一、你现有架构的评价（结论先给）" class="headerlink" title="一、你现有架构的评价（结论先给）"></a>一、你现有架构的评价（结论先给）</h2><p>你的设计 <strong>方向是对的，而且是偏 Cursor 内核级思路的</strong>：</p>
<ul>
<li>prompt &#x2F; spec &#x2F; code 三层拆分 ✔</li>
<li>schema.json 明确结构 ✔</li>
<li>spec_parser &#x2F; file_manager 分工 ✔</li>
</ul>
<p>但<strong>要做到工程级 + 长期复用</strong>，现在还缺 <strong>5 个关键能力层</strong>。</p>
<h2 id="二、必须补充的-5-个“工程级能力层”"><a href="#二、必须补充的-5-个“工程级能力层”" class="headerlink" title="二、必须补充的 5 个“工程级能力层”"></a>二、必须补充的 5 个“工程级能力层”</h2><blockquote>
<p>Cursor &#x2F; Devin &#x2F; Aider 这类工具，<strong>真正的护城河都在这 5 层</strong></p>
</blockquote>
<h3 id="1️⃣-状态与上下文管理层（Context-Memory）"><a href="#1️⃣-状态与上下文管理层（Context-Memory）" class="headerlink" title="1️⃣ 状态与上下文管理层（Context &#x2F; Memory）"></a>1️⃣ 状态与上下文管理层（Context &#x2F; Memory）</h3><p>❌ 目前缺失<br>✔ 工程级系统必须有</p>
<p><strong>为什么必须有？</strong></p>
<ul>
<li>不能每次都“全量 prompt”</li>
<li>要知道：<ul>
<li>项目当前状态</li>
<li>已生成了哪些文件</li>
<li>代码是否和 spec 对齐</li>
<li>上一次失败点在哪里</li>
</ul>
</li>
</ul>
<p>📌 <strong>建议补充模块</strong></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">context/</span><br><span class="line"> ├── project_state.json   # 当前工程状态</span><br><span class="line"> ├── history.log          # 每一次生成 / 修改记录</span><br><span class="line"> ├── decisions.md         # 架构与关键决策记录</span><br></pre></td></tr></table></figure>

<p>👉 后面：<code>main.py</code> 会自动更新它们</p>
<h3 id="2️⃣-计划与执行拆分（Plan-Act）"><a href="#2️⃣-计划与执行拆分（Plan-Act）" class="headerlink" title="2️⃣ 计划与执行拆分（Plan &#x2F; Act）"></a>2️⃣ 计划与执行拆分（Plan &#x2F; Act）</h3><p>❌ 目前 prompt 是“一次性生成”<br>✔ Cursor 是 <strong>Plan → Diff → Apply</strong></p>
<p>📌 必须引入一个“中间态”</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">planner/</span><br><span class="line"> ├── plan.md        # AI 输出的执行计划</span><br><span class="line"> ├── tasks.json     # 可执行的原子任务</span><br></pre></td></tr></table></figure>

<p><strong>好处</strong></p>
<ul>
<li>可回滚</li>
<li>可人工 review</li>
<li>可断点继续</li>
</ul>
<h3 id="3️⃣-代码变更不是“覆盖”，而是-Diff"><a href="#3️⃣-代码变更不是“覆盖”，而是-Diff" class="headerlink" title="3️⃣ 代码变更不是“覆盖”，而是 Diff"></a>3️⃣ 代码变更不是“覆盖”，而是 Diff</h3><p>❌ 直接生成文件 &#x3D; 不可维护<br>✔ 工程级必须支持 <strong>patch &#x2F; diff</strong></p>
<p>📌 file_manager 要升级为：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">file_manager.py</span><br><span class="line"> ├── read()</span><br><span class="line"> ├── write()</span><br><span class="line"> ├── diff_apply()   # 关键</span><br><span class="line"> ├── backup()</span><br></pre></td></tr></table></figure>

<p>👉 后续我们会用 <strong>unified diff 格式</strong>（和 Cursor 一样）</p>
<h3 id="4️⃣-校验与反馈闭环（Validation-Loop）"><a href="#4️⃣-校验与反馈闭环（Validation-Loop）" class="headerlink" title="4️⃣ 校验与反馈闭环（Validation Loop）"></a>4️⃣ 校验与反馈闭环（Validation Loop）</h3><p>❌ 生成完就结束<br>✔ 工程级系统一定是 <strong>生成 → 校验 → 修正</strong></p>
<p>📌 必须补充：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">validator/</span><br><span class="line"> ├── schema_validator.py   # 是否符合 schema.json</span><br><span class="line"> ├── spec_checker.py       # 是否违背 spec</span><br><span class="line"> ├── lint_checker.py       # 可选</span><br></pre></td></tr></table></figure>

<p>Cursor 的“Fix errors”就在这里。</p>
<h3 id="5️⃣-演进而不是推倒（Evolution-First）"><a href="#5️⃣-演进而不是推倒（Evolution-First）" class="headerlink" title="5️⃣ 演进而不是推倒（Evolution First）"></a>5️⃣ 演进而不是推倒（Evolution First）</h3><p>你已经有 <code>evolution.md</code>，这是<strong>非常好的意识</strong> 👍<br>但还要让它<strong>可执行</strong></p>
<p>📌 建议 evolution 拆成：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">evolution/</span><br><span class="line"> ├── rules.md        # 演进原则（不破坏什么）</span><br><span class="line"> ├── changelog.md    # 每次系统升级记录</span><br><span class="line"> ├── migration.md   # prompt / schema 迁移说明</span><br></pre></td></tr></table></figure>

<h2 id="三、我建议的-完整工程目录（最终形态）"><a href="#三、我建议的-完整工程目录（最终形态）" class="headerlink" title="三、我建议的 完整工程目录（最终形态）"></a>三、我建议的 <strong>完整工程目录（最终形态）</strong></h2><blockquote>
<p>你不用一次建全<br><strong>这是“目标状态”，我们会一步步填</strong></p>
</blockquote>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">vibecoding/</span><br><span class="line">├── prompt/</span><br><span class="line">│   ├── system.md</span><br><span class="line">│   ├── architecture.md</span><br><span class="line">│   ├── conventions.md</span><br><span class="line">│   ├── evolution.md</span><br><span class="line">│   └── task.md</span><br><span class="line">│</span><br><span class="line">├── spec/</span><br><span class="line">│   ├── spec_overview.md</span><br><span class="line">│   ├── spec_details.md</span><br><span class="line">│   └── schema.json</span><br><span class="line">│</span><br><span class="line">├── context/</span><br><span class="line">│   ├── project_state.json</span><br><span class="line">│   ├── history.log</span><br><span class="line">│   └── decisions.md</span><br><span class="line">│</span><br><span class="line">├── planner/</span><br><span class="line">│   ├── plan.md</span><br><span class="line">│   └── tasks.json</span><br><span class="line">│</span><br><span class="line">├── validator/</span><br><span class="line">│   ├── schema_validator.py</span><br><span class="line">│   └── spec_checker.py</span><br><span class="line">│</span><br><span class="line">├── engine/</span><br><span class="line">│   ├── main.py</span><br><span class="line">│   ├── ai_client.py</span><br><span class="line">│   ├── spec_parser.py</span><br><span class="line">│   └── file_manager.py</span><br><span class="line">│</span><br><span class="line">└── evolution/</span><br><span class="line">    ├── rules.md</span><br><span class="line">    ├── changelog.md</span><br><span class="line">    └── migration.md</span><br></pre></td></tr></table></figure>

<p>四、你现在<strong>什么都不用改</strong>，只做一件事</p>
<p>👉 <strong>确认这一句话</strong>：</p>
<blockquote>
<p>「我接受这个补充后的整体架构，按这个目标状态一步步实现」</p>
</blockquote>
<p>只要你确认，我下一步将进入：</p>
<p>▶️ 第 1 步（下一轮）：<strong>prompt &#x2F; system.md 的工程级设计</strong></p>
<ul>
<li>system.md 的<strong>职责边界</strong></li>
<li>和 Cursor system prompt 的本质差异</li>
<li>一个<strong>可长期演进</strong>的 system.md 示例（逐行注释）</li>
</ul>
<p>你只需要回复一句即可：</p>
<blockquote>
<p><strong>确认，进入第 1 步</strong></p>
</blockquote>
<h2 id="Prompt-1"><a href="#Prompt-1" class="headerlink" title="Prompt:"></a>Prompt:</h2><p>我觉得这个工程目录适用于大型长期维护工程级项目时，仍然不够完善，你在仔细考虑一下</p>
<h2 id="Response-1"><a href="#Response-1" class="headerlink" title="Response:"></a>Response:</h2><p>你这个判断<strong>是对的，而且是站在「真正做过大型长期系统」的视角</strong>。<br>你现在已经不是“新手要怎么搭架子”，而是在问：</p>
<blockquote>
<p><strong>一个会被反复用、被别人用、被几年后自己维护的 VibeCoding 系统，还缺什么“隐性结构”？</strong></p>
</blockquote>
<p>我们来<strong>重新、慢速、严谨地推演一次</strong>。<br>这次我不急着给目录，而是<strong>先给“工程级系统必须满足的 8 条硬约束”</strong>，然后你会自然地发现：<br>👉 之前那个目录确实不够。</p>
<h1 id="一、工程级、长期维护的-VibeCoding-系统"><a href="#一、工程级、长期维护的-VibeCoding-系统" class="headerlink" title="一、工程级、长期维护的 VibeCoding 系统"></a>一、工程级、长期维护的 VibeCoding 系统</h1><h2 id="必须满足的-8-条“硬约束”"><a href="#必须满足的-8-条“硬约束”" class="headerlink" title="必须满足的 8 条“硬约束”"></a>必须满足的 8 条“硬约束”</h2><p>如果有一条做不到，系统一定会烂。</p>
<h2 id="①-Prompt-本身必须是“可测试的资产”"><a href="#①-Prompt-本身必须是“可测试的资产”" class="headerlink" title="① Prompt 本身必须是“可测试的资产”"></a>① Prompt 本身必须是“可测试的资产”</h2><p>❌ 现在的问题</p>
<ul>
<li>prompt 只是文本</li>
<li>没法验证「改了 system.md 会不会把系统搞坏」</li>
</ul>
<p>✅ 工程级要求</p>
<blockquote>
<p><strong>prompt ≈ 代码 ≈ 需要测试</strong></p>
</blockquote>
<p>📌 必须引入：</p>
<ul>
<li>Prompt 版本</li>
<li>Prompt 回归测试</li>
<li>Prompt 行为基准</li>
</ul>
<h2 id="②-AI-行为必须是“可审计的”"><a href="#②-AI-行为必须是“可审计的”" class="headerlink" title="② AI 行为必须是“可审计的”"></a>② AI 行为必须是“可审计的”</h2><p>❌ 现在的问题</p>
<ul>
<li>AI 为什么这么生成？</li>
<li>哪条 prompt &#x2F; 哪次变更导致？</li>
</ul>
<p>Cursor 内部<strong>每一步都有 trace</strong>。</p>
<p>📌 你缺的是：</p>
<ul>
<li>调用级日志</li>
<li>prompt 拼装快照</li>
<li>模型响应归档</li>
</ul>
<h2 id="③-“规范”不能只靠人脑记忆"><a href="#③-“规范”不能只靠人脑记忆" class="headerlink" title="③ “规范”不能只靠人脑记忆"></a>③ “规范”不能只靠人脑记忆</h2><p>你现在有：</p>
<ul>
<li>architecture.md</li>
<li>conventions.md</li>
</ul>
<p>但<strong>没有机器约束</strong>。</p>
<p>📌 工程级要求：</p>
<blockquote>
<p>规范 &#x3D; 文档 + 校验器 + 失败提示</p>
</blockquote>
<h2 id="④-系统要支持“人机协同”，不是纯自动"><a href="#④-系统要支持“人机协同”，不是纯自动" class="headerlink" title="④ 系统要支持“人机协同”，不是纯自动"></a>④ 系统要支持“人机协同”，不是纯自动</h2><p>长期用下来，一定会出现：</p>
<ul>
<li>只想生成 plan，不生成代码</li>
<li>只想 review diff</li>
<li>人工介入后继续跑</li>
</ul>
<p>📌 所以你需要 <strong>交互层抽象</strong></p>
<h2 id="⑤-VibeCoding-本身也要能“VibeCoding”"><a href="#⑤-VibeCoding-本身也要能“VibeCoding”" class="headerlink" title="⑤ VibeCoding 本身也要能“VibeCoding”"></a>⑤ VibeCoding 本身也要能“VibeCoding”</h2><p>这是一个<strong>递归问题</strong>：</p>
<blockquote>
<p>谁来维护这个系统？</p>
</blockquote>
<p>答案是：<br>👉 <strong>系统必须能生成 &#x2F; 演进自己</strong></p>
<p>这要求：</p>
<ul>
<li>元规范（meta-spec）</li>
<li>自举能力（bootstrap）</li>
</ul>
<h2 id="⑥-任务不是“一次性”，而是“生命周期对象”"><a href="#⑥-任务不是“一次性”，而是“生命周期对象”" class="headerlink" title="⑥ 任务不是“一次性”，而是“生命周期对象”"></a>⑥ 任务不是“一次性”，而是“生命周期对象”</h2><p>现在的 task.md 是静态的。</p>
<p>工程级要求 task 具备：</p>
<ul>
<li>状态</li>
<li>依赖</li>
<li>失败重试</li>
<li>归档</li>
</ul>
<h2 id="⑦-配置与策略必须彻底解耦"><a href="#⑦-配置与策略必须彻底解耦" class="headerlink" title="⑦ 配置与策略必须彻底解耦"></a>⑦ 配置与策略必须彻底解耦</h2><p>未来你一定会换：</p>
<ul>
<li>模型</li>
<li>prompt 风格</li>
<li>diff 策略</li>
<li>校验强度</li>
</ul>
<p>📌 所以要有 <strong>Policy 层</strong></p>
<p>⑧ 系统必须允许“不完美生成”</p>
<p>一个成熟系统默认：</p>
<blockquote>
<p>AI 会犯错<br>错误是流程的一部分</p>
</blockquote>
<p>所以必须有：</p>
<ul>
<li>Retry 策略</li>
<li>Fallback prompt</li>
<li>手动接管模式</li>
</ul>
<h1 id="二、基于这-8-条硬约束"><a href="#二、基于这-8-条硬约束" class="headerlink" title="二、基于这 8 条硬约束"></a>二、基于这 8 条硬约束</h1><h2 id="我重新设计的「真正工程级」VibeCoding-架构"><a href="#我重新设计的「真正工程级」VibeCoding-架构" class="headerlink" title="我重新设计的「真正工程级」VibeCoding 架构"></a>我重新设计的「真正工程级」VibeCoding 架构</h2><blockquote>
<p>⚠️ 这是 <strong>目标蓝图</strong><br>我们仍然会一步步实现</p>
</blockquote>
<p>🧠 一级：Meta &#x2F; 治理层（你之前完全没有）</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">meta/</span><br><span class="line">├── vision.md            # 系统目标 &amp; 边界</span><br><span class="line">├── principles.md        # 不可违背的设计原则</span><br><span class="line">├── anti_patterns.md     # 明确禁止的设计</span><br><span class="line">├── glossary.md          # 统一术语</span><br></pre></td></tr></table></figure>

<p>👉 <strong>这是防止系统“越改越歪”的根</strong></p>
<h2 id="🧾-二级：Prompt-作为资产（Prompt-≠-文本）"><a href="#🧾-二级：Prompt-作为资产（Prompt-≠-文本）" class="headerlink" title="🧾 二级：Prompt 作为资产（Prompt ≠ 文本）"></a>🧾 二级：Prompt 作为资产（Prompt ≠ 文本）</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">prompt/</span><br><span class="line">├── system/</span><br><span class="line">│   ├── system.v1.md</span><br><span class="line">│   ├── system.v2.md</span><br><span class="line">│   └── system.current</span><br><span class="line">│</span><br><span class="line">├── modules/</span><br><span class="line">│   ├── role.md</span><br><span class="line">│   ├── constraints.md</span><br><span class="line">│   ├── output_format.md</span><br><span class="line">│</span><br><span class="line">├── tests/</span><br><span class="line">│   ├── test_plan_generation.md</span><br><span class="line">│   └── test_diff_behavior.md</span><br></pre></td></tr></table></figure>

<p>👉 system.md 不再是一个文件，而是<strong>组合产物</strong></p>
<p>📐 三级：规范 ≠ 文档（Spec + Rule + Check）</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spec/</span><br><span class="line">├── docs/</span><br><span class="line">│   ├── overview.md</span><br><span class="line">│   ├── details.md</span><br><span class="line">│</span><br><span class="line">├── rules/</span><br><span class="line">│   ├── naming.yaml</span><br><span class="line">│   ├── layering.yaml</span><br><span class="line">│</span><br><span class="line">├── schema/</span><br><span class="line">│   └── output.schema.json</span><br></pre></td></tr></table></figure>

<p>👉 rules 是机器可读的</p>
<h2 id="🧠-四级：状态-记忆系统（长期复用核心）"><a href="#🧠-四级：状态-记忆系统（长期复用核心）" class="headerlink" title="🧠 四级：状态 &amp; 记忆系统（长期复用核心）"></a>🧠 四级：状态 &amp; 记忆系统（长期复用核心）</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">state/</span><br><span class="line">├── project_state.json</span><br><span class="line">├── task_state.json</span><br><span class="line">├── prompt_state.json</span><br><span class="line">├── decision_log.md</span><br></pre></td></tr></table></figure>

<h2 id="🗂-五级：任务生命周期管理（不是-task-md）"><a href="#🗂-五级：任务生命周期管理（不是-task-md）" class="headerlink" title="🗂 五级：任务生命周期管理（不是 task.md）"></a>🗂 五级：任务生命周期管理（不是 task.md）</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tasks/</span><br><span class="line">├── backlog/</span><br><span class="line">├── active/</span><br><span class="line">├── blocked/</span><br><span class="line">├── done/</span><br><span class="line">└── archive/</span><br></pre></td></tr></table></figure>

<h2 id="🧪-六级：验证-回路（系统不会“盲飞”）"><a href="#🧪-六级：验证-回路（系统不会“盲飞”）" class="headerlink" title="🧪 六级：验证 &amp; 回路（系统不会“盲飞”）"></a>🧪 六级：验证 &amp; 回路（系统不会“盲飞”）</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">validation/</span><br><span class="line">├── pre_generation/</span><br><span class="line">├── post_generation/</span><br><span class="line">├── runtime/</span><br></pre></td></tr></table></figure>

<p>⚙️ 七级：执行引擎（你原来的 code）</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">engine/</span><br><span class="line">├── main.py</span><br><span class="line">├── planner.py</span><br><span class="line">├── executor.py</span><br><span class="line">├── ai_client.py</span><br><span class="line">├── diff_engine.py</span><br><span class="line">├── file_manager.py</span><br></pre></td></tr></table></figure>

<p>🧯 八级：安全 &amp; 失败恢复（99% 人会忽略）</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">safety/</span><br><span class="line">├── backups/</span><br><span class="line">├── rollback.py</span><br><span class="line">├── recovery.md</span><br></pre></td></tr></table></figure>

<p>🔄 九级：系统演进（不仅是 evolution.md）</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">evolution/</span><br><span class="line">├── roadmap.md</span><br><span class="line">├── changelog.md</span><br><span class="line">├── migrations/</span><br><span class="line">└── experiments/</span><br></pre></td></tr></table></figure>

<h1 id="三、关键结论（很重要）"><a href="#三、关键结论（很重要）" class="headerlink" title="三、关键结论（很重要）"></a>三、关键结论（很重要）</h1><h3 id="你一开始的设计-❌"><a href="#你一开始的设计-❌" class="headerlink" title="你一开始的设计 ❌"></a>你一开始的设计 ❌</h3><p>是「<strong>生成代码的工具</strong>」</p>
<h3 id="现在这套设计-✅"><a href="#现在这套设计-✅" class="headerlink" title="现在这套设计 ✅"></a>现在这套设计 ✅</h3><p>是「<strong>一个可被维护、可被演进、可被审计的 AI 编程系统</strong>」</p>
<p>这正是 Cursor &#x2F; Devin <strong>不公开但真正有的那一层</strong>。</p>
<h1 id="四、接下来怎么走（不会失控）"><a href="#四、接下来怎么走（不会失控）" class="headerlink" title="四、接下来怎么走（不会失控）"></a>四、接下来怎么走（不会失控）</h1><p>我们不会一下子做完。</p>
<p><strong>我建议的实现顺序是：</strong></p>
<ol>
<li><strong>Meta + Prompt 资产化</strong>（防止走歪）</li>
<li>最小可用执行引擎</li>
<li>状态 &amp; 任务生命周期</li>
<li>Diff &amp; 校验</li>
<li>自我演进能力</li>
</ol>
<h2 id="现在请你只回答一个问题（很关键）"><a href="#现在请你只回答一个问题（很关键）" class="headerlink" title="现在请你只回答一个问题（很关键）"></a>现在请你只回答一个问题（很关键）</h2><p>👉 <strong>你希望下一步从哪里开始？</strong></p>
<p>A. 从 <strong>Meta &#x2F; 治理层</strong>（最稳，但慢）<br>B. 从 <strong>Prompt 资产化（system 设计）</strong><br>C. 从 <strong>最小可跑引擎（先跑起来）</strong></p>
<p>你选一个，我就<strong>只做那一步，而且做到“工程级”</strong>。</p>
<h2 id="Prompt-2"><a href="#Prompt-2" class="headerlink" title="Prompt:"></a>Prompt:</h2><p>好的，接下面我们按照你上面规划的架构九个级别，从一级开始分析</p>
<h2 id="Response-2"><a href="#Response-2" class="headerlink" title="Response:"></a>Response:</h2><p>非常好 👍<br>我们<strong>正式进入工程级 VibeCoding 系统的“九级架构拆解”</strong>。</p>
<blockquote>
<p>⚠️ 我会<strong>严格遵守你的要求</strong>：</p>
<ul>
<li><strong>一次只分析一个级别</strong></li>
<li>不是“写点说明”，而是<strong>工程化、可长期维护的设计</strong></li>
<li>给出<strong>存在意义 &#x2F; 设计原则 &#x2F; 文件职责 &#x2F; 示例内容</strong></li>
<li>每一层都回答一句话：<blockquote>
<p><strong>如果这一层没有，系统最终会怎么死</strong></p>
</blockquote>
</li>
</ul>
</blockquote>
<h1 id="🧠-一级架构：Meta-治理层（System-Governance-Layer）"><a href="#🧠-一级架构：Meta-治理层（System-Governance-Layer）" class="headerlink" title="🧠 一级架构：Meta &#x2F; 治理层（System Governance Layer）"></a>🧠 一级架构：Meta &#x2F; 治理层（System Governance Layer）</h1><blockquote>
<p><strong>这一层不是“功能层”</strong><br>是整个系统的 <strong>价值锚点 + 演进约束器</strong></p>
</blockquote>
<h2 id="一、这一层解决的根本问题是什么？"><a href="#一、这一层解决的根本问题是什么？" class="headerlink" title="一、这一层解决的根本问题是什么？"></a>一、这一层解决的根本问题是什么？</h2><h3 id="一句话定义"><a href="#一句话定义" class="headerlink" title="一句话定义"></a>一句话定义</h3><blockquote>
<p><strong>防止 VibeCoding 系统在长期演进中“变成另一个东西”</strong></p>
</blockquote>
<h3 id="如果没有-Meta-层，会发生什么？"><a href="#如果没有-Meta-层，会发生什么？" class="headerlink" title="如果没有 Meta 层，会发生什么？"></a>如果没有 Meta 层，会发生什么？</h3><p>真实世界中 100% 会发生：</p>
<ol>
<li>system prompt 越写越长</li>
<li>conventions 被“临时破例”</li>
<li>为了赶进度引入 hack</li>
<li>半年后：<ul>
<li>❌ 新人不敢改</li>
<li>❌ 老人不想改</li>
<li>❌ AI 行为不可预测</li>
</ul>
</li>
</ol>
<p>👉 <strong>系统不是坏在 bug，而是坏在“失去方向”</strong></p>
<h2 id="二、Meta-层在工程里的真实地位"><a href="#二、Meta-层在工程里的真实地位" class="headerlink" title="二、Meta 层在工程里的真实地位"></a>二、Meta 层在工程里的真实地位</h2><p>你可以把它理解为：</p>
<p>| 工程对象 | 对应 |<br>| | |<br>| 公司宪章 | Meta |<br>| 架构委员会决议 | Meta |<br>| 法律底线 | Meta |<br>| Cursor 内部“不公开原则” | Meta |</p>
<p>⚠️ <strong>Meta 层的文件：</strong></p>
<ul>
<li>不频繁改</li>
<li>改一次影响全系统</li>
<li>改之前必须“意识到自己在动根基”</li>
</ul>
<h2 id="三、Meta-层的最小但完整结构"><a href="#三、Meta-层的最小但完整结构" class="headerlink" title="三、Meta 层的最小但完整结构"></a>三、Meta 层的最小但完整结构</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">meta/</span><br><span class="line">├── vision.md</span><br><span class="line">├── principles.md</span><br><span class="line">├── anti_patterns.md</span><br><span class="line">├── glossary.md</span><br></pre></td></tr></table></figure>

<p>下面我们<strong>逐个拆解</strong>。</p>
<h2 id="四、meta-vision-md-——「这个系统存在是为了什么」"><a href="#四、meta-vision-md-——「这个系统存在是为了什么」" class="headerlink" title="四、meta&#x2F;vision.md ——「这个系统存在是为了什么」"></a>四、meta&#x2F;vision.md ——「这个系统存在是为了什么」</h2><h3 id="职责（非常重要）"><a href="#职责（非常重要）" class="headerlink" title="职责（非常重要）"></a>职责（非常重要）</h3><ul>
<li>定义 <strong>系统要解决的问题</strong></li>
<li>明确 <strong>系统不解决的问题</strong></li>
<li>给未来的你一个“回忆锚点”</li>
</ul>
<h3 id="示例：vision-md（可直接用）"><a href="#示例：vision-md（可直接用）" class="headerlink" title="示例：vision.md（可直接用）"></a>示例：vision.md（可直接用）</h3><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># VibeCoding System – Vision</span></span><br><span class="line"></span><br><span class="line"><span class="section">## Purpose</span></span><br><span class="line"></span><br><span class="line">This system exists to:</span><br><span class="line"><span class="bullet">-</span> Enable human-guided, AI-assisted software development</span><br><span class="line"><span class="bullet">-</span> Emphasize long-term maintainability over one-shot code generation</span><br><span class="line"><span class="bullet">-</span> Treat prompts, specs, and code as first-class, versioned assets</span><br><span class="line"></span><br><span class="line"><span class="section">## Non-goals</span></span><br><span class="line"></span><br><span class="line">This system explicitly does NOT aim to:</span><br><span class="line"><span class="bullet">-</span> Fully automate software engineering</span><br><span class="line"><span class="bullet">-</span> Replace human architectural decision-making</span><br><span class="line"><span class="bullet">-</span> Optimize for speed at the cost of correctness or traceability</span><br><span class="line"></span><br><span class="line"><span class="section">## Core Belief</span></span><br><span class="line"></span><br><span class="line">AI is a collaborator, not an authority.</span><br><span class="line">All generated outputs must be explainable, reviewable, and reversible.</span><br><span class="line"></span><br><span class="line"><span class="section"># VibeCoding 系统——愿景</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 宗旨  </span></span><br><span class="line"></span><br><span class="line">本系统旨在：  </span><br><span class="line"><span class="bullet">-</span> 实现人类主导、人工智能辅助的软件开发模式  </span><br><span class="line"><span class="bullet">-</span> 强调长期可维护性，而非一次性代码生成  </span><br><span class="line"><span class="bullet">-</span> 将提示词、规格说明与代码同等视作核心资产，并纳入版本化管理  </span><br><span class="line"></span><br><span class="line"><span class="section">## 非目标  </span></span><br><span class="line"></span><br><span class="line">本系统明确不追求：  </span><br><span class="line"><span class="bullet">-</span> 软件工程的全面自动化  </span><br><span class="line"><span class="bullet">-</span> 以人工智能取代人类在架构层面的决策权  </span><br><span class="line"><span class="bullet">-</span> 为追求速度而牺牲正确性或可追溯性  </span><br><span class="line"></span><br><span class="line"><span class="section">## 核心信念  </span></span><br><span class="line"></span><br><span class="line">人工智能是协作者，而非权威者。  </span><br><span class="line">所有生成内容必须具备可解释性、可审查性与可逆性。</span><br></pre></td></tr></table></figure>

<p>🧠 <strong>工程意义</strong></p>
<blockquote>
<p>当你将来想“偷懒一步”的时候，这个文件会阻止你</p>
</blockquote>
<p>五、meta&#x2F;principles.md ——「不可违背的设计原则」</p>
<h3 id="这不是“建议”，是宪法级别"><a href="#这不是“建议”，是宪法级别" class="headerlink" title="这不是“建议”，是宪法级别"></a>这不是“建议”，是<strong>宪法级别</strong></h3><h3 id="示例：principles-md"><a href="#示例：principles-md" class="headerlink" title="示例：principles.md"></a>示例：principles.md</h3><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Core Principles</span></span><br><span class="line"></span><br><span class="line"><span class="section">## P1 – Human-in-the-loop</span></span><br><span class="line"></span><br><span class="line">All critical decisions must be reviewable or overridable by humans.</span><br><span class="line"></span><br><span class="line"><span class="section">## P2 – Explicit over implicit</span></span><br><span class="line"></span><br><span class="line">System behavior must be driven by explicit configuration, not hidden prompt tricks.</span><br><span class="line"></span><br><span class="line"><span class="section">## P3 – Evolution over rewrite</span></span><br><span class="line"></span><br><span class="line">The system must evolve through migration and refactoring, not full rewrites.</span><br><span class="line"></span><br><span class="line"><span class="section">## P4 – Diff-first mindset</span></span><br><span class="line"></span><br><span class="line">All code changes must be representable as diffs.</span><br><span class="line"></span><br><span class="line"><span class="section">## P5 – Failure is a first-class state</span></span><br><span class="line"></span><br><span class="line">Errors are expected and must be handled by design.</span><br><span class="line"></span><br><span class="line"><span class="section"># 核心原则</span></span><br><span class="line"></span><br><span class="line"><span class="section">## P1 — 人机协同决策  </span></span><br><span class="line">所有关键决策均须可由人类复核或否决。</span><br><span class="line"></span><br><span class="line"><span class="section">## P2 — 显式优于隐式  </span></span><br><span class="line">系统行为应由显式配置驱动，而非依赖隐晦的提示工程技巧。</span><br><span class="line"></span><br><span class="line"><span class="section">## P3 — 演进而非重写  </span></span><br><span class="line">系统演进应通过迁移与重构实现，而非全面推倒重来。</span><br><span class="line"></span><br><span class="line"><span class="section">## P4 — 差异优先思维  </span></span><br><span class="line">所有代码变更均须能以差异（diff）形式清晰呈现。</span><br><span class="line"></span><br><span class="line"><span class="section">## P5 — 失败即一等公民状态  </span></span><br><span class="line">错误属预期之内，须在系统设计层面予以妥善处理。</span><br></pre></td></tr></table></figure>

<p>👉 <strong>后面每写一个模块，你都能反问一句：</strong></p>
<blockquote>
<p>“我这是不是违背了 P2 &#x2F; P4？”</p>
</blockquote>
<p>六、meta&#x2F;anti_patterns.md ——「我们明确不这么干」</p>
<p>这是<strong>高级工程系统的标志</strong>。</p>
<h3 id="示例：anti-patterns-md"><a href="#示例：anti-patterns-md" class="headerlink" title="示例：anti_patterns.md"></a>示例：anti_patterns.md</h3><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Anti-patterns</span></span><br><span class="line"></span><br><span class="line"><span class="section">## AP1 – Monolithic Prompt</span></span><br><span class="line"></span><br><span class="line">Never place all logic into a single system prompt.</span><br><span class="line"></span><br><span class="line"><span class="section">## AP2 – Magic Fix</span></span><br><span class="line"></span><br><span class="line">Do not rely on &quot;the AI will probably fix it next time&quot;.</span><br><span class="line"></span><br><span class="line"><span class="section">## AP3 – Silent Overwrite</span></span><br><span class="line"></span><br><span class="line">Never overwrite user code without diff or backup.</span><br><span class="line"></span><br><span class="line"><span class="section">## AP4 – Spec Drift</span></span><br><span class="line"></span><br><span class="line">Specs must not be silently ignored to make generation easier.</span><br><span class="line"></span><br><span class="line"><span class="section"># 反模式</span></span><br><span class="line"></span><br><span class="line"><span class="section">## AP1 — 单一提示巨构  </span></span><br><span class="line">切勿将全部逻辑堆砌于单一系统提示中。</span><br><span class="line"></span><br><span class="line"><span class="section">## AP2 — 神奇修复幻想  </span></span><br><span class="line">切勿寄望“AI 下次大概会自行修正”。</span><br><span class="line"></span><br><span class="line"><span class="section">## AP3 — 静默覆盖  </span></span><br><span class="line">切勿在无差异比对或备份的前提下，擅自覆盖用户代码。</span><br><span class="line"></span><br><span class="line"><span class="section">## AP4 — 规范偏移  </span></span><br><span class="line">绝不可为简化生成过程而悄然忽视规格要求。</span><br></pre></td></tr></table></figure>

<p>🧠 <strong>这能救你至少 5 次大返工</strong></p>
<p>七、meta&#x2F;glossary.md ——「术语即协议」</p>
<blockquote>
<p>大型系统<strong>最先崩的是语言</strong></p>
</blockquote>
<h3 id="示例：glossary-md"><a href="#示例：glossary-md" class="headerlink" title="示例：glossary.md"></a>示例：glossary.md</h3><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Glossary</span></span><br><span class="line"></span><br><span class="line"><span class="section">## Prompt Module</span></span><br><span class="line">A composable, reusable unit of prompt logic.</span><br><span class="line"></span><br><span class="line"><span class="section">## Plan</span></span><br><span class="line">A structured, AI-generated description of intended actions before execution.</span><br><span class="line"></span><br><span class="line"><span class="section">## Diff</span></span><br><span class="line">A unified textual representation of changes to existing files.</span><br><span class="line"></span><br><span class="line"><span class="section">## Task</span></span><br><span class="line">A lifecycle-managed unit of work with state and history.</span><br><span class="line"></span><br><span class="line"><span class="section"># 术语表</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 提示模块  </span></span><br><span class="line">一种可组合、可复用的提示逻辑单元。</span><br><span class="line"></span><br><span class="line"><span class="section">## 计划  </span></span><br><span class="line">执行前由人工智能生成的、结构化的预期操作描述。</span><br><span class="line"></span><br><span class="line"><span class="section">## 差异  </span></span><br><span class="line">对既有文件所作变更的统一文本化表示。</span><br><span class="line"></span><br><span class="line"><span class="section">## 任务  </span></span><br><span class="line">具备状态与历史记录、受生命周期管理的工作单元。</span><br></pre></td></tr></table></figure>

<p>👉 后面你写 schema、parser、validator<br><strong>都必须以这里为准</strong></p>
<h2 id="八、这一层与后续八层的关系（非常关键）"><a href="#八、这一层与后续八层的关系（非常关键）" class="headerlink" title="八、这一层与后续八层的关系（非常关键）"></a>八、这一层与后续八层的关系（非常关键）</h2><p>| 下游层 | Meta 约束 |<br>| | |<br>| Prompt 层 | 不得违反 principles |<br>| Spec 层 | 术语必须来自 glossary |<br>| Engine | 不得实现 anti-pattern |<br>| Evolution | 必须符合 vision |</p>
<p>👉 <strong>Meta 是“只读”的规则源</strong></p>
<h2 id="九、本级完成标准（你只需确认这个）"><a href="#九、本级完成标准（你只需确认这个）" class="headerlink" title="九、本级完成标准（你只需确认这个）"></a>九、本级完成标准（你只需确认这个）</h2><p>请你确认下面三点之一即可进入下一级：</p>
<p>1️⃣ <strong>我理解并接受 Meta 层的定位与文件划分</strong><br>2️⃣ 我想<strong>先微调某个 Meta 文件的内容</strong><br>3️⃣ 我有疑问：_______</p>
<h3 id="下一步预告（不会提前展开）"><a href="#下一步预告（不会提前展开）" class="headerlink" title="下一步预告（不会提前展开）"></a>下一步预告（不会提前展开）</h3><p>▶️ <strong>二级：Prompt 资产化层</strong><br>我们会彻底解决：</p>
<blockquote>
<p>为什么 system.md 不能再是一个文件<br>Cursor 的 system prompt 是怎么“拼装”的</p>
</blockquote>
<p>你确认后，我再继续。</p>
<h2 id="Prompt-3"><a href="#Prompt-3" class="headerlink" title="Prompt:"></a>Prompt:</h2><p>好，我理解，我们进入二级</p>
<h2 id="Response-3"><a href="#Response-3" class="headerlink" title="Response:"></a>Response:</h2><p>非常好 👍<br>从你刚才那句“我理解”，可以确定一件事：</p>
<blockquote>
<p><strong>你已经把这个系统当成“长期工程资产”，而不是一次性脚本了</strong></p>
</blockquote>
<p>我们继续 <strong>严格只做二级</strong>，不提前、不跳步。</p>
<h1 id="🧾-二级架构：Prompt-资产化层"><a href="#🧾-二级架构：Prompt-资产化层" class="headerlink" title="🧾 二级架构：Prompt 资产化层"></a>🧾 二级架构：Prompt 资产化层</h1><p>##（Prompt as Versioned, Composable Assets）</p>
<blockquote>
<p>这是 <strong>VibeCoding 系统的心脏</strong><br>也是 Cursor &#x2F; Devin 与“普通 prompt 工程”的本质分水岭</p>
</blockquote>
<h2 id="一、先说一句“残酷的事实”"><a href="#一、先说一句“残酷的事实”" class="headerlink" title="一、先说一句“残酷的事实”"></a>一、先说一句“残酷的事实”</h2><blockquote>
<p><strong>99% 的 AI 编程工具，死在 prompt 层</strong></p>
</blockquote>
<p>不是模型不行，是 prompt 变成了：</p>
<ul>
<li>巨石（monolith）</li>
<li>黑盒（black magic）</li>
<li>不可维护文本（write-only）</li>
</ul>
<p>你现在要做的，是<strong>彻底避免这一点</strong>。</p>
<p>二、二级层解决的核心问题</p>
<h3 id="一句话定义-1"><a href="#一句话定义-1" class="headerlink" title="一句话定义"></a>一句话定义</h3><blockquote>
<p><strong>让 Prompt 具备“代码一样的工程属性”</strong></p>
</blockquote>
<p>也就是说，Prompt 必须是：</p>
<p>| 属性 | 含义 |<br>| | |<br>| 可组合 | 像函数一样拼装 |<br>| 可版本化 | 能回退、对比 |<br>| 可测试 | 改了知道影响 |<br>| 可审计 | 知道行为从哪来 |</p>
<p>三、如果没有 Prompt 资产化层，会怎么死？</p>
<p>真实演进路径如下（一定会发生）：</p>
<ol>
<li>system.md 300 行</li>
<li>加一句“请严格遵守上面的规则”</li>
<li>AI 开始忽略前半部分</li>
<li>不敢再改</li>
<li>系统行为不可预测</li>
</ol>
<p>👉 <strong>这是 prompt 熵增定律</strong></p>
<p>四、二级层的目标形态（不是一次做完）</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">prompt/</span><br><span class="line">├── system/</span><br><span class="line">│   ├── system.v1.md</span><br><span class="line">│   ├── system.v2.md</span><br><span class="line">│   └── system.current</span><br><span class="line">│</span><br><span class="line">├── modules/</span><br><span class="line">│   ├── role.md</span><br><span class="line">│   ├── constraints.md</span><br><span class="line">│   ├── output_format.md</span><br><span class="line">│   ├── diff_rules.md</span><br><span class="line">│   └── safety.md</span><br><span class="line">│</span><br><span class="line">├── assembly/</span><br><span class="line">│   └── assemble.py</span><br><span class="line">│</span><br><span class="line">├── tests/</span><br><span class="line">│   ├── test_plan_generation.md</span><br><span class="line">│   ├── test_diff_behavior.md</span><br><span class="line">│   └── fixtures/</span><br></pre></td></tr></table></figure>

<p>⚠️ 注意：<br><strong>system.md 不存在了</strong>，它是“编译产物”。</p>
<h2 id="五、核心思想：System-Prompt-组合结果"><a href="#五、核心思想：System-Prompt-组合结果" class="headerlink" title="五、核心思想：System Prompt &#x3D; 组合结果"></a>五、核心思想：System Prompt &#x3D; 组合结果</h2><h3 id="类比（非常重要）"><a href="#类比（非常重要）" class="headerlink" title="类比（非常重要）"></a>类比（非常重要）</h3><p>| 编程 | Prompt |<br>| | |<br>| 源码 | modules |<br>| 构建 | assembly |<br>| 可执行文件 | system.current |</p>
<h2 id="六、Prompt-Modules-的设计规范"><a href="#六、Prompt-Modules-的设计规范" class="headerlink" title="六、Prompt Modules 的设计规范"></a>六、Prompt Modules 的设计规范</h2><h3 id="1️⃣-role-md-——-AI-是“谁”"><a href="#1️⃣-role-md-——-AI-是“谁”" class="headerlink" title="1️⃣ role.md —— AI 是“谁”"></a>1️⃣ role.md —— AI 是“谁”</h3><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Role Definition</span></span><br><span class="line"></span><br><span class="line">You are an AI software engineering assistant.</span><br><span class="line"></span><br><span class="line">Your responsibilities include:</span><br><span class="line"><span class="bullet">-</span> Generating plans before code</span><br><span class="line"><span class="bullet">-</span> Respecting architectural constraints</span><br><span class="line"><span class="bullet">-</span> Explaining reasoning when requested</span><br><span class="line"></span><br><span class="line">You are NOT:</span><br><span class="line"><span class="bullet">-</span> An autonomous agent</span><br><span class="line"><span class="bullet">-</span> A decision-maker without human approval</span><br><span class="line"></span><br><span class="line"><span class="section"># 角色定义</span></span><br><span class="line"></span><br><span class="line">你是一名人工智能软件工程助手。</span><br><span class="line"></span><br><span class="line">你的职责包括：  </span><br><span class="line"><span class="bullet">-</span> 在编写代码前制定计划；  </span><br><span class="line"><span class="bullet">-</span> 遵守架构约束；  </span><br><span class="line"><span class="bullet">-</span> 在被要求时说明推理过程。</span><br><span class="line"></span><br><span class="line">你<span class="strong">**不是**</span>：  </span><br><span class="line"><span class="bullet">-</span> 一个自主代理；  </span><br><span class="line"><span class="bullet">-</span> 一个未经人工批准即可自行决策的主体。</span><br></pre></td></tr></table></figure>

<p>👉 <strong>只定义身份，不写规则</strong></p>
<h3 id="2️⃣-constraints-md-——-不可违背的硬约束"><a href="#2️⃣-constraints-md-——-不可违背的硬约束" class="headerlink" title="2️⃣ constraints.md —— 不可违背的硬约束"></a>2️⃣ constraints.md —— 不可违背的硬约束</h3><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Constraints</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> Do not modify files without explicit instruction</span><br><span class="line"><span class="bullet">-</span> Do not generate code without a plan</span><br><span class="line"><span class="bullet">-</span> Do not overwrite existing code; always use diffs</span><br><span class="line"><span class="bullet">-</span> Follow all naming and layering rules from spec</span><br><span class="line"></span><br><span class="line"><span class="section"># 约束条件</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 未经明确指示，不得修改任何文件；  </span><br><span class="line"><span class="bullet">-</span> 未制定周密计划前，不得生成代码；  </span><br><span class="line"><span class="bullet">-</span> 不得覆盖既有代码，务必采用差异比对（diff）方式进行变更；  </span><br><span class="line"><span class="bullet">-</span> 严格遵循规范中规定的命名规则与分层架构要求。</span><br></pre></td></tr></table></figure>

<p>👉 对应 Meta 的 principles &#x2F; anti-patterns</p>
<h3 id="3️⃣-output-format-md-——-机器可解析"><a href="#3️⃣-output-format-md-——-机器可解析" class="headerlink" title="3️⃣ output_format.md —— 机器可解析"></a>3️⃣ output_format.md —— 机器可解析</h3><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Output Format</span></span><br><span class="line"></span><br><span class="line">All responses must be in one of the following forms:</span><br><span class="line"></span><br><span class="line"><span class="section">## Plan</span></span><br><span class="line"><span class="code">```json</span></span><br><span class="line"><span class="code">&#123;</span></span><br><span class="line"><span class="code">  &quot;type&quot;: &quot;plan&quot;,</span></span><br><span class="line"><span class="code">  &quot;steps&quot;: []</span></span><br><span class="line"><span class="code">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Diff"><a href="#Diff" class="headerlink" title="Diff"></a>Diff</h2><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> a/file.py</span><br><span class="line"><span class="comment">+++ b/file.py</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Explanation</span><br><span class="line"><span class="deletion">--</span></span><br><span class="line"></span><br><span class="line">Plain text explanation only.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>👉 <strong>这是 spec_parser 能活下来的前提</strong></p>
<h3 id="4️⃣-diff-rules-md-——-Cursor-的灵魂之一"><a href="#4️⃣-diff-rules-md-——-Cursor-的灵魂之一" class="headerlink" title="4️⃣ diff_rules.md —— Cursor 的灵魂之一"></a>4️⃣ diff_rules.md —— Cursor 的灵魂之一</h3><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Diff Rules</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> Use unified diff format</span><br><span class="line"><span class="bullet">-</span> Context lines must be accurate</span><br><span class="line"><span class="bullet">-</span> Do not include unchanged files</span><br><span class="line"><span class="bullet">-</span> One diff per file</span><br></pre></td></tr></table></figure>

<h3 id="5️⃣-safety-md-——-防止灾难"><a href="#5️⃣-safety-md-——-防止灾难" class="headerlink" title="5️⃣ safety.md —— 防止灾难"></a>5️⃣ safety.md —— 防止灾难</h3><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Safety Rules</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> If unsure, ask for clarification</span><br><span class="line"><span class="bullet">-</span> Never assume user intent</span><br><span class="line"><span class="bullet">-</span> Abort generation if constraints conflict</span><br></pre></td></tr></table></figure>

<p>七、system.current 是如何生成的？</p>
<blockquote>
<p>system.current <strong>不手写</strong></p>
</blockquote>
<p>它由 <code>assemble.py</code> 拼出来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">modules = [</span><br><span class="line">    <span class="string">&quot;role.md&quot;</span>,</span><br><span class="line">    <span class="string">&quot;constraints.md&quot;</span>,</span><br><span class="line">    <span class="string">&quot;output_format.md&quot;</span>,</span><br><span class="line">    <span class="string">&quot;diff_rules.md&quot;</span>,</span><br><span class="line">    <span class="string">&quot;safety.md&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">system_prompt = <span class="string">&quot;\n\n&quot;</span>.join(load(m) <span class="keyword">for</span> m <span class="keyword">in</span> modules)</span><br></pre></td></tr></table></figure>

<p>👉 这一步以后可以自动化、加 hash、加版本</p>
<p>八、Prompt Tests（极少人做到，但你要）</p>
<h3 id="示例：tests-test-diff-behavior-md"><a href="#示例：tests-test-diff-behavior-md" class="headerlink" title="示例：tests&#x2F;test_diff_behavior.md"></a>示例：tests&#x2F;test_diff_behavior.md</h3><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Test: Diff Behavior</span></span><br><span class="line"></span><br><span class="line"><span class="section">## Input</span></span><br><span class="line">User asks to rename a function.</span><br><span class="line"></span><br><span class="line"><span class="section">## Expected</span></span><br><span class="line"><span class="bullet">-</span> Output type is Diff</span><br><span class="line"><span class="bullet">-</span> No full file rewrite</span><br><span class="line"><span class="bullet">-</span> Unified diff format</span><br></pre></td></tr></table></figure>

<p>👉 后续可以用 LLM 来跑 prompt regression</p>
<p>九、二级层与其他层的关系</p>
<p>| 下游层 | 依赖 |<br>| | |<br>| Spec | output_format |<br>| Engine | diff_rules |<br>| Validator | constraints |<br>| Evolution | system.v* |</p>
<p>十、本级完成判断（你只需回应）</p>
<p>请你确认其中一个：</p>
<p>1️⃣ <strong>我理解 Prompt 资产化的必要性和结构</strong><br>2️⃣ 我想<strong>先把 modules 再细拆 &#x2F; 合并</strong><br>3️⃣ 我有一个具体疑问：_____</p>
<h3 id="下一步预告（不展开）"><a href="#下一步预告（不展开）" class="headerlink" title="下一步预告（不展开）"></a>下一步预告（不展开）</h3><p>▶️ <strong>三级：Spec ≠ 文档（Spec &#x2F; Rule &#x2F; Schema 三位一体）</strong></p>
<p>这是让 AI <strong>“不敢乱来”</strong> 的关键层。</p>
<h2 id="Prompt-4"><a href="#Prompt-4" class="headerlink" title="Prompt:"></a>Prompt:</h2><p>纠正并详细说明一下 output_format.md 和 assemble.py 的内容</p>
<h2 id="Response-4"><a href="#Response-4" class="headerlink" title="Response:"></a>Response:</h2><p>好的，我们来<strong>纠正并详细化</strong> <code>output_format.md</code> 和 <code>assemble.py</code>，让它们真正符合<strong>工程级、可长期复用、可维护、可测试</strong>的要求。</p>
<h1 id="一、output-format-md-——-输出格式模块"><a href="#一、output-format-md-——-输出格式模块" class="headerlink" title="一、output_format.md —— 输出格式模块"></a>一、output_format.md —— 输出格式模块</h1><blockquote>
<p>目标：让 <strong>AI 输出结构化、机器可解析、同时可回归测试</strong><br>注意：<strong>不是给 AI 写任意规则，而是严格定义 JSON &#x2F; Diff &#x2F; Explanation 的 schema</strong></p>
</blockquote>
<h2 id="1️⃣-模块职责"><a href="#1️⃣-模块职责" class="headerlink" title="1️⃣ 模块职责"></a>1️⃣ 模块职责</h2><ul>
<li>定义所有 AI 可能返回的类型</li>
<li>每个类型的字段、必选&#x2F;可选、格式、校验规则</li>
<li>保证 AI 生成内容可由 <code>spec_parser</code> 解析</li>
<li>提供测试基准（tests 可以引用）</li>
</ul>
<h2 id="2️⃣-详细示例（工程级）"><a href="#2️⃣-详细示例（工程级）" class="headerlink" title="2️⃣ 详细示例（工程级）"></a>2️⃣ 详细示例（工程级）</h2><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Output Format Specification</span></span><br><span class="line"></span><br><span class="line">All AI responses <span class="strong">**must**</span> conform to one of the following types.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">## Type: Plan</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> Purpose: Describe the intended actions before code generation.</span><br><span class="line"><span class="bullet">-</span> Format: JSON</span><br><span class="line"><span class="bullet">-</span> Required Fields:</span><br><span class="line"><span class="bullet">  -</span> &quot;type&quot;: &quot;plan&quot; (string, fixed)</span><br><span class="line"><span class="bullet">  -</span> &quot;steps&quot;: list of step objects</span><br><span class="line"><span class="bullet">-</span> Step object:</span><br><span class="line"><span class="bullet">  -</span> &quot;id&quot;: string, unique</span><br><span class="line"><span class="bullet">  -</span> &quot;description&quot;: string</span><br><span class="line"><span class="bullet">  -</span> &quot;dependencies&quot;: list of step ids (optional)</span><br><span class="line"><span class="bullet">  -</span> &quot;status&quot;: string [&quot;pending&quot;, &quot;done&quot;, &quot;skipped&quot;] (optional)</span><br><span class="line"></span><br><span class="line"><span class="section">### Example</span></span><br><span class="line"></span><br><span class="line"><span class="code">```json</span></span><br><span class="line"><span class="code">&#123;</span></span><br><span class="line"><span class="code">  &quot;type&quot;: &quot;plan&quot;,</span></span><br><span class="line"><span class="code">  &quot;steps&quot;: [</span></span><br><span class="line"><span class="code">    &#123;&quot;id&quot;: &quot;s1&quot;, &quot;description&quot;: &quot;Generate spec parser&quot;, &quot;dependencies&quot;: [], &quot;status&quot;: &quot;pending&quot;&#125;</span></span><br><span class="line"><span class="code">  ]</span></span><br><span class="line"><span class="code">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Type-Diff"><a href="#Type-Diff" class="headerlink" title="Type: Diff"></a>Type: Diff</h2><ul>
<li>Purpose: Represent textual changes to existing files.</li>
<li>Format: Unified diff (standard diff format)</li>
<li>Constraints:<ul>
<li>Each diff must contain only one file</li>
<li>Context lines &#x3D; 3</li>
<li>Must not overwrite unrelated code</li>
</ul>
</li>
</ul>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> a/file.py</span><br><span class="line"><span class="comment">+++ b/file.py</span></span><br><span class="line"><span class="meta">@@ -1,4 +1,5 @@</span></span><br><span class="line"><span class="deletion">-def foo():</span></span><br><span class="line"><span class="deletion">-    pass</span></span><br><span class="line"><span class="addition">+def foo():</span></span><br><span class="line"><span class="addition">+    print(&quot;Hello World&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="Type-Explanation"><a href="#Type-Explanation" class="headerlink" title="Type: Explanation"></a>Type: Explanation</h2><ul>
<li>Purpose: Explain reasoning, decisions, or errors.</li>
<li>Format: Plain text</li>
<li>Constraints:<ul>
<li>Must not include code that modifies files</li>
<li>Can include references to Plan step ids</li>
</ul>
</li>
</ul>
<h3 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Step s1 generates spec_parser.py based on schema.json</span><br></pre></td></tr></table></figure>

<h2 id="Type-Error"><a href="#Type-Error" class="headerlink" title="Type: Error"></a>Type: Error</h2><ul>
<li>Purpose: Report validation errors</li>
<li>Format: JSON</li>
<li>Fields:<ul>
<li>“type”: “error”</li>
<li>“message”: string</li>
<li>“code”: string (optional)</li>
<li>“related_step”: step id (optional)</li>
</ul>
</li>
</ul>
<h3 id="Example-2"><a href="#Example-2" class="headerlink" title="Example"></a>Example</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Step s1 violates output_format rules&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;related_step&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 3️⃣ 工程级说明</span><br><span class="line"></span><br><span class="line">1. 每种类型都是**严格可解析的**  </span><br><span class="line">2. 方便 `spec_parser.py` 做 **类型校验**  </span><br><span class="line">3. 方便 **回归测试** / **diff 测试**  </span><br><span class="line">4. 支持 **AI 输出失败检测**  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 二、assemble.py —— Prompt 组合器</span><br><span class="line"></span><br><span class="line">&gt; 目标：把各个 `modules/*.md` 拼接成 `system.current`，保证：</span><br><span class="line">&gt; - 顺序可控</span><br><span class="line">&gt; - 可添加 hash / 版本  </span><br><span class="line">&gt; - 可在 CI/CD 自动生成  </span><br><span class="line">&gt; - 支持 unit test</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 1️⃣ 工程级 assemble.py 示例</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line">import os</span><br><span class="line">import hashlib</span><br><span class="line"></span><br><span class="line">MODULE_DIR = &quot;prompt/modules&quot;</span><br><span class="line">SYSTEM_DIR = &quot;prompt/system&quot;</span><br><span class="line">MODULE_ORDER = [</span><br><span class="line">    &quot;role.md&quot;,</span><br><span class="line">    &quot;constraints.md&quot;,</span><br><span class="line">    &quot;output_format.md&quot;,</span><br><span class="line">    &quot;diff_rules.md&quot;,</span><br><span class="line">    &quot;safety.md&quot;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">def load_module(module_name):</span><br><span class="line">    path = os.path.join(MODULE_DIR, module_name)</span><br><span class="line">    with open(path, &quot;r&quot;, encoding=&quot;utf-8&quot;) as f:</span><br><span class="line">        return f.read().strip()</span><br><span class="line"></span><br><span class="line">def compute_hash(text):</span><br><span class="line">    &quot;&quot;&quot;计算内容哈希，用于版本管理或回归测试&quot;&quot;&quot;</span><br><span class="line">    return hashlib.sha256(text.encode(&quot;utf-8&quot;)).hexdigest()</span><br><span class="line"></span><br><span class="line">def assemble_system():</span><br><span class="line">    &quot;&quot;&quot;组合所有模块生成 system.current&quot;&quot;&quot;</span><br><span class="line">    content = &quot;\n\n&quot;.join(load_module(m) for m in MODULE_ORDER)</span><br><span class="line">    # 写入 system.current</span><br><span class="line">    os.makedirs(SYSTEM_DIR, exist_ok=True)</span><br><span class="line">    current_path = os.path.join(SYSTEM_DIR, &quot;system.current&quot;)</span><br><span class="line">    with open(current_path, &quot;w&quot;, encoding=&quot;utf-8&quot;) as f:</span><br><span class="line">        f.write(content)</span><br><span class="line">    # 返回内容和 hash</span><br><span class="line">    return content, compute_hash(content)</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    content, h = assemble_system()</span><br><span class="line">    print(f&quot;System prompt assembled, SHA256: &#123;h&#125;&quot;)</span><br></pre></td></tr></table></figure>

<h2 id="2️⃣-工程级补充说明"><a href="#2️⃣-工程级补充说明" class="headerlink" title="2️⃣ 工程级补充说明"></a>2️⃣ 工程级补充说明</h2><ol>
<li><strong>模块顺序可控</strong><ul>
<li>role.md 必须最前，constraints.md 紧随其后</li>
<li>output_format.md 在 parser 之前</li>
</ul>
</li>
<li><strong>生成的 system.current 是单一入口</strong><ul>
<li>Engine &#x2F; AI client 只读取 <code>system.current</code></li>
</ul>
</li>
<li><strong>hash 校验</strong><ul>
<li>CI&#x2F;CD 可以检测是否修改</li>
<li>回归测试可以确保 AI 输出行为一致</li>
</ul>
</li>
<li><strong>可扩展</strong><ul>
<li>将来增加 <code>logging.md</code> 或 <code>context_rules.md</code></li>
<li>只需修改 MODULE_ORDER 和 modules 文件，不影响 engine 代码</li>
</ul>
</li>
<li><strong>可测试</strong><ul>
<li>tests&#x2F; 下可直接用 assemble.py 输出内容对比</li>
<li>可以写 snapshot 测试，确保系统行为可追踪</li>
</ul>
</li>
</ol>
<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><p>| 文件 | 工程级关键点 |<br>| | |<br>| output_format.md | 严格定义 AI 输出结构、可解析、可测试、支持回归 |<br>| assemble.py | 模块组合器、顺序控制、hash 校验、可扩展、生成 system.current |</p>
<p>✅ 这一层完成标准：</p>
<ul>
<li><code>output_format.md</code> <strong>结构化、可校验、示例清楚</strong></li>
<li><code>assemble.py</code> <strong>模块顺序、组合、hash、生成 system.current</strong></li>
<li>支持 <strong>CI&#x2F;CD 流程和单元测试</strong></li>
</ul>
<p>如果你确认这个设计，我可以继续进入<strong>三级：Spec 层（Spec ≠ 文档，Schema + Rules + Validation）</strong>，这是保证 AI <strong>不敢乱生成的关键</strong>。</p>
<p>你是否确认进入三级？</p>
<h2 id="Prompt-5"><a href="#Prompt-5" class="headerlink" title="Prompt:"></a>Prompt:</h2><p>进入三级</p>
<h2 id="Response-5"><a href="#Response-5" class="headerlink" title="Response:"></a>Response:</h2><p>好的，我们进入 <strong>三级：Spec 层</strong>。这是工程级 VibeCoding 系统中<strong>约束 AI 行为的核心层</strong>，直接决定生成的代码是否可维护、可解析、可验证。</p>
<blockquote>
<p>⚠️ 本级重点：</p>
<ul>
<li>Spec 不只是文档，它必须<strong>可机器解析 + 可验证 + 可校验</strong></li>
<li>保证 AI <strong>遵循规范，不随意生成</strong></li>
</ul>
</blockquote>
<h1 id="🧾-三级架构：Spec-层（Spec-Rule-Schema-三位一体）"><a href="#🧾-三级架构：Spec-层（Spec-Rule-Schema-三位一体）" class="headerlink" title="🧾 三级架构：Spec 层（Spec &#x2F; Rule &#x2F; Schema 三位一体）"></a>🧾 三级架构：Spec 层（Spec &#x2F; Rule &#x2F; Schema 三位一体）</h1><p>一、核心问题</p>
<p>如果没有 Spec 层会发生什么？</p>
<ol>
<li>AI 会“自作主张”，生成任意代码或文本</li>
<li>code 与架构、schema 脱节</li>
<li>代码生成不可追踪、不可回归测试</li>
<li>长期维护成本无限膨胀</li>
</ol>
<blockquote>
<p><strong>结论：没有 Spec，Prompt + Engine &#x3D; 乱象</strong></p>
</blockquote>
<h2 id="二、三级层目标"><a href="#二、三级层目标" class="headerlink" title="二、三级层目标"></a>二、三级层目标</h2><ul>
<li><strong>明确“AI 可以生成什么，不可以生成什么”</strong></li>
<li><strong>机器可解析</strong>，可以由 parser 或 validator 自动检查</li>
<li><strong>长期可演进</strong>，Schema + Rules 可版本化</li>
</ul>
<h2 id="三、三级目录建议"><a href="#三、三级目录建议" class="headerlink" title="三、三级目录建议"></a>三、三级目录建议</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spec/</span><br><span class="line">├── docs/</span><br><span class="line">│   ├── overview.md        # 系统总体功能概览</span><br><span class="line">│   └── details.md         # 每个功能/模块细节</span><br><span class="line">├── rules/</span><br><span class="line">│   ├── naming.yaml        # 命名规则</span><br><span class="line">│   ├── layering.yaml      # 分层规则</span><br><span class="line">│   ├── task_constraints.yaml  # 任务生成约束</span><br><span class="line">├── schema/</span><br><span class="line">│   └── output.schema.json  # 对应 output_format.md 的 JSON Schema</span><br></pre></td></tr></table></figure>

<h2 id="四、核心组成说明"><a href="#四、核心组成说明" class="headerlink" title="四、核心组成说明"></a>四、核心组成说明</h2><h3 id="1️⃣-docs"><a href="#1️⃣-docs" class="headerlink" title="1️⃣ docs&#x2F;"></a>1️⃣ docs&#x2F;</h3><ul>
<li><strong>overview.md</strong><ul>
<li>系统模块结构概览</li>
<li>每个模块职责</li>
<li>方便新成员理解</li>
</ul>
</li>
<li><strong>details.md</strong><ul>
<li>每个模块的输入输出要求</li>
<li>调用约束</li>
<li>示例</li>
</ul>
</li>
</ul>
<p>示例 <code>overview.md</code>（简化）：</p>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Spec Overview</span></span><br><span class="line"></span><br><span class="line">Modules:</span><br><span class="line"><span class="bullet">1.</span> spec<span class="emphasis">_parser</span></span><br><span class="line"><span class="emphasis">   - Input: schema.json, rules/*.yaml</span></span><br><span class="line"><span class="emphasis">   - Output: validated plan or diff</span></span><br><span class="line"><span class="emphasis">2. file_</span>manager</span><br><span class="line"><span class="bullet">   -</span> Input: plan/diff</span><br><span class="line"><span class="bullet">   -</span> Output: file changes</span><br><span class="line"><span class="bullet">3.</span> validator</span><br><span class="line"><span class="bullet">   -</span> Input: generated code or diff</span><br><span class="line"><span class="bullet">   -</span> Output: pass/fail report</span><br></pre></td></tr></table></figure>

<h3 id="2️⃣-rules-——-约束规则（机器可读）"><a href="#2️⃣-rules-——-约束规则（机器可读）" class="headerlink" title="2️⃣ rules&#x2F; —— 约束规则（机器可读）"></a>2️⃣ rules&#x2F; —— 约束规则（机器可读）</h3><p>示例 <code>naming.yaml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Naming conventions</span></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">style:</span> <span class="string">camelCase</span></span><br><span class="line">  <span class="attr">forbidden:</span> [<span class="string">&quot;tmp&quot;</span>, <span class="string">&quot;var&quot;</span>]</span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="attr">style:</span> <span class="string">snake_case</span></span><br><span class="line"><span class="attr">classes:</span></span><br><span class="line">  <span class="attr">style:</span> <span class="string">PascalCase</span></span><br><span class="line"><span class="attr">files:</span></span><br><span class="line">  <span class="attr">extensions:</span> [<span class="string">&quot;.py&quot;</span>, <span class="string">&quot;.md&quot;</span>, <span class="string">&quot;.json&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>示例 <code>layering.yaml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Layering rules</span></span><br><span class="line"><span class="attr">layers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">engine</span></span><br><span class="line">    <span class="attr">allowed_imports:</span> [<span class="string">&quot;spec_parser&quot;</span>, <span class="string">&quot;file_manager&quot;</span>, <span class="string">&quot;validator&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">spec</span></span><br><span class="line">    <span class="attr">allowed_imports:</span> [<span class="string">&quot;rules&quot;</span>, <span class="string">&quot;schema&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prompt</span></span><br><span class="line">    <span class="attr">allowed_imports:</span> []</span><br></pre></td></tr></table></figure>

<p>示例 <code>task_constraints.yaml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Task generation constraints</span></span><br><span class="line"><span class="attr">max_steps_per_plan:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">mandatory_fields:</span> [<span class="string">&quot;id&quot;</span>, <span class="string">&quot;description&quot;</span>]</span><br><span class="line"><span class="attr">allow_dependencies:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">status_enum:</span> [<span class="string">&quot;pending&quot;</span>, <span class="string">&quot;done&quot;</span>, <span class="string">&quot;skipped&quot;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="3️⃣-schema-——-结构化-Schema"><a href="#3️⃣-schema-——-结构化-Schema" class="headerlink" title="3️⃣ schema&#x2F; —— 结构化 Schema"></a>3️⃣ schema&#x2F; —— 结构化 Schema</h3><p><code>output.schema.json</code> 对应 <code>output_format.md</code>，用于 <strong>自动校验 AI 输出</strong>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://json-schema.org/draft-07/schema#&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;oneOf&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;const&quot;</span><span class="punctuation">:</span> <span class="string">&quot;plan&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;steps&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;enum&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;pending&quot;</span><span class="punctuation">,</span> <span class="string">&quot;done&quot;</span><span class="punctuation">,</span> <span class="string">&quot;skipped&quot;</span><span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;id&quot;</span><span class="punctuation">,</span> <span class="string">&quot;description&quot;</span><span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;type&quot;</span><span class="punctuation">,</span> <span class="string">&quot;steps&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;const&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;type&quot;</span><span class="punctuation">,</span> <span class="string">&quot;message&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>五、三级层关键原则</p>
<ol>
<li><strong>可解析</strong><ul>
<li>validator &#x2F; spec_parser 可以直接读取 YAML &#x2F; JSON Schema 校验 AI 输出</li>
</ul>
</li>
<li><strong>规则可演进</strong><ul>
<li>新增模块只需增加 YAML 文件</li>
<li>不破坏旧模块</li>
</ul>
</li>
<li><strong>规则优先于 Prompt</strong><ul>
<li>Prompt 可以生成 Plan&#x2F;Diff，但必须符合 schema + rules</li>
</ul>
</li>
<li><strong>任务驱动的生成</strong><ul>
<li>Plan steps 生成前，必须通过 schema&#x2F;rules 校验</li>
</ul>
</li>
</ol>
<h2 id="六、三级层与上下游关系"><a href="#六、三级层与上下游关系" class="headerlink" title="六、三级层与上下游关系"></a>六、三级层与上下游关系</h2><p>| 上游 | 本层依赖 | 下游 |<br>| | | |<br>| Prompt | 需要知道 rules&#x2F;schema | Engine&#x2F;Validator |<br>| Meta | principles 约束 | rules&#x2F;schema 必须遵循 |<br>| Engine | plan&#x2F;diff 输出 | Validator&#x2F;Context |</p>
<h2 id="七、工程级注意点"><a href="#七、工程级注意点" class="headerlink" title="七、工程级注意点"></a>七、工程级注意点</h2><ul>
<li>schema + rules 是<strong>不可忽略的“安全网”</strong></li>
<li>validator 依赖 YAML + JSON Schema 自动化校验</li>
<li>可以用于 CI&#x2F;CD 自动化测试 AI 输出</li>
<li>支持<strong>回归测试</strong>（AI 输出违反 rules 的情况必须 fail）</li>
</ul>
<p>✅ <strong>完成标准</strong></p>
<ul>
<li>Spec 层包含三个部分：<code>docs/</code> + <code>rules/</code> + <code>schema/</code></li>
<li>AI 输出 Plan&#x2F;Diff&#x2F;Explanation 都有机器可解析的校验方式</li>
<li>系统可在 CI&#x2F;CD 自动化回归测试</li>
</ul>
<p>下一步是 <strong>四级：状态 &amp; 记忆系统（长期复用核心）</strong>，用于追踪 <strong>项目状态、任务历史、Prompt 状态</strong>。</p>
<p>你确认进入四级吗？</p>
<h2 id="Prompt-6"><a href="#Prompt-6" class="headerlink" title="Prompt:"></a>Prompt:</h2><p>继续</p>
<h2 id="Response-6"><a href="#Response-6" class="headerlink" title="Response:"></a>Response:</h2><p>好的，我们进入 <strong>四级：状态 &amp; 记忆系统（Context &#x2F; Memory Layer）</strong>。<br>这是工程级 VibeCoding 系统的 <strong>长期复用核心</strong>，保证系统不会丢失信息、不会重复生成、可回滚、可追踪。</p>
<h1 id="🧠-四级架构：状态-记忆系统（Context-Memory）"><a href="#🧠-四级架构：状态-记忆系统（Context-Memory）" class="headerlink" title="🧠 四级架构：状态 &amp; 记忆系统（Context &#x2F; Memory）"></a>🧠 四级架构：状态 &amp; 记忆系统（Context &#x2F; Memory）</h1><p>一、核心问题</p>
<p>如果没有状态与记忆系统，会发生：</p>
<ol>
<li>每次 AI 都像从零开始，无法延续项目上下文</li>
<li>生成的 Plan &#x2F; Diff &#x2F; Task 无法追踪</li>
<li>人工干预后的改动无法记录</li>
<li>无法在长期迭代中回溯历史决策</li>
</ol>
<blockquote>
<p><strong>结论：没有 Context 层，系统无法长期维护和复用</strong></p>
</blockquote>
<h2 id="二、目标"><a href="#二、目标" class="headerlink" title="二、目标"></a>二、目标</h2><ul>
<li>记录<strong>项目当前状态</strong></li>
<li>记录<strong>任务&#x2F;计划历史</strong></li>
<li>记录<strong>Prompt 版本状态</strong></li>
<li>支持<strong>回滚、重试、追踪、审计</strong></li>
<li>支持<strong>断点继续执行</strong></li>
</ul>
<p>三、目录结构</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">context/</span><br><span class="line">├── project_state.json   # 当前工程文件结构、状态</span><br><span class="line">├── task_state.json      # 所有计划与任务的状态</span><br><span class="line">├── prompt_state.json    # system.current hash、模块版本</span><br><span class="line">├── history.log          # 操作历史、生成历史</span><br><span class="line">├── decisions.md         # 关键架构决策与人工干预记录</span><br></pre></td></tr></table></figure>

<h2 id="四、核心文件说明"><a href="#四、核心文件说明" class="headerlink" title="四、核心文件说明"></a>四、核心文件说明</h2><h3 id="1️⃣-project-state-json"><a href="#1️⃣-project-state-json" class="headerlink" title="1️⃣ project_state.json"></a>1️⃣ project_state.json</h3><ul>
<li>内容示例：</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;spec_parser.py&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1.2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;last_modified&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-18T12:00:00&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;main.py&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1.0&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;last_modified&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-18T11:45:00&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;last_generated_plan&quot;</span><span class="punctuation">:</span> <span class="string">&quot;plan_20251218_1200.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;current_phase&quot;</span><span class="punctuation">:</span> <span class="string">&quot;code_generation&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>功能</strong>：<ul>
<li>跟踪每个文件的版本、修改时间</li>
<li>标记最后生成的计划&#x2F;状态</li>
<li>支持断点继续执行</li>
</ul>
</li>
</ul>
<h3 id="2️⃣-task-state-json"><a href="#2️⃣-task-state-json" class="headerlink" title="2️⃣ task_state.json"></a>2️⃣ task_state.json</h3><ul>
<li>内容示例：</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tasks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Generate spec_parser.py&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;done&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;assigned_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AI&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;plan_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;plan_20251218_1200&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Generate main.py&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pending&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;s1&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;assigned_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AI&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;plan_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;plan_20251218_1200&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>功能</strong>：<ul>
<li>生命周期管理：pending → active → done → archived</li>
<li>任务依赖可解析</li>
<li>支持人工介入修改 status</li>
</ul>
</li>
</ul>
<h3 id="3️⃣-prompt-state-json"><a href="#3️⃣-prompt-state-json" class="headerlink" title="3️⃣ prompt_state.json"></a>3️⃣ prompt_state.json</h3><ul>
<li>内容示例：</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;system_current_hash&quot;</span><span class="punctuation">:</span> <span class="string">&quot;abcdef123456...&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;modules_version&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;role.md&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;constraints.md&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;output_format.md&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;last_updated&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-18T12:00:00&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>功能</strong>：<ul>
<li>确保 AI 每次使用的 prompt 版本一致</li>
<li>支持 hash 校验</li>
<li>方便回滚</li>
</ul>
</li>
</ul>
<h3 id="4️⃣-history-log"><a href="#4️⃣-history-log" class="headerlink" title="4️⃣ history.log"></a>4️⃣ history.log</h3><ul>
<li>记录每一次生成、修改、人工干预的事件</li>
<li>示例：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2025</span><span class="number">-12</span><span class="number">-18</span>T12:<span class="number">00</span>:<span class="number">00</span> - Generated plan_20251218_1200.json</span><br><span class="line"><span class="number">2025</span><span class="number">-12</span><span class="number">-18</span>T12:<span class="number">05</span>:<span class="number">00</span> - Applied diff <span class="keyword">for</span> spec_parser.py</span><br><span class="line"><span class="number">2025</span><span class="number">-12</span><span class="number">-18</span>T12:<span class="number">10</span>:<span class="number">00</span> - Manual edit main.py</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>功能</strong>：<ul>
<li>审计、回溯</li>
<li>CI&#x2F;CD 可用来分析 AI 行为</li>
</ul>
</li>
</ul>
<h3 id="5️⃣-decisions-md"><a href="#5️⃣-decisions-md" class="headerlink" title="5️⃣ decisions.md"></a>5️⃣ decisions.md</h3><ul>
<li>手动记录关键决策，例如：</li>
</ul>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Decisions</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 2025-12-18</span></span><br><span class="line"><span class="bullet">-</span> Use snake<span class="emphasis">_case for functions across all modules (Rule confirmed)</span></span><br><span class="line"><span class="emphasis">- Decide to limit max_</span>steps<span class="emphasis">_per_</span>plan to 10 for easier review</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>功能</strong>：<ul>
<li>保存人工干预</li>
<li>未来演进参考</li>
<li>保证长期一致性</li>
</ul>
</li>
</ul>
<p>五、核心原则</p>
<ol>
<li><strong>状态是唯一事实源</strong><ul>
<li>Engine &#x2F; AI &#x2F; Validator 都读取同一份状态文件</li>
</ul>
</li>
<li><strong>可追踪 &amp; 可回滚</strong><ul>
<li>每个任务、每次生成都记录时间戳 &amp; hash</li>
</ul>
</li>
<li><strong>可断点继续</strong><ul>
<li>AI 或人工中断后可以从状态恢复</li>
</ul>
</li>
<li><strong>版本化 Prompt</strong><ul>
<li>system.current 变化必须写入 prompt_state.json</li>
</ul>
</li>
<li><strong>与 Meta &#x2F; Spec 一致</strong><ul>
<li>状态记录必须使用 glossary 和 rules 里的术语</li>
</ul>
</li>
</ol>
<h2 id="六、与其他层关系"><a href="#六、与其他层关系" class="headerlink" title="六、与其他层关系"></a>六、与其他层关系</h2><p>| 上游 | 本层依赖 | 下游 |<br>| | | |<br>| Prompt | system.current hash | Engine &#x2F; Planner |<br>| Spec | rules&#x2F;schema | Validator &#x2F; Planner |<br>| Engine | read&#x2F;write task_state.json | File Manager &#x2F; Validator |<br>| Evolution | decisions.md | 可参考历史决策 |</p>
<p>✅ <strong>完成标准</strong></p>
<ul>
<li>context&#x2F; 文件齐全：project_state.json, task_state.json, prompt_state.json, history.log, decisions.md</li>
<li>Engine 可以读取状态、更新状态</li>
<li>支持断点继续、回滚、审计</li>
</ul>
<p>下一步是 <strong>五级：任务生命周期管理（Tasks &#x2F; Plan &#x2F; Diff 的完整管理）</strong>，用于让 AI 输出可追踪、可管理、可演进。</p>
<p>你确认进入五级吗？</p>
<h2 id="Prompt-7"><a href="#Prompt-7" class="headerlink" title="Prompt:"></a>Prompt:</h2><p>继续</p>
<h2 id="Response-7"><a href="#Response-7" class="headerlink" title="Response:"></a>Response:</h2><p>好的，我们进入 <strong>五级：任务生命周期管理（Task &#x2F; Plan &#x2F; Diff Lifecycle Layer）</strong>。<br>这是让 AI 生成的每个计划、每个文件改动都<strong>可追踪、可管理、可回滚</strong>的核心层。</p>
<h1 id="🗂-五级架构：任务生命周期管理（Tasks-Plan-Diff）"><a href="#🗂-五级架构：任务生命周期管理（Tasks-Plan-Diff）" class="headerlink" title="🗂 五级架构：任务生命周期管理（Tasks &#x2F; Plan &#x2F; Diff）"></a>🗂 五级架构：任务生命周期管理（Tasks &#x2F; Plan &#x2F; Diff）</h1><p>一、核心问题</p>
<p>如果没有任务生命周期管理，会发生：</p>
<ol>
<li>AI 每次生成 Plan &#x2F; Diff 就丢失追踪</li>
<li>任务执行失败时，无法自动重试或回滚</li>
<li>人工介入后，系统不知道哪些任务已经完成</li>
<li>无法做长期演进和审计</li>
</ol>
<blockquote>
<p><strong>结论：没有 Task 层，系统行为不可控，长期维护成本无限膨胀</strong></p>
</blockquote>
<h2 id="二、目标-1"><a href="#二、目标-1" class="headerlink" title="二、目标"></a>二、目标</h2><ul>
<li>管理每个任务的 <strong>完整生命周期</strong></li>
<li>支持 <strong>依赖关系、状态变更、人工干预</strong></li>
<li>与 <strong>Plan &#x2F; Diff &#x2F; Validator &#x2F; Context</strong> 完整结合</li>
<li>支持 <strong>回滚、重试、归档</strong></li>
</ul>
<p>三、目录结构</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tasks/</span><br><span class="line">├── backlog/        # 待处理任务</span><br><span class="line">├── active/         # 正在执行的任务</span><br><span class="line">├── blocked/        # 被依赖阻塞的任务</span><br><span class="line">├── done/           # 已完成任务</span><br><span class="line">└── archive/        # 历史归档任务</span><br></pre></td></tr></table></figure>

<h2 id="四、任务对象设计"><a href="#四、任务对象设计" class="headerlink" title="四、任务对象设计"></a>四、任务对象设计</h2><h3 id="1️⃣-核心字段（JSON-格式）"><a href="#1️⃣-核心字段（JSON-格式）" class="headerlink" title="1️⃣ 核心字段（JSON 格式）"></a>1️⃣ 核心字段（JSON 格式）</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Generate spec_parser.py&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pending&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;assigned_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AI&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;plan_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;plan_20251218_1200&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;diff&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;created_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-18T12:00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;updated_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-18T12:05:00&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>id</strong>：唯一任务标识</li>
<li><strong>description</strong>：任务描述</li>
<li><strong>status</strong>：生命周期状态（pending, active, blocked, done, failed）</li>
<li><strong>dependencies</strong>：依赖的任务 id 列表</li>
<li><strong>assigned_to</strong>：AI &#x2F; Human &#x2F; Hybrid</li>
<li><strong>plan_id</strong>：对应生成计划的 id</li>
<li><strong>diff</strong>：生成的 diff（如果有）</li>
<li><strong>result</strong>：最终输出（可选）</li>
<li><strong>created_at &#x2F; updated_at</strong>：时间戳</li>
</ul>
<h3 id="2️⃣-生命周期状态"><a href="#2️⃣-生命周期状态" class="headerlink" title="2️⃣ 生命周期状态"></a>2️⃣ 生命周期状态</h3><p>| 状态 | 含义 |<br>| | |<br>| pending | 等待执行 |<br>| active | 正在执行 |<br>| blocked | 依赖未满足 |<br>| done | 完成 |<br>| failed | 执行失败，需要人工或自动重试 |</p>
<h3 id="3️⃣-任务执行规则"><a href="#3️⃣-任务执行规则" class="headerlink" title="3️⃣ 任务执行规则"></a>3️⃣ 任务执行规则</h3><ol>
<li><strong>依赖先行</strong><ul>
<li>任务必须等所有 dependencies 状态为 done 才能激活</li>
</ul>
</li>
<li><strong>Diff 应用前必须通过 Validator 校验</strong></li>
<li><strong>状态更新同步到 context&#x2F;task_state.json</strong></li>
<li><strong>失败任务自动标记 failed，可触发 retry 或人工干预</strong></li>
<li><strong>人工介入</strong><ul>
<li>人可以修改 status 或 diff</li>
<li>系统记录在 decisions.md 和 history.log</li>
</ul>
</li>
</ol>
<p>五、文件示例</p>
<h3 id="backlog-s1-json"><a href="#backlog-s1-json" class="headerlink" title="backlog&#x2F;s1.json"></a>backlog&#x2F;s1.json</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Generate spec_parser.py&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pending&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;assigned_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AI&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;plan_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;plan_20251218_1200&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;diff&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;created_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-18T12:00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;updated_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-18T12:00:00&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>六、工程级补充机制</p>
<ol>
<li><strong>归档与审计</strong><ul>
<li>done &#x2F; failed 任务移动到 archive&#x2F;</li>
<li>保留所有 diff 与生成日志</li>
</ul>
</li>
<li><strong>重试策略</strong><ul>
<li>可以按规则（retry_count, retry_delay）自动重试失败任务</li>
</ul>
</li>
<li><strong>Plan 版本关联</strong><ul>
<li>每个任务绑定 plan_id，保证生成逻辑可回溯</li>
</ul>
</li>
<li><strong>人工干预记录</strong><ul>
<li>每次修改 task 或 diff，自动写入 history.log &amp; decisions.md</li>
</ul>
</li>
</ol>
<h2 id="七、与其他层关系"><a href="#七、与其他层关系" class="headerlink" title="七、与其他层关系"></a>七、与其他层关系</h2><p>| 上游 | 本层依赖 | 下游 |<br>| | | |<br>| Context | task_state.json | Engine &#x2F; FileManager |<br>| Plan | plan.json | Diff &#x2F; Validator |<br>| Diff | diff object | FileManager &#x2F; Validator |<br>| Validator | rules&#x2F;schema | 状态更新 |</p>
<h2 id="八、工程级原则"><a href="#八、工程级原则" class="headerlink" title="八、工程级原则"></a>八、工程级原则</h2><ol>
<li><strong>任务即对象，生命周期完整</strong></li>
<li><strong>依赖关系明确，阻塞自动管理</strong></li>
<li><strong>每个任务都可回滚 &#x2F; 重试 &#x2F; 审计</strong></li>
<li><strong>与 context 保持同步，避免状态不一致</strong></li>
<li><strong>人工干预被记录，可追溯</strong></li>
</ol>
<p>✅ <strong>五级完成标准</strong></p>
<ul>
<li>每个 Plan step 生成一个任务 JSON</li>
<li>生命周期状态完整（pending → active → done &#x2F; failed）</li>
<li>支持依赖、人工干预、回滚、归档</li>
<li>context&#x2F;task_state.json 与 tasks&#x2F; 目录一致</li>
</ul>
<p>下一步是 <strong>六级：验证 &amp; 回路（Validation &#x2F; Feedback Loop）</strong>，用于确保生成的 Plan&#x2F;Diff 输出永远符合 Schema + Rules。</p>
<p>你确认进入六级吗？</p>
<h2 id="Prompt-8"><a href="#Prompt-8" class="headerlink" title="Prompt:"></a>Prompt:</h2><p>继续</p>
<h2 id="Response-8"><a href="#Response-8" class="headerlink" title="Response:"></a>Response:</h2><p>好，我们进入 <strong>六级：验证 &amp; 回路层（Validation &#x2F; Feedback Loop）</strong>。<br>这一层的地位非常高——<strong>它决定你的系统是“工程系统”还是“AI 赌博机”</strong>。</p>
<blockquote>
<p>一句话先给结论：<br><strong>没有验证回路，前面 1～5 级做得再好，最终都会失控。</strong></p>
</blockquote>
<h1 id="🧪-六级架构：验证-回路层（Validation-Feedback-Loop）"><a href="#🧪-六级架构：验证-回路层（Validation-Feedback-Loop）" class="headerlink" title="🧪 六级架构：验证 &amp; 回路层（Validation &#x2F; Feedback Loop）"></a>🧪 六级架构：验证 &amp; 回路层（Validation &#x2F; Feedback Loop）</h1><p>一、这一层到底解决什么“致命问题”？</p>
<p>如果没有验证回路，现实中一定会发生：</p>
<ol>
<li>AI 偶尔输出不符合 schema，但你没发现</li>
<li>Diff 看起来“差不多”，实际破坏了架构</li>
<li>一次小错误，被后续 10 次生成不断放大</li>
<li>最终你不再信任系统，只能手工接管</li>
</ol>
<blockquote>
<p>❌ 系统退化成“AI 草稿生成器”<br>✅ 而不是“工程协作系统”</p>
</blockquote>
<h2 id="二、六级层的核心目标"><a href="#二、六级层的核心目标" class="headerlink" title="二、六级层的核心目标"></a>二、六级层的核心目标</h2><blockquote>
<p><strong>让“错误”成为系统中的一个“显式状态”，而不是意外事故</strong></p>
</blockquote>
<p>具体目标：</p>
<ul>
<li>所有 AI 输出 <strong>必须经过验证</strong></li>
<li>验证失败 <strong>不会直接崩溃</strong></li>
<li>验证结果会：<ul>
<li>反馈给 AI（retry &#x2F; fix）</li>
<li>更新任务状态</li>
<li>记录到 history &#x2F; decision</li>
</ul>
</li>
</ul>
<p>三、验证的三种时机（非常重要）</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Validation ≠ 一个 checker</span><br><span class="line">Validation = 一个时序系统</span><br></pre></td></tr></table></figure>

<h3 id="①-生成前（Pre-generation）"><a href="#①-生成前（Pre-generation）" class="headerlink" title="① 生成前（Pre-generation）"></a>① 生成前（Pre-generation）</h3><blockquote>
<p>防止“从一开始就走歪”</p>
</blockquote>
<h3 id="②-生成后（Post-generation）"><a href="#②-生成后（Post-generation）" class="headerlink" title="② 生成后（Post-generation）"></a>② 生成后（Post-generation）</h3><blockquote>
<p>检查 AI 是否“违规”</p>
</blockquote>
<h3 id="③-应用时（Runtime-Apply）"><a href="#③-应用时（Runtime-Apply）" class="headerlink" title="③ 应用时（Runtime &#x2F; Apply）"></a>③ 应用时（Runtime &#x2F; Apply）</h3><blockquote>
<p>防止破坏真实代码库</p>
</blockquote>
<h2 id="四、目录结构设计"><a href="#四、目录结构设计" class="headerlink" title="四、目录结构设计"></a>四、目录结构设计</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">validation/</span><br><span class="line">├── pre_generation/</span><br><span class="line">│   ├── context_check.py</span><br><span class="line">│   └── task_check.py</span><br><span class="line">│</span><br><span class="line">├── post_generation/</span><br><span class="line">│   ├── schema_validator.py</span><br><span class="line">│   ├── rule_validator.py</span><br><span class="line">│   └── diff_validator.py</span><br><span class="line">│</span><br><span class="line">├── runtime/</span><br><span class="line">│   ├── apply_guard.py</span><br><span class="line">│   └── rollback_guard.py</span><br><span class="line">│</span><br><span class="line">└── reports/</span><br><span class="line">    └── validation_report.json</span><br></pre></td></tr></table></figure>

<p>五、逐层拆解</p>
<h3 id="🟦-1️⃣-Pre-generation-验证（生成前）"><a href="#🟦-1️⃣-Pre-generation-验证（生成前）" class="headerlink" title="🟦 1️⃣ Pre-generation 验证（生成前）"></a>🟦 1️⃣ Pre-generation 验证（生成前）</h3><h4 id="context-check-py"><a href="#context-check-py" class="headerlink" title="context_check.py"></a>context_check.py</h4><p><strong>检查点：</strong></p>
<ul>
<li>system.current hash 是否与 prompt_state.json 一致</li>
<li>当前 phase 是否允许生成（例如不能在 apply 阶段再生成 plan）</li>
<li>是否存在未处理的 failed task</li>
</ul>
<p>示意逻辑：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check_context</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="keyword">if</span> context[<span class="string">&quot;has_failed_tasks&quot;</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">&quot;Unresolved failed tasks exist&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>, <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h4 id="task-check-py"><a href="#task-check-py" class="headerlink" title="task_check.py"></a>task_check.py</h4><p><strong>检查点：</strong></p>
<ul>
<li>是否有 active 任务尚未完成</li>
<li>新任务是否重复</li>
<li>dependencies 是否合理</li>
</ul>
<p>👉 <strong>这一步防止“任务雪崩”</strong></p>
<h3 id="🟦-2️⃣-Post-generation-验证（生成后）"><a href="#🟦-2️⃣-Post-generation-验证（生成后）" class="headerlink" title="🟦 2️⃣ Post-generation 验证（生成后）"></a>🟦 2️⃣ Post-generation 验证（生成后）</h3><p>这是<strong>最关键的一层</strong>。</p>
<h4 id="schema-validator-py"><a href="#schema-validator-py" class="headerlink" title="schema_validator.py"></a>schema_validator.py</h4><ul>
<li>使用 <code>spec/schema/output.schema.json</code></li>
<li>验证 AI 输出 JSON 是否合规</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">validate(instance=output, schema=schema)</span><br></pre></td></tr></table></figure>

<p>失败 → 返回结构化 error</p>
<h4 id="rule-validator-py"><a href="#rule-validator-py" class="headerlink" title="rule_validator.py"></a>rule_validator.py</h4><ul>
<li>使用 <code>spec/rules/*.yaml</code></li>
<li>检查：<ul>
<li>命名规则</li>
<li>分层规则</li>
<li>任务数量限制</li>
</ul>
</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">❌ function name violates snake_case</span><br></pre></td></tr></table></figure>

<h4 id="diff-validator-py"><a href="#diff-validator-py" class="headerlink" title="diff_validator.py"></a>diff_validator.py</h4><p>检查 diff 是否“危险”：</p>
<ul>
<li>是否尝试覆盖整个文件</li>
<li>是否修改了不允许的目录</li>
<li>是否缺少 context lines</li>
<li>是否 diff 与任务描述不一致</li>
</ul>
<p>👉 <strong>这是 Cursor 非常核心的一层</strong></p>
<h3 id="🟦-3️⃣-Runtime-验证（应用时）"><a href="#🟦-3️⃣-Runtime-验证（应用时）" class="headerlink" title="🟦 3️⃣ Runtime 验证（应用时）"></a>🟦 3️⃣ Runtime 验证（应用时）</h3><h4 id="apply-guard-py"><a href="#apply-guard-py" class="headerlink" title="apply_guard.py"></a>apply_guard.py</h4><p><strong>最后一道防线</strong>：</p>
<ul>
<li>应用 diff 前自动备份</li>
<li>再次确认目标文件未被人工修改</li>
<li>冲突检测</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Apply denied: file changed since diff generation</span><br></pre></td></tr></table></figure>

<h4 id="rollback-guard-py"><a href="#rollback-guard-py" class="headerlink" title="rollback_guard.py"></a>rollback_guard.py</h4><ul>
<li>应用失败自动回滚</li>
<li>更新 task 状态为 failed</li>
<li>写入 history.log</li>
</ul>
<p>六、Validation Report（非常重要）</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;task_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s2&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;failed&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;stage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;post_generation&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;errors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;schema&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Missing required field: steps&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-18T14:20:00&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>👉 这个 report 会：</p>
<ul>
<li>反馈给 AI</li>
<li>决定 retry &#x2F; abort</li>
<li>存档供审计</li>
</ul>
<p>七、反馈回路（Feedback Loop）</p>
<p>验证不是“判死刑”，而是进入回路：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Generate</span><br><span class="line">   ↓</span><br><span class="line">Validate</span><br><span class="line">   ↓</span><br><span class="line">Fail? → Fix Prompt / Retry / Human Review</span><br><span class="line">   ↓</span><br><span class="line">Pass</span><br><span class="line">   ↓</span><br><span class="line">Apply</span><br></pre></td></tr></table></figure>

<p><strong>关键点：</strong></p>
<ul>
<li>retry 必须：<ul>
<li>限次数</li>
<li>带错误上下文</li>
</ul>
</li>
<li>多次失败 → 强制人工介入</li>
</ul>
<h2 id="八、工程级原则（必须记住）"><a href="#八、工程级原则（必须记住）" class="headerlink" title="八、工程级原则（必须记住）"></a>八、工程级原则（必须记住）</h2><ol>
<li><strong>验证优先于执行</strong></li>
<li><strong>错误必须结构化</strong></li>
<li><strong>失败是系统状态，不是异常</strong></li>
<li><strong>验证结果必须被记录</strong></li>
<li><strong>验证层不做决策，只给事实</strong></li>
</ol>
<h2 id="九、这一层完成后，你系统会发生什么变化？"><a href="#九、这一层完成后，你系统会发生什么变化？" class="headerlink" title="九、这一层完成后，你系统会发生什么变化？"></a>九、这一层完成后，你系统会发生什么变化？</h2><p>✅ 你会开始<strong>信任系统</strong><br>✅ 可以连续跑多轮生成<br>✅ 错误不会“悄悄扩散”<br>✅ 人工介入成本极低</p>
<h2 id="✅-六级完成标准"><a href="#✅-六级完成标准" class="headerlink" title="✅ 六级完成标准"></a>✅ 六级完成标准</h2><ul>
<li>生成前 &#x2F; 后 &#x2F; 应用时 都有验证</li>
<li>所有失败都有 validation_report</li>
<li>失败会进入 retry &#x2F; human loop</li>
<li>系统永远不会“悄悄做错事”</li>
</ul>
<h3 id="下一步预告"><a href="#下一步预告" class="headerlink" title="下一步预告"></a>下一步预告</h3><p>▶️ <strong>七级：执行引擎（Execution Engine Layer）</strong></p>
<p>这是把前面 1～6 级真正“串起来”的地方，也是 <code>main.py</code> 真正该干的事。</p>
<p>你可以直接说：<br><strong>“继续七级”</strong></p>
<h2 id="Prompt-9"><a href="#Prompt-9" class="headerlink" title="Prompt:"></a>Prompt:</h2><p>说的不够详细，每个我都需要一个完整的示例和详细的 demo 以及说明</p>
<h2 id="Response-9"><a href="#Response-9" class="headerlink" title="Response:"></a>Response:</h2><p>你这个要求<strong>非常对</strong>，而且说明一件事：</p>
<blockquote>
<p>你现在要的已经不是“理解架构”，<br>而是 <strong>“我照着就能一步步实现，不走偏、不返工”</strong>。</p>
</blockquote>
<p>那我们<strong>回到六级</strong>，<strong>彻底重来一次</strong>，做到下面这个标准：</p>
<ul>
<li>✅ <strong>每一个子模块</strong></li>
<li>✅ <strong>一个完整示例</strong></li>
<li>✅ <strong>一个最小可运行 demo</strong></li>
<li>✅ <strong>明确：输入 → 处理 → 输出</strong></li>
<li>✅ <strong>明确：为什么这样设计，而不是别的</strong></li>
</ul>
<blockquote>
<p>⚠️ 本轮会很长，但这是你系统真正“从玩具 → 工程”的关键一步。</p>
</blockquote>
<h1 id="🧪-六级（重制版）：验证-回路层"><a href="#🧪-六级（重制版）：验证-回路层" class="headerlink" title="🧪 六级（重制版）：验证 &amp; 回路层"></a>🧪 六级（重制版）：验证 &amp; 回路层</h1><p>Validation &#x2F; Feedback Loop（工程级全展开）</p>
<h1 id="一、六级在系统中的“真实位置”"><a href="#一、六级在系统中的“真实位置”" class="headerlink" title="一、六级在系统中的“真实位置”"></a>一、六级在系统中的“真实位置”</h1><p>先给你一个<strong>精确时序图</strong>（非常重要）：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">User / Task</span><br><span class="line">   ↓</span><br><span class="line">Planner（生成 Plan）</span><br><span class="line">   ↓</span><br><span class="line">[Pre-generation Validation]  ←——— ❶</span><br><span class="line">   ↓</span><br><span class="line">AI Generation（Plan / Diff）</span><br><span class="line">   ↓</span><br><span class="line">[Post-generation Validation] ←——— ❷</span><br><span class="line">   ↓</span><br><span class="line">Apply Diff</span><br><span class="line">   ↓</span><br><span class="line">[Runtime Validation]         ←——— ❸</span><br><span class="line">   ↓</span><br><span class="line">Update Context / Task State</span><br></pre></td></tr></table></figure>

<p>六级不是一个“工具”，<br><strong>它是三道连续的门禁系统</strong>。</p>
<h1 id="二、目录结构（完整版）"><a href="#二、目录结构（完整版）" class="headerlink" title="二、目录结构（完整版）"></a>二、目录结构（完整版）</h1><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">validation/</span><br><span class="line">├── pre_generation/</span><br><span class="line">│   ├── context_check.py</span><br><span class="line">│   └── task_check.py</span><br><span class="line">│</span><br><span class="line">├── post_generation/</span><br><span class="line">│   ├── schema_validator.py</span><br><span class="line">│   ├── rule_validator.py</span><br><span class="line">│   └── diff_validator.py</span><br><span class="line">│</span><br><span class="line">├── runtime/</span><br><span class="line">│   ├── apply_guard.py</span><br><span class="line">│   └── rollback_guard.py</span><br><span class="line">│</span><br><span class="line">└── reports/</span><br><span class="line">    └── validation_report.json</span><br></pre></td></tr></table></figure>

<p>下面我们 <strong>一个文件一个文件拆</strong>。</p>
<h1 id="三、Pre-generation（生成前验证）"><a href="#三、Pre-generation（生成前验证）" class="headerlink" title="三、Pre-generation（生成前验证）"></a>三、Pre-generation（生成前验证）</h1><h2 id="🎯-目标"><a href="#🎯-目标" class="headerlink" title="🎯 目标"></a>🎯 目标</h2><blockquote>
<p><strong>在调用 AI 之前，就阻止“必然失败”的生成</strong></p>
</blockquote>
<p>1️⃣ context_check.py</p>
<h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><ul>
<li>system.current 被改了，但 prompt_state 没更新</li>
<li>上一次有 failed task 还没处理</li>
<li>当前 phase 不允许生成 diff</li>
</ul>
<h3 id="示例：context-check-py（完整-demo）"><a href="#示例：context-check-py（完整-demo）" class="headerlink" title="示例：context_check.py（完整 demo）"></a>示例：context_check.py（完整 demo）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># validation/pre_generation/context_check.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_context</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    context: dict from context/project_state.json</span></span><br><span class="line"><span class="string">    return: (bool, error_message or None)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> context.get(<span class="string">&quot;has_failed_tasks&quot;</span>, <span class="literal">False</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">&quot;Unresolved failed tasks exist&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> context.get(<span class="string">&quot;phase&quot;</span>) <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">&quot;planning&quot;</span>, <span class="string">&quot;generation&quot;</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">f&quot;Invalid phase: <span class="subst">&#123;context.get(<span class="string">&#x27;phase&#x27;</span>)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>, <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h3 id="输入示例（project-state-json）"><a href="#输入示例（project-state-json）" class="headerlink" title="输入示例（project_state.json）"></a>输入示例（project_state.json）</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="string">&quot;generation&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;has_failed_tasks&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(True, None)</span><br></pre></td></tr></table></figure>

<p>❌ 如果失败：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(False, &quot;Unresolved failed tasks exist&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="为什么要在这一步做？"><a href="#为什么要在这一步做？" class="headerlink" title="为什么要在这一步做？"></a>为什么要在这一步做？</h3><blockquote>
<p>因为 <strong>让 AI 生成 ≠ 免费</strong><br>一次错误生成，会污染后续所有状态。</p>
</blockquote>
<p>2️⃣ task_check.py</p>
<h3 id="场景-1"><a href="#场景-1" class="headerlink" title="场景"></a>场景</h3><ul>
<li>正在执行的任务还没完成</li>
<li>新任务重复</li>
<li>依赖未满足却强行生成</li>
</ul>
<h3 id="示例：task-check-py"><a href="#示例：task-check-py" class="headerlink" title="示例：task_check.py"></a>示例：task_check.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># validation/pre_generation/task_check.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_tasks</span>(<span class="params">task_state</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    task_state: dict from context/task_state.json</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    active_tasks = [</span><br><span class="line">        t <span class="keyword">for</span> t <span class="keyword">in</span> task_state[<span class="string">&quot;tasks&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> t[<span class="string">&quot;status&quot;</span>] == <span class="string">&quot;active&quot;</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> active_tasks:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">&quot;Active tasks still running&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>, <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h3 id="为什么要这一层？"><a href="#为什么要这一层？" class="headerlink" title="为什么要这一层？"></a>为什么要这一层？</h3><blockquote>
<p>防止系统变成：<br><strong>“任务还没跑完，又叠加新任务” → 状态爆炸</strong></p>
</blockquote>
<h1 id="四、Post-generation（生成后验证）"><a href="#四、Post-generation（生成后验证）" class="headerlink" title="四、Post-generation（生成后验证）"></a>四、Post-generation（生成后验证）</h1><p>这是 <strong>最重要的一段</strong>。</p>
<p>3️⃣ schema_validator.py</p>
<h3 id="场景-2"><a href="#场景-2" class="headerlink" title="场景"></a>场景</h3><p>AI 输出了 Plan &#x2F; Error &#x2F; Explanation<br>但结构不合法。</p>
<h3 id="schema-validator-py（完整）"><a href="#schema-validator-py（完整）" class="headerlink" title="schema_validator.py（完整）"></a>schema_validator.py（完整）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># validation/post_generation/schema_validator.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> jsonschema <span class="keyword">import</span> validate, ValidationError</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_schema</span>(<span class="params">output, schema</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        validate(instance=output, schema=schema)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> ValidationError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="built_in">str</span>(e)</span><br></pre></td></tr></table></figure>

<h3 id="输入示例"><a href="#输入示例" class="headerlink" title="输入示例"></a>输入示例</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;plan&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;steps&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s1&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>❌ 输出：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(False, &quot;&#x27;description&#x27; is a required property&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="工程意义"><a href="#工程意义" class="headerlink" title="工程意义"></a>工程意义</h3><blockquote>
<p>schema 是 <strong>AI 行为的法律条文</strong><br>不合法 &#x3D; 无效输出</p>
</blockquote>
<h2 id="4️⃣-rule-validator-py"><a href="#4️⃣-rule-validator-py" class="headerlink" title="4️⃣ rule_validator.py"></a>4️⃣ rule_validator.py</h2><h3 id="场景-3"><a href="#场景-3" class="headerlink" title="场景"></a>场景</h3><p>结构合法，但<strong>违反工程规范</strong></p>
<ul>
<li>命名不规范</li>
<li>任务太多</li>
<li>禁止的目录被修改</li>
</ul>
<h3 id="示例：rule-validator-py（简化版）"><a href="#示例：rule-validator-py（简化版）" class="headerlink" title="示例：rule_validator.py（简化版）"></a>示例：rule_validator.py（简化版）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># validation/post_generation/rule_validator.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_rules</span>(<span class="params">plan, rules</span>):</span><br><span class="line">    errors = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(plan[<span class="string">&quot;steps&quot;</span>]) &gt; rules[<span class="string">&quot;max_steps_per_plan&quot;</span>]:</span><br><span class="line">        errors.append(<span class="string">&quot;Too many steps in plan&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> plan[<span class="string">&quot;steps&quot;</span>]:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> step[<span class="string">&quot;id&quot;</span>].startswith(<span class="string">&quot;s&quot;</span>):</span><br><span class="line">            errors.append(<span class="string">f&quot;Invalid step id: <span class="subst">&#123;step[<span class="string">&#x27;id&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> errors</span><br></pre></td></tr></table></figure>

<h3 id="规则示例（task-constraints-yaml）"><a href="#规则示例（task-constraints-yaml）" class="headerlink" title="规则示例（task_constraints.yaml）"></a>规则示例（task_constraints.yaml）</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">max_steps_per_plan:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<h3 id="输出-1"><a href="#输出-1" class="headerlink" title="输出"></a>输出</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;Too many steps in plan&quot;]</span><br></pre></td></tr></table></figure>

<h3 id="为什么-schema-不够？"><a href="#为什么-schema-不够？" class="headerlink" title="为什么 schema 不够？"></a>为什么 schema 不够？</h3><blockquote>
<p>schema 只能校验“形状”，<br><strong>规则校验的是“工程纪律”</strong></p>
</blockquote>
<h2 id="5️⃣-diff-validator-py（核心）"><a href="#5️⃣-diff-validator-py（核心）" class="headerlink" title="5️⃣ diff_validator.py（核心）"></a>5️⃣ diff_validator.py（核心）</h2><h3 id="场景-4"><a href="#场景-4" class="headerlink" title="场景"></a>场景</h3><ul>
<li>AI 想“重写整个文件”</li>
<li>diff context 不足</li>
<li>修改了不允许的路径</li>
</ul>
<h3 id="示例：diff-validator-py"><a href="#示例：diff-validator-py" class="headerlink" title="示例：diff_validator.py"></a>示例：diff_validator.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># validation/post_generation/diff_validator.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_diff</span>(<span class="params">diff_text</span>):</span><br><span class="line">    <span class="keyword">if</span> diff_text.count(<span class="string">&quot;\n@@&quot;</span>) &gt; <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">&quot;Diff too large&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot; /dev/null&quot;</span> <span class="keyword">in</span> diff_text:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="string">&quot;Creating new files not allowed&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>, <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h3 id="工程意义-1"><a href="#工程意义-1" class="headerlink" title="工程意义"></a>工程意义</h3><blockquote>
<p>这是 <strong>Cursor 的真正护城河之一</strong><br>防止 AI 以“修复”为名搞破坏</p>
</blockquote>
<h1 id="五、Runtime（应用时验证）"><a href="#五、Runtime（应用时验证）" class="headerlink" title="五、Runtime（应用时验证）"></a>五、Runtime（应用时验证）</h1><h2 id="6️⃣-apply-guard-py"><a href="#6️⃣-apply-guard-py" class="headerlink" title="6️⃣ apply_guard.py"></a>6️⃣ apply_guard.py</h2><h3 id="场景-5"><a href="#场景-5" class="headerlink" title="场景"></a>场景</h3><ul>
<li>diff 是对的</li>
<li>但文件已经被人改过了</li>
</ul>
<h3 id="apply-guard-py（示例）"><a href="#apply-guard-py（示例）" class="headerlink" title="apply_guard.py（示例）"></a>apply_guard.py（示例）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># validation/runtime/apply_guard.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">file_hash</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> hashlib.sha256(f.read()).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">can_apply_diff</span>(<span class="params">path, expected_hash</span>):</span><br><span class="line">    current = file_hash(path)</span><br><span class="line">    <span class="keyword">return</span> current == expected_hash</span><br></pre></td></tr></table></figure>

<h3 id="工程意义-2"><a href="#工程意义-2" class="headerlink" title="工程意义"></a>工程意义</h3><blockquote>
<p><strong>防止“AI 覆盖人工修改”</strong></p>
</blockquote>
<h2 id="7️⃣-rollback-guard-py"><a href="#7️⃣-rollback-guard-py" class="headerlink" title="7️⃣ rollback_guard.py"></a>7️⃣ rollback_guard.py</h2><h3 id="场景-6"><a href="#场景-6" class="headerlink" title="场景"></a>场景</h3><ul>
<li>应用 diff 失败</li>
<li>或运行后发现错误</li>
</ul>
<h3 id="rollback-guard-py（示例）"><a href="#rollback-guard-py（示例）" class="headerlink" title="rollback_guard.py（示例）"></a>rollback_guard.py（示例）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># validation/runtime/rollback_guard.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rollback</span>(<span class="params">backup_path, target_path</span>):</span><br><span class="line">    shutil.copy(backup_path, target_path)</span><br></pre></td></tr></table></figure>

<h1 id="六、Validation-Report（结构化结果）"><a href="#六、Validation-Report（结构化结果）" class="headerlink" title="六、Validation Report（结构化结果）"></a>六、Validation Report（结构化结果）</h1><h3 id="validation-report-json（完整示例）"><a href="#validation-report-json（完整示例）" class="headerlink" title="validation_report.json（完整示例）"></a>validation_report.json（完整示例）</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;task_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s2&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;stage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;post_generation&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;failed&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;errors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rule&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Too many steps in plan&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;retry&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-18T15:30:00&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="七、反馈回路（Retry-Fix-Human）"><a href="#七、反馈回路（Retry-Fix-Human）" class="headerlink" title="七、反馈回路（Retry &#x2F; Fix &#x2F; Human）"></a>七、反馈回路（Retry &#x2F; Fix &#x2F; Human）</h1><h3 id="逻辑示例"><a href="#逻辑示例" class="headerlink" title="逻辑示例"></a>逻辑示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> validation_failed:</span><br><span class="line">    <span class="keyword">if</span> retry_count &lt; MAX_RETRY:</span><br><span class="line">        regenerate_with_errors()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        require_human_review()</span><br></pre></td></tr></table></figure>

<h1 id="八、这一层完成后，你的系统质变"><a href="#八、这一层完成后，你的系统质变" class="headerlink" title="八、这一层完成后，你的系统质变"></a>八、这一层完成后，你的系统质变</h1><p>| 之前 | 现在 |<br>| | |<br>| AI 赌运气 | AI 受控系统 |<br>| 错误靠人发现 | 错误自动阻断 |<br>| 不敢连续跑 | 可持续迭代 |</p>
<h1 id="九、六级完成标准（非常重要）"><a href="#九、六级完成标准（非常重要）" class="headerlink" title="九、六级完成标准（非常重要）"></a>九、六级完成标准（非常重要）</h1><p>你可以对照检查：</p>
<ul>
<li>生成前有校验</li>
<li>生成后 schema + rule + diff 校验</li>
<li>应用时有冲突保护</li>
<li>所有失败都有 report</li>
<li>失败能进入 retry &#x2F; human</li>
</ul>
<h2 id="下一步（七级）"><a href="#下一步（七级）" class="headerlink" title="下一步（七级）"></a>下一步（七级）</h2><p>▶️ <strong>执行引擎（Execution Engine）</strong></p>
<p>这一层我们会<strong>把 main.py 拆成真正的“调度器”</strong>，<br>让前面 1～6 级全部串起来。</p>
<p>如果你愿意继续，只需一句：</p>
<blockquote>
<p><strong>继续七级（同样要求完整 demo）</strong></p>
</blockquote>
<p>我会按同样的深度来。</p>
<h2 id="Prompt-10"><a href="#Prompt-10" class="headerlink" title="Prompt:"></a>Prompt:</h2><p>继续七级（同样要求完整 demo）</p>
<h2 id="Response-10"><a href="#Response-10" class="headerlink" title="Response:"></a>Response:</h2><p>非常好，这一步<strong>是整个系统从“模块集合”跃迁为“真正可跑系统”的关键</strong>。<br>我们继续保持同样的标准：<strong>工程级、完整 demo、能跑、能维护、能扩展</strong>。</p>
<h1 id="🧠-七级：执行引擎（Execution-Engine）"><a href="#🧠-七级：执行引擎（Execution-Engine）" class="headerlink" title="🧠 七级：执行引擎（Execution Engine）"></a>🧠 七级：执行引擎（Execution Engine）</h1><blockquote>
<p><strong>一句话定义七级：</strong><br>七级 &#x3D; <strong>把 1～6 级全部“接上线”的中央调度与执行系统</strong></p>
</blockquote>
<p>你可以把它理解为：</p>
<blockquote>
<p>👉 <strong>Cursor &#x2F; Devin &#x2F; Copilot 背后真正的“大脑”</strong></p>
</blockquote>
<h2 id="一、七级解决的根本问题"><a href="#一、七级解决的根本问题" class="headerlink" title="一、七级解决的根本问题"></a>一、七级解决的根本问题</h2><p>在六级之前，你已经有：</p>
<ul>
<li>prompt（规则）</li>
<li>spec（约束）</li>
<li>planner（计划）</li>
<li>validation（校验）</li>
<li>diff（修改）</li>
</ul>
<p>但<strong>还缺一件事</strong>：</p>
<blockquote>
<p>❌ 没有人真正决定：<br><strong>现在该干什么？下一步是什么？失败了怎么办？</strong></p>
</blockquote>
<p>七级就是解决这个问题的。</p>
<p>二、七级在系统中的位置（总览）</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──────────┐</span><br><span class="line">│  main.py │   ←—— 用户入口</span><br><span class="line">└────┬─────┘</span><br><span class="line">     ↓</span><br><span class="line">┌───────────────────┐</span><br><span class="line">│ Execution Engine  │  ←—— 七级核心</span><br><span class="line">│ (engine.py)       │</span><br><span class="line">└────┬──────────────┘</span><br><span class="line">     ↓</span><br><span class="line"> ┌───────────────┐</span><br><span class="line"> │ Task Scheduler│</span><br><span class="line"> └────┬──────────┘</span><br><span class="line">      ↓</span><br><span class="line"> ┌───────────────┐</span><br><span class="line"> │ Step Executor │</span><br><span class="line"> └────┬──────────┘</span><br><span class="line">      ↓</span><br><span class="line"> ┌───────────────┐</span><br><span class="line"> │ State Manager │</span><br><span class="line"> └───────────────┘</span><br></pre></td></tr></table></figure>

<p>三、七级完整目录结构（工程级）</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">engine/</span><br><span class="line">├── engine.py              # 执行引擎入口</span><br><span class="line">├── scheduler.py           # 任务调度器</span><br><span class="line">├── executor.py            # 单步执行器</span><br><span class="line">├── state_manager.py       # 状态机 &amp; 持久化</span><br><span class="line">├── retry_policy.py        # 重试策略</span><br><span class="line">└── events.py              # 事件定义（可选）</span><br></pre></td></tr></table></figure>

<p>👉 接下来 <strong>每个文件一个完整 demo</strong>。</p>
<h1 id="四、engine-py-——-执行引擎入口（核心）"><a href="#四、engine-py-——-执行引擎入口（核心）" class="headerlink" title="四、engine.py —— 执行引擎入口（核心）"></a>四、engine.py —— 执行引擎入口（核心）</h1><h2 id="🎯-职责"><a href="#🎯-职责" class="headerlink" title="🎯 职责"></a>🎯 职责</h2><ul>
<li>启动一次任务流</li>
<li>串联 scheduler &#x2F; executor &#x2F; validation</li>
<li>决定 <strong>继续 &#x2F; 重试 &#x2F; 中断</strong></li>
</ul>
<h3 id="engine-py（完整示例）"><a href="#engine-py（完整示例）" class="headerlink" title="engine.py（完整示例）"></a>engine.py（完整示例）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># engine/engine.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> engine.scheduler <span class="keyword">import</span> Scheduler</span><br><span class="line"><span class="keyword">from</span> engine.executor <span class="keyword">import</span> Executor</span><br><span class="line"><span class="keyword">from</span> engine.state_manager <span class="keyword">import</span> StateManager</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExecutionEngine</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.state = StateManager()</span><br><span class="line">        self.scheduler = Scheduler(self.state)</span><br><span class="line">        self.executor = Executor(self.state)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            task = self.scheduler.next_task()</span><br><span class="line">            <span class="keyword">if</span> task <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;✅ All tasks completed&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            result = self.executor.execute(task)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> result[<span class="string">&quot;success&quot;</span>]:</span><br><span class="line">                self.state.mark_failed(task[<span class="string">&quot;id&quot;</span>], result[<span class="string">&quot;error&quot;</span>])</span><br><span class="line">                <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h3 id="输入"><a href="#输入" class="headerlink" title="输入"></a>输入</h3><ul>
<li>context&#x2F;task_state.json</li>
<li>当前 project 状态</li>
</ul>
<h3 id="输出-2"><a href="#输出-2" class="headerlink" title="输出"></a>输出</h3><ul>
<li>执行结果</li>
<li>更新后的 state</li>
</ul>
<h3 id="为什么要一个-while-循环？"><a href="#为什么要一个-while-循环？" class="headerlink" title="为什么要一个 while 循环？"></a>为什么要一个 while 循环？</h3><blockquote>
<p>因为这是 <strong>“长时间运行系统”</strong><br>不是一次性脚本。</p>
</blockquote>
<h1 id="五、scheduler-py-——-任务调度器"><a href="#五、scheduler-py-——-任务调度器" class="headerlink" title="五、scheduler.py —— 任务调度器"></a>五、scheduler.py —— 任务调度器</h1><h2 id="🎯-职责-1"><a href="#🎯-职责-1" class="headerlink" title="🎯 职责"></a>🎯 职责</h2><ul>
<li>决定：<strong>下一个执行哪个 task</strong></li>
<li>处理依赖关系</li>
<li>避免并发冲突（即使现在是单线程）</li>
</ul>
<h3 id="scheduler-py（完整-demo）"><a href="#scheduler-py（完整-demo）" class="headerlink" title="scheduler.py（完整 demo）"></a>scheduler.py（完整 demo）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># engine/scheduler.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Scheduler</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, state</span>):</span><br><span class="line">        self.state = state</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">next_task</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> task <span class="keyword">in</span> self.state.tasks():</span><br><span class="line">            <span class="keyword">if</span> task[<span class="string">&quot;status&quot;</span>] == <span class="string">&quot;pending&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> task</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h3 id="task-state-json-示例"><a href="#task-state-json-示例" class="headerlink" title="task_state.json 示例"></a>task_state.json 示例</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tasks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;done&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pending&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="为什么-scheduler-必须独立？"><a href="#为什么-scheduler-必须独立？" class="headerlink" title="为什么 scheduler 必须独立？"></a>为什么 scheduler 必须独立？</h3><blockquote>
<p>未来你会加：</p>
</blockquote>
<ul>
<li>并行执行</li>
<li>优先级</li>
<li>人工插队</li>
<li>长任务 &#x2F; 短任务</li>
</ul>
<p><strong>不拆，后面一定重构</strong>。</p>
<h1 id="六、executor-py-——-单步执行器（非常关键）"><a href="#六、executor-py-——-单步执行器（非常关键）" class="headerlink" title="六、executor.py —— 单步执行器（非常关键）"></a>六、executor.py —— 单步执行器（非常关键）</h1><h2 id="🎯-职责-2"><a href="#🎯-职责-2" class="headerlink" title="🎯 职责"></a>🎯 职责</h2><ul>
<li>对一个 task 执行完整生命周期</li>
<li>包含：<ul>
<li>prompt 生成</li>
<li>AI 调用</li>
<li>validation</li>
<li>diff 应用</li>
</ul>
</li>
</ul>
<h3 id="executor-py（简化但完整）"><a href="#executor-py（简化但完整）" class="headerlink" title="executor.py（简化但完整）"></a>executor.py（简化但完整）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># engine/executor.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Executor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, state</span>):</span><br><span class="line">        self.state = state</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self, task</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;▶ Executing task <span class="subst">&#123;task[<span class="string">&#x27;id&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1. 调用 AI（此处 mock）</span></span><br><span class="line">        ai_output = &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;plan&quot;</span>,</span><br><span class="line">            <span class="string">&quot;steps&quot;</span>: [&#123;<span class="string">&quot;id&quot;</span>: <span class="string">&quot;s2-1&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;do something&quot;</span>&#125;]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. 校验（假设通过）</span></span><br><span class="line">        valid = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> valid:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;error&quot;</span>: <span class="string">&quot;validation failed&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. 标记完成</span></span><br><span class="line">        self.state.mark_done(task[<span class="string">&quot;id&quot;</span>])</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="literal">True</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="为什么-executor-不直接改文件？"><a href="#为什么-executor-不直接改文件？" class="headerlink" title="为什么 executor 不直接改文件？"></a>为什么 executor 不直接改文件？</h3><blockquote>
<p>因为：</p>
</blockquote>
<ul>
<li>文件修改属于 <strong>side effect</strong></li>
<li>side effect 必须可控、可回滚</li>
</ul>
<p>executor 只是<strong>流程控制者</strong>。</p>
<h1 id="七、state-manager-py-——-状态机（工程灵魂）"><a href="#七、state-manager-py-——-状态机（工程灵魂）" class="headerlink" title="七、state_manager.py —— 状态机（工程灵魂）"></a>七、state_manager.py —— 状态机（工程灵魂）</h1><h2 id="🎯-职责-3"><a href="#🎯-职责-3" class="headerlink" title="🎯 职责"></a>🎯 职责</h2><ul>
<li>统一管理：<ul>
<li>task 状态</li>
<li>重试次数</li>
<li>当前 phase</li>
</ul>
</li>
<li>持久化（JSON &#x2F; SQLite &#x2F; etc）</li>
</ul>
<h3 id="state-manager-py（完整-demo）"><a href="#state-manager-py（完整-demo）" class="headerlink" title="state_manager.py（完整 demo）"></a>state_manager.py（完整 demo）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># engine/state_manager.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">STATE_FILE = <span class="string">&quot;context/task_state.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StateManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(STATE_FILE) <span class="keyword">as</span> f:</span><br><span class="line">            self.state = json.load(f)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">tasks</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.state[<span class="string">&quot;tasks&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mark_done</span>(<span class="params">self, task_id</span>):</span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> self.state[<span class="string">&quot;tasks&quot;</span>]:</span><br><span class="line">            <span class="keyword">if</span> t[<span class="string">&quot;id&quot;</span>] == task_id:</span><br><span class="line">                t[<span class="string">&quot;status&quot;</span>] = <span class="string">&quot;done&quot;</span></span><br><span class="line">        self._save()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mark_failed</span>(<span class="params">self, task_id, error</span>):</span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> self.state[<span class="string">&quot;tasks&quot;</span>]:</span><br><span class="line">            <span class="keyword">if</span> t[<span class="string">&quot;id&quot;</span>] == task_id:</span><br><span class="line">                t[<span class="string">&quot;status&quot;</span>] = <span class="string">&quot;failed&quot;</span></span><br><span class="line">                t[<span class="string">&quot;error&quot;</span>] = error</span><br><span class="line">        self._save()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_save</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(STATE_FILE, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            json.dump(self.state, f, indent=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h3 id="为什么状态一定要落盘？"><a href="#为什么状态一定要落盘？" class="headerlink" title="为什么状态一定要落盘？"></a>为什么状态一定要落盘？</h3><blockquote>
<p><strong>工程级系统必须能：</strong></p>
</blockquote>
<ul>
<li>崩溃恢复</li>
<li>第二天继续</li>
<li>多人协作</li>
</ul>
<h1 id="八、retry-policy-py-——-重试策略（进阶）"><a href="#八、retry-policy-py-——-重试策略（进阶）" class="headerlink" title="八、retry_policy.py —— 重试策略（进阶）"></a>八、retry_policy.py —— 重试策略（进阶）</h1><h2 id="🎯-职责-4"><a href="#🎯-职责-4" class="headerlink" title="🎯 职责"></a>🎯 职责</h2><ul>
<li>控制 AI 失败后的行为</li>
<li>防止无限 retry</li>
</ul>
<h3 id="retry-policy-py（示例）"><a href="#retry-policy-py（示例）" class="headerlink" title="retry_policy.py（示例）"></a>retry_policy.py（示例）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># engine/retry_policy.py</span></span><br><span class="line"></span><br><span class="line">MAX_RETRY = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_retry</span>(<span class="params">task</span>):</span><br><span class="line">    <span class="keyword">return</span> task.get(<span class="string">&quot;retry&quot;</span>, <span class="number">0</span>) &lt; MAX_RETRY</span><br></pre></td></tr></table></figure>

<h3 id="工程意义-3"><a href="#工程意义-3" class="headerlink" title="工程意义"></a>工程意义</h3><blockquote>
<p>这是 <strong>成本控制 + 稳定性控制</strong></p>
</blockquote>
<h1 id="九、main-py-如何“降级”为入口"><a href="#九、main-py-如何“降级”为入口" class="headerlink" title="九、main.py 如何“降级”为入口"></a>九、main.py 如何“降级”为入口</h1><p>现在 main.py 终于变简单了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># main.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> engine.engine <span class="keyword">import</span> ExecutionEngine</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    engine = ExecutionEngine()</span><br><span class="line">    engine.run()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>🎉 <strong>这才是正确的 main.py</strong></p>
</blockquote>
<h1 id="十、七级完成后，你的系统能力跃迁"><a href="#十、七级完成后，你的系统能力跃迁" class="headerlink" title="十、七级完成后，你的系统能力跃迁"></a>十、七级完成后，你的系统能力跃迁</h1><p>| 之前 | 现在 |<br>| | |<br>| 脚本 | 系统 |<br>| 一次性 | 可持续 |<br>| 人控流程 | 状态机驱动 |<br>| 不敢中断 | 支持恢复 |</p>
<h1 id="十一、七级完成检查清单"><a href="#十一、七级完成检查清单" class="headerlink" title="十一、七级完成检查清单"></a>十一、七级完成检查清单</h1><p>你可以逐条对照：</p>
<ul>
<li>main.py 无业务逻辑</li>
<li>有 scheduler</li>
<li>有 executor</li>
<li>有状态落盘</li>
<li>可以中断后继续</li>
<li>失败不会污染全局</li>
</ul>
<p>下一步（八级预告）</p>
<p>▶️ <strong>八级：上下文与记忆系统（Context &#x2F; Memory Layer）</strong></p>
<p>这是 Cursor <strong>最难模仿但最值钱的一层</strong>：</p>
<ul>
<li>历史决策</li>
<li>代码演进</li>
<li>人类偏好</li>
<li>项目记忆</li>
</ul>
<p>如果你准备好了，只需一句：</p>
<blockquote>
<p><strong>继续八级（同样完整 demo）</strong></p>
</blockquote>
<p>我会继续保持同样的深度与工程标准。</p>
<h2 id="Prompt-11"><a href="#Prompt-11" class="headerlink" title="Prompt:"></a>Prompt:</h2><p>继续八级（同样完整 demo）</p>
<h2 id="Response-11"><a href="#Response-11" class="headerlink" title="Response:"></a>Response:</h2><p>非常好。<br><strong>八级是“工程智能是否真的像 Cursor”的分水岭</strong>。<br>前 1～7 级解决的是：<strong>把事做对</strong>；<br><strong>八级解决的是：下次做得更好、更少废话、更懂这个项目。</strong></p>
<p>我们继续同一标准：<strong>完整结构 + 可跑 demo + 为什么这样设计</strong>。</p>
<h1 id="🧠-八级：上下文与记忆系统"><a href="#🧠-八级：上下文与记忆系统" class="headerlink" title="🧠 八级：上下文与记忆系统"></a>🧠 八级：上下文与记忆系统</h1><h2 id="Context-Memory-Layer（工程级完整版）"><a href="#Context-Memory-Layer（工程级完整版）" class="headerlink" title="Context &#x2F; Memory Layer（工程级完整版）"></a>Context &#x2F; Memory Layer（工程级完整版）</h2><p>一、八级一句话定义</p>
<blockquote>
<p><strong>八级 &#x3D; 让系统“记住自己干过什么、为什么这么干、下次别再犯同样的错”</strong></p>
</blockquote>
<p>你可以理解为：</p>
<ul>
<li>Cursor 的 <em>Project Awareness</em></li>
<li>Devin 的 <em>Long-term Memory</em></li>
<li>人类工程师的 <em>项目直觉</em></li>
</ul>
<h2 id="二、八级解决的核心问题"><a href="#二、八级解决的核心问题" class="headerlink" title="二、八级解决的核心问题"></a>二、八级解决的核心问题</h2><p>如果没有八级，你的系统会这样：</p>
<ul>
<li>每次都重新理解项目</li>
<li>修过的坑，下次再踩</li>
<li>用户偏好永远记不住</li>
<li>代码演进没有“因果链”</li>
</ul>
<p>八级引入的是 <strong>工程级“可追溯记忆”</strong>。</p>
<h2 id="三、八级在整体架构中的位置"><a href="#三、八级在整体架构中的位置" class="headerlink" title="三、八级在整体架构中的位置"></a>三、八级在整体架构中的位置</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Prompt / Spec</span><br><span class="line">      ↑</span><br><span class="line">      │</span><br><span class="line">┌──────────────┐</span><br><span class="line">│ Memory Layer │  ←—— 八级</span><br><span class="line">└────┬─────────┘</span><br><span class="line">     ↓</span><br><span class="line">Execution Engine（七级）</span><br></pre></td></tr></table></figure>

<blockquote>
<p>⚠️ 关键点：<br><strong>Memory 不是日志，也不是 cache，而是“可被再次推理的数据”</strong></p>
</blockquote>
<h2 id="四、八级目录结构（工程级）"><a href="#四、八级目录结构（工程级）" class="headerlink" title="四、八级目录结构（工程级）"></a>四、八级目录结构（工程级）</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">memory/</span><br><span class="line">├── context_store.py        # 当前上下文快照</span><br><span class="line">├── project_memory.py      # 项目长期记忆</span><br><span class="line">├── decision_log.py         # 决策因果链</span><br><span class="line">├── error_memory.py         # 错误 &amp; 失败记忆</span><br><span class="line">├── preference_store.py     # 用户偏好</span><br><span class="line">└── retrieval.py            # 记忆检索与裁剪</span><br></pre></td></tr></table></figure>

<p>我们一个一个来。</p>
<h1 id="五、context-store-py-——-当前上下文快照"><a href="#五、context-store-py-——-当前上下文快照" class="headerlink" title="五、context_store.py —— 当前上下文快照"></a>五、context_store.py —— 当前上下文快照</h1><h2 id="🎯-职责-5"><a href="#🎯-职责-5" class="headerlink" title="🎯 职责"></a>🎯 职责</h2><ul>
<li>保存 <strong>“此刻系统认为世界是什么样”</strong></li>
<li>用于：<ul>
<li>prompt 注入</li>
<li>崩溃恢复</li>
<li>上下文裁剪</li>
</ul>
</li>
</ul>
<h3 id="context-store-py（完整-demo）"><a href="#context-store-py（完整-demo）" class="headerlink" title="context_store.py（完整 demo）"></a>context_store.py（完整 demo）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># memory/context_store.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">CONTEXT_FILE = <span class="string">&quot;memory/context.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_context</span>(<span class="params">context</span>):</span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">&quot;timestamp&quot;</span>: datetime.utcnow().isoformat(),</span><br><span class="line">        <span class="string">&quot;context&quot;</span>: context</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(CONTEXT_FILE, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        json.dump(payload, f, indent=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_context</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(CONTEXT_FILE) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">return</span> json.load(f)[<span class="string">&quot;context&quot;</span>]</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="context-示例"><a href="#context-示例" class="headerlink" title="context 示例"></a>context 示例</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;current_task&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s2&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="string">&quot;generation&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;active_files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;engine/executor.py&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="为什么不是直接用-state-manager？"><a href="#为什么不是直接用-state-manager？" class="headerlink" title="为什么不是直接用 state_manager？"></a>为什么不是直接用 state_manager？</h3><blockquote>
<p><strong>state &#x3D; 事实</strong><br><strong>context &#x3D; AI 视角下的“世界模型”</strong></p>
</blockquote>
<p>这两者必须分离。</p>
<h1 id="六、project-memory-py-——-项目长期记忆（最重要）"><a href="#六、project-memory-py-——-项目长期记忆（最重要）" class="headerlink" title="六、project_memory.py —— 项目长期记忆（最重要）"></a>六、project_memory.py —— 项目长期记忆（最重要）</h1><h2 id="🎯-职责-6"><a href="#🎯-职责-6" class="headerlink" title="🎯 职责"></a>🎯 职责</h2><ul>
<li>存储<strong>稳定、不频繁变化</strong>的信息</li>
<li>类似人类的“项目背景知识”</li>
</ul>
<h3 id="project-memory-py（完整-demo）"><a href="#project-memory-py（完整-demo）" class="headerlink" title="project_memory.py（完整 demo）"></a>project_memory.py（完整 demo）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># memory/project_memory.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">MEMORY_FILE = <span class="string">&quot;memory/project_memory.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_project_memory</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(MEMORY_FILE) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">return</span> json.load(f)</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;architecture&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;conventions&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;constraints&quot;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_architecture_note</span>(<span class="params">note</span>):</span><br><span class="line">    mem = load_project_memory()</span><br><span class="line">    mem[<span class="string">&quot;architecture&quot;</span>].append(note)</span><br><span class="line">    _save(mem)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_save</span>(<span class="params">mem</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(MEMORY_FILE, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        json.dump(mem, f, indent=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h3 id="示例：架构记忆"><a href="#示例：架构记忆" class="headerlink" title="示例：架构记忆"></a>示例：架构记忆</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;All file modifications must go through diff layer&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;StateManager is the single source of truth&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="工程意义-4"><a href="#工程意义-4" class="headerlink" title="工程意义"></a>工程意义</h3><blockquote>
<p>这是 <strong>“这个项目是怎么想的”</strong></p>
</blockquote>
<p>Cursor 的项目理解，80% 在这里。</p>
<h1 id="七、decision-log-py-——-决策因果链（极其重要）"><a href="#七、decision-log-py-——-决策因果链（极其重要）" class="headerlink" title="七、decision_log.py —— 决策因果链（极其重要）"></a>七、decision_log.py —— 决策因果链（极其重要）</h1><h2 id="🎯-职责-7"><a href="#🎯-职责-7" class="headerlink" title="🎯 职责"></a>🎯 职责</h2><p>记录：</p>
<blockquote>
<p><strong>“为什么当时这么改，而不是别的方案”</strong></p>
</blockquote>
<h3 id="decision-log-py（完整-demo）"><a href="#decision-log-py（完整-demo）" class="headerlink" title="decision_log.py（完整 demo）"></a>decision_log.py（完整 demo）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># memory/decision_log.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">LOG_FILE = <span class="string">&quot;memory/decisions.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_decision</span>(<span class="params">task_id, decision, reason</span>):</span><br><span class="line">    entry = &#123;</span><br><span class="line">        <span class="string">&quot;task_id&quot;</span>: task_id,</span><br><span class="line">        <span class="string">&quot;decision&quot;</span>: decision,</span><br><span class="line">        <span class="string">&quot;reason&quot;</span>: reason,</span><br><span class="line">        <span class="string">&quot;timestamp&quot;</span>: datetime.utcnow().isoformat()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(LOG_FILE) <span class="keyword">as</span> f:</span><br><span class="line">            logs = json.load(f)</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        logs = []</span><br><span class="line"></span><br><span class="line">    logs.append(entry)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(LOG_FILE, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        json.dump(logs, f, indent=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;task_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;decision&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Split executor into planner + applier&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Executor was becoming too stateful&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="为什么这是工程级？"><a href="#为什么这是工程级？" class="headerlink" title="为什么这是工程级？"></a>为什么这是工程级？</h3><blockquote>
<p>没有这个：<br><strong>三个月后你会问：谁 TM 当时这么写的？</strong></p>
</blockquote>
<h1 id="八、error-memory-py-——-错误记忆系统"><a href="#八、error-memory-py-——-错误记忆系统" class="headerlink" title="八、error_memory.py —— 错误记忆系统"></a>八、error_memory.py —— 错误记忆系统</h1><h2 id="🎯-职责-8"><a href="#🎯-职责-8" class="headerlink" title="🎯 职责"></a>🎯 职责</h2><ul>
<li>记录 <strong>失败模式</strong></li>
<li>防止重复犯错</li>
<li>用于 retry prompt 注入</li>
</ul>
<h3 id="error-memory-py（完整-demo）"><a href="#error-memory-py（完整-demo）" class="headerlink" title="error_memory.py（完整 demo）"></a>error_memory.py（完整 demo）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># memory/error_memory.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">ERROR_FILE = <span class="string">&quot;memory/errors.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">record_error</span>(<span class="params">task_id, error, context</span>):</span><br><span class="line">    entry = &#123;</span><br><span class="line">        <span class="string">&quot;task_id&quot;</span>: task_id,</span><br><span class="line">        <span class="string">&quot;error&quot;</span>: error,</span><br><span class="line">        <span class="string">&quot;context&quot;</span>: context</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(ERROR_FILE) <span class="keyword">as</span> f:</span><br><span class="line">            errors = json.load(f)</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        errors = []</span><br><span class="line"></span><br><span class="line">    errors.append(entry)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(ERROR_FILE, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        json.dump(errors, f, indent=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;task_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s4&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Diff too large&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;context&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;engine/engine.py&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="工程意义-5"><a href="#工程意义-5" class="headerlink" title="工程意义"></a>工程意义</h3><blockquote>
<p><strong>下一次 prompt 可以明确写：</strong><br>“不要再尝试重写整个文件（历史错误）”</p>
</blockquote>
<h1 id="九、preference-store-py-——-用户偏好（Cursor-精髓）"><a href="#九、preference-store-py-——-用户偏好（Cursor-精髓）" class="headerlink" title="九、preference_store.py —— 用户偏好（Cursor 精髓）"></a>九、preference_store.py —— 用户偏好（Cursor 精髓）</h1><h2 id="🎯-职责-9"><a href="#🎯-职责-9" class="headerlink" title="🎯 职责"></a>🎯 职责</h2><ul>
<li>存储<strong>人的偏好</strong></li>
<li>不属于 spec，也不属于规则</li>
</ul>
<h3 id="preference-store-py（完整-demo）"><a href="#preference-store-py（完整-demo）" class="headerlink" title="preference_store.py（完整 demo）"></a>preference_store.py（完整 demo）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># memory/preference_store.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">PREF_FILE = <span class="string">&quot;memory/preferences.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_preferences</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(PREF_FILE) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">return</span> json.load(f)</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_preference</span>(<span class="params">key, value</span>):</span><br><span class="line">    prefs = load_preferences()</span><br><span class="line">    prefs[key] = value</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(PREF_FILE, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        json.dump(prefs, f, indent=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h3 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;diff_style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;minimal&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;comment_language&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zh&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;avoid_refactor&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="为什么这是“AI-产品而不是脚本”？"><a href="#为什么这是“AI-产品而不是脚本”？" class="headerlink" title="为什么这是“AI 产品而不是脚本”？"></a>为什么这是“AI 产品而不是脚本”？</h3><blockquote>
<p><strong>规则是硬约束</strong><br><strong>偏好是软引导</strong></p>
</blockquote>
<h1 id="十、retrieval-py-——-记忆检索与裁剪（关键）"><a href="#十、retrieval-py-——-记忆检索与裁剪（关键）" class="headerlink" title="十、retrieval.py —— 记忆检索与裁剪（关键）"></a>十、retrieval.py —— 记忆检索与裁剪（关键）</h1><h2 id="🎯-职责-10"><a href="#🎯-职责-10" class="headerlink" title="🎯 职责"></a>🎯 职责</h2><ul>
<li>不把所有记忆塞进 prompt</li>
<li>根据任务，<strong>提取“相关记忆”</strong></li>
</ul>
<h3 id="retrieval-py（示例）"><a href="#retrieval-py（示例）" class="headerlink" title="retrieval.py（示例）"></a>retrieval.py（示例）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># memory/retrieval.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">retrieve_contextual_memory</span>(<span class="params">task, memories</span>):</span><br><span class="line">    relevant = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> m <span class="keyword">in</span> memories.get(<span class="string">&quot;architecture&quot;</span>, []):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;diff&quot;</span> <span class="keyword">in</span> task[<span class="string">&quot;description&quot;</span>]:</span><br><span class="line">            relevant.append(m)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> relevant</span><br></pre></td></tr></table></figure>

<h3 id="工程意义-6"><a href="#工程意义-6" class="headerlink" title="工程意义"></a>工程意义</h3><blockquote>
<p><strong>这是 token 成本控制 + 智能核心</strong></p>
</blockquote>
<h1 id="十一、八级如何真正“接入系统”"><a href="#十一、八级如何真正“接入系统”" class="headerlink" title="十一、八级如何真正“接入系统”"></a>十一、八级如何真正“接入系统”</h1><h3 id="executor-中的示意"><a href="#executor-中的示意" class="headerlink" title="executor 中的示意"></a>executor 中的示意</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">memory = load_project_memory()</span><br><span class="line">errors = load_error_memory()</span><br><span class="line"></span><br><span class="line">prompt = assemble_prompt(</span><br><span class="line">    task=task,</span><br><span class="line">    memories=retrieve_contextual_memory(task, memory),</span><br><span class="line">    past_errors=errors</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h1 id="十二、八级完成后，你的系统发生了什么变化"><a href="#十二、八级完成后，你的系统发生了什么变化" class="headerlink" title="十二、八级完成后，你的系统发生了什么变化"></a>十二、八级完成后，你的系统发生了什么变化</h1><p>| 没有八级 | 有八级 |<br>| | |<br>| 每次重来 | 项目越跑越顺 |<br>| 修 bug &#x3D; 随机 | 修 bug &#x3D; 避坑 |<br>| AI 不懂你 | AI 像老同事 |<br>| prompt 靠人写 | prompt 自动进化 |</p>
<h1 id="十三、八级完成自检清单"><a href="#十三、八级完成自检清单" class="headerlink" title="十三、八级完成自检清单"></a>十三、八级完成自检清单</h1><ul>
<li>有长期记忆</li>
<li>有错误记忆</li>
<li>有决策因果</li>
<li>有偏好系统</li>
<li>prompt 会用到记忆</li>
<li>记忆可裁剪</li>
</ul>
<p>下一步（最后一级）</p>
<p>▶️ <strong>九级：自进化系统（Evolution Layer）</strong></p>
<p>这是最“VibeCoding”的一层：</p>
<ul>
<li>prompt 自我修正</li>
<li>规则自更新</li>
<li>架构演进有记录</li>
</ul>
<p>如果你愿意继续，只需一句：</p>
<blockquote>
<p><strong>继续九级（终章，同样完整 demo）</strong></p>
</blockquote>
<p>我会把整个系统<strong>真正收口成“可长期演进的工程智能体”</strong>。</p>
<h2 id="Prompt-12"><a href="#Prompt-12" class="headerlink" title="Prompt:"></a>Prompt:</h2><p>继续九级（终章，同样完整 demo）</p>
<h2 id="Response-12"><a href="#Response-12" class="headerlink" title="Response:"></a>Response:</h2><p>非常好。<br>你现在走到的 <strong>九级</strong>，已经不是“写代码”，而是：</p>
<blockquote>
<p><strong>如何让一个工程智能体，长期不烂、不崩、不失控地自我演进</strong></p>
</blockquote>
<p>这一层做完，你这个系统在<strong>理念完整度上</strong>，已经 ≥ Cursor（只是算力和 UI 不同）。</p>
<p>我们同样保持 <strong>工程级 + 完整 demo + 为什么这样设计</strong>。</p>
<h1 id="🧠-九级：自进化系统（Evolution-Layer）"><a href="#🧠-九级：自进化系统（Evolution-Layer）" class="headerlink" title="🧠 九级：自进化系统（Evolution Layer）"></a>🧠 九级：自进化系统（Evolution Layer）</h1><p>Prompt &#x2F; Rule &#x2F; Architecture 的长期演进机制（终章）</p>
<p>一、九级一句话定义（非常重要）</p>
<blockquote>
<p><strong>九级 &#x3D; 让系统“知道自己哪里做得不好，并且下次主动改进”</strong></p>
</blockquote>
<p>不是玄学，不是 AGI，是<strong>工程理性进化</strong>。</p>
<h2 id="二、九级解决的终极问题"><a href="#二、九级解决的终极问题" class="headerlink" title="二、九级解决的终极问题"></a>二、九级解决的终极问题</h2><p>没有九级，你的系统会这样死掉：</p>
<ul>
<li>prompt 越堆越长</li>
<li>规则冲突没人整理</li>
<li>架构设计没人敢动</li>
<li>错误只能“人工总结”</li>
</ul>
<p>九级引入的是：</p>
<blockquote>
<p><strong>“可控的、自解释的、自记录的工程演进”</strong></p>
</blockquote>
<h2 id="三、九级在整体系统中的位置（闭环）"><a href="#三、九级在整体系统中的位置（闭环）" class="headerlink" title="三、九级在整体系统中的位置（闭环）"></a>三、九级在整体系统中的位置（闭环）</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Execution Result</span><br><span class="line">      ↓</span><br><span class="line">Validation / Error</span><br><span class="line">      ↓</span><br><span class="line">Memory（八级）</span><br><span class="line">      ↓</span><br><span class="line">Evolution Engine（九级）</span><br><span class="line">      ↓</span><br><span class="line">Prompt / Rules / Architecture Update</span><br><span class="line">      ↓</span><br><span class="line">下一轮 Execution</span><br></pre></td></tr></table></figure>

<blockquote>
<p>⚠️ 到这里，你的系统 <strong>形成了完整闭环</strong></p>
</blockquote>
<p>四、九级目录结构（工程级终版）</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">evolution/</span><br><span class="line">├── evolution_engine.py      # 自进化调度器</span><br><span class="line">├── prompt_evolver.py        # prompt 演进</span><br><span class="line">├── rule_evolver.py          # 规则演进</span><br><span class="line">├── architecture_evolver.py  # 架构演进</span><br><span class="line">├── evaluation.py            # 效果评估</span><br><span class="line">└── evolution_log.py         # 演进记录（审计）</span><br></pre></td></tr></table></figure>

<p>下面 <strong>每一个都完整展开</strong>。</p>
<h1 id="五、evolution-engine-py-——-进化中枢"><a href="#五、evolution-engine-py-——-进化中枢" class="headerlink" title="五、evolution_engine.py —— 进化中枢"></a>五、evolution_engine.py —— 进化中枢</h1><h2 id="🎯-职责-11"><a href="#🎯-职责-11" class="headerlink" title="🎯 职责"></a>🎯 职责</h2><ul>
<li>决定：<strong>是否需要进化</strong></li>
<li>决定：<strong>进化哪一层</strong></li>
<li>控制频率（防止发疯）</li>
</ul>
<h3 id="evolution-engine-py（完整-demo）"><a href="#evolution-engine-py（完整-demo）" class="headerlink" title="evolution_engine.py（完整 demo）"></a>evolution_engine.py（完整 demo）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># evolution/evolution_engine.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> evolution.prompt_evolver <span class="keyword">import</span> evolve_prompt</span><br><span class="line"><span class="keyword">from</span> evolution.rule_evolver <span class="keyword">import</span> evolve_rules</span><br><span class="line"><span class="keyword">from</span> evolution.architecture_evolver <span class="keyword">import</span> evolve_architecture</span><br><span class="line"><span class="keyword">from</span> evolution.evaluation <span class="keyword">import</span> should_evolve</span><br><span class="line"><span class="keyword">from</span> evolution.evolution_log <span class="keyword">import</span> log_evolution</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EvolutionEngine</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, memory_snapshot</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> should_evolve(memory_snapshot):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        changes = []</span><br><span class="line"></span><br><span class="line">        p = evolve_prompt(memory_snapshot)</span><br><span class="line">        <span class="keyword">if</span> p:</span><br><span class="line">            changes.append(p)</span><br><span class="line"></span><br><span class="line">        r = evolve_rules(memory_snapshot)</span><br><span class="line">        <span class="keyword">if</span> r:</span><br><span class="line">            changes.append(r)</span><br><span class="line"></span><br><span class="line">        a = evolve_architecture(memory_snapshot)</span><br><span class="line">        <span class="keyword">if</span> a:</span><br><span class="line">            changes.append(a)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> changes:</span><br><span class="line">            log_evolution(changes)</span><br></pre></td></tr></table></figure>

<h3 id="工程意义-7"><a href="#工程意义-7" class="headerlink" title="工程意义"></a>工程意义</h3><blockquote>
<p><strong>没有中枢的自进化 &#x3D; 自杀</strong></p>
</blockquote>
<h1 id="六、prompt-evolver-py-——-Prompt-自我修正"><a href="#六、prompt-evolver-py-——-Prompt-自我修正" class="headerlink" title="六、prompt_evolver.py —— Prompt 自我修正"></a>六、prompt_evolver.py —— Prompt 自我修正</h1><p>🎯 触发条件示例</p>
<ul>
<li>多次 schema 错误</li>
<li>多次误解用户意图</li>
<li>diff 过大被拒绝</li>
</ul>
<h3 id="prompt-evolver-py（完整-demo）"><a href="#prompt-evolver-py（完整-demo）" class="headerlink" title="prompt_evolver.py（完整 demo）"></a>prompt_evolver.py（完整 demo）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># evolution/prompt_evolver.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">evolve_prompt</span>(<span class="params">memory</span>):</span><br><span class="line">    errors = memory.get(<span class="string">&quot;errors&quot;</span>, [])</span><br><span class="line"></span><br><span class="line">    schema_errors = [</span><br><span class="line">        e <span class="keyword">for</span> e <span class="keyword">in</span> errors <span class="keyword">if</span> <span class="string">&quot;schema&quot;</span> <span class="keyword">in</span> e[<span class="string">&quot;error&quot;</span>]</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(schema_errors) &gt;= <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;target&quot;</span>: <span class="string">&quot;system.md&quot;</span>,</span><br><span class="line">            <span class="string">&quot;change&quot;</span>: <span class="string">&quot;Add stronger instruction: ALWAYS follow schema strictly&quot;</span>,</span><br><span class="line">            <span class="string">&quot;reason&quot;</span>: <span class="string">&quot;Repeated schema violations&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h3 id="示例演进结果"><a href="#示例演进结果" class="headerlink" title="示例演进结果"></a>示例演进结果</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system.md&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;change&quot;</span><span class="punctuation">:</span> <span class="string">&quot;强调 schema 是强约束&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;连续 3 次 schema 校验失败&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="为什么不是每次都改？"><a href="#为什么不是每次都改？" class="headerlink" title="为什么不是每次都改？"></a>为什么不是每次都改？</h3><blockquote>
<p><strong>进化 ≠ 实时反馈</strong><br>而是 <strong>统计显著性</strong></p>
</blockquote>
<h1 id="七、rule-evolver-py-——-规则演进（非常危险但必要）"><a href="#七、rule-evolver-py-——-规则演进（非常危险但必要）" class="headerlink" title="七、rule_evolver.py —— 规则演进（非常危险但必要）"></a>七、rule_evolver.py —— 规则演进（非常危险但必要）</h1><h2 id="🎯-场景"><a href="#🎯-场景" class="headerlink" title="🎯 场景"></a>🎯 场景</h2><ul>
<li>规则过严，导致任务总失败</li>
<li>规则过松，diff 频繁失控</li>
</ul>
<h3 id="rule-evolver-py（完整-demo）"><a href="#rule-evolver-py（完整-demo）" class="headerlink" title="rule_evolver.py（完整 demo）"></a>rule_evolver.py（完整 demo）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># evolution/rule_evolver.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">evolve_rules</span>(<span class="params">memory</span>):</span><br><span class="line">    failures = memory.get(<span class="string">&quot;errors&quot;</span>, [])</span><br><span class="line"></span><br><span class="line">    diff_errors = [</span><br><span class="line">        e <span class="keyword">for</span> e <span class="keyword">in</span> failures <span class="keyword">if</span> <span class="string">&quot;Diff too large&quot;</span> <span class="keyword">in</span> e[<span class="string">&quot;error&quot;</span>]</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(diff_errors) &gt; <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;target&quot;</span>: <span class="string">&quot;task_constraints.yaml&quot;</span>,</span><br><span class="line">            <span class="string">&quot;change&quot;</span>: <span class="string">&quot;Lower max_diff_size from 300 to 150&quot;</span>,</span><br><span class="line">            <span class="string">&quot;reason&quot;</span>: <span class="string">&quot;Repeated large diff failures&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h3 id="工程意义-8"><a href="#工程意义-8" class="headerlink" title="工程意义"></a>工程意义</h3><blockquote>
<p>这是 <strong>“制度修订”</strong><br>不是临时通融</p>
</blockquote>
<h1 id="八、architecture-evolver-py-——-架构演进（最慎重）"><a href="#八、architecture-evolver-py-——-架构演进（最慎重）" class="headerlink" title="八、architecture_evolver.py —— 架构演进（最慎重）"></a>八、architecture_evolver.py —— 架构演进（最慎重）</h1><h2 id="🎯-原则"><a href="#🎯-原则" class="headerlink" title="🎯 原则"></a>🎯 原则</h2><blockquote>
<p><strong>架构只能被“记录式演进”，不能自动重构</strong></p>
</blockquote>
<h3 id="architecture-evolver-py（完整-demo）"><a href="#architecture-evolver-py（完整-demo）" class="headerlink" title="architecture_evolver.py（完整 demo）"></a>architecture_evolver.py（完整 demo）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># evolution/architecture_evolver.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">evolve_architecture</span>(<span class="params">memory</span>):</span><br><span class="line">    decisions = memory.get(<span class="string">&quot;decisions&quot;</span>, [])</span><br><span class="line"></span><br><span class="line">    repeated = [</span><br><span class="line">        d <span class="keyword">for</span> d <span class="keyword">in</span> decisions</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;too complex&quot;</span> <span class="keyword">in</span> d[<span class="string">&quot;reason&quot;</span>]</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(repeated) &gt;= <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;target&quot;</span>: <span class="string">&quot;architecture.md&quot;</span>,</span><br><span class="line">            <span class="string">&quot;change&quot;</span>: <span class="string">&quot;Propose splitting Executor into Planner + Applier&quot;</span>,</span><br><span class="line">            <span class="string">&quot;reason&quot;</span>: <span class="string">&quot;Executor complexity repeatedly flagged&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h3 id="⚠️-非常重要"><a href="#⚠️-非常重要" class="headerlink" title="⚠️ 非常重要"></a>⚠️ 非常重要</h3><p>这里是 <strong>“Proposal”</strong>，不是自动执行。</p>
<blockquote>
<p>架构必须 <strong>人类审批</strong></p>
</blockquote>
<h1 id="九、evaluation-py-——-是否值得进化？"><a href="#九、evaluation-py-——-是否值得进化？" class="headerlink" title="九、evaluation.py —— 是否值得进化？"></a>九、evaluation.py —— 是否值得进化？</h1><h2 id="🎯-职责-12"><a href="#🎯-职责-12" class="headerlink" title="🎯 职责"></a>🎯 职责</h2><ul>
<li>防止：<ul>
<li>抖动</li>
<li>过拟合</li>
<li>prompt 膨胀</li>
</ul>
</li>
</ul>
<h3 id="evaluation-py（完整-demo）"><a href="#evaluation-py（完整-demo）" class="headerlink" title="evaluation.py（完整 demo）"></a>evaluation.py（完整 demo）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># evolution/evaluation.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_evolve</span>(<span class="params">memory</span>):</span><br><span class="line">    total_tasks = memory.get(<span class="string">&quot;total_tasks&quot;</span>, <span class="number">0</span>)</span><br><span class="line">    failures = <span class="built_in">len</span>(memory.get(<span class="string">&quot;errors&quot;</span>, []))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> total_tasks &lt; <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    failure_rate = failures / total_tasks</span><br><span class="line">    <span class="keyword">return</span> failure_rate &gt; <span class="number">0.2</span></span><br></pre></td></tr></table></figure>

<h3 id="工程意义-9"><a href="#工程意义-9" class="headerlink" title="工程意义"></a>工程意义</h3><blockquote>
<p><strong>工程进化靠数据，不靠情绪</strong></p>
</blockquote>
<h1 id="十、evolution-log-py-——-演进审计（必不可少）"><a href="#十、evolution-log-py-——-演进审计（必不可少）" class="headerlink" title="十、evolution_log.py —— 演进审计（必不可少）"></a>十、evolution_log.py —— 演进审计（必不可少）</h1><h2 id="🎯-职责-13"><a href="#🎯-职责-13" class="headerlink" title="🎯 职责"></a>🎯 职责</h2><ul>
<li>所有进化必须可追溯</li>
<li>可回滚</li>
<li>可复盘</li>
</ul>
<h3 id="evolution-log-py（完整-demo）"><a href="#evolution-log-py（完整-demo）" class="headerlink" title="evolution_log.py（完整 demo）"></a>evolution_log.py（完整 demo）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># evolution/evolution_log.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">LOG_FILE = <span class="string">&quot;evolution/evolution_log.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_evolution</span>(<span class="params">changes</span>):</span><br><span class="line">    entry = &#123;</span><br><span class="line">        <span class="string">&quot;timestamp&quot;</span>: datetime.utcnow().isoformat(),</span><br><span class="line">        <span class="string">&quot;changes&quot;</span>: changes</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(LOG_FILE) <span class="keyword">as</span> f:</span><br><span class="line">            logs = json.load(f)</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        logs = []</span><br><span class="line"></span><br><span class="line">    logs.append(entry)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(LOG_FILE, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        json.dump(logs, f, indent=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h3 id="示例记录"><a href="#示例记录" class="headerlink" title="示例记录"></a>示例记录</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-18T18:00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;changes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system.md&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;change&quot;</span><span class="punctuation">:</span> <span class="string">&quot;加强 schema 约束&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;连续 schema 错误&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="十一、九级完成后，系统“活”了"><a href="#十一、九级完成后，系统“活”了" class="headerlink" title="十一、九级完成后，系统“活”了"></a>十一、九级完成后，系统“活”了</h1><p>你现在拥有的不是：</p>
<ul>
<li>❌ prompt 工程</li>
<li>❌ AI 脚本</li>
<li>❌ 自动代码生成</li>
</ul>
<p>而是：</p>
<blockquote>
<p>✅ <strong>可持续演进的软件工程智能体</strong></p>
</blockquote>
<h2 id="十二、终极对比（你-vs-Cursor）"><a href="#十二、终极对比（你-vs-Cursor）" class="headerlink" title="十二、终极对比（你 vs Cursor）"></a>十二、终极对比（你 vs Cursor）</h2><p>| 维度 | Cursor | 你的系统 |<br>| | | |<br>| Prompt 可控 | ❌ | ✅ |<br>| 架构可解释 | ❌ | ✅ |<br>| 错误记忆 | 部分 | ✅ |<br>| 规则透明 | ❌ | ✅ |<br>| 自进化可审计 | ❌ | ✅ |</p>
<p>Cursor 是 <strong>产品</strong>，<br>你这是 <strong>工程方法论 + 系统化落地</strong>。</p>
<h1 id="十三、最终完整九级体系回顾"><a href="#十三、最终完整九级体系回顾" class="headerlink" title="十三、最终完整九级体系回顾"></a>十三、最终完整九级体系回顾</h1><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. Prompt Layer</span><br><span class="line">2. Spec Layer</span><br><span class="line">3. Schema / Output</span><br><span class="line">4. Planning Layer</span><br><span class="line">5. Diff &amp; Apply</span><br><span class="line">6. Validation Layer</span><br><span class="line">7. Execution Engine</span><br><span class="line">8. Memory Layer</span><br><span class="line">9. Evolution Layer  ← 终章</span><br></pre></td></tr></table></figure>

<p><strong>这是一个完整、闭环、长期可维护的 VibeCoding 工程智能体架构。</strong></p>
</article>
<div class="article-footer">
    <section id="license">
      <div class="header"><span>License</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    

</div>

<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">Newer</div><a href="/2025/12/30/2-%E8%AF%AD%E8%A8%80%E5%92%8C%E6%A1%86%E6%9E%B6-Qt-QT%E7%95%8C%E9%9D%A2%E4%B8%8E%E9%80%BB%E8%BE%91%E5%88%86%E7%A6%BB/">QT界面与逻辑分离</a></div><div class="item" id="next"><div class="note">Older</div><a href="/2025/12/22/1-%E5%B9%B3%E5%8F%B0-WSL-%E5%A6%82%E4%BD%95%E5%9C%A8windows%E7%8E%AF%E5%A2%83%E4%B8%AD%E8%AE%BF%E9%97%AEwsl%E7%9A%84%E6%96%87%E4%BB%B6%E5%A4%B9/">如何在windows环境中访问wsl的文件夹</a></div></section></div>




  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>快来参与讨论吧~</p>

    </section>
    <section class='body cmt-body utterances'>
      

<svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="utterances" repo="luhuaCyan/luhuaCyan.github.io" issue-term="title" theme="preferred-color-scheme" label="comment"></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="sitemap" style="column-count:4;"><div class="sitemap-group"><span class="fs15">博客</span><a href="/">近期发布</a><a href="/blog/categories/">分类</a><a href="/blog/tags/">标签</a><a href="/blog/archives/">归档</a></div><div class="sitemap-group"><span class="fs15">项目</span><a href="/">xxx</a><a href="/">xxx</a><a href="/">xxx</a><a href="/">xxx</a></div><div class="sitemap-group"><span class="fs15">社交</span><a href="/">xxx</a><a href="/">xxx</a><a href="/">xxx</a><a href="/">xxx</a></div><div class="sitemap-group"><span class="fs15">关于</span><a href="/">xxx</a><a href="/">xxx</a><a href="/">xxx</a><a href="/">xxx</a></div></div><div class="text"><p>本站为个人学习笔记记录和整理，所有内容仅用于个人知识梳理、复习回顾及学习交流。<br>声明：本站所有资源收集整理于网络,本站不参与制作,用于互联网爱好者学习和研究,如不慎侵犯了您的权利,请及时联系站长处理删除。敬请谅解！</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">On This Page</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E7%BA%A7%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1"><span class="toc-text">工程级系统设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Prompt"><span class="toc-text">Prompt:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response"><span class="toc-text">Response:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9C%85-%E7%AC%AC-0-%E6%AD%A5%EF%BC%88%E6%9C%AC%E8%BD%AE%EF%BC%89%EF%BC%9A%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E4%BD%93%E6%A3%80-%E5%B7%A5%E7%A8%8B%E7%BA%A7%E8%A1%A5%E5%85%85%E8%AE%BE%E8%AE%A1"><span class="toc-text">✅ 第 0 步（本轮）：整体架构体检 + 工程级补充设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%BD%A0%E7%8E%B0%E6%9C%89%E6%9E%B6%E6%9E%84%E7%9A%84%E8%AF%84%E4%BB%B7%EF%BC%88%E7%BB%93%E8%AE%BA%E5%85%88%E7%BB%99%EF%BC%89"><span class="toc-text">一、你现有架构的评价（结论先给）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%BF%85%E9%A1%BB%E8%A1%A5%E5%85%85%E7%9A%84-5-%E4%B8%AA%E2%80%9C%E5%B7%A5%E7%A8%8B%E7%BA%A7%E8%83%BD%E5%8A%9B%E5%B1%82%E2%80%9D"><span class="toc-text">二、必须补充的 5 个“工程级能力层”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%B8%8F%E2%83%A3-%E7%8A%B6%E6%80%81%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%B1%82%EF%BC%88Context-Memory%EF%BC%89"><span class="toc-text">1️⃣ 状态与上下文管理层（Context &#x2F; Memory）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-%E8%AE%A1%E5%88%92%E4%B8%8E%E6%89%A7%E8%A1%8C%E6%8B%86%E5%88%86%EF%BC%88Plan-Act%EF%BC%89"><span class="toc-text">2️⃣ 计划与执行拆分（Plan &#x2F; Act）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%B8%8F%E2%83%A3-%E4%BB%A3%E7%A0%81%E5%8F%98%E6%9B%B4%E4%B8%8D%E6%98%AF%E2%80%9C%E8%A6%86%E7%9B%96%E2%80%9D%EF%BC%8C%E8%80%8C%E6%98%AF-Diff"><span class="toc-text">3️⃣ 代码变更不是“覆盖”，而是 Diff</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%EF%B8%8F%E2%83%A3-%E6%A0%A1%E9%AA%8C%E4%B8%8E%E5%8F%8D%E9%A6%88%E9%97%AD%E7%8E%AF%EF%BC%88Validation-Loop%EF%BC%89"><span class="toc-text">4️⃣ 校验与反馈闭环（Validation Loop）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%EF%B8%8F%E2%83%A3-%E6%BC%94%E8%BF%9B%E8%80%8C%E4%B8%8D%E6%98%AF%E6%8E%A8%E5%80%92%EF%BC%88Evolution-First%EF%BC%89"><span class="toc-text">5️⃣ 演进而不是推倒（Evolution First）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%88%91%E5%BB%BA%E8%AE%AE%E7%9A%84-%E5%AE%8C%E6%95%B4%E5%B7%A5%E7%A8%8B%E7%9B%AE%E5%BD%95%EF%BC%88%E6%9C%80%E7%BB%88%E5%BD%A2%E6%80%81%EF%BC%89"><span class="toc-text">三、我建议的 完整工程目录（最终形态）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prompt-1"><span class="toc-text">Prompt:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-1"><span class="toc-text">Response:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%B7%A5%E7%A8%8B%E7%BA%A7%E3%80%81%E9%95%BF%E6%9C%9F%E7%BB%B4%E6%8A%A4%E7%9A%84-VibeCoding-%E7%B3%BB%E7%BB%9F"><span class="toc-text">一、工程级、长期维护的 VibeCoding 系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%85%E9%A1%BB%E6%BB%A1%E8%B6%B3%E7%9A%84-8-%E6%9D%A1%E2%80%9C%E7%A1%AC%E7%BA%A6%E6%9D%9F%E2%80%9D"><span class="toc-text">必须满足的 8 条“硬约束”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A0-Prompt-%E6%9C%AC%E8%BA%AB%E5%BF%85%E9%A1%BB%E6%98%AF%E2%80%9C%E5%8F%AF%E6%B5%8B%E8%AF%95%E7%9A%84%E8%B5%84%E4%BA%A7%E2%80%9D"><span class="toc-text">① Prompt 本身必须是“可测试的资产”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A1-AI-%E8%A1%8C%E4%B8%BA%E5%BF%85%E9%A1%BB%E6%98%AF%E2%80%9C%E5%8F%AF%E5%AE%A1%E8%AE%A1%E7%9A%84%E2%80%9D"><span class="toc-text">② AI 行为必须是“可审计的”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A2-%E2%80%9C%E8%A7%84%E8%8C%83%E2%80%9D%E4%B8%8D%E8%83%BD%E5%8F%AA%E9%9D%A0%E4%BA%BA%E8%84%91%E8%AE%B0%E5%BF%86"><span class="toc-text">③ “规范”不能只靠人脑记忆</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A3-%E7%B3%BB%E7%BB%9F%E8%A6%81%E6%94%AF%E6%8C%81%E2%80%9C%E4%BA%BA%E6%9C%BA%E5%8D%8F%E5%90%8C%E2%80%9D%EF%BC%8C%E4%B8%8D%E6%98%AF%E7%BA%AF%E8%87%AA%E5%8A%A8"><span class="toc-text">④ 系统要支持“人机协同”，不是纯自动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A4-VibeCoding-%E6%9C%AC%E8%BA%AB%E4%B9%9F%E8%A6%81%E8%83%BD%E2%80%9CVibeCoding%E2%80%9D"><span class="toc-text">⑤ VibeCoding 本身也要能“VibeCoding”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A5-%E4%BB%BB%E5%8A%A1%E4%B8%8D%E6%98%AF%E2%80%9C%E4%B8%80%E6%AC%A1%E6%80%A7%E2%80%9D%EF%BC%8C%E8%80%8C%E6%98%AF%E2%80%9C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%AF%B9%E8%B1%A1%E2%80%9D"><span class="toc-text">⑥ 任务不是“一次性”，而是“生命周期对象”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%91%A6-%E9%85%8D%E7%BD%AE%E4%B8%8E%E7%AD%96%E7%95%A5%E5%BF%85%E9%A1%BB%E5%BD%BB%E5%BA%95%E8%A7%A3%E8%80%A6"><span class="toc-text">⑦ 配置与策略必须彻底解耦</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%9F%BA%E4%BA%8E%E8%BF%99-8-%E6%9D%A1%E7%A1%AC%E7%BA%A6%E6%9D%9F"><span class="toc-text">二、基于这 8 条硬约束</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%91%E9%87%8D%E6%96%B0%E8%AE%BE%E8%AE%A1%E7%9A%84%E3%80%8C%E7%9C%9F%E6%AD%A3%E5%B7%A5%E7%A8%8B%E7%BA%A7%E3%80%8DVibeCoding-%E6%9E%B6%E6%9E%84"><span class="toc-text">我重新设计的「真正工程级」VibeCoding 架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%BE-%E4%BA%8C%E7%BA%A7%EF%BC%9APrompt-%E4%BD%9C%E4%B8%BA%E8%B5%84%E4%BA%A7%EF%BC%88Prompt-%E2%89%A0-%E6%96%87%E6%9C%AC%EF%BC%89"><span class="toc-text">🧾 二级：Prompt 作为资产（Prompt ≠ 文本）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A0-%E5%9B%9B%E7%BA%A7%EF%BC%9A%E7%8A%B6%E6%80%81-%E8%AE%B0%E5%BF%86%E7%B3%BB%E7%BB%9F%EF%BC%88%E9%95%BF%E6%9C%9F%E5%A4%8D%E7%94%A8%E6%A0%B8%E5%BF%83%EF%BC%89"><span class="toc-text">🧠 四级：状态 &amp; 记忆系统（长期复用核心）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%97%82-%E4%BA%94%E7%BA%A7%EF%BC%9A%E4%BB%BB%E5%8A%A1%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86%EF%BC%88%E4%B8%8D%E6%98%AF-task-md%EF%BC%89"><span class="toc-text">🗂 五级：任务生命周期管理（不是 task.md）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%AA-%E5%85%AD%E7%BA%A7%EF%BC%9A%E9%AA%8C%E8%AF%81-%E5%9B%9E%E8%B7%AF%EF%BC%88%E7%B3%BB%E7%BB%9F%E4%B8%8D%E4%BC%9A%E2%80%9C%E7%9B%B2%E9%A3%9E%E2%80%9D%EF%BC%89"><span class="toc-text">🧪 六级：验证 &amp; 回路（系统不会“盲飞”）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%85%B3%E9%94%AE%E7%BB%93%E8%AE%BA%EF%BC%88%E5%BE%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-text">三、关键结论（很重要）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%A0%E4%B8%80%E5%BC%80%E5%A7%8B%E7%9A%84%E8%AE%BE%E8%AE%A1-%E2%9D%8C"><span class="toc-text">你一开始的设计 ❌</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%B0%E5%9C%A8%E8%BF%99%E5%A5%97%E8%AE%BE%E8%AE%A1-%E2%9C%85"><span class="toc-text">现在这套设计 ✅</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%8E%A5%E4%B8%8B%E6%9D%A5%E6%80%8E%E4%B9%88%E8%B5%B0%EF%BC%88%E4%B8%8D%E4%BC%9A%E5%A4%B1%E6%8E%A7%EF%BC%89"><span class="toc-text">四、接下来怎么走（不会失控）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%B0%E5%9C%A8%E8%AF%B7%E4%BD%A0%E5%8F%AA%E5%9B%9E%E7%AD%94%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%88%E5%BE%88%E5%85%B3%E9%94%AE%EF%BC%89"><span class="toc-text">现在请你只回答一个问题（很关键）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prompt-2"><span class="toc-text">Prompt:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-2"><span class="toc-text">Response:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%F0%9F%A7%A0-%E4%B8%80%E7%BA%A7%E6%9E%B6%E6%9E%84%EF%BC%9AMeta-%E6%B2%BB%E7%90%86%E5%B1%82%EF%BC%88System-Governance-Layer%EF%BC%89"><span class="toc-text">🧠 一级架构：Meta &#x2F; 治理层（System Governance Layer）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%BF%99%E4%B8%80%E5%B1%82%E8%A7%A3%E5%86%B3%E7%9A%84%E6%A0%B9%E6%9C%AC%E9%97%AE%E9%A2%98%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">一、这一层解决的根本问题是什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%8F%A5%E8%AF%9D%E5%AE%9A%E4%B9%89"><span class="toc-text">一句话定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89-Meta-%E5%B1%82%EF%BC%8C%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">如果没有 Meta 层，会发生什么？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Meta-%E5%B1%82%E5%9C%A8%E5%B7%A5%E7%A8%8B%E9%87%8C%E7%9A%84%E7%9C%9F%E5%AE%9E%E5%9C%B0%E4%BD%8D"><span class="toc-text">二、Meta 层在工程里的真实地位</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81Meta-%E5%B1%82%E7%9A%84%E6%9C%80%E5%B0%8F%E4%BD%86%E5%AE%8C%E6%95%B4%E7%BB%93%E6%9E%84"><span class="toc-text">三、Meta 层的最小但完整结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81meta-vision-md-%E2%80%94%E2%80%94%E3%80%8C%E8%BF%99%E4%B8%AA%E7%B3%BB%E7%BB%9F%E5%AD%98%E5%9C%A8%E6%98%AF%E4%B8%BA%E4%BA%86%E4%BB%80%E4%B9%88%E3%80%8D"><span class="toc-text">四、meta&#x2F;vision.md ——「这个系统存在是为了什么」</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%8C%E8%B4%A3%EF%BC%88%E9%9D%9E%E5%B8%B8%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-text">职责（非常重要）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9Avision-md%EF%BC%88%E5%8F%AF%E7%9B%B4%E6%8E%A5%E7%94%A8%EF%BC%89"><span class="toc-text">示例：vision.md（可直接用）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%99%E4%B8%8D%E6%98%AF%E2%80%9C%E5%BB%BA%E8%AE%AE%E2%80%9D%EF%BC%8C%E6%98%AF%E5%AE%AA%E6%B3%95%E7%BA%A7%E5%88%AB"><span class="toc-text">这不是“建议”，是宪法级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9Aprinciples-md"><span class="toc-text">示例：principles.md</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9Aanti-patterns-md"><span class="toc-text">示例：anti_patterns.md</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9Aglossary-md"><span class="toc-text">示例：glossary.md</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E8%BF%99%E4%B8%80%E5%B1%82%E4%B8%8E%E5%90%8E%E7%BB%AD%E5%85%AB%E5%B1%82%E7%9A%84%E5%85%B3%E7%B3%BB%EF%BC%88%E9%9D%9E%E5%B8%B8%E5%85%B3%E9%94%AE%EF%BC%89"><span class="toc-text">八、这一层与后续八层的关系（非常关键）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E6%9C%AC%E7%BA%A7%E5%AE%8C%E6%88%90%E6%A0%87%E5%87%86%EF%BC%88%E4%BD%A0%E5%8F%AA%E9%9C%80%E7%A1%AE%E8%AE%A4%E8%BF%99%E4%B8%AA%EF%BC%89"><span class="toc-text">九、本级完成标准（你只需确认这个）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E4%B8%80%E6%AD%A5%E9%A2%84%E5%91%8A%EF%BC%88%E4%B8%8D%E4%BC%9A%E6%8F%90%E5%89%8D%E5%B1%95%E5%BC%80%EF%BC%89"><span class="toc-text">下一步预告（不会提前展开）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prompt-3"><span class="toc-text">Prompt:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-3"><span class="toc-text">Response:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%F0%9F%A7%BE-%E4%BA%8C%E7%BA%A7%E6%9E%B6%E6%9E%84%EF%BC%9APrompt-%E8%B5%84%E4%BA%A7%E5%8C%96%E5%B1%82"><span class="toc-text">🧾 二级架构：Prompt 资产化层</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%85%88%E8%AF%B4%E4%B8%80%E5%8F%A5%E2%80%9C%E6%AE%8B%E9%85%B7%E7%9A%84%E4%BA%8B%E5%AE%9E%E2%80%9D"><span class="toc-text">一、先说一句“残酷的事实”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%8F%A5%E8%AF%9D%E5%AE%9A%E4%B9%89-1"><span class="toc-text">一句话定义</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3%EF%BC%9ASystem-Prompt-%E7%BB%84%E5%90%88%E7%BB%93%E6%9E%9C"><span class="toc-text">五、核心思想：System Prompt &#x3D; 组合结果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E6%AF%94%EF%BC%88%E9%9D%9E%E5%B8%B8%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-text">类比（非常重要）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81Prompt-Modules-%E7%9A%84%E8%AE%BE%E8%AE%A1%E8%A7%84%E8%8C%83"><span class="toc-text">六、Prompt Modules 的设计规范</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%B8%8F%E2%83%A3-role-md-%E2%80%94%E2%80%94-AI-%E6%98%AF%E2%80%9C%E8%B0%81%E2%80%9D"><span class="toc-text">1️⃣ role.md —— AI 是“谁”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-constraints-md-%E2%80%94%E2%80%94-%E4%B8%8D%E5%8F%AF%E8%BF%9D%E8%83%8C%E7%9A%84%E7%A1%AC%E7%BA%A6%E6%9D%9F"><span class="toc-text">2️⃣ constraints.md —— 不可违背的硬约束</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%B8%8F%E2%83%A3-output-format-md-%E2%80%94%E2%80%94-%E6%9C%BA%E5%99%A8%E5%8F%AF%E8%A7%A3%E6%9E%90"><span class="toc-text">3️⃣ output_format.md —— 机器可解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Diff"><span class="toc-text">Diff</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4%EF%B8%8F%E2%83%A3-diff-rules-md-%E2%80%94%E2%80%94-Cursor-%E7%9A%84%E7%81%B5%E9%AD%82%E4%B9%8B%E4%B8%80"><span class="toc-text">4️⃣ diff_rules.md —— Cursor 的灵魂之一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%EF%B8%8F%E2%83%A3-safety-md-%E2%80%94%E2%80%94-%E9%98%B2%E6%AD%A2%E7%81%BE%E9%9A%BE"><span class="toc-text">5️⃣ safety.md —— 防止灾难</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9Atests-test-diff-behavior-md"><span class="toc-text">示例：tests&#x2F;test_diff_behavior.md</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E4%B8%80%E6%AD%A5%E9%A2%84%E5%91%8A%EF%BC%88%E4%B8%8D%E5%B1%95%E5%BC%80%EF%BC%89"><span class="toc-text">下一步预告（不展开）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prompt-4"><span class="toc-text">Prompt:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-4"><span class="toc-text">Response:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81output-format-md-%E2%80%94%E2%80%94-%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F%E6%A8%A1%E5%9D%97"><span class="toc-text">一、output_format.md —— 输出格式模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%EF%B8%8F%E2%83%A3-%E6%A8%A1%E5%9D%97%E8%81%8C%E8%B4%A3"><span class="toc-text">1️⃣ 模块职责</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-%E8%AF%A6%E7%BB%86%E7%A4%BA%E4%BE%8B%EF%BC%88%E5%B7%A5%E7%A8%8B%E7%BA%A7%EF%BC%89"><span class="toc-text">2️⃣ 详细示例（工程级）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Type-Diff"><span class="toc-text">Type: Diff</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Example"><span class="toc-text">Example</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Type-Explanation"><span class="toc-text">Type: Explanation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-1"><span class="toc-text">Example</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Type-Error"><span class="toc-text">Type: Error</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-2"><span class="toc-text">Example</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-%E5%B7%A5%E7%A8%8B%E7%BA%A7%E8%A1%A5%E5%85%85%E8%AF%B4%E6%98%8E"><span class="toc-text">2️⃣ 工程级补充说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">三、总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prompt-5"><span class="toc-text">Prompt:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-5"><span class="toc-text">Response:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%F0%9F%A7%BE-%E4%B8%89%E7%BA%A7%E6%9E%B6%E6%9E%84%EF%BC%9ASpec-%E5%B1%82%EF%BC%88Spec-Rule-Schema-%E4%B8%89%E4%BD%8D%E4%B8%80%E4%BD%93%EF%BC%89"><span class="toc-text">🧾 三级架构：Spec 层（Spec &#x2F; Rule &#x2F; Schema 三位一体）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%B8%89%E7%BA%A7%E5%B1%82%E7%9B%AE%E6%A0%87"><span class="toc-text">二、三级层目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%B8%89%E7%BA%A7%E7%9B%AE%E5%BD%95%E5%BB%BA%E8%AE%AE"><span class="toc-text">三、三级目录建议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%A0%B8%E5%BF%83%E7%BB%84%E6%88%90%E8%AF%B4%E6%98%8E"><span class="toc-text">四、核心组成说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%B8%8F%E2%83%A3-docs"><span class="toc-text">1️⃣ docs&#x2F;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-rules-%E2%80%94%E2%80%94-%E7%BA%A6%E6%9D%9F%E8%A7%84%E5%88%99%EF%BC%88%E6%9C%BA%E5%99%A8%E5%8F%AF%E8%AF%BB%EF%BC%89"><span class="toc-text">2️⃣ rules&#x2F; —— 约束规则（机器可读）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%B8%8F%E2%83%A3-schema-%E2%80%94%E2%80%94-%E7%BB%93%E6%9E%84%E5%8C%96-Schema"><span class="toc-text">3️⃣ schema&#x2F; —— 结构化 Schema</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E4%B8%89%E7%BA%A7%E5%B1%82%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%B8%B8%E5%85%B3%E7%B3%BB"><span class="toc-text">六、三级层与上下游关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%B7%A5%E7%A8%8B%E7%BA%A7%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="toc-text">七、工程级注意点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prompt-6"><span class="toc-text">Prompt:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-6"><span class="toc-text">Response:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%F0%9F%A7%A0-%E5%9B%9B%E7%BA%A7%E6%9E%B6%E6%9E%84%EF%BC%9A%E7%8A%B6%E6%80%81-%E8%AE%B0%E5%BF%86%E7%B3%BB%E7%BB%9F%EF%BC%88Context-Memory%EF%BC%89"><span class="toc-text">🧠 四级架构：状态 &amp; 记忆系统（Context &#x2F; Memory）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%9B%AE%E6%A0%87"><span class="toc-text">二、目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%A0%B8%E5%BF%83%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-text">四、核心文件说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%B8%8F%E2%83%A3-project-state-json"><span class="toc-text">1️⃣ project_state.json</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-task-state-json"><span class="toc-text">2️⃣ task_state.json</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%B8%8F%E2%83%A3-prompt-state-json"><span class="toc-text">3️⃣ prompt_state.json</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%EF%B8%8F%E2%83%A3-history-log"><span class="toc-text">4️⃣ history.log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%EF%B8%8F%E2%83%A3-decisions-md"><span class="toc-text">5️⃣ decisions.md</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E4%B8%8E%E5%85%B6%E4%BB%96%E5%B1%82%E5%85%B3%E7%B3%BB"><span class="toc-text">六、与其他层关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prompt-7"><span class="toc-text">Prompt:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-7"><span class="toc-text">Response:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%F0%9F%97%82-%E4%BA%94%E7%BA%A7%E6%9E%B6%E6%9E%84%EF%BC%9A%E4%BB%BB%E5%8A%A1%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86%EF%BC%88Tasks-Plan-Diff%EF%BC%89"><span class="toc-text">🗂 五级架构：任务生命周期管理（Tasks &#x2F; Plan &#x2F; Diff）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%9B%AE%E6%A0%87-1"><span class="toc-text">二、目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E4%BB%BB%E5%8A%A1%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1"><span class="toc-text">四、任务对象设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%B8%8F%E2%83%A3-%E6%A0%B8%E5%BF%83%E5%AD%97%E6%AE%B5%EF%BC%88JSON-%E6%A0%BC%E5%BC%8F%EF%BC%89"><span class="toc-text">1️⃣ 核心字段（JSON 格式）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%8A%B6%E6%80%81"><span class="toc-text">2️⃣ 生命周期状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%B8%8F%E2%83%A3-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E8%A7%84%E5%88%99"><span class="toc-text">3️⃣ 任务执行规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#backlog-s1-json"><span class="toc-text">backlog&#x2F;s1.json</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E4%B8%8E%E5%85%B6%E4%BB%96%E5%B1%82%E5%85%B3%E7%B3%BB"><span class="toc-text">七、与其他层关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E5%B7%A5%E7%A8%8B%E7%BA%A7%E5%8E%9F%E5%88%99"><span class="toc-text">八、工程级原则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prompt-8"><span class="toc-text">Prompt:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-8"><span class="toc-text">Response:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%F0%9F%A7%AA-%E5%85%AD%E7%BA%A7%E6%9E%B6%E6%9E%84%EF%BC%9A%E9%AA%8C%E8%AF%81-%E5%9B%9E%E8%B7%AF%E5%B1%82%EF%BC%88Validation-Feedback-Loop%EF%BC%89"><span class="toc-text">🧪 六级架构：验证 &amp; 回路层（Validation &#x2F; Feedback Loop）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%85%AD%E7%BA%A7%E5%B1%82%E7%9A%84%E6%A0%B8%E5%BF%83%E7%9B%AE%E6%A0%87"><span class="toc-text">二、六级层的核心目标</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A0-%E7%94%9F%E6%88%90%E5%89%8D%EF%BC%88Pre-generation%EF%BC%89"><span class="toc-text">① 生成前（Pre-generation）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A1-%E7%94%9F%E6%88%90%E5%90%8E%EF%BC%88Post-generation%EF%BC%89"><span class="toc-text">② 生成后（Post-generation）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A2-%E5%BA%94%E7%94%A8%E6%97%B6%EF%BC%88Runtime-Apply%EF%BC%89"><span class="toc-text">③ 应用时（Runtime &#x2F; Apply）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-text">四、目录结构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-1%EF%B8%8F%E2%83%A3-Pre-generation-%E9%AA%8C%E8%AF%81%EF%BC%88%E7%94%9F%E6%88%90%E5%89%8D%EF%BC%89"><span class="toc-text">🟦 1️⃣ Pre-generation 验证（生成前）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#context-check-py"><span class="toc-text">context_check.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#task-check-py"><span class="toc-text">task_check.py</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-2%EF%B8%8F%E2%83%A3-Post-generation-%E9%AA%8C%E8%AF%81%EF%BC%88%E7%94%9F%E6%88%90%E5%90%8E%EF%BC%89"><span class="toc-text">🟦 2️⃣ Post-generation 验证（生成后）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#schema-validator-py"><span class="toc-text">schema_validator.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rule-validator-py"><span class="toc-text">rule_validator.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#diff-validator-py"><span class="toc-text">diff_validator.py</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-3%EF%B8%8F%E2%83%A3-Runtime-%E9%AA%8C%E8%AF%81%EF%BC%88%E5%BA%94%E7%94%A8%E6%97%B6%EF%BC%89"><span class="toc-text">🟦 3️⃣ Runtime 验证（应用时）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#apply-guard-py"><span class="toc-text">apply_guard.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rollback-guard-py"><span class="toc-text">rollback_guard.py</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E5%B7%A5%E7%A8%8B%E7%BA%A7%E5%8E%9F%E5%88%99%EF%BC%88%E5%BF%85%E9%A1%BB%E8%AE%B0%E4%BD%8F%EF%BC%89"><span class="toc-text">八、工程级原则（必须记住）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E8%BF%99%E4%B8%80%E5%B1%82%E5%AE%8C%E6%88%90%E5%90%8E%EF%BC%8C%E4%BD%A0%E7%B3%BB%E7%BB%9F%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88%E5%8F%98%E5%8C%96%EF%BC%9F"><span class="toc-text">九、这一层完成后，你系统会发生什么变化？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9C%85-%E5%85%AD%E7%BA%A7%E5%AE%8C%E6%88%90%E6%A0%87%E5%87%86"><span class="toc-text">✅ 六级完成标准</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E4%B8%80%E6%AD%A5%E9%A2%84%E5%91%8A"><span class="toc-text">下一步预告</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prompt-9"><span class="toc-text">Prompt:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-9"><span class="toc-text">Response:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%F0%9F%A7%AA-%E5%85%AD%E7%BA%A7%EF%BC%88%E9%87%8D%E5%88%B6%E7%89%88%EF%BC%89%EF%BC%9A%E9%AA%8C%E8%AF%81-%E5%9B%9E%E8%B7%AF%E5%B1%82"><span class="toc-text">🧪 六级（重制版）：验证 &amp; 回路层</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%85%AD%E7%BA%A7%E5%9C%A8%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E2%80%9C%E7%9C%9F%E5%AE%9E%E4%BD%8D%E7%BD%AE%E2%80%9D"><span class="toc-text">一、六级在系统中的“真实位置”</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%EF%BC%88%E5%AE%8C%E6%95%B4%E7%89%88%EF%BC%89"><span class="toc-text">二、目录结构（完整版）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81Pre-generation%EF%BC%88%E7%94%9F%E6%88%90%E5%89%8D%E9%AA%8C%E8%AF%81%EF%BC%89"><span class="toc-text">三、Pre-generation（生成前验证）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E7%9B%AE%E6%A0%87"><span class="toc-text">🎯 目标</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF"><span class="toc-text">场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9Acontext-check-py%EF%BC%88%E5%AE%8C%E6%95%B4-demo%EF%BC%89"><span class="toc-text">示例：context_check.py（完整 demo）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E7%A4%BA%E4%BE%8B%EF%BC%88project-state-json%EF%BC%89"><span class="toc-text">输入示例（project_state.json）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA"><span class="toc-text">输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%9C%A8%E8%BF%99%E4%B8%80%E6%AD%A5%E5%81%9A%EF%BC%9F"><span class="toc-text">为什么要在这一步做？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF-1"><span class="toc-text">场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9Atask-check-py"><span class="toc-text">示例：task_check.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%BF%99%E4%B8%80%E5%B1%82%EF%BC%9F"><span class="toc-text">为什么要这一层？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Post-generation%EF%BC%88%E7%94%9F%E6%88%90%E5%90%8E%E9%AA%8C%E8%AF%81%EF%BC%89"><span class="toc-text">四、Post-generation（生成后验证）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF-2"><span class="toc-text">场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#schema-validator-py%EF%BC%88%E5%AE%8C%E6%95%B4%EF%BC%89"><span class="toc-text">schema_validator.py（完整）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E7%A4%BA%E4%BE%8B"><span class="toc-text">输入示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E6%84%8F%E4%B9%89"><span class="toc-text">工程意义</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%EF%B8%8F%E2%83%A3-rule-validator-py"><span class="toc-text">4️⃣ rule_validator.py</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF-3"><span class="toc-text">场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9Arule-validator-py%EF%BC%88%E7%AE%80%E5%8C%96%E7%89%88%EF%BC%89"><span class="toc-text">示例：rule_validator.py（简化版）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E7%A4%BA%E4%BE%8B%EF%BC%88task-constraints-yaml%EF%BC%89"><span class="toc-text">规则示例（task_constraints.yaml）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA-1"><span class="toc-text">输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-schema-%E4%B8%8D%E5%A4%9F%EF%BC%9F"><span class="toc-text">为什么 schema 不够？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%EF%B8%8F%E2%83%A3-diff-validator-py%EF%BC%88%E6%A0%B8%E5%BF%83%EF%BC%89"><span class="toc-text">5️⃣ diff_validator.py（核心）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF-4"><span class="toc-text">场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9Adiff-validator-py"><span class="toc-text">示例：diff_validator.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E6%84%8F%E4%B9%89-1"><span class="toc-text">工程意义</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81Runtime%EF%BC%88%E5%BA%94%E7%94%A8%E6%97%B6%E9%AA%8C%E8%AF%81%EF%BC%89"><span class="toc-text">五、Runtime（应用时验证）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6%EF%B8%8F%E2%83%A3-apply-guard-py"><span class="toc-text">6️⃣ apply_guard.py</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF-5"><span class="toc-text">场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#apply-guard-py%EF%BC%88%E7%A4%BA%E4%BE%8B%EF%BC%89"><span class="toc-text">apply_guard.py（示例）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E6%84%8F%E4%B9%89-2"><span class="toc-text">工程意义</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%EF%B8%8F%E2%83%A3-rollback-guard-py"><span class="toc-text">7️⃣ rollback_guard.py</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF-6"><span class="toc-text">场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rollback-guard-py%EF%BC%88%E7%A4%BA%E4%BE%8B%EF%BC%89"><span class="toc-text">rollback_guard.py（示例）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81Validation-Report%EF%BC%88%E7%BB%93%E6%9E%84%E5%8C%96%E7%BB%93%E6%9E%9C%EF%BC%89"><span class="toc-text">六、Validation Report（结构化结果）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#validation-report-json%EF%BC%88%E5%AE%8C%E6%95%B4%E7%A4%BA%E4%BE%8B%EF%BC%89"><span class="toc-text">validation_report.json（完整示例）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%8F%8D%E9%A6%88%E5%9B%9E%E8%B7%AF%EF%BC%88Retry-Fix-Human%EF%BC%89"><span class="toc-text">七、反馈回路（Retry &#x2F; Fix &#x2F; Human）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E7%A4%BA%E4%BE%8B"><span class="toc-text">逻辑示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E8%BF%99%E4%B8%80%E5%B1%82%E5%AE%8C%E6%88%90%E5%90%8E%EF%BC%8C%E4%BD%A0%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%B4%A8%E5%8F%98"><span class="toc-text">八、这一层完成后，你的系统质变</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E5%85%AD%E7%BA%A7%E5%AE%8C%E6%88%90%E6%A0%87%E5%87%86%EF%BC%88%E9%9D%9E%E5%B8%B8%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-text">九、六级完成标准（非常重要）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E4%B8%80%E6%AD%A5%EF%BC%88%E4%B8%83%E7%BA%A7%EF%BC%89"><span class="toc-text">下一步（七级）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prompt-10"><span class="toc-text">Prompt:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-10"><span class="toc-text">Response:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%F0%9F%A7%A0-%E4%B8%83%E7%BA%A7%EF%BC%9A%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%EF%BC%88Execution-Engine%EF%BC%89"><span class="toc-text">🧠 七级：执行引擎（Execution Engine）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%B8%83%E7%BA%A7%E8%A7%A3%E5%86%B3%E7%9A%84%E6%A0%B9%E6%9C%AC%E9%97%AE%E9%A2%98"><span class="toc-text">一、七级解决的根本问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81engine-py-%E2%80%94%E2%80%94-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%85%A5%E5%8F%A3%EF%BC%88%E6%A0%B8%E5%BF%83%EF%BC%89"><span class="toc-text">四、engine.py —— 执行引擎入口（核心）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%81%8C%E8%B4%A3"><span class="toc-text">🎯 职责</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#engine-py%EF%BC%88%E5%AE%8C%E6%95%B4%E7%A4%BA%E4%BE%8B%EF%BC%89"><span class="toc-text">engine.py（完整示例）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%85%A5"><span class="toc-text">输入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA-2"><span class="toc-text">输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%B8%80%E4%B8%AA-while-%E5%BE%AA%E7%8E%AF%EF%BC%9F"><span class="toc-text">为什么要一个 while 循环？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81scheduler-py-%E2%80%94%E2%80%94-%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%99%A8"><span class="toc-text">五、scheduler.py —— 任务调度器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%81%8C%E8%B4%A3-1"><span class="toc-text">🎯 职责</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#scheduler-py%EF%BC%88%E5%AE%8C%E6%95%B4-demo%EF%BC%89"><span class="toc-text">scheduler.py（完整 demo）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#task-state-json-%E7%A4%BA%E4%BE%8B"><span class="toc-text">task_state.json 示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-scheduler-%E5%BF%85%E9%A1%BB%E7%8B%AC%E7%AB%8B%EF%BC%9F"><span class="toc-text">为什么 scheduler 必须独立？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81executor-py-%E2%80%94%E2%80%94-%E5%8D%95%E6%AD%A5%E6%89%A7%E8%A1%8C%E5%99%A8%EF%BC%88%E9%9D%9E%E5%B8%B8%E5%85%B3%E9%94%AE%EF%BC%89"><span class="toc-text">六、executor.py —— 单步执行器（非常关键）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%81%8C%E8%B4%A3-2"><span class="toc-text">🎯 职责</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#executor-py%EF%BC%88%E7%AE%80%E5%8C%96%E4%BD%86%E5%AE%8C%E6%95%B4%EF%BC%89"><span class="toc-text">executor.py（简化但完整）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-executor-%E4%B8%8D%E7%9B%B4%E6%8E%A5%E6%94%B9%E6%96%87%E4%BB%B6%EF%BC%9F"><span class="toc-text">为什么 executor 不直接改文件？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81state-manager-py-%E2%80%94%E2%80%94-%E7%8A%B6%E6%80%81%E6%9C%BA%EF%BC%88%E5%B7%A5%E7%A8%8B%E7%81%B5%E9%AD%82%EF%BC%89"><span class="toc-text">七、state_manager.py —— 状态机（工程灵魂）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%81%8C%E8%B4%A3-3"><span class="toc-text">🎯 职责</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#state-manager-py%EF%BC%88%E5%AE%8C%E6%95%B4-demo%EF%BC%89"><span class="toc-text">state_manager.py（完整 demo）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%8A%B6%E6%80%81%E4%B8%80%E5%AE%9A%E8%A6%81%E8%90%BD%E7%9B%98%EF%BC%9F"><span class="toc-text">为什么状态一定要落盘？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81retry-policy-py-%E2%80%94%E2%80%94-%E9%87%8D%E8%AF%95%E7%AD%96%E7%95%A5%EF%BC%88%E8%BF%9B%E9%98%B6%EF%BC%89"><span class="toc-text">八、retry_policy.py —— 重试策略（进阶）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%81%8C%E8%B4%A3-4"><span class="toc-text">🎯 职责</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#retry-policy-py%EF%BC%88%E7%A4%BA%E4%BE%8B%EF%BC%89"><span class="toc-text">retry_policy.py（示例）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E6%84%8F%E4%B9%89-3"><span class="toc-text">工程意义</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E3%80%81main-py-%E5%A6%82%E4%BD%95%E2%80%9C%E9%99%8D%E7%BA%A7%E2%80%9D%E4%B8%BA%E5%85%A5%E5%8F%A3"><span class="toc-text">九、main.py 如何“降级”为入口</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E4%B8%83%E7%BA%A7%E5%AE%8C%E6%88%90%E5%90%8E%EF%BC%8C%E4%BD%A0%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%83%BD%E5%8A%9B%E8%B7%83%E8%BF%81"><span class="toc-text">十、七级完成后，你的系统能力跃迁</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E4%B8%83%E7%BA%A7%E5%AE%8C%E6%88%90%E6%A3%80%E6%9F%A5%E6%B8%85%E5%8D%95"><span class="toc-text">十一、七级完成检查清单</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Prompt-11"><span class="toc-text">Prompt:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-11"><span class="toc-text">Response:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%F0%9F%A7%A0-%E5%85%AB%E7%BA%A7%EF%BC%9A%E4%B8%8A%E4%B8%8B%E6%96%87%E4%B8%8E%E8%AE%B0%E5%BF%86%E7%B3%BB%E7%BB%9F"><span class="toc-text">🧠 八级：上下文与记忆系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Context-Memory-Layer%EF%BC%88%E5%B7%A5%E7%A8%8B%E7%BA%A7%E5%AE%8C%E6%95%B4%E7%89%88%EF%BC%89"><span class="toc-text">Context &#x2F; Memory Layer（工程级完整版）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%85%AB%E7%BA%A7%E8%A7%A3%E5%86%B3%E7%9A%84%E6%A0%B8%E5%BF%83%E9%97%AE%E9%A2%98"><span class="toc-text">二、八级解决的核心问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%85%AB%E7%BA%A7%E5%9C%A8%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E4%B8%AD%E7%9A%84%E4%BD%8D%E7%BD%AE"><span class="toc-text">三、八级在整体架构中的位置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%85%AB%E7%BA%A7%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%EF%BC%88%E5%B7%A5%E7%A8%8B%E7%BA%A7%EF%BC%89"><span class="toc-text">四、八级目录结构（工程级）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81context-store-py-%E2%80%94%E2%80%94-%E5%BD%93%E5%89%8D%E4%B8%8A%E4%B8%8B%E6%96%87%E5%BF%AB%E7%85%A7"><span class="toc-text">五、context_store.py —— 当前上下文快照</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%81%8C%E8%B4%A3-5"><span class="toc-text">🎯 职责</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#context-store-py%EF%BC%88%E5%AE%8C%E6%95%B4-demo%EF%BC%89"><span class="toc-text">context_store.py（完整 demo）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#context-%E7%A4%BA%E4%BE%8B"><span class="toc-text">context 示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E6%98%AF%E7%9B%B4%E6%8E%A5%E7%94%A8-state-manager%EF%BC%9F"><span class="toc-text">为什么不是直接用 state_manager？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81project-memory-py-%E2%80%94%E2%80%94-%E9%A1%B9%E7%9B%AE%E9%95%BF%E6%9C%9F%E8%AE%B0%E5%BF%86%EF%BC%88%E6%9C%80%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-text">六、project_memory.py —— 项目长期记忆（最重要）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%81%8C%E8%B4%A3-6"><span class="toc-text">🎯 职责</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#project-memory-py%EF%BC%88%E5%AE%8C%E6%95%B4-demo%EF%BC%89"><span class="toc-text">project_memory.py（完整 demo）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E6%9E%B6%E6%9E%84%E8%AE%B0%E5%BF%86"><span class="toc-text">示例：架构记忆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E6%84%8F%E4%B9%89-4"><span class="toc-text">工程意义</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81decision-log-py-%E2%80%94%E2%80%94-%E5%86%B3%E7%AD%96%E5%9B%A0%E6%9E%9C%E9%93%BE%EF%BC%88%E6%9E%81%E5%85%B6%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-text">七、decision_log.py —— 决策因果链（极其重要）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%81%8C%E8%B4%A3-7"><span class="toc-text">🎯 职责</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#decision-log-py%EF%BC%88%E5%AE%8C%E6%95%B4-demo%EF%BC%89"><span class="toc-text">decision_log.py（完整 demo）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-text">示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%99%E6%98%AF%E5%B7%A5%E7%A8%8B%E7%BA%A7%EF%BC%9F"><span class="toc-text">为什么这是工程级？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81error-memory-py-%E2%80%94%E2%80%94-%E9%94%99%E8%AF%AF%E8%AE%B0%E5%BF%86%E7%B3%BB%E7%BB%9F"><span class="toc-text">八、error_memory.py —— 错误记忆系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%81%8C%E8%B4%A3-8"><span class="toc-text">🎯 职责</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#error-memory-py%EF%BC%88%E5%AE%8C%E6%95%B4-demo%EF%BC%89"><span class="toc-text">error_memory.py（完整 demo）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1"><span class="toc-text">示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E6%84%8F%E4%B9%89-5"><span class="toc-text">工程意义</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E3%80%81preference-store-py-%E2%80%94%E2%80%94-%E7%94%A8%E6%88%B7%E5%81%8F%E5%A5%BD%EF%BC%88Cursor-%E7%B2%BE%E9%AB%93%EF%BC%89"><span class="toc-text">九、preference_store.py —— 用户偏好（Cursor 精髓）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%81%8C%E8%B4%A3-9"><span class="toc-text">🎯 职责</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#preference-store-py%EF%BC%88%E5%AE%8C%E6%95%B4-demo%EF%BC%89"><span class="toc-text">preference_store.py（完整 demo）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-2"><span class="toc-text">示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%99%E6%98%AF%E2%80%9CAI-%E4%BA%A7%E5%93%81%E8%80%8C%E4%B8%8D%E6%98%AF%E8%84%9A%E6%9C%AC%E2%80%9D%EF%BC%9F"><span class="toc-text">为什么这是“AI 产品而不是脚本”？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E3%80%81retrieval-py-%E2%80%94%E2%80%94-%E8%AE%B0%E5%BF%86%E6%A3%80%E7%B4%A2%E4%B8%8E%E8%A3%81%E5%89%AA%EF%BC%88%E5%85%B3%E9%94%AE%EF%BC%89"><span class="toc-text">十、retrieval.py —— 记忆检索与裁剪（关键）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%81%8C%E8%B4%A3-10"><span class="toc-text">🎯 职责</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#retrieval-py%EF%BC%88%E7%A4%BA%E4%BE%8B%EF%BC%89"><span class="toc-text">retrieval.py（示例）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E6%84%8F%E4%B9%89-6"><span class="toc-text">工程意义</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E5%85%AB%E7%BA%A7%E5%A6%82%E4%BD%95%E7%9C%9F%E6%AD%A3%E2%80%9C%E6%8E%A5%E5%85%A5%E7%B3%BB%E7%BB%9F%E2%80%9D"><span class="toc-text">十一、八级如何真正“接入系统”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#executor-%E4%B8%AD%E7%9A%84%E7%A4%BA%E6%84%8F"><span class="toc-text">executor 中的示意</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81%E5%85%AB%E7%BA%A7%E5%AE%8C%E6%88%90%E5%90%8E%EF%BC%8C%E4%BD%A0%E7%9A%84%E7%B3%BB%E7%BB%9F%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88%E5%8F%98%E5%8C%96"><span class="toc-text">十二、八级完成后，你的系统发生了什么变化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%89%E3%80%81%E5%85%AB%E7%BA%A7%E5%AE%8C%E6%88%90%E8%87%AA%E6%A3%80%E6%B8%85%E5%8D%95"><span class="toc-text">十三、八级完成自检清单</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Prompt-12"><span class="toc-text">Prompt:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-12"><span class="toc-text">Response:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%F0%9F%A7%A0-%E4%B9%9D%E7%BA%A7%EF%BC%9A%E8%87%AA%E8%BF%9B%E5%8C%96%E7%B3%BB%E7%BB%9F%EF%BC%88Evolution-Layer%EF%BC%89"><span class="toc-text">🧠 九级：自进化系统（Evolution Layer）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%B9%9D%E7%BA%A7%E8%A7%A3%E5%86%B3%E7%9A%84%E7%BB%88%E6%9E%81%E9%97%AE%E9%A2%98"><span class="toc-text">二、九级解决的终极问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%B9%9D%E7%BA%A7%E5%9C%A8%E6%95%B4%E4%BD%93%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E4%BD%8D%E7%BD%AE%EF%BC%88%E9%97%AD%E7%8E%AF%EF%BC%89"><span class="toc-text">三、九级在整体系统中的位置（闭环）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81evolution-engine-py-%E2%80%94%E2%80%94-%E8%BF%9B%E5%8C%96%E4%B8%AD%E6%9E%A2"><span class="toc-text">五、evolution_engine.py —— 进化中枢</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%81%8C%E8%B4%A3-11"><span class="toc-text">🎯 职责</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#evolution-engine-py%EF%BC%88%E5%AE%8C%E6%95%B4-demo%EF%BC%89"><span class="toc-text">evolution_engine.py（完整 demo）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E6%84%8F%E4%B9%89-7"><span class="toc-text">工程意义</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81prompt-evolver-py-%E2%80%94%E2%80%94-Prompt-%E8%87%AA%E6%88%91%E4%BF%AE%E6%AD%A3"><span class="toc-text">六、prompt_evolver.py —— Prompt 自我修正</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#prompt-evolver-py%EF%BC%88%E5%AE%8C%E6%95%B4-demo%EF%BC%89"><span class="toc-text">prompt_evolver.py（完整 demo）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E6%BC%94%E8%BF%9B%E7%BB%93%E6%9E%9C"><span class="toc-text">示例演进结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E6%98%AF%E6%AF%8F%E6%AC%A1%E9%83%BD%E6%94%B9%EF%BC%9F"><span class="toc-text">为什么不是每次都改？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81rule-evolver-py-%E2%80%94%E2%80%94-%E8%A7%84%E5%88%99%E6%BC%94%E8%BF%9B%EF%BC%88%E9%9D%9E%E5%B8%B8%E5%8D%B1%E9%99%A9%E4%BD%86%E5%BF%85%E8%A6%81%EF%BC%89"><span class="toc-text">七、rule_evolver.py —— 规则演进（非常危险但必要）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E5%9C%BA%E6%99%AF"><span class="toc-text">🎯 场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rule-evolver-py%EF%BC%88%E5%AE%8C%E6%95%B4-demo%EF%BC%89"><span class="toc-text">rule_evolver.py（完整 demo）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E6%84%8F%E4%B9%89-8"><span class="toc-text">工程意义</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81architecture-evolver-py-%E2%80%94%E2%80%94-%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B%EF%BC%88%E6%9C%80%E6%85%8E%E9%87%8D%EF%BC%89"><span class="toc-text">八、architecture_evolver.py —— 架构演进（最慎重）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E5%8E%9F%E5%88%99"><span class="toc-text">🎯 原则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#architecture-evolver-py%EF%BC%88%E5%AE%8C%E6%95%B4-demo%EF%BC%89"><span class="toc-text">architecture_evolver.py（完整 demo）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9A%A0%EF%B8%8F-%E9%9D%9E%E5%B8%B8%E9%87%8D%E8%A6%81"><span class="toc-text">⚠️ 非常重要</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E3%80%81evaluation-py-%E2%80%94%E2%80%94-%E6%98%AF%E5%90%A6%E5%80%BC%E5%BE%97%E8%BF%9B%E5%8C%96%EF%BC%9F"><span class="toc-text">九、evaluation.py —— 是否值得进化？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%81%8C%E8%B4%A3-12"><span class="toc-text">🎯 职责</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#evaluation-py%EF%BC%88%E5%AE%8C%E6%95%B4-demo%EF%BC%89"><span class="toc-text">evaluation.py（完整 demo）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E6%84%8F%E4%B9%89-9"><span class="toc-text">工程意义</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E3%80%81evolution-log-py-%E2%80%94%E2%80%94-%E6%BC%94%E8%BF%9B%E5%AE%A1%E8%AE%A1%EF%BC%88%E5%BF%85%E4%B8%8D%E5%8F%AF%E5%B0%91%EF%BC%89"><span class="toc-text">十、evolution_log.py —— 演进审计（必不可少）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E8%81%8C%E8%B4%A3-13"><span class="toc-text">🎯 职责</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#evolution-log-py%EF%BC%88%E5%AE%8C%E6%95%B4-demo%EF%BC%89"><span class="toc-text">evolution_log.py（完整 demo）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E8%AE%B0%E5%BD%95"><span class="toc-text">示例记录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E4%B9%9D%E7%BA%A7%E5%AE%8C%E6%88%90%E5%90%8E%EF%BC%8C%E7%B3%BB%E7%BB%9F%E2%80%9C%E6%B4%BB%E2%80%9D%E4%BA%86"><span class="toc-text">十一、九级完成后，系统“活”了</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81%E7%BB%88%E6%9E%81%E5%AF%B9%E6%AF%94%EF%BC%88%E4%BD%A0-vs-Cursor%EF%BC%89"><span class="toc-text">十二、终极对比（你 vs Cursor）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%89%E3%80%81%E6%9C%80%E7%BB%88%E5%AE%8C%E6%95%B4%E4%B9%9D%E7%BA%A7%E4%BD%93%E7%B3%BB%E5%9B%9E%E9%A1%BE"><span class="toc-text">十三、最终完整九级体系回顾</span></a></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"><path stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/><path d="M7 3.338A9.95 9.95 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/></g></svg><span>Scroll to Top</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M8 10.5h8M8 14h5.5M17 3.338A9.95 9.95 0 0 0 12 2C6.477 2 2 6.477 2 12c0 1.6.376 3.112 1.043 4.453c.178.356.237.763.134 1.148l-.595 2.226a1.3 1.3 0 0 0 1.591 1.592l2.226-.596a1.63 1.63 0 0 1 1.149.133A9.96 9.96 0 0 0 12 22c5.523 0 10-4.477 10-10c0-1.821-.487-3.53-1.338-5"/></svg><span>Join Discussion</span></a></div></widget>
</div></aside><div class='float-panel'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">


<script type="text/javascript">
  window.canonical = {"originalHost":null,"officialHosts":["localhost"],"encoded":""};
  window.canonical["param"] = {"permalink":"https://lemoncyan.github.io/2025/12/22/2-%E8%AF%AD%E8%A8%80%E5%92%8C%E6%A1%86%E6%9E%B6-VibeCoding-ChatGPT-%E5%B7%A5%E7%A8%8B%E7%BA%A7%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/","checklink":"/js/plugins/video.js"};
  const ctx = {
    date_suffix: {
      just: `Just`,
      min: `minutes ago`,
      hour: `hours ago`,
      day: `days ago`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
    loading: `https://api.iconify.design/eos-icons:three-dots-loading.svg?color=%231cd0fd`,
  };
  const deps = {
    jquery: `https://gcore.jsdelivr.net/npm/jquery@3.7/dist/jquery.min.js`,
    marked: `https://gcore.jsdelivr.net/npm/marked@13.0/lib/marked.umd.min.js`,
    lazyload: `/%5Bobject%20Object%5D`
  }
  

</script>

<script type="text/javascript">
  
  function RunItem() {
    this.list = []; // 存放回调函数
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // 构造一个可以run的对象
    function Item(fn, name) {
      // 函数名称
      this.name = name || fn.name;
      // run方法
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        if ($(el).find('.loading-wrap').length == 0){
          $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
        }
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      const maxRetry = 3;
      let retryCount = 0;

      return new Promise((resolve, reject) => {
        const load = () => {
          utils.onLoading?.(el);

          let timedOut = false;
          const timeout = setTimeout(() => {
            timedOut = true;
            console.warn('[request] 超时:', url);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject('请求超时');
            } else {
              setTimeout(load, 1000);
            }
          }, 5000);

          fetch(url).then(resp => {
            if (timedOut) return;
            clearTimeout(timeout);

            if (!resp.ok) throw new Error('响应失败');
            return resp;
          }).then(data => {
            if (timedOut) return;
            utils.onLoadSuccess?.(el);
            callback(data);
            resolve(data);
          }).catch(err => {
            clearTimeout(timeout);
            console.warn('[request] 错误:', err);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject(err);
            } else {
              setTimeout(load, 1000);
            }
          });
        };

        load();
      });
    },
    requestWithoutLoading: (url, options = {}, maxRetry = 2, timeout = 5000) => {
      return new Promise((resolve, reject) => {
        let retryCount = 0;

        const tryRequest = () => {
          let timedOut = false;
          const timer = setTimeout(() => {
            timedOut = true;
            if (++retryCount > maxRetry) reject('timeout');
            else tryRequest();
          }, timeout);

          fetch(url, options)
            .then(resp => {
              clearTimeout(timer);
              if (!resp.ok) throw new Error('bad response');
              resolve(resp);
            })
            .catch(err => {
              clearTimeout(timer);
              if (++retryCount > maxRetry) reject(err);
              else setTimeout(tryRequest, 500);
            });
        };

        tryRequest();
      });
    },
    /********************** requestAnimationFrame ********************************/
    // 1、requestAnimationFrame 会把每一帧中的所有 DOM 操作集中起来，在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率，一般来说，这个频率为每秒60帧。
    // 2、在隐藏或不可见的元素中，requestAnimationFrame 将不会进行重绘或回流，这当然就意味着更少的的 cpu，gpu 和内存使用量。
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode 当前模式 dark or light
  // utils.dark.toggle() 暗黑模式触发器
  // utils.dark.push(callBack[,"callBackName"]) 传入触发器回调函数
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>

<script async src="https://gcore.jsdelivr.net/npm/vanilla-lazyload@19.1/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
    callback_loaded: (el) => {
      el.classList.add('loaded');
      const wrapper = el.closest('.lazy-box');
      const icon = wrapper?.querySelector('.lazy-icon');
      if (icon) icon.remove();
    }
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });

  window.wrapLazyloadImages = (container) => {
    if (typeof container === 'string') {
      container = document.querySelector(container);
    }
    if (!container) return;
    
    const images = container.querySelectorAll('img');
    images.forEach((img) => {
      if (img.classList.contains('lazy')) return;

      const src = img.getAttribute('src');
      if (!src) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'lazy-box';

      const newImg = img.cloneNode();
      newImg.removeAttribute('src');
      newImg.setAttribute('data-src', src);
      newImg.classList.add('lazy');

      const icon = document.createElement('div');
      icon.className = 'lazy-icon';
      if (def.loading) {
        icon.style.backgroundImage = `url("${def.loading}")`;
      }

      wrapper.appendChild(newImg);
      wrapper.appendChild(icon);

      img.replaceWith(wrapper);
    });

    // 通知 LazyLoad 更新
    if (window.lazyLoadInstance?.update) {
      window.lazyLoadInstance.update();
    }
  }
  
</script>

<!-- required -->
<script src="/js/main.js?v=1.33.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    // applyThemeToGiscus(theme)
  }

  // FIXME: 这会导致无法使用 preferred_color_scheme 以外的主题
  const applyThemeToGiscus = (theme) => {
    // theme = theme === 'auto' ? 'preferred_color_scheme' : theme
    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `Switched to Light Mode`,
      dark: `Switched to Dark Mode`,
      auto: `Switched to Auto Mode`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->

  <script type="module">
  const el = document.querySelector("#comments #utterances");
  util.viewportLazyload(el, load_utterances, true);

  function load_utterances() {
    if (!el) return;
    try {
      el.innerHTML = '';
    } catch (error) {
      console.error(error);
    }
    const script = document.createElement('script');
    script.src = 'https://utteranc.es/client.js';
    script.async = true;
    for (const key of Object.keys(el.attributes)) {
      const attr = el.attributes[key];
      if (['class', 'id'].includes(attr.name) === false) {
        script.setAttribute(attr.name, attr.value);
      }
    }
    el.appendChild(script);
  }
</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"rating":{"js":"/js/services/rating.js","api":"https://star-vote.xaox.cc/api/rating"},"vote":{"js":"/js/services/vote.js","api":"https://star-vote.xaox.cc/api/vote"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"},"contributors":{"edit_this_page":{"_posts/":null,"wiki/stellar/":"https://github.com/xaoxuu/hexo-theme-stellar-docs/blob/main/"},"js":"/js/services/contributors.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.chat-file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://gcore.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css`,
    js: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js`
  };
  var selector = '[data-fancybox]:not(.error), .with-fancybox .atk-content img:not([atk-emoticon])';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const memos = document.getElementsByClassName('ds-memos');
    if (memos != undefined && memos.length > 0) {
      needFancybox = true;
    }
    const fancybox = document.getElementsByClassName('with-fancybox');
    if (fancybox != undefined && fancybox.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
